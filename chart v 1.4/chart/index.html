<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talaria Chart Pro </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        (function() {
            function redirectToLogin() {
                var next = window.location.pathname + window.location.search;
                var loginUrl = '/login/?next=' + encodeURIComponent(next);
                try {
                    if (window.top && window.top !== window.self) {
                        window.top.location.href = loginUrl;
                        return;
                    }
                } catch (e) {}
                window.location.href = loginUrl;
            }

            fetch('/api/auth/me', { credentials: 'include', cache: 'no-store' })
                .then(function(res) {
                    if (!res.ok) {
                        redirectToLogin();
                    }
                })
                .catch(function() {
                    redirectToLogin();
                });
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Override default cursor for UI elements only - allow SVG/canvas dynamic cursors */
        button, select, input, label, a, 
        [role="button"], [onclick], [class*="btn"], [class*="click"], 
        [class*="menu"], [class*="tab"], [class*="item"], [class*="option"],
        [class*="toggle"], [class*="switch"], [class*="check"], [class*="radio"] {
            cursor: default !important;
        }
        
        /* Allow canvas and SVG to have dynamic cursors */
        canvas, svg, svg * {
            cursor: inherit;
        }
        
        /* Keep resize cursors for axis zones */
        .price-axis-zone {
            cursor: ns-resize !important;
        }
        .time-axis-zone {
            cursor: ew-resize !important;
        }
        
        /* Allow grabbing cursor on canvas when panning */
        canvas.grabbing,
        canvas[style*="grabbing"] {
            cursor: grabbing !important;
        }
        
        /* Toolbar drawing icons */
        .toolbar-drawing-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-drawing-icons .toolbar-icon-btn {
            color: #a0aec0;
        }
        
        .toolbar-drawing-icons .toolbar-icon-btn:hover {
            color: #a0aec0;
        }
        
        /* Toolbar tool-group for horizontal layout - match left sidebar exactly */
        .toolbar-drawing-icons .tool-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .toolbar-drawing-icons .tool-group-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #a0aec0;
            cursor: default;
            transition: all 0.15s ease;
            position: relative;
        }
        
        .toolbar-drawing-icons .tool-group-btn:hover {
            color: #a0aec0;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .toolbar-drawing-icons .tool-group-btn.active {
            background: rgba(47, 114, 255, 0.25);
            color: #a0aec0;
        }
        
        .toolbar-drawing-icons .tool-group-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Hide default tooltip on toolbar tool-group-btn */
        .toolbar-drawing-icons .tool-group-btn::after {
            display: none !important;
        }
        
        /* Toolbar dropdown arrow - show on hover like sidebar */
        .toolbar-drawing-icons .dropdown-arrow {
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            opacity: 0;
            cursor: default !important;
            pointer-events: auto !important;
            transition: opacity 0.15s ease;
        }
        
        .toolbar-drawing-icons .tool-group:hover .dropdown-arrow {
            opacity: 1;
        }
        
        .toolbar-drawing-icons .dropdown-arrow:hover {
            background: #050028;
            color: #ffffff;
        }
        
        /* Sidebar timeframe section - Current timeframe display */
        .sidebar-timeframe-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px 6px;
            border: none;
            box-shadow: none;
            background: transparent;
        }
        
        /* Container for current timeframe + arrow button */
        .sidebar-current-timeframe-container {
            display: flex;
            gap: 4px;
            width: 100%;
            position: relative;
            border: none;
            box-shadow: none;
            background: transparent;
        }
        
        .sidebar-current-timeframe-container:hover {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        
        /* Current timeframe display button */
        .sidebar-current-timeframe {
            background: rgba(47, 114, 255, 0.25);
            border: none;
            color: #a0aec0;
            font-size: 11px;
            font-weight: 600;
            padding: 4px;
            border-radius: 6px;
            transition: none;
            width: 34px;
            height: 34px;
            min-width: 34px;
            min-height: 34px;
            max-width: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            cursor: default;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            box-shadow: none;
        }
        
        .sidebar-current-timeframe:hover {
            background: rgba(47, 114, 255, 0.35);
        }
        
        /* Small arrow button next to current timeframe */
        .sidebar-timeframe-arrow {
            width: 10px !important;
            height: 34px !important;
            min-width: 10px !important;
            padding: 0 !important;
            margin: 0 !important;
            background: rgba(0, 0, 0, 0.92);
            border: 1px solid rgba(63, 84, 124, 0.35);
            border-left: none;
            border-radius: 0 4px 4px 0;
            cursor: default;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: #a0aec0;
            transition: none;
            box-sizing: border-box !important;
            position: absolute;
            right: -10px;
            top: 0;
            bottom: 0;
            margin: auto 0;
            opacity: 0;
            flex-shrink: 0;
            z-index: 1;
            box-shadow: none;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Show arrow when hovering the container or the arrow itself */
        .sidebar-current-timeframe-container:hover .sidebar-timeframe-arrow,
        .sidebar-timeframe-arrow:hover,
        .sidebar-timeframe-arrow.open {
            opacity: 1;
        }
        
        /* Light mode - base state of arrow when visible */
        body.light-mode .sidebar-timeframe-arrow {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #787b86 !important;
            border-color: #e0e3eb !important;
        }
        
        .sidebar-timeframe-arrow:hover {
            background: rgba(41, 98, 255, 0.15);
            color: #a0aec0;
        }

        .sidebar-timeframe-arrow.open {
            background: rgba(41, 98, 255, 0.15);
            color: #a0aec0;
        }
        
        body.light-mode .sidebar-timeframe-arrow:hover {
            background: rgba(41, 98, 255, 0.12) !important;
            color: #2962ff !important;
        }

        body.light-mode .sidebar-timeframe-arrow.open {
            background: rgba(41, 98, 255, 0.15) !important;
            color: #2962ff !important;
        }
        
        .sidebar-timeframe-arrow svg {
            width: 12px;
            height: 8px;
            flex-shrink: 0;
            transform: rotate(-90deg);
            transition: none;
        }
        
        .sidebar-timeframe-arrow.open svg {
            transform: rotate(90deg);
        }
        
        /* Other timeframe buttons (vertical list below) */
        .sidebar-timeframe-btn {
            background: transparent;
            border: none;
            color: #a0aec0;
            font-size: 11px;
            font-weight: 600;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.15s ease;
            width: 34px;
            height: 34px;
            min-width: 34px;
            min-height: 34px;
            max-width: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            cursor: default;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            box-shadow: none;
        }
        
        .sidebar-timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #a0aec0;
        }
        
        .sidebar-timeframe-btn.active {
            background: rgba(47, 114, 255, 0.25);
            color: #a0aec0;
        }
        
        .sidebar-timeframe-btn.active:hover {
            background: rgba(47, 114, 255, 0.35);
        }
        
        body.light-mode .sidebar-timeframe-btn {
            color: #1e1e1e;
            background: transparent;
        }
        
        body.light-mode .sidebar-timeframe-btn:hover {
            background: #ffffff !important;
            color: #000000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }
        
        body.light-mode .sidebar-timeframe-btn.active {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }
        
        body.light-mode .sidebar-current-timeframe {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }
        
        body.light-mode .sidebar-current-timeframe:hover {
            background: rgba(41, 98, 255, 0.25);
        }
        
        body.light-mode .sidebar-timeframe-arrow {
            color: #787b86;
        }
        
        body.light-mode .sidebar-timeframe-arrow:hover {
            color: #050028;
        }
        
        #undoBtn, #redoBtn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            min-height: 34px;
        }
        
        #undoBtn svg, #redoBtn svg {
            width: 18px;
            height: 18px;
        }
        
        #undoBtn {
            margin-top: 0px;
        }
        

        html, body {
            min-width: 600px;
            min-height: 400px;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #050028;
            color: #ffffff;
        }

        /* Light Mode Styles */
        body.light-mode {
            background: #f8f9fa;
            color: #1e1e1e;
        }
        
        body.light-mode .toolbar {
            background: #f0f3fa;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: none;
        }
        
        body.light-mode .toolbar-icon-btn,
        body.light-mode .toolbar-icon-btn-dark,
        body.light-mode .toolbar-icon-btn-light {
            color: #1e1e1e;
        }
        
        body.light-mode .toolbar-icon-btn:hover,
        body.light-mode .toolbar-icon-btn-dark:hover,
        body.light-mode .toolbar-icon-btn-light:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        
        /* Timeframe buttons */
        body.light-mode .timeframe-btn {
            color: #1e1e1e;
        }
        
        body.light-mode .timeframe-btn:hover {
            color: #000000;
            background: rgba(0, 0, 0, 0.08);
        }
        
        body.light-mode .timeframe-btn.active {
            background: rgba(58, 153, 237, 0.2);
            color: #7c3aed;
        }
        
        body.light-mode .timeframe-selector#timeframeDropdown {
            background: rgba(0, 0, 0, 0.04);
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .timeframe-selector#timeframeDropdown:hover {
            background: rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 0, 0, 0.15);
        }
        
        body.light-mode .timeframe-selector .timeframe-label {
            color: #050028;
        }
        
        body.light-mode .timeframe-dropdown-trigger {
            color: #787b86;
        }
        
        body.light-mode .timeframe-selector#timeframeDropdown:hover .timeframe-dropdown-trigger {
            color: #050028;
        }
        
        body.light-mode .timeframe-dropdown-trigger {
            color: #050028;
        }
        
        body.light-mode .timeframe-dropdown-trigger:hover {
            color: #000000;
            background: rgba(0, 0, 0, 0.08) !important;
        }
        
        body.light-mode .timeframe-dropdown.open .timeframe-dropdown-trigger {
            background: rgba(0, 0, 0, 0.12) !important;
            color: #000000;
        }
        
        /* Timeframe Dropdown Menu - Light Mode */
        body.light-mode .timeframe-dropdown-menu,
        body.light-mode #timeframeDropdownMenu {
            background: #ffffff !important;
            border: 1px solid #e0e3eb !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }
        
        body.light-mode .timeframe-dropdown-section {
            border-bottom-color: #e0e3eb;
            background: #ffffff !important;
        }
        
        body.light-mode .timeframe-dropdown-section-header {
            color: #787b86;
            background: #f5f7fa !important;
        }
        
        body.light-mode .timeframe-dropdown-section-header:hover {
            background: #e8ecf1 !important;
        }
        
        body.light-mode .timeframe-dropdown-section-header svg {
            color: #787b86;
        }
        
        body.light-mode .timeframe-dropdown-item {
            color: #050028;
            background: #ffffff;
        }
        
        body.light-mode .timeframe-dropdown-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .timeframe-dropdown-item.selected {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }
        
        body.light-mode .timeframe-dropdown-item-star {
            color: #787b86;
        }
        
        body.light-mode .timeframe-dropdown-item-star:hover,
        body.light-mode .timeframe-dropdown-item-star.active {
            color: #f59e0b;
        }
        
        body.light-mode .timeframe-custom-section {
            border-top-color: #e0e3eb;
        }
        
        body.light-mode .right-sidebar,
        body.light-mode .right-sidebar-icons {
            background: #f0f3fa;
            border: none;
            border-right: 1px solid #f0f3fa!important;
            outline: none !important;
        }

        body.light-mode .right-sidebar-bottom {
            background: transparent;
            border-top: none;
        }
        
        body.light-mode .right-sidebar-icons {
            outline: none !important;
        }
        
        body.light-mode .right-sidebar-icon-btn {
            color: #1e1e1e;
            transition: all 0.15s ease;
            border-radius: 4px;
        }
        
        body.light-mode .right-sidebar-icon-btn:hover {
            background: #ffffff !important;
            color: #000000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }
        
        body.light-mode .right-sidebar-icon-btn.active {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }
        
        body.light-mode .sidebar-timeframe-btn,
        body.light-mode .sidebar-current-timeframe {
            box-shadow: none !important;
            transition: all 0.15s ease;
            outline: none !important;
            border-radius: 4px;
        }
        
        body.light-mode .chart-container {
            background: #ffffff;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        body.light-mode #chart-container,
        body.light-mode #chart-container canvas,
        body.light-mode #chart-container * {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* Left Sidebar / Drawing Tools */
        body.light-mode .left-sidebar {
            background: #f0f3fa !important;
            border-right: 1px solid #e0e3eb !important;
        }
        body.light-mode .drawing-toolbar {
            background: #f0f3fa;
            border-right: 1px solid #e0e3eb;
            box-shadow: none;
        }
        
        body.light-mode .drawing-tools-vertical .tool-btn,
        body.light-mode .tool-group-btn {
            color: #050028;
        }
        
        body.light-mode .drawing-tools-vertical .tool-btn:hover,
        body.light-mode .tool-group-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #000000;
        }
        
        body.light-mode .drawing-tools-vertical .tool-btn.active,
        body.light-mode .tool-group-btn.active {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
            box-shadow: none;
        }
        
        /* Symbol Plus Buttons (Compare & Watchlist) - Light Mode */
        body.light-mode .symbol-plus-btn {
            color: #050028;
        }
        
        body.light-mode .symbol-plus-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #000000;
        }
        
        /* Tool Dropdowns - Light Mode */
        body.light-mode .tool-dropdown {
            background: #ffffff;
            border: 1px solid #e0e3eb;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        body.light-mode .tool-dropdown .tool-btn {
            color: #050028;
            border-bottom-color: #e0e3eb;
        }
        
        body.light-mode .tool-dropdown .tool-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #000000;
        }
        
        body.light-mode .tool-dropdown .tool-btn.active {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }
        
        body.light-mode .tool-label {
            color: #050028;
        }
        
        body.light-mode .tool-btn-with-label:hover .tool-label {
            color: #000000;
        }
        
        body.light-mode .tool-dropdown-label {
            color: #787b86;
        }
        
        body.light-mode .drawing-tool-btn {
            color: #1e1e1e;
        }
        
        body.light-mode .drawing-tool-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        
        /* Panels */
        body.light-mode .unified-right-panel,
        body.light-mode .right-sidebar-panel {
            background: #f0f3fa;
            border-left: 1px solid #e0e0e0;
        }
        
        body.light-mode .unified-panel-header {
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            color: #1e1e1e;
        }
        
        body.light-mode .unified-panel-header h2 {
            color: #1e1e1e;
        }
        
        /* Watchlist - Light Mode */
        body.light-mode .watchlist-header {
            border-bottom-color: #e0e0e0;
            color: #1e1e1e;
        }
        
        body.light-mode .watchlist-symbol-name {
            color: #1e1e1e;
        }
        
        body.light-mode .watchlist-price {
            color: #1e1e1e;
        }
        
        body.light-mode .watchlist-price .decimals {
            color: #666666;
        }
        
        body.light-mode .watchlist-item {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .watchlist-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* News Panel - Light Mode */
        body.light-mode .news-header {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .news-header h2 {
            color: #1e1e1e;
        }
        
        body.light-mode .news-header-btn {
            color: #666666;
        }
        
        body.light-mode .news-header-btn:hover {
            color: #1e1e1e;
        }
        
        body.light-mode .news-search input {
            background: #f5f5f5;
            border-color: #e0e0e0;
            color: #1e1e1e;
        }
        
        body.light-mode .news-search input::placeholder {
            color: #999999;
        }
        
        body.light-mode .news-tabs {
            background: #f5f5f5;
        }
        
        body.light-mode .news-tab {
            color: #666666;
        }
        
        body.light-mode .news-tab:hover:not(.active) {
            color: #1e1e1e;
        }
        
        body.light-mode .news-item {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .news-time {
            color: #1e1e1e;
        }
        
        body.light-mode .news-title {
            color: #1e1e1e;
        }
        
        body.light-mode .news-currency {
            color: #666666;
        }
        
        body.light-mode .news-details {
            color: #666666;
        }
        
        /* Clock Panel - Light Mode */
        body.light-mode .clock-display {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .clock-time {
            color: #1e1e1e;
        }
        
        body.light-mode .clock-date {
            color: #666666;
        }
        
        body.light-mode .clock-timezone-label {
            color: #7c3aed;
        }
        
        body.light-mode .clock-candle-label {
            color: #9ca3af;
        }
        
        body.light-mode .clock-timezones {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .timezone-item {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .timezone-name {
            color: #666666;
        }
        
        body.light-mode .timezone-time {
            color: #1e1e1e;
        }
        
        body.light-mode .session-title {
            color: #666666;
        }
        
        body.light-mode .session-item {
            border-bottom-color: #e0e0e0;
        }
        
        body.light-mode .session-name {
            color: #1e1e1e;
        }
        
        body.light-mode .session-hours {
            color: #666666;
        }
        
        /* Bottom Panels */
        body.light-mode .bottom-panel,
        body.light-mode .trade-panel,
        body.light-mode .backtest-panel,
        body.light-mode .replay-toolbar,
        body.light-mode .replay-control-bar {
            background: #f0f3fa;
            border-top: 1px solid #e0e0e0;
            box-shadow: none;
        }
        
        body.light-mode .panel-tabs {
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }
        
        body.light-mode .panel-tab {
            color: #666666;
        }
        
        body.light-mode .panel-tab.active {
            color: #1e1e1e;
            background: #ffffff;
        }
        
        /* Replay Toolbar */
        body.light-mode .replay-toolbar {
            background: #f0f3fa;
            border-top: 1px solid #e0e0e0;
        }
        
        body.light-mode .replay-toolbar::before {
            background: none;
        }
        
        body.light-mode .replay-toolbar-bar {
            background: #f5f5f5;
        }
        
        body.light-mode .replay-toolbar button,
        body.light-mode .replay-toolbar select {
            background: transparent;
            color: #050028;
            border: none;
        }
        
        body.light-mode .replay-toolbar button:hover:not(.speed-clone-close-btn),
        body.light-mode .replay-toolbar select:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #000000;
        }
        
        body.light-mode .replay-toolbar button.replay-primary {
            background: #050028;
            color: #ffffff;
        }
        
        body.light-mode .replay-toolbar button.replay-danger {
            background: rgba(220, 38, 38, 0.15);
            color: #dc2626;
            border-color: rgba(220, 38, 38, 0.3);
        }
        
        body.light-mode .replay-toolbar-divider {
            background: #d0d0d0;
        }
        
        body.light-mode .replay-compact-meta {
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
        }
        
        body.light-mode .replay-datetime-display {
            border-radius: 6px;
            cursor: pointer;
        }
        
        body.light-mode .replay-datetime-display:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        
        body.light-mode .replay-datetime-icon {
            color: #64748b;
        }
        
        body.light-mode .replay-datetime-value {
            color: #1e1e1e;
        }
        
        body.light-mode .replay-toolbar .balance-display,
        body.light-mode .replay-toolbar .realized-display,
        body.light-mode .replay-toolbar span,
        body.light-mode .replay-toolbar label,
        body.light-mode .replay-compact-meta span {
            color: #1e1e1e;
        }
        
        body.light-mode .speed-label {
            color: #1e1e1e;
        }
        
        /* Speed Slider - Light Mode */
        body.light-mode .speed-slider-control {
            background: transparent;
            border: none;
        }
        
        body.light-mode .speed-slider-control.detached {
            background: rgba(248, 250, 255, 0.98);
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        }
        
        body.light-mode .speed-slider-control.detached .speed-drag-handle {
            color: #6b7280;
        }
        
        body.light-mode .speed-slider-control.detached .speed-slider-play-btn {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #374151;
            box-shadow: none;
        }
        
        body.light-mode .speed-slider-label {
            color: #374151;
        }
        
        body.light-mode .speed-slider-label .speed-value {
            color: #1e1e1e;
        }
        
        body.light-mode .speed-slider-label .speed-rate {
            color: rgba(55, 65, 81, 0.7);
        }
        
        body.light-mode .speed-slider-custom {
            background: #e0e3eb;
        }
        
        body.light-mode .speed-slider-custom-fill {
            background: #787b86;
        }
        
        body.light-mode .speed-slider-custom-thumb {
            background: #050028;
            box-shadow: none;
        }
        
        body.light-mode .speed-slider-ticks .tick {
            background: #d1d5db;
        }
        
        body.light-mode .speed-drag-handle {
            color: rgba(55, 65, 81, 0.4);
        }
        
        body.light-mode .speed-drag-handle:hover {
            color: rgba(55, 65, 81, 0.7);
            background: rgba(120, 136, 182, 0.15);
        }
        
        body.light-mode .speed-icon-btn {
            color: rgba(55, 65, 81, 0.6);
            background: rgba(120, 136, 182, 0.1);
            border-color: rgba(120, 136, 182, 0.2);
        }
        
        body.light-mode .speed-icon-btn:hover {
            color: #1e1e1e;
            background: rgba(120, 136, 182, 0.2);
            border-color: rgba(120, 136, 182, 0.3);
        }
        
        /* Replay Tabs Panels - Light Mode */
        body.light-mode .replay-tabs-container {
            background: #050028;
            border: 1px solid rgba(120, 136, 182, 0.3);
            color: #0f172a;
            box-shadow: 0 4px 24px rgba(99, 102, 241, 0.08);
        }
        
        body.light-mode .replay-tabs-container::before {
            border: 1px solid rgba(124, 58, 237, 0.16);
        }
        
        body.light-mode .replay-tabs-nav {
            border-bottom-color: rgba(120, 136, 182, 0.2);
        }
        
        body.light-mode .replay-tab-btn {
            color: rgba(71, 85, 105, 0.85);
            background: rgba(255, 255, 255, 0.5);
        }
        
        body.light-mode .replay-tab-btn:hover {
            color: #1e293b;
            background: rgba(255, 255, 255, 0.75);
            border-color: rgba(124, 58, 237, 0.2);
        }
        
        body.light-mode .replay-tab-btn.active {
            background: #ffffff;
            color: #7c3aed;
            border-color: rgba(124, 58, 237, 0.3);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.15), inset 0 -2px 0 0 #7c3aed;
        }
        
        body.light-mode .replay-tabs-body {
            background: #ffffff;
            border: 1px solid rgba(120, 136, 182, 0.2);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.04), inset 0 0 0 1px rgba(148, 163, 184, 0.06);
        }
        
        body.light-mode .replay-tab-scroller {
            border: 1px solid rgba(226, 232, 240, 0.5);
        }
        
        body.light-mode .replay-tab-scroller::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
        }
        
        body.light-mode .replay-tab-scroller::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.3);
        }
        
        body.light-mode .replay-tab-scroller::-webkit-scrollbar-thumb:hover {
            background: rgba(124, 58, 237, 0.5);
        }
        
        body.light-mode .replay-tab-empty {
            color: rgba(59, 72, 114, 0.75);
            border: 1px dashed rgba(148, 163, 184, 0.45);
            background: rgba(248, 250, 255, 0.7);
        }
        
        body.light-mode .replay-tab-table {
            color: #1e293b;
        }
        
        body.light-mode .replay-tab-table thead {
            background: #050028;
        }
        
        body.light-mode .replay-tab-table th,
        body.light-mode .replay-tab-table td {
            border-bottom: 1px solid rgba(226, 232, 240, 0.7);
        }
        
        body.light-mode .replay-tab-table th {
            color: rgba(71, 85, 105, 0.85);
            border-bottom: 2px solid rgba(120, 136, 182, 0.25);
        }
        
        body.light-mode .replay-tab-table tbody tr:hover {
            background: rgba(241, 245, 255, 0.7);
        }
        
        body.light-mode .replay-tabs-meta {
            color: rgba(59, 72, 114, 0.85);
            background: #050028;
            border: 1px solid rgba(120, 136, 182, 0.15);
        }
        
        body.light-mode .replay-meta-item .label {
            color: rgba(71, 85, 105, 0.75);
        }
        
        body.light-mode .replay-meta-item .value {
            color: #1e293b;
        }
        
        body.light-mode .replay-section-header {
            background: #050028;
            border-bottom: 2px solid rgba(124, 58, 237, 0.15);
        }
        
        body.light-mode .replay-section-title {
            color: #1e293b;
        }
        
        body.light-mode .replay-section-count {
            background: rgba(124, 58, 237, 0.15);
            color: #7c3aed;
        }
        
        /* Dropdowns and Menus */
        body.light-mode .chart-type-dropdown,
        body.light-mode .timeframe-dropdown,
        body.light-mode .symbol-switcher-dropdown,
        body.light-mode .help-dropdown-menu,
        body.light-mode .profile-dropdown-menu,
        body.light-mode .language-submenu {
            background: #ffffff;
            border: 1px solid #e0e3eb;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        /* Help Menu - Light Mode */
        body.light-mode .help-menu-item {
            color: #050028;
        }
        
        body.light-mode .help-menu-item:hover {
            background: rgba(41, 98, 255, 0.08);
            color: #000000;
        }
        
        body.light-mode .help-menu-item svg {
            color: #787b86;
        }
        
        body.light-mode .help-menu-item:hover svg {
            color: #050028;
        }
        
        body.light-mode .help-menu-footer {
            border-top-color: #e0e3eb;
            color: #787b86;
        }
        
        /* Profile Menu - Light Mode */
        body.light-mode .profile-menu-header {
            color: #787b86;
        }
        
        body.light-mode .profile-menu-item {
            color: #050028;
        }
        
        body.light-mode .profile-menu-item:hover {
            background: rgba(41, 98, 255, 0.08);
            color: #000000;
        }
        
        body.light-mode .profile-menu-item svg {
            color: #787b86;
        }
        
        body.light-mode .profile-menu-item:hover svg {
            color: #050028;
        }
        
        body.light-mode .profile-menu-value {
            color: #787b86;
        }
        
        body.light-mode .profile-menu-divider {
            background: #e0e3eb;
        }
        
        body.light-mode .language-item {
            color: #050028;
        }
        
        body.light-mode .language-item:hover {
            background: rgba(41, 98, 255, 0.08);
        }
        
        body.light-mode .chart-type-option,
        body.light-mode .timeframe-option,
        body.light-mode .symbol-switcher-item,
        body.light-mode .help-menu-item {
            color: #1e1e1e;
        }
        
        body.light-mode .chart-type-option:hover,
        body.light-mode .timeframe-option:hover,
        body.light-mode .symbol-switcher-item:hover,
        body.light-mode .help-menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* Settings Panel */
        body.light-mode .settings-panel {
            background: #ffffff;
            border-left: 1px solid #e0e0e0;
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .settings-panel-header {
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }
        
        body.light-mode .settings-panel-header h2 {
            color: #050028;
        }
        
        body.light-mode .settings-panel-close {
            color: #787b86;
        }
        
        body.light-mode .settings-panel-close:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #050028;
        }
        
        body.light-mode .settings-menu-item {
            color: #050028;
        }
        
        body.light-mode .settings-menu-item:hover {
            background: rgba(41, 98, 255, 0.08);
        }
        
        body.light-mode .settings-menu-item.active {
            background: rgba(41, 98, 255, 0.12);
        }
        
        body.light-mode .settings-menu-item svg {
            color: #787b86;
        }
        
        body.light-mode .settings-menu-item:hover svg,
        body.light-mode .settings-menu-item.active svg {
            color: #050028;
        }
        
        body.light-mode .settings-section-title {
            color: #787b86;
        }
        
        /* Light mode - Context Menu */
        body.light-mode .chart-context-menu {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
            color: #050028;
        }
        
        body.light-mode .context-menu-item {
            color: #050028;
        }
        
        body.light-mode .context-menu-item:hover {
            background: rgba(41, 98, 255, 0.12);
            color: #2962ff;
        }
        
        /* Light mode - Drawing Style Editor */
        body.light-mode .drawing-style-editor {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
            color: #050028;
        }
        
        body.light-mode .drawing-style-editor .settings-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        body.light-mode .drawing-style-editor .settings-header h3 {
            color: #050028;
        }
        
        body.light-mode .drawing-style-editor .settings-header .settings-close:hover {
            background: rgba(41, 98, 255, 0.12);
            color: #2962ff;
        }
        
        body.light-mode .drawing-style-editor label {
            color: #787b86;
        }
        
        /* Indicator Dropdown - Light Mode */
        body.light-mode .chart-settings-menu {
            background: #ffffff;
            border: 1px solid #e0e3eb;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        body.light-mode .settings-item {
            color: #050028;
        }
        
        body.light-mode .settings-item:hover {
            background: rgba(41, 98, 255, 0.08);
        }
        
        /* Indicator Settings Panel - Light Mode */
        body.light-mode #indicatorSettingsPanel {
            background: #ffffff !important;
            border-color: #e0e3eb !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        }
        
        body.light-mode #indicatorSettingsPanel .settings-section-title {
            color: #050028 !important;
        }
        
        body.light-mode #indicatorSettingsPanel label {
            color: #050028 !important;
        }
        
        body.light-mode #indicatorSettingsPanel input[type="number"],
        body.light-mode #indicatorSettingsPanel input[type="text"],
        body.light-mode #indicatorSettingsPanel select {
            background: #f5f5f5 !important;
            border-color: #e0e3eb !important;
            color: #050028 !important;
        }
        
        body.light-mode #indicatorSettingsPanel button {
            background: #f5f5f5;
            border-color: #e0e3eb;
            color: #050028;
        }
        
        body.light-mode #indicatorSettingsPanel button:hover {
            background: #e8e8e8;
        }
        
        body.light-mode #indicatorSettingsPanel button[style*="2962ff"],
        body.light-mode #indicatorSettingsPanel button[style*="background: #2962ff"] {
            background: #2962ff !important;
            color: #ffffff !important;
        }
        
        body.light-mode #indicatorSettingsBackdrop {
            background: rgba(255, 255, 255, 0.5) !important;
        }
        
        body.light-mode .indicator-color-value {
            color: #050028 !important;
        }
        
        body.light-mode .indicator-color-palette {
            background: #ffffff !important;
            border: 1px solid #e0e3eb;
        }
        
        /* Help Modal Styles */
        #helpModalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            backdrop-filter: blur(2px);
        }
        
        .help-modal {
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #363a45;
        }
        
        .help-modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .help-modal-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: default;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s;
        }
        
        .help-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .help-modal-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .help-modal-section {
            margin-bottom: 20px;
        }
        
        .help-modal-section:last-child {
            margin-bottom: 0;
        }
        
        .help-modal-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2962ff;
        }
        
        .help-modal-section p {
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            color: #9aa3c2;
        }
        
        /* Help Modal - Light Mode */
        body.light-mode #helpModalOverlay {
            background: rgba(255, 255, 255, 0.6);
        }
        
        body.light-mode .help-modal {
            background: #ffffff;
            border-color: #e0e3eb;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        body.light-mode .help-modal-header {
            border-color: #e0e3eb;
        }
        
        body.light-mode .help-modal-header h2 {
            color: #050028;
        }
        
        body.light-mode .help-modal-close:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #050028;
        }
        
        body.light-mode .help-modal-section h3 {
            color: #2962ff;
        }
        
        body.light-mode .help-modal-section p {
            color: #4a5568;
        }
        
        body.light-mode .settings-back-btn {
            color: #787b86;
        }
        
        body.light-mode .settings-back-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #050028;
        }
        
        body.light-mode .settings-radio-item {
            border-color: #e0e3eb;
        }
        
        body.light-mode .settings-radio-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }
        
        body.light-mode .settings-radio-item.selected {
            border-color: #2962ff;
            background: rgba(41, 98, 255, 0.06);
        }
        
        body.light-mode .settings-radio-content h4 {
            color: #050028;
        }
        
        body.light-mode .settings-radio-content p {
            color: #787b86;
        }
        
        body.light-mode .settings-checkbox-label {
            color: #050028;
        }
        
        body.light-mode .settings-label {
            color: #666666;
        }
        
        body.light-mode .settings-slider {
            background: #e0e3eb;
        }
        
        /* Inputs and Selects */
        body.light-mode input,
        body.light-mode select,
        body.light-mode textarea {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            color: #1e1e1e;
        }
        
        body.light-mode input:focus,
        body.light-mode select:focus,
        body.light-mode textarea:focus {
            border-color: #2962ff;
        }
        
        /* Dividers - Unified Light Mode */
        body.light-mode .divider,
        body.light-mode .toolbar-divider,
        body.light-mode .tool-divider,
        body.light-mode .symbol-divider {
            background: rgba(0, 0, 0, 0.12);
        }
        
        /* Symbol Display */
        body.light-mode .symbol-display {
            color: #1e1e1e;
        }
        
        /* OHLC Info */
        body.light-mode .ohlc-info {
            background: transparent;
            color: #1e1e1e;
        }
        
        body.light-mode .ohlc-symbol-block,
        body.light-mode .ohlc-separator,
        body.light-mode .ohlc-stats,
        body.light-mode .ohlc-label,
        body.light-mode .ohlc-value,
        body.light-mode .ohlc-value.up,
        body.light-mode .ohlc-value.down,
        body.light-mode .ohlc-change,
        body.light-mode .ohlc-change.positive,
        body.light-mode .ohlc-change.negative,
        body.light-mode .ohlc-volume-line,
        body.light-mode .volume-value {
            color: #050028;
        }
        
        body.light-mode .ohlc-change,
        body.light-mode .ohlc-change.positive,
        body.light-mode .ohlc-change.negative {
            background: rgba(2, 192, 118, 0.15);
        }
        
        /* Scrollbars */
        body.light-mode ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        
        body.light-mode ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
        }
        
        body.light-mode ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

:root {
    --replay-toolbar-bar-height: 20px;
    --replay-toolbar-tabs-height: 152px;
    --replay-toolbar-spacing: 20px;
    --replay-toolbar-collapsed-spacing: 2px;
    --replay-toolbar-height: calc(var(--replay-toolbar-bar-height) + var(--replay-toolbar-tabs-height) + var(--replay-toolbar-spacing));
}

        /* Toolbar Styles - TradingView Style */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px 8px;
            background: #050028;
            border-bottom: 1px solid rgba(50, 50, 60, 0.9);
            color: #d1d5db;
            height: 48px;
            gap: 6px;
            user-select: none;
            z-index: 150;
        }

        .container {
            position: fixed;
            top: 48px;
            left: 0;
            right: 0;
            bottom: 230px;
            background: #050028;
            transition: bottom 0.3s ease;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            flex-wrap: nowrap;
            overflow: visible;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            user-select: none;
            -webkit-user-select: none;
        }

        .toolbar-left::-webkit-scrollbar {
            height: 0;
            display: none;
        }

        .toolbar-left::-webkit-scrollbar-track {
            background: transparent;
        }

        .toolbar-left::-webkit-scrollbar-thumb {
            background: rgba(70, 70, 70, 0.6);
            border-radius: 3px;
        }

        .toolbar-left::-webkit-scrollbar-thumb:hover {
            background: rgba(110, 110, 110, 0.7);
        }

        .toolbar-left > * {
            flex-shrink: 0;
        }

        /* Ensure tool-group in toolbar has same visual width as standalone buttons */
        .toolbar-left .tool-group {
            width: auto;
            min-width: 34px;
        }
        
        .toolbar-left .tool-group-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
        }

        .replay-mode-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 14px;
            background: rgba(37, 47, 69, 0.75);
            border: 1px solid rgba(90, 111, 154, 0.5);
            color: #ffffff;
            cursor: default;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .replay-mode-btn:hover {
            background: rgba(105, 73, 255, 0.2);
            border-color: rgba(124, 58, 237, 0.55);
            color: #ffffff;
        }

        .replay-mode-btn.active {
            background: rgba(124, 58, 237, 0.3);
            border-color: rgba(124, 58, 237, 0.9);
            color: #ffffff;
            box-shadow: 0 6px 18px rgba(124, 58, 237, 0.2);
        }

        .replay-mode-btn svg {
            width: 14px;
            height: 14px;
            stroke-width: 2;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            -webkit-user-select: none;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Drawing Tools Section in Main Toolbar */
        .toolbar-drawing-tools {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0 8px;
            height: 100%;
        }

        .toolbar-drawing-tools .tool-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .toolbar-drawing-tools .tool-group-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            border: none;
            background: transparent;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.15s ease;
            border-radius: 4px;
        }

        .toolbar-drawing-tools .tool-group-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #a0aec0;
        }

        .toolbar-drawing-tools .tool-group-btn.active {
            background: rgba(41, 98, 255, 0.2);
            color: #a0aec0;
        }

        .toolbar-drawing-tools .tool-group-btn svg {
            width: 18px;
            height: 18px;
        }

        .toolbar-drawing-tools .toolbar-tool-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            border: none;
            background: transparent;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.15s ease;
            border-radius: 4px;
            padding: 0;
        }


        .toolbar-drawing-tools .toolbar-tool-btn svg {
            width: 18px;
            height: 18px;
        }

        .toolbar-divider {
            width: 1px;
            height: 20px;
            background: rgba(120, 123, 134, 0.3);
            margin: 0 8px;
            border-radius: 1px;
        }

        /* Dropdowns for toolbar drawing tools */
        .toolbar-drawing-tools .tool-dropdown {
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 8px;
            background: #050028;
            border: 1px solid rgba(50, 50, 60, 0.9);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            min-width: 160px;
            z-index: 10000;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .toolbar-drawing-tools .tool-dropdown.show {
            display: flex;
        }

        /* New Order Button - Blue */
        .new-order-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 28px;
            padding: 0 12px;
            background: #2962FF;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            font-size: 11px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
        }

        .new-order-btn:hover {
            background: #1e4fd9;
        }

        .new-order-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Screenshot Dropdown Styles */
        .screenshot-dropdown-container {
            position: relative;
        }

        .screenshot-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 220px;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: none;
            overflow: hidden;
        }

        .screenshot-dropdown-menu.open {
            display: block;
        }

        .screenshot-dropdown-header {
            padding: 12px 16px 8px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #363a45;
        }

        .screenshot-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: default;
            transition: background 0.15s ease;
            color: #ffffff;
            font-size: 13px;
        }

        .screenshot-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .screenshot-dropdown-item svg {
            width: 18px;
            height: 18px;
            color: #ffffff;
            flex-shrink: 0;
        }

        .screenshot-dropdown-item span:first-of-type {
            flex: 1;
        }

        .screenshot-shortcut {
            font-size: 11px;
            color: #787b86;
            font-family: system-ui, -apple-system, sans-serif;
        }

        /* Screenshot Dropdown - Light Mode */
        body.light-mode .screenshot-dropdown-menu {
            background: #ffffff;
            border-color: #e0e3eb;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        body.light-mode .screenshot-dropdown-header {
            color: #787b86;
            border-color: #e0e3eb;
        }

        body.light-mode .screenshot-dropdown-item {
            color: #050028;
        }

        body.light-mode .screenshot-dropdown-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .screenshot-dropdown-item svg {
            color: #787b86;
        }

        /* Layout Selector Button - Dark */
        .layout-selector-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 6px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
        }

        .layout-selector-btn:hover {
            background: #2a2e39;
            border-color: #434651;
        }

        .layout-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            color: #ffffff;
        }

        .layout-checkbox svg {
            width: 14px;
            height: 14px;
        }

        /* Toolbar Icon Group - Dark Background */
        .toolbar-icon-group {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 6px;
        }

        .toolbar-icon-btn-dark {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border: none;
            background: transparent;
            color: #a0aec0;
            cursor: default;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .toolbar-icon-btn-dark:hover {
            background: rgba(42, 46, 57, 0.85);
            color: #a0aec0;
        }

        .toolbar-icon-btn-dark svg {
            width: 18px;
            height: 18px;
        }

        /* Layout Button - Standalone with blue border */
        .layout-btn {
            width: 34px;
            height: 34px;
            border: 2px solid #2962FF;
            border-radius: 8px;
            background: rgba(5, 0, 40, 0.95);
        }


        .layout-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Layout Selector - Light Mode */
        body.light-mode .layout-selector-btn {
            background: #ffffff;
            border-color: #e0e3eb;
            color: #050028;
        }

        body.light-mode .layout-selector-btn:hover {
            background: #f5f5f5;
            border-color: #d0d0d0;
        }

        body.light-mode .layout-checkbox {
            color: #787b86;
        }

        body.light-mode .toolbar-icon-group {
            background: #f0f3fa;
            border-color: #e0e3eb;
        }

        body.light-mode .toolbar-icon-btn-dark {
            color: #1e1e1e;
        }

        body.light-mode .toolbar-icon-btn-dark:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #050028;
        }

        body.light-mode .layout-btn {
            background: rgba(255, 255, 255, 0.95);
            border-color: #2962FF;
        }

        body.light-mode .layout-btn:hover {
            background: rgba(41, 98, 255, 0.1);
        }

        /* Help Button - Light Circle */
        .toolbar-icon-btn-light {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border: 1px solid #363a45;
            background: transparent;
            color: #a0aec0;
            cursor: default;
            border-radius: 50%;
            transition: all 0.15s ease;
        }


        .toolbar-icon-btn-light svg {
            width: 18px;
            height: 18px;
        }

        /* Help Menu Container */
        .help-menu-container {
            position: static;
        }

        .help-dropdown-menu {
            position: fixed;
            top: 50px;
            right: 100px;
            width: 280px;
            background: rgba(5, 0, 40, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(63, 84, 124, 0.35);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            z-index: 999999;
            display: none;
            overflow: visible;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .help-dropdown-menu.open {
            display: block;
        }

        .help-menu-header {
            padding: 16px 20px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #2962ff;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .help-menu-items {
            padding: 0 8px 8px;
        }

        .help-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 14px;
            border-radius: 8px;
            cursor: default;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .help-menu-item:hover {
            background: rgba(41, 98, 255, 0.12);
            color: #fff;
        }

        .help-menu-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: #ffffff;
        }

        .help-menu-item:hover svg {
            color: #ffffff;
        }

        .help-menu-item span:first-of-type {
            flex: 1;
        }

        .help-menu-badge {
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .help-menu-footer {
            padding: 12px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 12px;
            color: #787b86;
        }

        /* Profile Menu Container */
        .profile-menu-container {
            position: static;
        }

        .profile-dropdown-menu,
        .language-submenu {
            position: fixed;
            top: 50px;
            right: 60px;
            width: 280px;
            background: rgba(5, 0, 40, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(63, 84, 124, 0.35);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            z-index: 999999;
            display: none;
            overflow: visible;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .profile-dropdown-menu.open,
        .language-submenu.open {
            display: block;
        }

        .profile-menu-header {
            padding: 16px 20px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .profile-menu-items {
            padding: 0 8px 8px;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 8px;
            cursor: default;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .profile-menu-item:hover {
            background: rgba(41, 98, 255, 0.12);
            color: #fff;
        }

        .profile-menu-item.logout:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .profile-menu-item.logout:hover svg {
            color: #ef4444;
        }

        .profile-menu-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: #ffffff;
        }

        .profile-menu-item .chevron-icon {
            width: 16px;
            height: 16px;
            margin-left: auto;
        }

        .profile-menu-item:hover svg {
            color: #ffffff;
        }

        .profile-menu-item span:first-of-type {
            flex: 1;
        }

        .profile-menu-value {
            font-size: 12px;
            color: #787b86;
            margin-left: auto;
        }

        .profile-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.06);
            
        }

        /* Language Submenu */
        .language-submenu-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        .language-back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255, 255, 255, 0.06);
            color: #ffffff;
            border-radius: 6px;
            cursor: default;
            transition: all 0.15s ease;
        }

        .language-back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .language-back-btn svg {
            width: 16px;
            height: 16px;
        }

        .language-options {
            padding: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: default;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .language-option:hover {
            background: rgba(41, 98, 255, 0.12);
        }

        .language-option.selected {
            background: rgba(41, 98, 255, 0.15);
            color: #fff;
        }

        .language-option .check-icon {
            width: 16px;
            height: 16px;
            margin-left: auto;
            color: #2962ff;
        }

        /*  Settings Panel  two-column layout  */
        .settings-panel {
            position: fixed;
            top: 48px;
            right: -440px;
            width: 420px;
            background: #050028;
            border-left: 1px solid rgba(255,255,255,0.07);
            z-index: 1000010;
            display: flex;
            flex-direction: row;
            transition: right 0.28s cubic-bezier(.4,0,.2,1);
            box-shadow: -8px 0 40px rgba(0,0,0,0.6);
        }
        .settings-panel.open { right: 0; }

        /* Left nav sidebar */
        .sp-sidebar {
            width: 130px;
            min-width: 130px;
            background: #04001f;
            border-right: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sp-sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 20px 16px 16px;
            color: #e0e3ea;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.02em;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .sp-sidebar-header svg { color: #2962ff; flex-shrink: 0; }

        .sp-nav { padding: 10px 8px; display: flex; flex-direction: column; gap: 2px; }
        .sp-nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: #787b86;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.15s, color 0.15s;
            user-select: none;
        }
        .sp-nav-item:hover { background: rgba(255,255,255,0.05); color: #d1d5db; }
        .sp-nav-item.active { background: rgba(41,98,255,0.18); color: #fff; }
        .sp-nav-item.active svg { color: #2962ff; }
        .sp-nav-item svg { flex-shrink: 0; color: #555a6e; transition: color 0.15s; }

        /* Right content area */
        .sp-content-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sp-content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }
        #spContentTitle {
            font-size: 15px;
            font-weight: 700;
            color: #e0e3ea;
            letter-spacing: 0.01em;
        }
        .sp-close-btn {
            display: flex; align-items: center; justify-content: center;
            width: 30px; height: 30px;
            border: none; background: transparent;
            color: #787b86; cursor: pointer; border-radius: 6px;
            transition: background 0.15s, color 0.15s;
        }
        .sp-close-btn:hover { background: rgba(255,255,255,0.07); color: #fff; }

        .sp-content-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }
        .sp-content-body .sp-embedded { margin: -20px -24px; }
        .sp-content-body .sp-embedded .side-panel-item { padding: 14px 24px; }
        .sp-content-body .sp-embedded .side-panel-footer { padding: 14px 24px; }
        .sp-content-body::-webkit-scrollbar { width: 4px; }
        .sp-content-body::-webkit-scrollbar-track { background: transparent; }
        .sp-content-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        /*  Generic Side Panels (Notifications, Help, Profile)  */
        .side-panel {
            position: fixed;
            top: 48px;
            right: -440px;
            width: 420px;
            height: calc(100vh - 48px);
            background: #0a0a1a;
            border-left: 1px solid rgba(255,255,255,0.07);
            z-index: 1000010;
            display: flex;
            flex-direction: column;
            transition: right 0.28s cubic-bezier(.4,0,.2,1);
            box-shadow: -8px 0 40px rgba(0,0,0,0.6);
        }
        .side-panel.open { right: 0; }
        .side-panel-title {
            font-size: 15px; font-weight: 700;
            color: #e0e3ea; letter-spacing: 0.01em;
        }
        .side-panel-body {
            flex: 1; overflow-y: auto; padding: 0;
        }
        .side-panel-body::-webkit-scrollbar { width: 4px; }
        .side-panel-body::-webkit-scrollbar-track { background: transparent; }
        .side-panel-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .side-panel-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 24px;
            cursor: pointer; color: #d1d4dc; font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            transition: background 0.15s; user-select: none;
        }
        .side-panel-item:hover { background: rgba(255,255,255,0.05); }
        .side-panel-item svg { width: 18px; height: 18px; color: #787b86; flex-shrink: 0; }
        .side-panel-item > span:first-of-type { flex: 1; }
        .side-panel-value { color: #787b86; font-size: 12px; }
        .side-panel-badge {
            background: #2962ff; color: #fff;
            border-radius: 10px; padding: 1px 8px;
            font-size: 11px; font-weight: 700;
        }
        .side-panel-item.sp-danger { color: #f23645; }
        .side-panel-item.sp-danger svg { color: #f23645; }
        .side-panel-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 4px 0; }
        .side-panel-footer {
            padding: 14px 24px; color: #555a6e; font-size: 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }

        /* Settings Content Styles */
        .settings-content-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 20px;
        }

        .settings-back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 14px;
            cursor: default;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .settings-back-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            color: #ffffff;
        }

        .settings-back-btn svg {
            width: 16px;
            height: 16px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .tv-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }
        .tv-row .settings-checkbox-item {
            flex: 1;
            margin: 0;
        }
        .tv-row .settings-input-row {
            margin: 0;
            flex-shrink: 0;
        }

        .settings-radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-radio-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            cursor: default;
            transition: all 0.15s ease;
        }

        .settings-radio-item:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .settings-radio-item.selected {
            border-color: #2962ff;
            background: rgba(41, 98, 255, 0.08);
        }

        .settings-radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #787b86;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .settings-radio-item.selected .settings-radio-circle {
            border-color: #2962ff;
        }

        .settings-radio-circle::after {
            content: '';
            width: 10px;
            height: 10px;
            background: #2962ff;
            border-radius: 50%;
            display: none;
        }

        .settings-radio-item.selected .settings-radio-circle::after {
            display: block;
        }

        .settings-radio-content h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
        }

        .settings-radio-content p {
            margin: 0;
            font-size: 12px;
            color: #787b86;
            line-height: 1.4;
        }

        .settings-checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            cursor: default;
        }

        .settings-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #787b86;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s ease;
        }

        .settings-checkbox-item.checked .settings-checkbox {
            background: #2962ff;
            border-color: #2962ff;
        }

        .settings-checkbox svg {
            width: 14px;
            height: 14px;
            color: white;
            display: none;
        }

        .settings-checkbox-item.checked .settings-checkbox svg {
            display: block;
        }

        .settings-checkbox-label {
            font-size: 14px;
            color: #ffffff;
        }

        .settings-slider-group {
            margin-top: 8px;
        }

        .settings-slider-label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .settings-slider {
            width: 100%;
            height: 4px;
            background: #2a2e39;
            border-radius: 2px;
            appearance: none;
            cursor: default;
        }

        .settings-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #2962ff;
            border-radius: 50%;
            cursor: default;
        }

        .settings-slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #787b86;
        }

        .settings-input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .settings-input-label {
            font-size: 14px;
            color: #ffffff;
        }

        .settings-input {
            width: 100px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
            text-align: center;
        }

        .settings-input:focus {
            outline: none;
            border-color: #2962ff;
        }

        /* Hide native spinner arrows */
        .settings-input[type="number"]::-webkit-inner-spin-button,
        .settings-input[type="number"]::-webkit-outer-spin-button,
        .tv-number-input::-webkit-inner-spin-button,
        .tv-number-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .settings-input[type="number"],
        .tv-number-input {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Custom spinner wrapper - unified single input */
        .number-input-wrapper {
            display: flex;
            align-items: stretch;
            background: #050028;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .number-input-wrapper .tv-number-input {
            border: none !important;
            background: transparent !important;
            border-radius: 0;
            width: 40px;
            padding: 4px 6px;
            font-size: 12px !important;
        }
        
        /* Custom spinner buttons container */
        .custom-spinner {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: transparent;
            border: none;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1px 4px;
            gap: 0;
            cursor: pointer;
        }
        
        .custom-spinner-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 10px;
            height: 8px;
            color: #787b86;
            transition: color 0.15s;
        }
        
        .custom-spinner-btn:hover {
            color: #ffffff;
        }
        
        .custom-spinner-btn svg {
            width: 6px;
            height: 6px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .settings-select {
            width: 140px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
            cursor: default;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23787b86' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .settings-select:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        /* Dark dropdown options */
        .tv-select,
        .settings-select {
            background-color: #000000 !important;
            color: #d1d4dc;
        }
        
        .tv-select option,
        .settings-select option {
            background-color: #000000;
            color: #d1d4dc;
            padding: 8px;
        }
        
        .tv-select option:hover,
        .settings-select option:hover,
        .tv-select option:checked,
        .settings-select option:checked {
            background-color: #2962ff;
            color: #ffffff;
        }

        /* Chart Type Selector - match tool-group pattern */
        .chart-type-selector {
            position: relative;
        }

        .chart-type-dropdown {
            display: none;
            flex-direction: column;
            gap: 2px;
            padding: 6px;
        }

        .chart-type-dropdown.show {
            display: flex;
        }

        .chart-type-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: default;
            color: #ffffff;
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .chart-type-option:hover {
            background: rgba(41, 98, 255, 0.12);
        }

        .chart-type-option.active {
            background: rgba(41, 98, 255, 0.18);
            color: #fff;
        }

        .chart-type-option svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Settings Panel Overlay */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }

        .settings-overlay.open {
            display: block;
        }

        /* Profile Avatar Button */
        .profile-avatar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            padding: 0;
            border: none;
            background: transparent;
            cursor: default;
            border-radius: 50%;
            overflow: hidden;
        }

        .avatar-circle {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #050028;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
        }

        .avatar-circle svg {
            width: 18px;
            height: 18px;
        }

        .market-overview {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        /* Symbol Picker */
        .symbol-timeframe-group {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 6px;
            min-height: 32px;
            border-radius: 16px;
            background: rgba(20, 20, 20, 0.65);
        }

        .symbol-timeframe-group::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            border: 1px solid rgba(70, 70, 70, 0.55);
            pointer-events: none;
        }

        .symbol-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            color: #e6e9f4;
            pointer-events: none;
        }

        .symbol-display {
            font-size: 14px;
            font-weight: 400;
            color: #f5f7ff;
            letter-spacing: 0.1px;
            text-transform: uppercase;
            pointer-events: none;
        }

        .session-mode-badge {
            display: none !important;
        }

        .session-mode-badge.standard {
            background: #050028;
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .session-mode-badge.propfirm {
            background: #050028;
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        /* Symbol Search Group - Clean Style */
        .symbol-search-group {
            display: flex;
            align-items: center;
            gap: 4px;
            
            cursor: default;
            transition: all 0.15s ease;
        }

        .symbol-search-group:hover {
            opacity: 0.8;
        }

        .symbol-search-icon {
            width: 14px;
            height: 14px;
            color: #ffffff;
            flex-shrink: 0;
        }

        .symbol-search-group .symbol-display {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: 0.3px;
        }

        .symbol-plus-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            min-width: 34px;
            max-width: 34px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #ffffff;
            cursor: default;
            transition: all 0.15s ease;
            padding: 0;
            margin-left: 4px;
            position: relative;
            overflow: visible;
            flex-shrink: 0;
        }

        .symbol-plus-btn:hover {
            background: rgba(42, 46, 57, 0.85);
            color: #ffffff;
        }

        .symbol-plus-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Symbol Switcher Dropdown */
        .symbol-switcher-dropdown {
            display: none;
            position: fixed;
            background: #050028;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            min-width: 420px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        
        .symbol-switcher-dropdown.open {
            display: block;
        }
        
        .symbol-switcher-header {
            padding: 10px 14px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .symbol-switcher-list {
            padding: 6px;
        }
        
        .symbol-switcher-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            transition: background 0.15s;
            color: #ffffff;
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .symbol-switcher-item:last-child {
            border-bottom: none;
        }
        
        .symbol-switcher-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .symbol-switcher-item.active {
            background: rgba(59, 130, 246, 0.15);
        }
        
        .symbol-switcher-item .symbol-icon {
            width: 28px;
            height: 28px;
            background: #050028;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        
        .symbol-switcher-item .symbol-name {
            flex: 1;
            font-weight: 500;
            min-width: 80px;
        }
        
        .symbol-switcher-item .symbol-check {
            color: #3b82f6;
            margin-left: auto;
        }
        
        /* Symbol Add Options - 3 buttons */
        .symbol-switcher-options {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }
        
        .symbol-switcher-option-btn {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(120, 123, 134, 0.3);
            border-radius: 4px;
            color: #787b86;
            font-size: 11px;
            cursor: default;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .symbol-switcher-option-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .symbol-switcher-empty {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 13px;
        }

        /* Toolbar Icon Buttons - Unified size */
        .toolbar-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            min-width: 34px;
            border-radius: 4px;
            background: transparent;
            border: none;
            color: #a0aec0;
            cursor: default;
            transition: all 0.15s ease;
            flex-shrink: 0;
            padding: 0;
            outline: none !important;
        }

        .toolbar-icon-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #a0aec0;
        }

        .toolbar-icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .toolbar-icon-btn.with-label {
            width: auto;
            padding: 0 12px;
            gap: 6px;
        }

        .toolbar-icon-btn.with-label span {
            font-size: 13px;
            font-weight: 500;
            color: inherit;
        }

        /* Cursor tool tooltip - show clearly below cursor button + arrow */
        #cursorTool {
            position: relative;
        }

        #cursorTool::after {
            content: attr(data-tooltip);
            position: absolute;
            
            left: 50%;
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid #363a45;
            z-index: 1000002; /* above the dropdown arrow */
        }

        #cursorTool:hover::after {
            opacity: 1;
        }

        /* Tooltip for indicators button only */
        #indicatorsBtn {
            position: relative;
        }

        #indicatorsBtn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid #363a45;
            z-index: 1000;
        }

        #indicatorsBtn:hover::after {
            opacity: 1;
        }

        /* Tooltip for chart type button */
        #chartTypeBtn {
            position: relative;
        }

        #chartTypeBtn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid #363a45;
            z-index: 1000;
        }

        #chartTypeBtn:hover::after {
            opacity: 1;
        }

        /* Tooltip for ruler button - position below like top toolbar buttons */
        #rulerTool {
            position: relative;
        }

        #rulerTool::after {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 4px);
            left: 50%;
            transform: translateX(-65%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid #363a45;
            z-index: 1000;
        }

        #rulerTool:hover::after {
            opacity: 1;
        }

        /* Tooltip for pin button - position below like ruler button */
        /* Tooltip for watchlist button in symbol selector */
        #symbolWatchlistBtn {
            position: relative;
        }

        #symbolWatchlistBtn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid #363a45;
            z-index: 1000;
        }

        #symbolWatchlistBtn:hover::after {
            opacity: 1;
        }

        /* Tooltip for visibility toolbar button */
        .tool-group-btn[data-group="visibility-toolbar"] {
            position: relative;
        }

        .tool-group-btn[data-group="visibility-toolbar"]::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: calc(100% + 4px);
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            border: 1px solid #363a45;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tool-group-btn[data-group="visibility-toolbar"]:hover::after {
            opacity: 1;
        }

        /* Tooltip for keep drawing mode button */
        #keepDrawingModeToolbar {
            position: relative;
        }

        #keepDrawingModeToolbar::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: calc(100% + 4px);
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            border: 1px solid #363a45;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        #keepDrawingModeToolbar:hover::after {
            opacity: 1;
        }
      
        
        /* Light mode - keep drawing button hover */
        body.light-mode #keepDrawingModeToolbar:hover {
            color: #1e1e1e !important;
        }
        

        /* Tooltip for delete toolbar button */
        .tool-group-btn[data-group="delete-toolbar"] {
            position: relative;
        }

        .tool-group-btn[data-group="delete-toolbar"]::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: calc(100% + 4px);
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            border: 1px solid #363a45;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tool-group-btn[data-group="delete-toolbar"]:hover::after {
            opacity: 1;
        }

        /* Inline Timeframe Group */
        .timeframe-inline-group {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .tf-btn {
            padding: 6px 10px;
            border: none;
            background: transparent;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: default;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .tf-btn:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.06);
        }

        .tf-btn.active {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.12);
        }

        .tf-dropdown-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 28px;
            border: none;
            background: transparent;
            color: #ffffff;
            cursor: default;
            border-radius: 4px;
            transition: all 0.15s ease;
            padding: 0;
        }

        .tf-dropdown-btn:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.06);
        }

        .tf-dropdown-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Divider */
        .divider {
            width: 1px;
            height: 28px;
            background: rgba(78, 91, 126, 0.45);
            margin: 0;
            border-radius: 1px;
        }

        /* First divider after logo - full height */
        .logo-link + .divider {
            height: 100%;
            align-self: stretch;
        }

        .symbol-plus-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            color: #d9deea;
            pointer-events: none;
        }

        .symbol-plus-icon svg {
            width: 14px;
            height: 14px;
            color: #d9deea;
        }

        .symbol-divider {
            width: 1px;
            height: 16px;
            background: rgba(120, 123, 134, 0.3);
            border-radius: 1px;
            pointer-events: none;
        }

        .symbol-timeframe-group select {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: default;
            border: none;
            background: transparent;
            appearance: none;
            -webkit-appearance: none;
            z-index: 1;
        }

        .price-tickets {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .price-ticket {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 6px 14px 8px;
            border-radius: 12px;
            min-width: 108px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
        }

        .price-ticket .price {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.3px;
        }

        .price-ticket .label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.4px;
            color: rgba(255, 255, 255, 0.75);
        }

        .price-ticket.sell {
            background: #050028;
            border: 1px solid rgba(235, 87, 87, 0.65);
        }

        .price-ticket.buy {
            background: #050028;
            border: 1px solid rgba(58, 113, 255, 0.65);
        }

        .timeframe-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 6px 4px 10px;
            border-radius: 16px;
            border: 1px solid rgba(63, 84, 124, 0.45);
            background: #050028;
            backdrop-filter: blur(6px);
        }

        .timeframe-favorites {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timeframe-favorites-empty {
            font-size: 11px;
            color: rgba(206, 214, 236, 0.65);
            white-space: nowrap;
        }

        .timeframe-btn {
            background: transparent;
            border: none;
            color: #d9deea;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: default;
            transition: all 0.15s ease;
        }

        .timeframe-dropdown-wrapper {
            position: relative;
        }

        .timeframe-dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: none;
            background: rgba(255, 255, 255, 0.06);
            cursor: default;
            color: rgba(206, 214, 236, 0.9);
            transition: background 0.15s ease, color 0.15s ease;
        }

        .timeframe-dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.12);
            color: #ffffff;
        }

        .timeframe-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            min-width: 220px;
            background: #121826;
            border-radius: 14px;
            box-shadow: 0 24px 64px rgba(8, 15, 35, 0.55);
            padding: 12px 0;
            display: none;
            z-index: 2200;
            border: 1px solid rgba(63, 84, 124, 0.35);
        }

        .timeframe-dropdown.open {
            display: block;
        }

        .timeframe-dropdown::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 18px;
            width: 12px;
            height: 12px;
            background: inherit;
            transform: rotate(45deg);
            border-left: 1px solid rgba(63, 84, 124, 0.35);
            border-top: 1px solid rgba(63, 84, 124, 0.35);
        }

        .timeframe-dropdown-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 0 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .timeframe-dropdown-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .timeframe-dropdown-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(148, 163, 184, 0.8);
            margin: 6px 0 2px;
        }

        .timeframe-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 10px;
            background: transparent;
            cursor: default;
            transition: background 0.15s ease;
        }

        .timeframe-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .timeframe-dropdown-item.active {
            background: rgba(124, 58, 237, 0.18);
            color: #ffffff;
        }

        .timeframe-dropdown-label {
            font-size: 12px;
            font-weight: 600;
        }

        .timeframe-dropdown-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeframe-star {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            color: rgba(203, 213, 225, 0.7);
            border-radius: 50%;
            transition: color 0.15s ease;
            cursor: default;
        }

        .timeframe-star:hover {
            color: #facc15;
        }

        .timeframe-star svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
        }

        .timeframe-star.active {
            color: #facc15;
        }

        .timeframe-star.active svg {
            fill: currentColor;
        }

        .timeframe-dropdown-footer {
            margin-top: 10px;
            padding: 8px 14px 0;
            font-size: 11px;
            color: rgba(148, 163, 184, 0.7);
            border-top: 1px solid rgba(63, 84, 124, 0.3);
        }

        /* OHLC Display */
        .ohlc-display {
            display: flex;
            align-items: center;
            gap: 1px;
            font-size: 12px;
            color: #000b2b;
            padding: 4px 8px;
        }

        .ohlc-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ohlc-label {
            color: #787b86;
            font-weight: 500;
        }

        .ohlc-value {
            font-weight: 600;
        }

        .ohlc-change {
            font-weight: 600;
        }

        .ohlc-change.positive {
            color: #089981;
        }

        .ohlc-change.negative {
            color: #f23645;
        }

        .volume-display {
            color: #787b86;
            font-size: 11px;
        }

        /* Modern Icon Buttons */
        .icon-btn {
            background: rgba(16, 16, 16, 0.96);
            color: #ffffff;
            border: 1px solid rgba(45, 45, 45, 0.7);
            border-radius: 8px;
            padding: 6px 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: default;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .icon-btn:hover {
            color: #ffffff;
            border-color: rgba(70, 70, 70, 0.85);
            background: rgba(26, 26, 26, 0.98);
        }

        .icon-btn:active {
            background: rgba(20, 20, 20, 0.98);
            transform: translateY(1px);
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .icon-btn-icon {
            background: transparent;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            width: 34px;
            height: 34px;
            cursor: default;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn-icon:hover {
            background: rgba(26, 26, 26, 0.98);
            color: #ffffff;
        }

        .icon-btn-icon svg {
            width: 18px;
            height: 18px;
        }

        .indicator-icon {
            color: #ffffff;
        }

        .indicator-icon svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.8;
        }

        .settings-icon {
            color: #ffffff;
        }

        .settings-icon svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.8;
        }

        .layout-icon {
            color: #ffffff;
        }

        .layout-icon svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.8;
        }

        .divider {
            width: 1px;
            height: 26px;
            background: rgba(120, 123, 134, 0.3);
            border-radius: 1px;
            margin: 0px;
            flex-shrink: 0;
        }

        /* Date Search - Modern Style */
        .date-search-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(21, 27, 36, 0.85);
            border: 1px solid rgba(45, 54, 74, 0.9);
            border-radius: 10px;
            transition: all 0.15s;
            color: #ffffff;
        }

        .date-search-wrapper:hover {
            background: rgba(30, 37, 52, 0.9);
            border-color: rgba(63, 75, 104, 0.9);
        }
        
        /* Disable wrapper hover for Go To control - only button hover */
        #goToControl.date-search-wrapper:hover {
            background: transparent;
            border-color: transparent;
        }

        .date-search-wrapper:focus-within {
            border-color: rgba(73, 104, 179, 0.9);
            background: rgba(30, 38, 54, 0.95);
            color: #e4e8f5;
        }

        .date-input {
            background: transparent;
            color: #e4e8f5;
            border: none;
            outline: none;
            padding: 0;
            font-size: 12px;
            font-weight: 600;
            width: 110px;
            cursor: default;
        }

        .date-input:disabled {
            color: rgba(154, 163, 194, 0.55);
            cursor: not-allowed;
        }

        .date-input::-webkit-calendar-picker-indicator {
            cursor: default;
            opacity: 0.6;
            filter: invert(1);
        }
        
        .date-input::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        .date-input:disabled::-webkit-calendar-picker-indicator {
            opacity: 0.25;
            cursor: not-allowed;
        }

        .time-input {
            background: transparent;
            color: #e4e8f5;
            border: none;
            outline: none;
            padding: 0;
            font-size: 12px;
            font-weight: 600;
            width: 70px;
            cursor: default;
        }

        .time-input::-webkit-calendar-picker-indicator {
            cursor: default;
            opacity: 0.6;
            filter: invert(1);
        }

        .time-input::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        .time-input:disabled::-webkit-calendar-picker-indicator {
            opacity: 0.25;
            cursor: not-allowed;
        }

        .go-to-btn {
            border: none;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: default;
            background: rgba(63, 75, 104, 0.9);
            color: #ffffff;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .go-to-btn:hover {
            background: rgba(99, 119, 167, 1);
            color: #ffffff;
        }

        .go-to-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           Compare Symbol Overlay Styles
           ============================================ */
        .compare-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
        }

        .compare-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .compare-btn.active,
        #compareBtn.active {
            color: #2962ff;
            background: rgba(41, 98, 255, 0.12);
        }

        /* Hide compare button from toolbar - moved to symbol area */
        #compareBtn {
            display: none !important;
        }

        /* Add Symbol Plus Button - TradingView Style */
        .add-symbol-btn {
            width: 22px;
            height: 22px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background: rgba(41, 98, 255, 0.1);
            border: 1px solid #2962ff;
            border-radius: 50%;
            color: #2962ff;
            cursor: default;
            transition: all 0.15s ease;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .add-symbol-btn:hover {
            background: rgba(41, 98, 255, 0.25);
            border-color: #2962ff;
            color: #fff;
        }

        .add-symbol-btn.active {
            background: #2962ff;
            border-color: #2962ff;
            color: #fff;
        }

        .add-symbol-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Symbol Plus Dropdown */
        .symbol-plus-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 6px;
            min-width: 160px;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            overflow: hidden;
        }

        .symbol-plus-dropdown.open {
            display: flex;
        }

        .symbol-plus-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: default;
            transition: background 0.15s, color 0.15s;
            text-align: left;
            width: 100%;
        }

        .symbol-plus-dropdown-item:hover {
            background: rgba(41, 98, 255, 0.12);
            color: #ffffff;
        }

        .symbol-plus-dropdown-item svg {
            flex-shrink: 0;
        }

        /* Add Symbol Dropdown - TradingView Style */
        .add-symbol-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 8px;
            min-width: 420px;
            max-height: 400px;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            overflow: hidden;
        }

        .add-symbol-dropdown.open {
            display: flex;
        }

        .add-symbol-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #363a45;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .add-symbol-dropdown-list {
            overflow-y: auto;
            max-height: 300px;
            padding: 8px 0;
        }

        .add-symbol-dropdown-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            transition: background 0.15s;
            gap: 10px;
            border-bottom: 1px solid rgba(54, 58, 69, 0.5);
        }

        .add-symbol-dropdown-item:last-child {
            border-bottom: none;
        }

        .add-symbol-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .add-symbol-dropdown-item.current {
            background: rgba(41, 98, 255, 0.1);
        }

        .add-symbol-dropdown-item .symbol-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #050028;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .add-symbol-dropdown-item .symbol-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: #ffffff;
            min-width: 80px;
        }

        .add-symbol-dropdown-item .symbol-check {
            color: #2962ff;
            margin-left: auto;
        }

        /* Symbol Options - 3 buttons inline */
        .symbol-add-options {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }

        .symbol-add-btn {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(120, 123, 134, 0.3);
            border-radius: 4px;
            color: #787b86;
            font-size: 11px;
            cursor: default;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .symbol-add-btn:hover {
            background: rgba(41, 98, 255, 0.15);
            border-color: #2962ff;
            color: #2962ff;
        }

        .symbol-add-btn.active {
            background: rgba(41, 98, 255, 0.2);
            border-color: #2962ff;
            color: #2962ff;
        }

        /* Compare Modal - Modern Dark Theme */
        .compare-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .compare-modal-overlay.open {
            display: flex;
        }

        .compare-modal {
            background: #050028;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            width: 520px;
            max-width: 95vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .compare-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: #050028;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .compare-modal-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: #e1e3e8;
            letter-spacing: 0.3px;
        }

        .compare-modal-close {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #6b7280;
            cursor: default;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compare-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e1e3e8;
            transform: rotate(90deg);
        }

        .compare-modal-close svg {
            width: 16px;
            height: 16px;
        }

        .compare-modal-body {
            padding: 0;
            overflow-y: auto;
            flex: 1;
        }

        /* Search Box */
        .compare-search-box {
            position: relative;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
        }

        .compare-search-icon {
            position: absolute;
            left: 36px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: #4b5563;
            pointer-events: none;
        }

        .compare-search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            color: #e1e3e8;
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        .compare-search-input:focus {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(41, 98, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.1);
        }

        .compare-search-input::placeholder {
            color: #4b5563;
        }

        /* Section Styles */
        .compare-section {
            padding: 0;
        }

        .compare-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 16px 20px 8px;
            background: transparent;
        }

        .compare-section-list {
            padding: 0 8px 8px;
        }

        /* Symbol Row - Card Style */
        .compare-symbol-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin: 4px 0;
            cursor: default;
            transition: all 0.15s ease;
            border-radius: 10px;
            background: transparent;
            border: 1px solid transparent;
        }

        .compare-symbol-row:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.06);
        }

        .compare-symbol-row.added {
            background: rgba(41, 98, 255, 0.08);
            border-color: rgba(41, 98, 255, 0.2);
        }

        /* Symbol Icon */
        .compare-symbol-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #050028;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #60a5fa;
            margin-right: 14px;
            flex-shrink: 0;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .compare-symbol-icon.gold {
            background: #050028;
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.2);
        }

        .compare-symbol-icon.crypto {
            background: #050028;
            color: #34d399;
            border-color: rgba(52, 211, 153, 0.2);
        }

        .compare-symbol-icon.stock {
            background: #050028;
            color: #a78bfa;
            border-color: rgba(167, 139, 250, 0.2);
        }

        /* Symbol Info */
        .compare-symbol-info {
            flex: 1;
            min-width: 80px;
            max-width: 180px;
            margin-right: 12px;
        }

        .compare-symbol-name {
            font-size: 14px;
            font-weight: 600;
            color: #e1e3e8;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compare-symbol-desc {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Symbol Actions */
        .compare-symbol-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .compare-symbol-row .compare-symbol-actions {
            opacity: 1;
        }

        .compare-action-btn {
            padding: 6px 10px;
            border: none;
            background: rgba(41, 98, 255, 0.15);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #60a5fa;
            cursor: default;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .compare-action-btn:hover {
            background: rgba(41, 98, 255, 0.25);
            color: #93c5fd;
        }

        .compare-action-btn.primary {
            background: #2962ff;
            color: white;
        }

        .compare-action-btn.primary:hover {
            background: #1d4ed8;
        }

        .compare-action-btn.remove {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        .compare-action-btn.remove:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* Added Symbols - Pill Style */
        .compare-added-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .compare-added-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 12px;
            background: rgba(41, 98, 255, 0.12);
            border: 1px solid rgba(41, 98, 255, 0.25);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #93c5fd;
        }

        .compare-added-pill .pill-color {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .compare-added-pill .pill-remove {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #9ca3af;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            padding: 0;
        }

        .compare-added-pill .pill-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .compare-added-pill .pill-remove svg {
            width: 10px;
            height: 10px;
        }

        /* Empty State */
        .compare-empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #6b7280;
        }

        .compare-empty-state svg {
            width: 48px;
            height: 48px;
            color: #374151;
            margin-bottom: 12px;
        }

        .compare-empty-state p {
            margin: 0;
            font-size: 13px;
        }

        /* Scrollbar */
        .compare-modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .compare-modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .compare-modal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .compare-modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Light Mode */
        body.light-mode .compare-modal {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.08);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.15), 0 0 1px rgba(0, 0, 0, 0.1);
        }

        body.light-mode .compare-modal-header {
            background: #050028;
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .compare-modal-header h3 {
            color: #1f2937;
        }

        body.light-mode .compare-modal-close {
            background: rgba(0, 0, 0, 0.04);
            color: #9ca3af;
        }

        body.light-mode .compare-modal-close:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #1f2937;
        }

        body.light-mode .compare-search-box {
            background: rgba(0, 0, 0, 0.02);
        }

        body.light-mode .compare-search-input {
            background: rgba(0, 0, 0, 0.04);
            border-color: rgba(0, 0, 0, 0.08);
            color: #1f2937;
        }

        body.light-mode .compare-search-input:focus {
            background: white;
            border-color: rgba(41, 98, 255, 0.5);
        }

        body.light-mode .compare-search-input::placeholder {
            color: #9ca3af;
        }

        body.light-mode .compare-section-title {
            color: #6b7280;
        }

        body.light-mode .compare-symbol-row:hover {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .compare-symbol-row.added {
            background: rgba(41, 98, 255, 0.06);
            border-color: rgba(41, 98, 255, 0.15);
        }

        body.light-mode .compare-symbol-name {
            color: #1f2937;
        }

        body.light-mode .compare-symbol-desc {
            color: #6b7280;
        }

        body.light-mode .compare-added-pills {
            background: rgba(0, 0, 0, 0.02);
            border-bottom-color: rgba(0, 0, 0, 0.04);
        }

        body.light-mode .compare-added-pill {
            background: rgba(41, 98, 255, 0.08);
            border-color: rgba(41, 98, 255, 0.2);
            color: #2962ff;
        }

        .compare-symbol-right {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            color: #787b86;
            font-size: 12px;
        }

        .compare-symbol-broker {
            text-align: right;
        }

        .compare-symbol-broker-name {
            font-size: 12px;
            color: #050028;
            font-weight: 500;
        }

        .compare-symbol-broker-type {
            font-size: 11px;
            color: #787b86;
        }

        /* Added symbols with remove button */
        .compare-added-row {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            border-left: 3px solid #2962ff;
            background: #f0f3fa;
            min-height: 48px;
        }

        .compare-added-remove {
            margin-left: auto;
            background: transparent;
            border: none;
            color: #ffffff;
            cursor: default;
            padding: 4px;
            border-radius: 4px;
        }

        .compare-added-remove:hover {
            background: rgba(242, 54, 69, 0.1);
            color: #f23645;
        }

        /* Overlay Legend on Chart */
        .overlay-legend {
            position: absolute;
            top: 60px;
            left: 60px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 100;
            pointer-events: auto;
        }

        .overlay-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(5, 0, 40, 0.9);
            border-radius: 6px;
            font-size: 12px;
            color: #ffffff;
            backdrop-filter: blur(8px);
        }

        .overlay-legend-color {
            width: 10px;
            height: 3px;
            border-radius: 2px;
        }

        .overlay-legend-close {
            background: transparent;
            border: none;
            color: #ffffff;
            cursor: default;
            padding: 2px;
            margin-left: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .overlay-legend-close:hover {
            color: #f23645;
        }

        .overlay-legend-close svg {
            width: 12px;
            height: 12px;
        }

        /* Left Y-Axis for Overlay */
        .overlay-y-axis {
            position: absolute;
            left: 0;
            top: 44px;
            width: 50px;
            height: calc(100% - 74px);
            pointer-events: none;
            z-index: 50;
        }

        /* Overlay Item with Controls */
        .compare-overlay-item {
            flex-direction: column;
            align-items: stretch;
        }

        .compare-overlay-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compare-overlay-header .compare-overlay-name {
            flex: 1;
        }

        .compare-overlay-toggle,
        .compare-overlay-remove {
            background: transparent;
            border: none;
            color: #787b86;
            cursor: default;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .compare-overlay-toggle:hover,
        .compare-overlay-remove:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .compare-overlay-toggle.visible {
            color: #2962ff;
        }

        .compare-overlay-remove:hover {
            color: #f23645;
        }

        .compare-overlay-toggle svg,
        .compare-overlay-remove svg {
            width: 16px;
            height: 16px;
        }

        .compare-overlay-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .compare-control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compare-control-row label {
            font-size: 11px;
            color: #787b86;
            width: 50px;
        }

        .compare-control-row input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #363a45;
            border-radius: 2px;
            cursor: default;
        }

        .compare-control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #2962ff;
            border-radius: 50%;
            cursor: default;
        }

        .compare-control-row input[type="color"] {
            width: 24px;
            height: 24px;
            padding: 0;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: default;
            background: transparent;
            transition: border-color 0.15s ease;
        }
        .compare-control-row input[type="color"]:hover {
            border-color: #2962ff;
        }

        .compare-control-row input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .compare-control-row input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .compare-value {
            font-size: 11px;
            color: #787b86;
            min-width: 35px;
            text-align: right;
        }

        .compare-reset-scale {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 4px;
            color: #787b86;
            font-size: 11px;
            cursor: default;
            transition: all 0.15s;
        }

        .compare-reset-scale:hover {
            background: rgba(41, 98, 255, 0.2);
            color: #2962ff;
        }

        .compare-type-toggle {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .compare-type-btn {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid transparent;
            border-radius: 4px;
            color: #787b86;
            font-size: 11px;
            cursor: default;
            transition: all 0.15s;
        }

        .compare-type-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .compare-type-btn.active {
            background: rgba(41, 98, 255, 0.2);
            border-color: #2962ff;
            color: #2962ff;
        }

        /* Overlay Settings Popup */
        .overlay-settings-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .overlay-settings-popup.open {
            display: flex;
        }

        .overlay-settings-content {
            background: #ffffff;
            border-radius: 8px;
            width: 340px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .overlay-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e3eb;
        }

        .overlay-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #050028;
        }

        .overlay-settings-close {
            background: none;
            border: none;
            cursor: default;
            padding: 4px;
            color: #787b86;
        }

        .overlay-settings-close:hover {
            color: #050028;
        }

        .overlay-settings-close svg {
            width: 18px;
            height: 18px;
        }

        .overlay-settings-tabs {
            display: flex;
            border-bottom: 1px solid #e0e3eb;
            padding: 0 20px;
        }

        .overlay-tab {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            color: #787b86;
            cursor: default;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .overlay-tab.active {
            color: #050028;
            border-bottom-color: #2962ff;
        }

        .overlay-settings-body {
            padding: 16px 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .overlay-setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .overlay-setting-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #050028;
        }

        .overlay-setting-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #2962ff;
        }

        .overlay-select {
            padding: 8px 12px;
            border: 1px solid #e0e3eb;
            border-radius: 4px;
            font-size: 14px;
            color: #050028;
            background: #ffffff;
            min-width: 120px;
        }

        .overlay-setting-row input[type="range"] {
            flex: 1;
            margin: 0 12px;
            accent-color: #2962ff;
        }

        .overlay-setting-row span {
            min-width: 40px;
            text-align: right;
            font-size: 13px;
            color: #787b86;
        }

        .overlay-color-pair {
            display: flex;
            gap: 8px;
        }

        .overlay-color-swatch {
            width: 32px;
            height: 32px;
            border: 2px solid #e0e3eb;
            border-radius: 4px;
            cursor: default;
            transition: border-color 0.15s ease, transform 0.15s ease;
        }

        .overlay-color-swatch:hover {
            border-color: #2962ff;
            transform: scale(1.05);
        }

        .overlay-setting-divider {
            height: 1px;
            background: #e0e3eb;
            
        }

        .overlay-settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid #e0e3eb;
        }

        .overlay-btn-cancel {
            padding: 8px 20px;
            background: #ffffff;
            border: 1px solid #e0e3eb;
            border-radius: 4px;
            font-size: 14px;
            color: #050028;
            cursor: default;
        }

        .overlay-btn-cancel:hover {
            background: #f0f3fa;
        }

        .overlay-btn-ok {
            padding: 8px 24px;
            background: #050028;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            color: #ffffff;
            cursor: default;
        }

        .overlay-btn-ok:hover {
            background: #2a2e39;
        }

        .date-time-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            background: transparent;
            color: #e4e8f5;
            cursor: default;
            font-size: 12px;
            font-weight: 600;
            padding: 0;
        }

        .date-time-toggle-label {
            white-space: nowrap;
        }

        .datetime-picker-popover {
            position: fixed;
            background: #ffffff;
            color: #050028;
            border-radius: 10px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
            z-index: 2000;
            width: 420px;
            max-height: 420px;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .datetime-picker-header {
            padding: 10px 16px;
            border-bottom: 1px solid #e0e3eb;
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
        }

        .datetime-picker-body {
            display: flex;
            padding: 12px 16px 8px;
            gap: 16px;
        }

        .datetime-calendar {
            flex: 1.2;
        }

        .datetime-month-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .datetime-month-nav {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .datetime-month-btn {
            border: none;
            background: transparent;
            cursor: default;
            padding: 0 4px;
            font-size: 16px;
            color: #6b7280;
        }

        .datetime-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .datetime-weekday {
            text-align: center;
            padding: 2px 0;
        }

        .datetime-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .datetime-day {
            border: none;
            background: transparent;
            border-radius: 999px;
            font-size: 12px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            margin: 1px auto;
            color: #4b5563;
        }

        .datetime-day:hover {
            background: #e5e7eb;
        }

        .datetime-day.selected {
            background: #5b21ff;
            color: #ffffff;
        }

        .datetime-day.blank {
            cursor: default;
        }

        /* Go To Menu - Modern Compact Design */
        .go-to-menu-wrapper {
            position: relative;
            display: inline-flex;
        }

        .go-to-menu {
            position: fixed;
            width: 380px;
            background: #050028;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 0;
            display: none;
            flex-direction: column;
            z-index: 100000;
            overflow: hidden;
        }

        .go-to-menu.open {
            display: flex !important;
            visibility: visible !important;
            animation: goToMenuFadeIn 0.15s ease-out;
        }

        @keyframes goToMenuFadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .go-to-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .go-to-menu-title {
            font-size: 14px;
            font-weight: 600;
            color: #e1e3e8;
        }

        .go-to-menu-close {
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: default;
            padding: 4px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .go-to-menu-close:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Input Section */
        .go-to-menu-inputs {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .go-to-input-group {
            margin-bottom: 12px;
        }

        .go-to-input-group:last-child {
            margin-bottom: 0;
        }

        .go-to-input-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .go-to-input-label .tz-badge {
            color: #2962ff;
            font-weight: 600;
        }

        .go-to-input-row {
            display: flex;
            gap: 8px;
        }

        .go-to-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px 12px;
            color: #e1e3e8;
            font-size: 13px;
            font-weight: 500;
            outline: none;
            transition: all 0.15s ease;
        }

        .go-to-input:focus {
            border-color: #2962ff;
            background: rgba(41, 98, 255, 0.05);
        }

        .go-to-input::placeholder {
            color: #4b5563;
        }

        .go-to-input-btn {
            padding: 10px 16px;
            background: #2962ff;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: default;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .go-to-input-btn:hover {
            background: #1e4fd8;
        }

        /* Quick Actions Grid */
        .go-to-quick-actions {
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .go-to-quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            color: #9ca3af;
            font-size: 11px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
            text-align: center;
            gap: 6px;
        }

        .go-to-quick-btn:hover {
            background: rgba(41, 98, 255, 0.1);
            border-color: rgba(41, 98, 255, 0.3);
            color: #60a5fa;
        }

        .go-to-quick-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.5;
        }

        .go-to-quick-btn .time-badge {
            font-size: 10px;
            color: #6b7280;
            font-weight: 400;
        }

        /* Section Divider */
        .go-to-section-title {
            padding: 8px 16px 6px;
            font-size: 10px;
            font-weight: 700;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            background: rgba(0, 0, 0, 0.2);
        }

        /* List Items */
        .go-to-list {
            padding: 4px 8px;
        }

        .go-to-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
            width: 100%;
            text-align: left;
        }

        .go-to-list-item:hover {
            background: rgba(41, 98, 255, 0.1);
            color: #60a5fa;
        }

        .go-to-list-item .item-time {
            font-size: 11px;
            color: #6b7280;
            font-weight: 400;
        }

        .go-to-list-item:hover .item-time {
            color: #60a5fa;
        }

        /* Footer */
        .go-to-menu-footer {
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: flex-end;
        }

        .go-to-settings-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
        }

        .go-to-settings-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #e1e3e8;
        }

        .go-to-settings-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Legacy classes kept for compatibility */
        .go-to-menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
            width: 100%;
            text-align: left;
        }

        .go-to-menu-item:hover {
            background: rgba(41, 98, 255, 0.1);
            color: #60a5fa;
        }

        /* Go To Menu - Light Theme */
        body.light-mode .go-to-menu {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        body.light-mode .go-to-menu-header {
            background: rgba(0, 0, 0, 0.02);
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .go-to-menu-title {
            color: #1e293b;
        }

        body.light-mode .go-to-menu-close {
            color: #94a3b8;
        }

        body.light-mode .go-to-menu-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        body.light-mode .go-to-menu-inputs {
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .go-to-input-label {
            color: #64748b;
        }

        body.light-mode .go-to-input {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }

        body.light-mode .go-to-input:focus {
            border-color: #2962ff;
            background: rgba(41, 98, 255, 0.03);
        }

        body.light-mode .go-to-input::placeholder {
            color: #94a3b8;
        }

        body.light-mode .go-to-quick-btn {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.06);
            color: #64748b;
        }

        body.light-mode .go-to-quick-btn:hover {
            background: rgba(41, 98, 255, 0.08);
            border-color: rgba(41, 98, 255, 0.2);
            color: #2962ff;
        }

        body.light-mode .go-to-section-title {
            background: rgba(0, 0, 0, 0.03);
            color: #94a3b8;
        }

        body.light-mode .go-to-list-item {
            color: #334155;
        }

        body.light-mode .go-to-list-item:hover {
            background: rgba(41, 98, 255, 0.08);
            color: #2962ff;
        }

        body.light-mode .go-to-list-item .item-time {
            color: #94a3b8;
        }

        body.light-mode .go-to-menu-footer {
            background: rgba(0, 0, 0, 0.02);
            border-top-color: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .go-to-settings-btn {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.08);
            color: #64748b;
        }

        body.light-mode .go-to-settings-btn:hover {
            background: rgba(0, 0, 0, 0.06);
            color: #1e293b;
        }

        body.light-mode .go-to-menu-item {
            color: #334155;
        }

        body.light-mode .go-to-menu-item:hover {
            background: rgba(41, 98, 255, 0.08);
            color: #2962ff;
        }

        body.light-mode .go-to-menu-input-label {
            color: #64748b;
        }

        body.light-mode .go-to-menu-input::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }

        /* Go To settings modal - Dark Mode (Default) */
        .go-to-settings-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200000;
        }

        .go-to-settings-modal.open {
            display: flex;
        }

        .go-to-settings-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
        }

        .go-to-settings-dialog {
            position: relative;
            width: 480px;
            max-width: calc(100% - 32px);
            max-height: 90vh;
            background: #050028;
            color: #ffffff;
            border-radius: 18px;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .go-to-settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 28px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

       .go-to-settings-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
        }

        .go-to-settings-close {
            border: none;
            background: transparent;
            color: #787b86;
            cursor: default;
            padding: 4px;
            border-radius: 6px;
        }

        .go-to-settings-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .go-to-settings-body {
            padding: 22px 28px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .go-to-settings-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .go-to-settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #38bdf8;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .go-to-settings-section-description {
            font-size: 12px;
            color: #787b86;
        }

        .go-to-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.5);
        }

        .go-to-settings-row.disabled {
            opacity: 0.6;
        }

        .go-to-settings-row label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #ffffff;
            cursor: default;
        }

        .go-to-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }

        .go-to-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .go-to-toggle-slider {
            position: absolute;
            cursor: default;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #4b5563;
            border-radius: 999px;
            transition: background 0.2s;
        }

        .go-to-toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 2px;
            top: 2px;
            background: #ffffff;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .go-to-toggle input:checked + .go-to-toggle-slider {
            background: #050028;
        }

        .go-to-toggle input:checked + .go-to-toggle-slider::before {
            transform: translateX(18px);
        }

        .go-to-settings-select {
            min-width: 84px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 13px;
            color: #ffffff;
            background: #050028;
            cursor: default;
        }

        .go-to-settings-footer {
            padding: 16px 28px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .go-to-settings-footer button {
            min-width: 96px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            padding: 10px 18px;
            border: none;
            cursor: default;
        }

        #goToSettingsCancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        #goToSettingsCancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        #goToSettingsSave {
            background: #050028;
            color: #ffffff;
        }

        #goToSettingsSave:hover {
            background: #050028;
        }

        /* Go To Settings Modal - Light Mode */
        body.light-mode .go-to-settings-backdrop {
            background: rgba(255, 255, 255, 0.6);
        }

        body.light-mode .go-to-settings-dialog {
            background: #ffffff;
            color: #111827;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 24px 80px rgba(5, 0, 40, 0.25);
        }

        body.light-mode .go-to-settings-header {
            border-bottom: 1px solid #e5e7eb;
        }

        body.light-mode .go-to-settings-title {
            color: #0f172a;
        }

        body.light-mode .go-to-settings-close {
            color: #94a3b8;
        }

        body.light-mode .go-to-settings-close:hover {
            background: rgba(148, 163, 184, 0.12);
            color: #475569;
        }

        body.light-mode .go-to-settings-section-title {
            color: #0ea5e9;
        }

        body.light-mode .go-to-settings-section-description {
            color: #6b7280;
        }

        body.light-mode .go-to-settings-row {
            border: 1px solid #e5e7eb;
            background: #fafafa;
        }

        body.light-mode .go-to-settings-row label {
            color: #111827;
        }

        body.light-mode .go-to-toggle-slider {
            background: #d1d5db;
        }

        body.light-mode .go-to-settings-select {
            border: 1px solid #d1d5db;
            color: #0f172a;
            background: #ffffff;
        }

        body.light-mode .go-to-settings-footer {
            border-top: 1px solid #e5e7eb;
        }

        body.light-mode #goToSettingsCancel {
            background: #f3f4f6;
            color: #4b5563;
        }

        body.light-mode #goToSettingsCancel:hover {
            background: #e5e7eb;
        }

        /* Replay toolbar */
        body.replay-tabs-collapsed {
            --replay-toolbar-height: 42px;
        }

        .replay-toolbar {
            position: fixed !important;
            left: 0 !important;
            bottom: 0 !important;
            right: 0 !important;
            background: #050028;
            border-top: 1px solid rgba(50, 50, 60, 0.9);
            z-index: 101;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            padding: 12px 32px 20px;
            box-shadow: 0 -18px 48px rgba(2, 5, 18, 0.45);
            height: auto;
            max-height: none;
            transition: all 0.3s ease;
        }

        .replay-toolbar::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0;
            border: none;
            pointer-events: none;
            z-index: 0;
        }

        .replay-toolbar > * {
            position: relative;
            z-index: 1;
        }

        /* Make empty space of the BIG replay toolbar non-interactive (click-through)
           while keeping actual controls clickable. Do NOT affect floating clones. */
        .replay-toolbar:not(.floating-clone) {
            pointer-events: none;
        }

        .replay-toolbar:not(.floating-clone) .replay-toolbar-content,
        .replay-toolbar:not(.floating-clone) .replay-controls-group {
            pointer-events: none;
        }

        .replay-toolbar:not(.floating-clone) button,
        .replay-toolbar:not(.floating-clone) select,
        .replay-toolbar:not(.floating-clone) input,
        .replay-toolbar:not(.floating-clone) .speed-slider-control,
        .replay-toolbar:not(.floating-clone) .replay-tabs-container,
        .replay-toolbar:not(.floating-clone) #goToControl,
        .replay-toolbar:not(.floating-clone) .replay-timezone-selector,
        .replay-toolbar:not(.floating-clone) .replay-tz-menu {
            pointer-events: auto;
        }

        .replay-toolbar-content {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 0 20px;
            min-height: var(--replay-toolbar-bar-height);
            position: relative;
            z-index: 2;
            margin: 0 auto;
        }

        .replay-controls-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .replay-controls-group.replay-controls-left {
            position: absolute;
            left: 40px;
        }

        .replay-controls-group.replay-controls-right {
            position: absolute;
            right: 2px;
        }

        .replay-toolbar-divider,
        .replay-toolbar-content > .replay-toolbar-divider {
            height: 28px;
            width: 1px;
            background: rgba(78, 91, 126, 0.45);
            margin: 0 3px;
        }

        /* Compact Meta Info (collapsed state) */
        .replay-compact-meta {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 4px 12px;
            background: #050028;
            border-radius: 6px;
            border: 1px solid rgba(124, 58, 237, 0.2);
            position: absolute;
            left: 20px;
            backdrop-filter: blur(8px);
        }

        body.replay-tabs-collapsed .replay-compact-meta {
            display: flex;
        }

        /* Speed Slider Control - Integrated Style */
        .speed-slider-control {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            min-width: 340px;
        }

        /* Speed Bar Drag Handle */
        .speed-drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            cursor: move;
            color: #5d606b;
            flex-shrink: 0;
        }

        .speed-drag-handle:active {
            cursor: move;
        }

        .speed-drag-handle svg {
            width: 16px;
            height: 16px;
        }

        body.speed-slider-clone-active #speedSliderControl #speedDragHandle svg {
            visibility: hidden;
        }

        body.speed-slider-clone-active #speedSliderControl,
        body.speed-slider-clone-active #replayGoBack,
        body.speed-slider-clone-active #replayStepBackward,
        body.speed-slider-clone-active #replayPlayPause,
        body.speed-slider-clone-active #replayStepForward,
        body.speed-slider-clone-active #goToControl {
            pointer-events: none;
        }

        body.speed-slider-clone-active #speedSliderClone {
            pointer-events: auto;
        }

        /* Detached Speed Bar State - matches drawing toolbar style */
        .speed-slider-control.detached {
            position: fixed;
            background: #050028;
            border: 1px solid rgba(50, 50, 60, 0.9);
            border-radius: 8px;
            padding: 8px 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10000;
        }

        .speed-slider-control.detached .speed-drag-handle {
            color: #ffffff;
        }

        .speed-slider-control.dragging {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            opacity: 0.95;
        }

        /* Snap indicator when near original position */
        .speed-slider-control.snap-ready {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            border-color: rgba(99, 102, 241, 0.6);
        }

        /* Placeholder when detached */
        .speed-slider-placeholder {
            display: none;
            width: 200px;
            height: 28px;
            border: 1px dashed rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.05);
        }

        .speed-slider-placeholder.visible {
            display: block;
        }

        .speed-slider-play-btn {
            width: 28px;
            height: 28px;
            background: #000000;
            border: 1px solid #10b981;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            color: #10b981;
            transition: all 0.15s ease;
        }

        .speed-slider-play-btn:hover {
            background: #050028;
            color: #34d399;
            transform: none;
        }

        .speed-slider-play-btn:active,
        .speed-slider-play-btn.btn-clicked {
            transform: scale(0.9) !important;
        }

        .speed-slider-play-btn svg {
            width: 12px;
            height: 12px;
        }

        .speed-slider-play-btn .pause-icon {
            display: none;
        }

        .speed-slider-play-btn.playing {
            background: #000000;
            border-color: #fb923c;
            color: #fb923c;
            box-shadow: none;
            animation: none;
        }

        .speed-slider-play-btn.playing:hover {
            background: #050028;
            color: #fdba74;
        }

        .speed-slider-play-btn.playing .play-icon {
            display: none;
        }

        .speed-slider-play-btn.playing .pause-icon {
            display: block !important;
        }
        
        /* Light mode - speed slider play button */
        body.light-mode .speed-slider-play-btn {
            background: #ffffff;
            border-color: #10b981;
            color: #10b981;
        }
        
        body.light-mode .speed-slider-play-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        body.light-mode .speed-slider-play-btn.playing {
            background: #ffffff;
            border-color: #fb923c;
            color: #fb923c;
        }
        
        body.light-mode .speed-slider-play-btn.playing:hover {
            background: rgba(251, 146, 60, 0.1);
            color: #ea580c;
        }

        @keyframes playingPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(16, 185, 129, 0.5); }
            50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
        }

        .speed-slider-label {
            display: flex;
            align-items: baseline;
            gap: 0;
            color: #cbd5f5;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .speed-slider-label > span:first-child {
            margin-right: 4px;
        }

        .speed-slider-label .speed-value {
            color: #ffffff;
            font-weight: 600;
            display: inline-block;
            min-width: auto;
            text-align: left;
            margin-right: 6px;
        }

        .speed-slider-label .speed-rate {
            color: rgba(150, 160, 180, 0.7);
            font-size: 11px;
            font-weight: 400;
            display: inline-block;
            min-width: auto;
            text-align: left;
            margin-left: 4px;
        }

        .speed-slider-track-container {
            position: relative;
            width: 140px;
            height: 24px;
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .speed-slider-ticks {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 6px;
            pointer-events: none;
        }

        .speed-slider-ticks .tick {
            width: 1px;
            height: 4px;
            background: #363a45;
            border-radius: 1px;
        }

        /* Custom smooth slider track */
        .speed-slider-custom {
            position: relative;
            width: 100%;
            height: 3px;
            background: #363a45;
            border-radius: 2px;
            cursor: default;
            transition: background 0.15s ease, height 0.15s ease, box-shadow 0.15s ease;
        }

        .speed-slider-custom:hover {
            background: #4a4e5a;
            height: 4px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 0 0 16px rgba(255, 255, 255, 0.15);
        }

        .speed-slider-custom-thumb {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ffffff;
            border-radius: 50%;
            cursor: default;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.15);
            top: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s ease, transform 0.15s ease;
            z-index: 2;
        }

        .speed-slider-custom-thumb:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.25), 0 0 12px rgba(255, 255, 255, 0.4);
        }

        .speed-slider-custom-thumb:active,
        .speed-slider-custom-thumb.dragging {
            cursor: default;
            transform: translate(-50%, -50%) scale(1.05);
            transition: transform 0.1s;
        }

        .speed-slider-custom-fill {
            position: absolute;
            height: 100%;
            background: #787b86;
            border-radius: 2px;
            transition: width 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .speed-slider-input {
            display: none;
        }

        body.replay-tabs-collapsed .replay-toolbar-content {
            justify-content: center;
        }

        .compact-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .compact-meta-item .meta-label {
            color: rgba(226, 232, 255, 0.65);
            font-weight: 600;
        }

        .compact-meta-item .meta-value {
            color: rgba(226, 232, 255, 1);
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .compact-meta-item .meta-value.positive {
            color: #26a69a;
        }

        .compact-meta-item .meta-value.negative {
            color: #ef5350;
        }

        .compact-meta-divider {
            width: 1px;
            height: 14px;
            background: rgba(124, 58, 237, 0.3);
        }

        .replay-toolbar.visible {
            display: flex;
        }

        .replay-toolbar-handle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: rgba(226, 232, 255, 0.7);
            cursor: grab;
            user-select: none;
            padding-right: 10px;
            border-right: 1px solid rgba(78, 91, 126, 0.5);
        }

        .replay-toolbar-handle svg {
            width: 11px;
            height: 11px;
            stroke: currentColor;
            opacity: 0.8;
        }

        .replay-toolbar.dragging .replay-toolbar-handle {
            cursor: grabbing;
        }

        /* Floating clone styles */
        .replay-toolbar.floating-clone {
            width: auto !important;
            min-width: 500px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .replay-toolbar.floating-clone .replay-tabs-container {
            display: none !important;
        }

        .replay-toolbar.floating-clone .replay-toolbar-content {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Hide left and right groups in floating clone, show only center */
        .replay-toolbar.floating-clone .replay-controls-group.replay-controls-left,
        .replay-toolbar.floating-clone .replay-controls-group.replay-controls-right {
            display: none !important;
        }
        
        /* Make center group flow properly in floating clone */
        .replay-toolbar.floating-clone .replay-controls-group.replay-controls-center {
            position: static !important;
            display: flex !important;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }
        
        /* Show the control buttons in floating clone */
        .replay-toolbar.floating-clone #replayGoBack,
        .replay-toolbar.floating-clone #replayStepForward {
            display: flex !important;
        }
        
        /* Hide Go To in floating clone */
        .replay-toolbar.floating-clone #goToControl {
            display: none !important;
        }

        .replay-clone-close-btn:hover {
            background: rgba(120, 123, 134, 0.2) !important;
            color: #ffffff !important;
        }

        .speed-clone-close-btn,
        .speed-clone-close-btn:focus,
        .speed-clone-close-btn:active,
        .replay-toolbar .speed-clone-close-btn,
        .replay-toolbar button.speed-clone-close-btn,
        button.speed-clone-close-btn,
        .speed-slider-control .speed-clone-close-btn,
        .detached .speed-clone-close-btn,
        #speedSliderClone .speed-clone-close-btn {
            background: rgba(239, 68, 68, 0.6) !important;
            background-color: rgba(239, 68, 68, 0.6) !important;
            color: #ffffff !important;
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
            -webkit-appearance: none !important;
            appearance: none !important;
        }
        
        .speed-clone-close-btn:hover,
        .replay-toolbar .speed-clone-close-btn:hover,
        .replay-toolbar button.speed-clone-close-btn:hover,
        button.speed-clone-close-btn:hover,
        .speed-slider-control .speed-clone-close-btn:hover,
        .detached .speed-clone-close-btn:hover,
        #speedSliderClone .speed-clone-close-btn:hover {
            background: #dc2626 !important;
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        /* Light mode close button */
        body.light-mode .speed-clone-close-btn,
        body.light-mode #speedSliderClone .speed-clone-close-btn,
        body.light-mode #speedCloneCloseBtn {
            background: rgba(239, 68, 68, 0.7) !important;
            background-color: rgba(239, 68, 68, 0.7) !important;
            color: #ffffff !important;
        }
        
        body.light-mode .speed-clone-close-btn:hover,
        body.light-mode #speedSliderClone .speed-clone-close-btn:hover,
        body.light-mode #speedCloneCloseBtn:hover {
            background: #dc2626 !important;
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        /* ID selector for maximum specificity */
        #speedCloneCloseBtn {
            background: rgba(239, 68, 68, 0.7) !important;
            background-color: rgba(239, 68, 68, 0.7) !important;
            color: #ffffff !important;
        }
        
        #speedCloneCloseBtn:hover {
            background: #dc2626 !important;
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }

        .replay-toolbar button,
        .replay-toolbar select {
            height: 34px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: #ffffff;
            font-size: 12px;
            font-weight: 500;
            padding: 0 9px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: default;
            transition: all 0.15s ease;
        }

        .replay-toolbar button:hover:not(.speed-clone-close-btn),
        .replay-toolbar select:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .replay-toolbar button.replay-primary {
            background: #050028;
            color: #ffffff;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
            border-color: rgba(157, 78, 255, 0.5);
        }

        .replay-toolbar button.replay-primary:hover {
            background: #050028;
            box-shadow: 0 6px 24px rgba(124, 58, 237, 0.5);
        }

        /* Play/Pause button states */
        #replayPlayPause {
            transition: all 0.15s ease, transform 0.1s ease;
            min-width: 80px;
        }

        #replayPlayPause.replay-playing {
            background: #050028 !important;
            border-color: rgba(34, 197, 94, 0.5) !important;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4) !important;
        }

        #replayPlayPause.replay-playing:hover {
            background: #050028 !important;
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.5) !important;
        }

        #replayPlayPause.replay-paused {
            background: #050028;
            border-color: rgba(157, 78, 255, 0.5);
        }

        /* Click animation */
        #replayPlayPause.btn-clicked {
            transform: scale(0.92) !important;
        }

        @keyframes playPulse {
            0% { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(16, 185, 129, 0.6); }
            100% { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4); }
        }

        #replayPlayPause.replay-playing {
            animation: playPulse 2s ease-in-out infinite;
        }

        .replay-toolbar button.replay-danger {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border-color: rgba(220, 38, 38, 0.3);
        }

        .replay-toolbar button.replay-danger:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #fff5f5;
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Icon-only buttons */
        .replay-toolbar button.replay-icon-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .replay-toolbar button.replay-icon-btn svg {
            width: 18px;
            height: 18px;
        }

        #replayStepForward {
            width: 40px !important;
            height: 36px !important;
            min-width: 40px !important;
        }
        
        #replayStepForward svg {
            width: 34px !important;
            height: 30px !important;
            margin-left: -10px;
        }
        
        #replayStepForward:hover svg {
            margin-left: -10px;
        }

        .replay-toolbar button.replay-collapse-toggle .toggle-arrow {
            transition: transform 0.2s ease;
        }

        body.replay-tabs-collapsed .replay-toolbar button.replay-collapse-toggle .toggle-arrow {
            transform: rotate(180deg);
        }

        .replay-toolbar button svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
        }

        .replay-toolbar select {
            padding-right: 30px;
            appearance: none;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 12 8" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M1 1l5 5 5-5" stroke="%23cbd5f5" stroke-width="1.5" fill="none" stroke-linecap="round"/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            cursor: default;
        }

        .replay-toolbar .replay-time-label {
            display: none;
        }

        /* Current Candle Date/Time Display */
        .replay-datetime-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 8px;
            background: transparent;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 36px;
            box-sizing: border-box;
        }

        .replay-datetime-icon {
            width: 16px;
            height: 16px;
            color: #a0aec0;
            flex-shrink: 0;
        }

        /* Replay Timezone Selector */
        .replay-timezone-selector {
            position: relative;
            margin-left: 6px;
        }

        .replay-tz-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #a0aec0;
            font-size: 10px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s ease;
        }

        .replay-tz-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #a0aec0;
        }

        .replay-tz-btn svg {
            opacity: 1;
        }

        .replay-tz-menu {
            position: fixed;
            bottom: auto;
            right: auto;
            margin-bottom: 4px;
            min-width: 180px;
            max-height: 280px;
            overflow-y: auto;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: none;
            z-index: 100000;
        }

        .replay-tz-menu.show {
            display: block;
        }

        .replay-tz-menu .timezone-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            font-size: 11px;
            color: #94a3b8;
            cursor: default;
            transition: all 0.15s ease;
        }

        .replay-tz-menu .timezone-option:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .replay-tz-menu .timezone-option.selected {
            background: rgba(124, 58, 237, 0.2);
            color: #a78bfa;
        }

        .replay-tz-menu .timezone-option-label {
            font-weight: 500;
        }

        .replay-tz-menu .timezone-option-offset {
            opacity: 0.6;
            font-size: 10px;
        }

        /* Light mode */
        body.light-mode .replay-tz-btn {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        body.light-mode .replay-tz-btn:hover {
            background: rgba(0, 0, 0, 0.06);
            color: #1e293b;
        }

        body.light-mode .replay-tz-menu {
            background: #ffffff;
            border: 1px solid #e0e3eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        body.light-mode .replay-tz-menu .timezone-option {
            color: #64748b;
            border-bottom: 1px solid #f0f0f0;
        }

        body.light-mode .replay-tz-menu .timezone-option:last-child {
            border-bottom: none;
        }

        body.light-mode .replay-tz-menu .timezone-option:hover {
            background: #f5f7fa;
            color: #1e293b;
        }

        body.light-mode .replay-tz-menu .timezone-option.selected {
            background: rgba(41, 98, 255, 0.1);
            color: #2962ff;
        }

        /* Floating Follow Button - positioned inside chart-wrapper */
        #replayFollow {
            position: absolute;
            bottom: 70px;
            right: 120px;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
            background: rgba(45, 55, 72, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(160, 174, 192, 0.3);
            border-radius: 50%;
            color: #a0aec0;
            cursor: default;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            animation: followPulse 2s ease-in-out infinite;
        }

        @keyframes followPulse {
            0%, 100% {
                border-color: rgba(160, 174, 192, 0.3);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }
            50% {
                border-color: rgba(160, 174, 192, 0.6);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(160, 174, 192, 0.2);
            }
        }

        #replayFollow:hover {
            background: rgba(55, 65, 81, 0.95);
            border-color: rgba(160, 174, 192, 0.7);
            color: #e2e8f0;
            transform: scale(1.08);
            animation: none;
        }

        #replayFollow svg {
            width: 20px;
            height: 20px;
        }

        /* Light mode */
        body.light-mode #replayFollow {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(100, 116, 139, 0.3);
            color: #64748b;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body.light-mode #replayFollow:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(100, 116, 139, 0.6);
            color: #475569;
        }

        .replay-datetime-label {
            color: #a0aec0;
            font-size: 12px;
            font-weight: 500;
        }

        .replay-datetime-value {
            color: #a0aec0;
            font-size: 12px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.3px;
        }

        /* Account Stats Display */
        .replay-account-stats {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 14px;
            background: rgba(78, 91, 126, 0.2);
            border: 1px solid rgba(78, 91, 126, 0.3);
            border-radius: 6px;
            height: 36px;
            box-sizing: border-box;
        }

        .replay-stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .replay-stat-icon {
            width: 14px;
            height: 14px;
            color: #a0aec0;
            flex-shrink: 0;
        }

        .replay-stat-label {
            color: #a0aec0;
            font-size: 12px;
            font-weight: 500;
        }

        .replay-stat-value {
            color: #a0aec0;
            font-size: 12px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .replay-stat-value.positive {
            color: #a0aec0;
        }

        .replay-stat-value.negative {
            color: #a0aec0;
        }

        .replay-stat-divider {
            width: 1px;
            height: 16px;
            background: rgba(78, 91, 126, 0.4);
            margin: 0px;
        }

        .replay-stat-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: rgba(5, 0, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            cursor: default;
            color: #94a3b8;
            padding: 0;
            margin-left: 8px;
            transition: all 0.15s ease;
        }

        .replay-stat-toggle:hover {
            background: rgba(46, 55, 76, 0.65);
            color: #ffffff;
        }

        .replay-stat-toggle svg {
            width: 16px;
            height: 16px;
            display: block;
        }

        .replay-stat-toggle .eye-closed {
            display: none;
        }

        .replay-stat-toggle.hidden .eye-open {
            display: none;
        }

        .replay-stat-toggle.hidden .eye-closed {
            display: block;
        }

        /* Analytics Button */
        .replay-analytics-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            background: #050028;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: default;
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            height: 36px;
            box-sizing: border-box;
        }

        .replay-analytics-btn:hover {
            background: #050028;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .replay-analytics-btn svg {
            width: 16px;
            height: 16px;
        }

        .replay-slider-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            min-width: 200px;
            max-width: 350px;
        }

        .replay-slider-wrapper input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(78, 91, 126, 0.4);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .replay-slider-wrapper input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #050028;
            cursor: default;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.4);
            transition: all 0.15s ease;
        }

        .replay-slider-wrapper input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.6);
        }

        .replay-slider-wrapper input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #050028;
            cursor: default;
            border: none;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.4);
            transition: all 0.15s ease;
        }

        .replay-slider-wrapper input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.6);
        }

        .replay-date-search {
            flex: 0 0 auto;
            padding: 0;
            background: transparent;
            border: none;
        }

        .replay-date-search .date-time-toggle {
            border: none;
            border-radius: 4px;
            background: transparent;
            color: #ffffff;
            font-size: 10.5px;
            font-weight: 600;
            padding: 5px 9px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: default;
            transition: all 0.15s ease;
        }

        .replay-date-search .date-time-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .replay-date-search .date-time-toggle-label {
            font-size: 10.5px;
        }
        
        .replay-date-search .date-time-toggle svg {
            width: 12px;
            height: 12px;
        }

        /* Go To Arrow Button Style */
        .goto-arrow-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            max-width: 34px;
            padding: 0 !important;
            justify-content: center;
        }

        .goto-arrow-btn svg {
            width: 18px !important;
            height: 18px !important;
        }

        /* Timeframe Dropdown */
        .timeframe-dropdown-wrapper {
            position: relative;
            overflow: visible !important;
        }

        .timeframe-dropdown-menu {
            display: none;
            position: fixed;
            background: #050028;
            border: 1px solid #2a2e39;
            border-radius: 8px;
            padding: 4px;
            min-width: auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            z-index: 99999;
        }

        .timeframe-dropdown-menu.show {
            display: block;
        }

        .timeframe-option {
            padding: 6px 16px;
            font-size: 12px;
            color: #a0aec0;
            cursor: default;
            border-radius: 4px;
            text-align: center;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .timeframe-option:hover {
            background: rgba(78, 91, 126, 0.4);
            color: #fff;
        }

        .timeframe-option.selected {
            background: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .replay-tabs-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #050028;
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 16px;
            padding: 12px 24px 24px;
            position: relative;
            backdrop-filter: blur(20px);
            color: #e2e8f0;
            margin: 0 auto;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .replay-tabs-container::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border: 1px solid rgba(124, 58, 237, 0.2);
            pointer-events: none;
        }

        .replay-tabs-nav {
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 2px solid rgba(71, 85, 105, 0.4);
            padding-bottom: 8px;
            padding-left: 20px;
            margin-bottom: 4px;
        }

        .replay-tab-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: rgba(148, 163, 184, 0.85);
            background: rgba(30, 41, 59, 0.6);
            cursor: default;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .replay-tab-btn:hover {
            color: #e2e8f0;
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(124, 58, 237, 0.3);
        }

        .replay-tab-btn.active {
            background: rgba(124, 58, 237, 0.2);
            color: #a78bfa;
            border-color: rgba(124, 58, 237, 0.4);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.2), inset 0 -2px 0 0 #7c3aed;
        }

        .replay-tabs-body {
            background: rgba(5, 0, 40, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            padding: 20px;
            height: 800px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 0 0 1px rgba(71, 85, 105, 0.1);
            overflow: hidden;
        }

        .replay-tab-panel {
            display: none;
            flex-direction: column;
            gap: 14px;
            height: 100%;
            overflow: hidden;
        }

        .replay-tab-panel.active {
            display: flex;
        }

        .replay-tab-scroller {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.4);
        }

        .replay-tab-scroller::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .replay-tab-scroller::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }

        .replay-tab-scroller::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.4);
            border-radius: 4px;
        }

        .replay-tab-scroller::-webkit-scrollbar-thumb:hover {
            background: rgba(124, 58, 237, 0.6);
        }

        .replay-tab-empty {
            font-size: 13px;
            font-weight: 500;
            color: rgba(148, 163, 184, 0.75);
            border: 1px dashed rgba(71, 85, 105, 0.6);
            border-radius: 12px;
            padding: 18px 14px;
            text-align: center;
            background: rgba(30, 41, 59, 0.5);
        }

        /* Analytics Panel Styles */
        .analytics-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            height: 100%;
            overflow-y: auto;
            background: transparent;
        }

        .analytics-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .analytics-stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #050028 !important;
            border-radius: 10px;
            border: 1px solid rgba(124, 58, 237, 0.25) !important;
        }

        .analytics-stat-card .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .analytics-stat-card .stat-icon svg {
            width: 18px;
            height: 18px;
        }

        .analytics-stat-card .stat-icon.profit {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .analytics-stat-card .stat-icon.loss {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .analytics-stat-card .stat-icon.neutral {
            background: rgba(124, 58, 237, 0.2);
            color: #a78bfa;
        }

        .analytics-stat-card .stat-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .analytics-stat-card .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-stat-card .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .analytics-stat-card .stat-value.profit { color: #22c55e; }
        .analytics-stat-card .stat-value.loss { color: #ef4444; }

        .analytics-metrics-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .analytics-metric-card {
            padding: 14px;
            background: #1e293b !important;
            border-radius: 10px;
            border: 1px solid rgba(78, 91, 126, 0.4) !important;
        }

        .analytics-metric-card .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .analytics-metric-card .metric-title {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
        }

        .analytics-metric-card .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .analytics-metric-card .metric-value.profit { color: #22c55e; }
        .analytics-metric-card .metric-value.loss { color: #ef4444; }

        .analytics-metric-card .metric-bar {
            height: 6px;
            background: rgba(78, 91, 126, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .analytics-metric-card .metric-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .analytics-metric-card .metric-bar-fill.win {
            background: #050028;
        }

        .analytics-metric-card .metric-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #64748b;
        }

        .analytics-metric-card .metric-details.single {
            justify-content: center;
        }

        .analytics-metric-card .metric-details .dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .analytics-metric-card .metric-details .dot.win { background: #22c55e; }
        .analytics-metric-card .metric-details .dot.loss { background: #ef4444; }

        .analytics-details-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .analytics-detail-card {
            padding: 16px;
            background: #1e293b !important;
            border-radius: 10px;
            border: 1px solid rgba(78, 91, 126, 0.4) !important;
        }

        .analytics-detail-card h4 {
            margin: 0 0 14px 0;
            font-size: 13px;
            font-weight: 600;
            color: #cbd5e1;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(78, 91, 126, 0.3);
        }

        .analytics-detail-card .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .analytics-detail-card .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .analytics-detail-card .detail-label {
            font-size: 11px;
            color: #64748b;
        }

        .analytics-detail-card .detail-value {
            font-size: 12px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .analytics-detail-card .detail-value.profit { color: #22c55e; }
        .analytics-detail-card .detail-value.loss { color: #ef4444; }

        /* Light mode analytics */
        body.light-mode .analytics-stat-card {
            background: #050028 !important;
            border-color: rgba(148, 163, 184, 0.3) !important;
        }

        body.light-mode .analytics-stat-card .stat-label {
            color: #64748b;
        }

        body.light-mode .analytics-stat-card .stat-value {
            color: #1e293b;
        }

        body.light-mode .analytics-metric-card,
        body.light-mode .analytics-detail-card {
            background: #f8fafc !important;
            border-color: rgba(148, 163, 184, 0.3) !important;
        }

        body.light-mode .analytics-metric-card .metric-title,
        body.light-mode .analytics-metric-card .metric-details {
            color: #64748b;
        }

        body.light-mode .analytics-metric-card .metric-value,
        body.light-mode .analytics-detail-card .detail-value {
            color: #1e293b;
        }

        body.light-mode .analytics-detail-card h4 {
            color: #334155;
        }

        body.light-mode .analytics-detail-card .detail-label {
            color: #64748b;
        }

        .replay-tabs-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start;
            align-items: center;
            font-size: 12px;
            color: rgba(148, 163, 184, 0.85);
            background: #050028;
            padding: 14px 18px;
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .replay-meta-item {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .replay-meta-item .label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            font-size: 11px;
            color: rgba(148, 163, 184, 0.75);
        }

        .replay-meta-item .value {
            font-weight: 700;
            font-size: 13px;
            color: #ffffff;
        }

        .replay-tab-section {
            margin-top: 16px;
        }

        .replay-tab-section:first-of-type {
            margin-top: 12px;
        }

        .replay-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #050028;
            border-bottom: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }

        .replay-section-title {
            font-size: 12px;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .replay-section-count {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            background: rgba(124, 58, 237, 0.25);
            color: #a78bfa;
            border-radius: 999px;
        }

        .order-btn--small {
            padding: 4px 8px;
            font-size: 11px;
            min-width: auto;
            margin: 0 2px;
        }

        .replay-tab-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
            color: #ffffff;
            border-radius: 8px;
            overflow: hidden;
        }

        .replay-tab-table thead {
            background: #050028;
        }

        .replay-tab-table th,
        .replay-tab-table td {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.4);
            text-align: left;
            white-space: nowrap;
        }

        .replay-tab-table th {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(148, 163, 184, 0.85);
            padding: 14px 14px;
            border-bottom: 2px solid rgba(71, 85, 105, 0.5);
        }

        .replay-tab-table tbody tr {
            transition: background 0.15s ease;
        }

        .replay-tab-table tbody tr:hover {
            background: rgba(51, 65, 85, 0.5);
        }

        .replay-tab-table tbody tr:last-child td {
            border-bottom: none;
        }

        .replay-cell-number {
            text-align: right;
        }

        .replay-cell-center {
            text-align: center;
        }

        .replay-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .replay-badge.buy {
            background: rgba(34, 197, 94, 0.15);
            color: #15803d;
        }

        .replay-badge.sell {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .replay-badge--buy {
            background: rgba(34, 197, 94, 0.15);
            color: #15803d;
        }

        .replay-badge--sell {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .replay-badge--closed {
            background: rgba(100, 116, 139, 0.15);
            color: #475569;
        }

        .replay-badge--open {
            background: rgba(59, 130, 246, 0.15);
            color: #1e40af;
        }

        .order-value--profit {
            color: #15803d;
            font-weight: 600;
        }

        .order-value--loss {
            color: #b91c1c;
            font-weight: 600;
        }

        .replay-tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 6px;
            background: rgba(148, 163, 184, 0.25);
            color: rgba(71, 85, 105, 0.9);
            font-size: 10px;
            font-weight: 700;
        }

        .replay-collapse-toggle {
            padding: 10px 18px;
            border-radius: 10px;
            background: rgba(40, 51, 74, 0.7);
            color: rgba(226, 232, 255, 0.9);
            font-size: 13px;
            font-weight: 600;
            cursor: default;
            transition: all 0.2s ease;
            border: 1px solid rgba(78, 91, 126, 0.3);
        }

        .replay-collapse-toggle:hover {
            background: rgba(55, 65, 91, 0.9);
            border-color: rgba(124, 58, 237, 0.4);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .replay-collapse-toggle .toggle-icon {
            display: inline-flex;
            margin-right: 6px;
            font-size: 16px;
            transition: transform 0.3s ease;
            transform: rotate(180deg); /* Default: arrow up (panels visible) */
        }

        .replay-tabs-container {
            width: 100%;
            height: auto;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.2s ease;
            opacity: 1;
            padding: 12px 0;
        }

        body.replay-tabs-collapsed .replay-tabs-container,
        body.replay-tabs-collapsed .replay-tabs-container *,
        body.replay-tabs-collapsed .replay-tabs-body,
        body.replay-tabs-collapsed .replay-tabs-nav,
        body.replay-tabs-collapsed .replay-tab-panel {
            max-height: 0 !important;
            min-height: 0 !important;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            opacity: 0 !important;
            overflow: hidden !important;
            display: none !important;
            border: none !important;
        }

        /* Collapsed state - compact single bar, no extra space */
        body.replay-tabs-collapsed .replay-toolbar {
            background: #050028 !important;
            border-top: 1px solid rgba(50, 50, 60, 0.9) !important;
            box-shadow: none !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 6px !important;
            padding: 2px 8px !important;
            height: 48px !important;
            min-height: 48px !important;
            max-height: 50px !important;
            bottom: 0 !important;
            top: auto !important;
        }

        body.replay-tabs-collapsed .replay-toolbar-content {
            min-height: 48px;
            gap: 10px;
            padding: 0 8px;
        }

        body.replay-tabs-collapsed .replay-compact-meta {
            position: static;
            display: flex !important;
        }

        body.replay-tabs-collapsed .replay-controls-group.replay-controls-right {
            position: absolute;
            right: 2px;
        }

        body.replay-tabs-collapsed .replay-toolbar button,
        body.replay-tabs-collapsed .replay-toolbar select {
            padding: 4px 7px;
            font-size: 10px;
        }

        body.replay-tabs-collapsed .replay-collapse-toggle .toggle-icon {
            transform: rotate(0deg); /* Collapsed: arrow down (panels hidden) */
        }

        body.replay-tabs-collapsed .speed-slider-control {
            gap: 8px;
        }

        body.replay-tabs-collapsed .speed-slider-track-container {
            width: 100px;
        }

        body.replay-tabs-collapsed .speed-slider-label .speed-rate {
            display: inline;
        }

        body.replay-tabs-collapsed .speed-slider-play-btn {
            width: 24px;
            height: 24px;
        }

        body.replay-tabs-collapsed .speed-slider-play-btn svg {
            width: 10px;
            height: 10px;
        }

        .replay-slider-wrapper input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 3px;
            border-radius: 999px;
            background: #050028;
            outline: none;
            cursor: default;
            transition: filter 0.15s ease;
        }

        .replay-slider-wrapper input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: default;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.25);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .replay-slider-wrapper input[type="range"]::-moz-range-thumb {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: default;
            border: none;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.25);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .replay-slider-wrapper input[type="range"]:hover::-webkit-slider-thumb,
        .replay-slider-wrapper input[type="range"]:hover::-moz-range-thumb {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.35);
        }

        .replay-toolbar-divider {
            width: 1px;
            height: 28px;
            background: rgba(78, 91, 126, 0.45);
        }

        /* Speed Selection Bar */
        .speed-select-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(30, 40, 55, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(78, 91, 126, 0.4);
        }

        .speed-select-label {
            font-size: 11px;
            font-weight: 600;
            color: #8a94a6;
            margin-right: 4px;
        }

        .speed-option {
            padding: 5px 10px;
            font-size: 11px;
            font-weight: 600;
            color: #a0a7b8;
            background: rgba(50, 60, 80, 0.5);
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: default;
            transition: all 0.15s ease;
            min-width: 36px;
        }

        .speed-option:hover {
            color: #ffffff;
            background: rgba(78, 91, 126, 0.6);
            border-color: rgba(0, 188, 212, 0.3);
        }

        .speed-option.active {
            color: #ffffff;
            background: #050028;
            border-color: #00bcd4;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
        }

        .speed-option[data-speed="0.5"] {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }

        .speed-option[data-speed="0.5"]:hover {
            background: rgba(255, 152, 0, 0.4);
        }

        .speed-option[data-speed="0.5"].active {
            background: #050028;
            color: #ffffff;
            border-color: #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.4);
        }

        /* Tick Progress Indicator */
        .tick-progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: rgba(30, 35, 45, 0.8);
            border-radius: 6px;
            border: 1px solid rgba(78, 91, 126, 0.3);
            min-width: 120px;
        }

        .tick-progress-bar {
            width: 100px;
            height: 6px;
            background: rgba(78, 91, 126, 0.3);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .tick-progress-fill {
            height: 100%;
            background: #050028;
            border-radius: 3px;
            transition: width 0.05s linear;
            width: 0%;
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.5);
        }

        .tick-progress-fill.animating {
            animation: tickPulse 0.5s ease infinite;
        }

        @keyframes tickPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Navigation Integrity Badge */
        .nav-integrity-badge {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            margin-left: 8px;
            pointer-events: auto;
        }

        .nav-badge-icon {
            position: relative;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            border-radius: 50%;
            background: rgba(74, 222, 128, 0.15);
        }

        .nav-badge-letters {
            font-size: 7px;
            font-weight: 700;
            letter-spacing: 0.3px;
            z-index: 2;
        }

        .nav-badge-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            stroke-width: 1.5;
        }

        .nav-integrity-badge.enabled .nav-badge-letters {
            color: #4ade80;
        }

        .nav-integrity-badge.enabled .nav-badge-circle {
            stroke: transparent;
        }

        .nav-integrity-badge.enabled .nav-badge-circle line {
            display: none;
        }

        .nav-integrity-badge.disabled .nav-badge-letters {
            color: #fca5a5;
        }

        .nav-integrity-badge.disabled .nav-badge-circle {
            stroke: #fca5a5;
        }

        /* Badge Tooltip */
        .nav-badge-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            padding: 10px 14px;
            background: rgba(5, 0, 40, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.5;
            color: #ffffff;
            white-space: nowrap;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .nav-badge-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid rgba(5, 0, 40, 0.98);
        }

        .nav-integrity-badge:hover .nav-badge-tooltip,
        .nav-integrity-badge.show-tooltip .nav-badge-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .nav-badge-tooltip strong {
            color: #ffffff;
        }

        .nav-badge-tooltip.enabled-tip strong {
            color: #4ade80;
        }

        .nav-badge-tooltip.disabled-tip strong {
            color: #fca5a5;
        }

        /* Session Info Panel */
        .session-info-panel {
            position: fixed;
            top: 50px;
            right: 60px;
            z-index: 999;
            background: #050028;
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .session-info-panel.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .session-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
        }

        .session-info-title {
            font-size: 13px;
            font-weight: 600;
            color: #e2e8ff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .session-info-title svg {
            width: 16px;
            height: 16px;
            stroke: #7c3aed;
        }

        .session-info-toggle {
            background: none;
            border: none;
            color: rgba(226, 232, 255, 0.6);
            cursor: default;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .session-info-toggle:hover {
            background: rgba(124, 58, 237, 0.2);
            color: #e2e8ff;
        }

        .session-info-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .session-info-label {
            color: rgba(226, 232, 255, 0.7);
            font-weight: 500;
        }

        .session-info-value {
            color: #e2e8ff;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .session-info-value.success {
            color: #4ade80;
        }

        .session-info-value.warning {
            color: #fbbf24;
        }

        .session-info-value.danger {
            color: #f87171;
        }

        .session-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-status-badge.active {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .session-status-badge.paused {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .session-status-badge.stopped {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .datetime-time-columns {
            flex: 0.9;
            display: flex;
            gap: 8px;
        }

        .datetime-time-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .datetime-time-label {
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 4px;
            text-align: center;
        }

        .datetime-time-values {
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            overflow-y: auto;
            max-height: 220px;
        }

        .datetime-time-value {
            font-size: 12px;
            padding: 4px 0;
            text-align: center;
            cursor: default;
            color: #4b5563;
        }

        .datetime-time-value:hover {
            background: #e5e7eb;
        }

        .datetime-time-value.selected {
            background: #5b21ff;
            color: #ffffff;
        }

        .datetime-picker-footer {
            padding: 8px 16px 10px;
            border-top: 1px solid #e0e3eb;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .datetime-btn {
            border-radius: 999px;
            border: none;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 500;
            cursor: default;
        }

        .datetime-btn-cancel {
            background: transparent;
            color: #6b7280;
        }

        .datetime-btn-ok {
            background: #5b21ff;
            color: #ffffff;
        }

        /* Timeframe Selector - Modern Style */
        .timeframe-btn {
            background: transparent;
            border: none;
            color: #d9deea;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: default;
            transition: background 0.15s ease, color 0.15s ease;
            min-width: 0;
            letter-spacing: 0.2px;
        }


        /* Timeframe Dropdown Menu */
        .timeframe-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .timeframe-selector#timeframeDropdown {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            position: relative;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 4px 8px;
            cursor: default;
            transition: all 0.15s ease;
        }

        .timeframe-selector#timeframeDropdown:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .timeframe-selector#timeframeDropdown:active {
            transform: translateY(0);
        }
        
        .timeframe-selector .timeframe-label {
            color: #d9deea;
            font-size: 12px;
            font-weight: 600;
            padding: 0;
            cursor: default;
            letter-spacing: 0.2px;
        }

        .timeframe-dropdown-trigger {
            background: transparent !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            color: #787b86;
            font-size: 12px;
            font-weight: 500;
            padding: 0 !important;
            margin: 0;
            cursor: default;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }

        .timeframe-dropdown-trigger:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .timeframe-dropdown-trigger:active {
            outline: none !important;
            box-shadow: none !important;
        }

        .timeframe-selector#timeframeDropdown:hover .timeframe-dropdown-trigger {
            color: #d9deea;
        }

        .timeframe-dropdown.open .timeframe-dropdown-trigger {
            color: #d9deea;
        }

        .timeframe-dropdown-trigger svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s ease;
        }

        .timeframe-dropdown.open .timeframe-dropdown-trigger svg {
            transform: rotate(180deg);
        }

        .timeframe-dropdown-menu,
        #timeframeDropdownMenu {
            position: fixed;
            top: auto;
            left: auto;
            background: #050028;
            border: 1px solid #2a2e39;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            min-width: 180px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 999999;
            display: none;
        }

        .timeframe-dropdown-section {
            background: #050028;
        }

        .timeframe-dropdown-section:last-child {
            border-bottom: none;
        }

        .timeframe-dropdown-section-header {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.15s ease;
            background: #050028;
        }

        .timeframe-dropdown-section-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .timeframe-dropdown-section-header svg {
            width: 12px;
            height: 12px;
            transition: transform 0.2s ease;
        }

        .timeframe-dropdown-section.collapsed .timeframe-dropdown-section-header svg {
            transform: rotate(-90deg);
        }

        .timeframe-dropdown-section-content {
            display: block;
        }

        .timeframe-dropdown-section.collapsed .timeframe-dropdown-section-content {
            display: none;
        }

        .timeframe-dropdown-item {
            padding: 10px 12px;
            font-size: 13px;
            color: #d9deea;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.15s ease;
            background: #050028;
        }

        .timeframe-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .timeframe-dropdown-item.selected {
            background: #2a2e39;
            color: #ffffff;
        }

        .timeframe-dropdown-item-star {
            width: 16px;
            height: 16px;
            color: #787b86;
            cursor: default;
            transition: color 0.15s ease;
            flex-shrink: 0;
        }

        .timeframe-dropdown-item-star:hover {
            color: #ffd54f;
        }

        .timeframe-dropdown-item-star.active {
            color: #ffd54f;
            fill: #ffd54f;
        }

        .timeframe-more {
            background: transparent;
            border: none;
            color: #787b86;
            padding: 4px 6px;
            border-radius: 12px;
            cursor: default;
            transition: background 0.15s ease, color 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .timeframe-more:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d9deea;
        }

        .timeframe-more svg {
            width: 14px;
            height: 14px;
        }

        .timeframe-selector:empty {
            display: none;
        }

        /* Custom Timeframe Button */
        .timeframe-custom-section {
            border-top: 1px solid #2a2e39;
            margin-top: 4px;
            padding-top: 4px;
        }

        .timeframe-custom-btn {
            color: #2962ff !important;
            font-weight: 600;
        }

        .timeframe-custom-btn:hover {
            background: rgba(41, 98, 255, 0.15) !important;
        }

        .timeframe-custom-btn svg {
            color: #2962ff;
        }

        /* Custom Timeframe Modal */
        .custom-timeframe-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000000;
            align-items: center;
            justify-content: center;
        }

        .custom-timeframe-modal.open {
            display: flex;
        }

        .custom-timeframe-content {
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 12px;
            padding: 24px;
            min-width: 320px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        .custom-timeframe-content h3 {
            margin: 0 0 20px 0;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .custom-timeframe-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .custom-timeframe-input {
            flex: 1;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 6px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s ease;
        }

        .custom-timeframe-input:focus {
            border-color: #2962ff;
        }

        .custom-timeframe-input::placeholder {
            color: #787b86;
        }

        .custom-timeframe-select {
            width: 120px;
            background: #050028;
            border: 1px solid #363a45;
            border-radius: 6px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 14px;
            outline: none;
            cursor: default;
        }

        .custom-timeframe-select:focus {
            border-color: #2962ff;
        }

        .custom-timeframe-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .custom-timeframe-actions button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: default;
            transition: all 0.15s ease;
        }

        /* ========================================
           UNIFIED BUTTON SYSTEM
           All buttons share consistent colors and reactions
           ======================================== */
        
        /* Base button styles */
        button {
            transition: all 0.15s ease;
        }

        /* Unified hover effect for all buttons */
        button:not(:disabled):not(.timeframe-dropdown-trigger):not(.tv-color-btn):not(.dropdown-arrow):not(.cursor-dropdown-arrow):not(.sidebar-timeframe-arrow):hover {
            background: rgba(255, 255, 255, 0.12) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        body.light-mode .sidebar-timeframe-arrow:hover {
            background: rgba(41, 98, 255, 0.12) !important;
            color: #2962ff !important;
        }

        /* Unified active/click effect */
        button:not(:disabled):not(.timeframe-dropdown-trigger):active {
            transform: translateY(0) scale(0.98);
        }

        /* Active state for toggle buttons */
        button.active {
            background: rgba(41, 98, 255, 0.25) !important;
            color: #2962ff !important;
            box-shadow: 0 0 0 1px rgba(41, 98, 255, 0.3) inset;
        }

        button.active:hover {
            background: rgba(41, 98, 255, 0.35) !important;
            box-shadow: 0 2px 8px rgba(41, 98, 255, 0.3), 0 0 0 1px rgba(41, 98, 255, 0.4) inset;
        }

        /* Prevent filter from affecting select dropdowns */
        select {
            transition: all 0.15s ease;
        }

        select:hover {
            filter: none !important;
        }

        .custom-timeframe-cancel {
            background: transparent;
            border: 1px solid #363a45;
            color: #787b86;
        }

        .custom-timeframe-cancel:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .custom-timeframe-apply {
            background: #2962ff;
            border: none;
            color: white;
        }

        .custom-timeframe-apply:hover {
            background: #1e53e5;
        }

        /* Custom Timeframe Modal - Light Mode */
        body.light-mode .custom-timeframe-content {
            background: #ffffff;
            border-color: #e0e3eb;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        body.light-mode .custom-timeframe-content h3 {
            color: #050028;
        }

        body.light-mode .custom-timeframe-input,
        body.light-mode .custom-timeframe-select {
            background: #f5f5f5;
            border-color: #e0e3eb;
            color: #050028;
        }

        body.light-mode .custom-timeframe-input:focus,
        body.light-mode .custom-timeframe-select:focus {
            border-color: #2962ff;
        }

        body.light-mode .custom-timeframe-input::placeholder {
            color: #787b86;
        }

        body.light-mode .custom-timeframe-cancel {
            border-color: #e0e3eb;
            color: #787b86;
        }

        body.light-mode .custom-timeframe-cancel:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #050028;
        }

        /* Auto-save Indicator */
        .autosave-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            font-size: 12px;
            color: #787b86;
            background: #f8f9fd;
            border-radius: 6px;
            border: 1px solid #e0e3eb;
        }

        .autosave-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #089981;
        }

        /* Tooltip for generic drawing tools (top toolbar) */
        .tool-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid #363a45;
            z-index: 1000;
        }

        /* Tooltip for sidebar tools - Fixed position like price axis */
        .left-sidebar .tool-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            border: 1px solid #363a45;
            z-index: 10001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            width: fit-content;
            height: fit-content;
            min-height: 0;
            max-width: 200px;
            display: block;
            line-height: 1.4;
        }

        .left-sidebar .tool-btn:hover::after {
            opacity: 1;
        }

        /* Hide tooltip for favorites toggle */
        #toggleFavoritesBar {
            margin-top: 0;
        }

        #toggleFavoritesBar.active {
            
            color: #f59e0b !important;
        }

        #toggleFavoritesBar::after {
            display: none !important;
        }

        /* Tooltip for group buttons */
        .tool-group-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: calc(100% + 4px);
            transform: translateX(-50%);
            background: #050028;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            border: 1px solid #363a45;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .tool-group-btn:hover::after {
            opacity: 1;
        }

        /* Hide tooltip when dropdown is open */
        .tool-group-btn.dropdown-open::after,
        .tool-group-btn.dropdown-open:hover::after {
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* Hide tooltip for cursor dropdown arrow */
        .cursor-dropdown-arrow::after {
    display: none !important;
}

.cursor-dropdown-arrow {
    z-index: 1000001;
}

/* Left Sidebar - Inline in main toolbar */
.left-sidebar {
    position: static !important;
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    height: 44px !important;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin: 0 !important;
    gap: 4px !important;
    overflow: visible !important;
}

/* Hide divider inside left-sidebar */
.left-sidebar > .divider:first-child {
    display: none !important;
}

/* Ensure tool dropdowns are visible */
.left-sidebar .tool-group {
    overflow: visible !important;
}

.left-sidebar .tool-dropdown {
    z-index: 10000 !important;
}

.toolbox-handle {
    display: none;
}

.drawing-tools-vertical {
    display: flex;
    flex-direction: row;
    align-items: center;
    flex: 1;
    padding: 0;
    gap: 2px;
    overflow: visible;
    height: 100%;
    cursor: default;
}


.drawing-tools-vertical .tool-btn {
    width: 34px;
    height: 34px;
    min-width: 34px;
    max-width: 34px;
    border: none;
    background: transparent;
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: default;
    transition: all 0.15s ease;
    position: relative;
    pointer-events: auto;
    overflow: visible;
    border-radius: 4px;
    flex-shrink: 0;
    outline: none !important;
}

.drawing-tools-vertical .tool-btn:focus,
.drawing-tools-vertical .tool-btn:focus-visible,
.tool-group-btn:focus,
.tool-group-btn:focus-visible,
.toolbar-icon-btn:focus,
.toolbar-icon-btn:focus-visible {
    outline: none !important;
    box-shadow: none !important;
}

.drawing-tools-vertical .tool-btn:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #ffffff;
}

.drawing-tools-vertical .tool-btn.active {
    background: rgba(47, 114, 255, 0.25);
    color: #ffffff;
}

.drawing-tools-vertical .tool-btn.active::before {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    right: 0;
    height: 3px;
    width: 100%;
    background: #050028;
}

.drawing-tools-vertical .tool-btn svg {
    width: 18px;
    height: 18px;
    stroke-width: 1.5;
}
          
        .tool-divider {
            width: 1px;
            height: 24px;
            margin: 0px;
            background: rgba(120, 123, 134, 0.3);
            border-radius: 1px;
        }

        /* Tool Groups and Dropdowns */
        .tool-group {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Prevent cursor tool from moving on click */
        #cursorTool {
            transform: none !important;
        }
        
        #cursorTool:active {
            transform: none !important;
        }

        .tool-group-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            max-width: 34px;
            border: none;
            background: transparent;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.15s ease;
            position: relative;
            overflow: visible;
            border-radius: 4px;
            flex-shrink: 0;
            z-index: 1;
            outline: none !important;
        }
        
        .tool-group-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #a0aec0;
        }

        /* Unified button alignment in toolbar */
        .left-sidebar .tool-group,
        .left-sidebar .tool-btn,
        .left-sidebar .tool-group-btn,
        .toolbar-drawing-icons .toolbar-icon-btn {
            vertical-align: middle;
        }

        /* Ensure ALL toolbar buttons have exact same size */
        .toolbar-icon-btn,
        .tool-group-btn,
        .drawing-tools-vertical .tool-btn {
            width: 34px !important;
            height: 34px !important;
            min-width: 34px !important;
            max-width: 34px !important;
            min-height: 34px !important;
            max-height: 34px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }

        /* Exception for buttons with labels */
        .toolbar-icon-btn.with-label {
            width: auto !important;
            max-width: none !important;
            padding: 0 12px !important;
        }

        /* Ensure all toolbar buttons have same SVG size */
        .drawing-tools-vertical .tool-btn svg,
        .drawing-tools-vertical .tool-group-btn svg,
        .toolbar-drawing-icons .toolbar-icon-btn svg,
        .toolbar-icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .drawing-tools-vertical .tool-btn svg,
        .drawing-tools-vertical .tool-group-btn svg,
        .toolbar-drawing-icons .toolbar-icon-btn svg,
        .toolbar-icon-btn svg,
        .toolbar-icon-btn-dark svg,
        .toolbar-icon-btn-light svg,
        .tool-group-btn svg,
        .tool-btn svg {
            stroke-width: 1.5 !important;
        }

        /* Align tool groups in horizontal toolbar */
        .left-sidebar .drawing-tools-vertical {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .left-sidebar .tool-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* Remove old dropdown arrow indicators - now using separate buttons */

        /* Dropdown arrow buttons for all tool groups */
        .cursor-dropdown-arrow,
        .dropdown-arrow {
            width: 32px;
            height: 10px;
            border: none;
            background: rgba(0, 0, 0, 0.92);
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default !important;
            pointer-events: auto !important;
            transition: background 0.15s ease, color 0.15s ease, opacity 0.15s ease;
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            margin: 0 auto;
            border-radius: 0 0 4px 4px;
            padding: 0;
            opacity: 0;
            z-index: 100000;
            border: 1px solid rgba(63, 84, 124, 0.35);
            border-top: none;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .dropdown-arrow svg {
            width: 12px;
            height: 8px;
        }
        
        /* Create invisible bridge between button and arrow to maintain hover - only active when arrow is visible */
        .cursor-dropdown-arrow::before,
        .dropdown-arrow::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 0;
            right: 0;
            height: 5px;
            background: transparent;
            pointer-events: none;
        }
        
        .cursor-dropdown-arrow:hover::before,
        .dropdown-arrow:hover::before,
        .cursor-dropdown-arrow.dropdown-open::before,
        .dropdown-arrow.dropdown-open::before {
            pointer-events: auto;
        }
        
        .cursor-dropdown-arrow:active,
        .dropdown-arrow:active {
            transform: none !important;
        }

        /* Show arrows when hovering main button or arrow itself */
        .tool-group-btn:hover ~ .cursor-dropdown-arrow,
        .tool-group-btn:hover ~ .dropdown-arrow,
        .replay-stat-toggle:hover ~ .dropdown-arrow,
        .cursor-dropdown-arrow:hover,
        .dropdown-arrow:hover {
            opacity: 1 !important;
        }
        
        .cursor-dropdown-arrow:hover,
        .dropdown-arrow:hover {
            background: rgba(41, 98, 255, 0.15);
            color: #a0aec0;
        }
        
        /* Ensure visibility when dropdown is open */
        .cursor-dropdown-arrow.dropdown-open,
        .dropdown-arrow.dropdown-open {
            opacity: 1 !important;
        }
        
        /* Rotate arrow when dropdown is open */
        .dropdown-arrow.dropdown-open svg {
            transform: rotate(180deg);
            transition: transform 0.2s ease;
        }
        
        .cursor-dropdown-arrow.dropdown-open {
            background: rgba(41, 98, 255, 0.15);
            color: #a0aec0;
            opacity: 1;
            pointer-events: auto;
        }

        .cursor-dropdown-arrow svg {
            width: 10px;
            height: 10px;
        }

        /* Light mode styles for all dropdown arrows */
        body.light-mode .cursor-dropdown-arrow,
        body.light-mode .dropdown-arrow {
            background: rgba(255, 255, 255, 0.9);
            color: #787b86;
            border-color: #e0e3eb;
        }

        body.light-mode .cursor-dropdown-arrow:hover,
        body.light-mode .dropdown-arrow:hover {
            background: rgba(41, 98, 255, 0.12);
            color: #2962ff;
        }

        body.light-mode .cursor-dropdown-arrow.dropdown-open,
        body.light-mode .dropdown-arrow.dropdown-open {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }


        .tool-group-btn.active {
            background: rgba(47, 114, 255, 0.25);
            color: #a0aec0;
        }
        
        /* Remove active state from cursor tool when dropdown arrow is open */
        .tool-group:has(.cursor-dropdown-arrow.dropdown-open) #cursorTool.active {
            background: transparent;
        }
        
        body.light-mode .tool-group:has(.cursor-dropdown-arrow.dropdown-open) #cursorTool.active {
            background: transparent;
        }

        .tool-group-btn svg {
            width: 18px;
            height: 18px;
        }

        .tool-dropdown {
            position: fixed;
            top: 48px;
            left: 0;
            background: #050028;
            border: 1px solid rgba(50, 50, 60, 0.9);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            min-width: 50px;
            z-index: 100000;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .tool-dropdown.show {
            display: flex;
        }
        
        /* Scrollbar styling for dropdown */
        .tool-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        
        .tool-dropdown::-webkit-scrollbar-track {
            background: rgba(30, 33, 42, 0.5);
            border-radius: 3px;
        }
        
        .tool-dropdown::-webkit-scrollbar-thumb {
            background: rgba(100, 110, 140, 0.5);
            border-radius: 3px;
        }
        
        .tool-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 110, 140, 0.8);
        }

        .tool-dropdown .tool-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-bottom: 1px solid rgba(34, 41, 55, 0.85);
            background: transparent;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.15s ease;
            position: relative;
        }

        .tool-dropdown .tool-btn:last-child {
            border-bottom: none;
        }


        .tool-dropdown .tool-btn.active {
            background: rgba(40, 88, 210, 0.25);
            color: #ffffff;
        }

        .tool-dropdown .tool-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Wide dropdown for tools with labels */
        .tool-dropdown-wide {
            min-width: 180px !important;
        }

        /* Cursor Dropdown Styles */
        .cursor-dropdown {
            min-width: 200px !important;
            padding: 6px 0 !important;
        }

        .cursor-option {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: #ffffff;
            cursor: default;
            transition: all 0.15s ease;
            font-size: 13px;
            text-align: left;
        }

        .cursor-option:hover {
            background: rgba(46, 55, 76, 0.65);
            color: #ffffff;
        }

        .cursor-option.selected {
            background: rgba(40, 88, 210, 0.2);
            color: #ffffff;
        }
        
        /* Remove selected state from cursor options when dropdown arrow is open */
        .tool-group:has(.cursor-dropdown-arrow.dropdown-open) .cursor-option.selected {
            background: transparent;
        }

        .cursor-option svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .cursor-option span {
            font-weight: 500;
        }

        body.light-mode .cursor-option {
            color: #4a5568;
        }

        body.light-mode .cursor-option:hover {
            background: rgba(0, 0, 0, 0.06);
            color: #1a202c;
        }

        body.light-mode .cursor-option.selected {
            background: rgba(40, 88, 210, 0.15);
            color: #2858d2;
        }

        .cursor-option {
            position: relative;
        }

        .cursor-option .tool-favorite-star {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            background: transparent;
            border: none;
            padding: 0;
        }

        .cursor-option .tool-favorite-star svg {
            width: 14px;
            height: 14px;
            color: #787b86;
        }

        .cursor-option:hover .tool-favorite-star {
            opacity: 1;
        }

        .cursor-option .tool-favorite-star:hover svg {
            color: #ffd54f;
        }

        .cursor-option .tool-favorite-star.active {
            opacity: 1;
        }

        .cursor-option .tool-favorite-star.active svg {
            color: #ffd54f;
            fill: #ffd54f;
        }

        /* Shortcut styling for cursor options */
        .cursor-option-shortcut {
            margin-left: auto;
            margin-right: 28px;
            font-size: 12px;
            color: rgba(255,255,255,0.35);
            font-weight: 400;
        }

        /* Magnet dropdown item styles */
        .tool-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: #ffffff;
            cursor: default;
            transition: all 0.15s ease;
            font-size: 13px;
            text-align: left;
            position: relative;
        }

        .tool-dropdown-item:hover {
            background: rgba(46, 55, 76, 0.65);
            color: #ffffff;
        }

        .tool-dropdown-item.active {
            background: rgba(40, 88, 210, 0.25);
            color: #ffffff;
        }

        .tool-dropdown-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .tool-dropdown-item span {
            font-weight: 500;
        }

        body.light-mode .tool-dropdown-item {
            color: #4a5568;
        }

        body.light-mode .tool-dropdown-item:hover {
            background: rgba(0, 0, 0, 0.06);
            color: #1a202c;
        }

        body.light-mode .tool-dropdown-item.active {
            background: rgba(40, 88, 210, 0.15);
            color: #2858d2;
        }

        /* Hide favorite stars in magnet dropdown and magnet button */
        #magnetDropdown .tool-favorite-star,
        #magnetDropdown .tool-dropdown-item .tool-favorite-star,
        .tool-dropdown-item[data-magnet] .tool-favorite-star,
        #magnetMode .tool-favorite-star {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Magnet dropdown specific positioning */
        #magnetDropdown {
            position: fixed;
            left: auto !important;
            right: auto !important;
        }
        
        .magnet-dropdown {
            padding: 6px 0;
        }
        
        .magnet-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 6px 10px;
        }
        
        .magnet-toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 13px;
            cursor: default;
        }
        
        .magnet-toggle-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .magnet-toggle {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        
        .magnet-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .magnet-toggle-slider {
            position: absolute;
            cursor: default;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #363a45;
            transition: 0.2s;
            border-radius: 20px;
        }
        
        .magnet-toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: #787b86;
            transition: 0.2s;
            border-radius: 50%;
        }
        
        .magnet-toggle input:checked + .magnet-toggle-slider {
            background-color: #2962ff;
        }
        
        .magnet-toggle input:checked + .magnet-toggle-slider:before {
            transform: translateX(16px);
            background-color: white;
        }

        /* Magnet split button design */
        .magnet-split-btn {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 34px;
            width: 34px;
        }
        
        .magnet-split-btn .magnet-main {
            width: 28px !important;
            height: 28px !important;
            min-width: 28px !important;
            max-width: 28px !important;
            border-radius: 6px;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-sizing: border-box !important;
            background: transparent;
            transition: all 0.15s ease;
        }
        
        .magnet-split-btn .magnet-main svg {
            width: 18px !important;
            height: 18px !important;
            flex-shrink: 0;
        }
        
        .magnet-split-btn .magnet-main.active {
            background: rgba(47, 114, 255, 0.25) !important;
            color: #2962ff !important;
            border-radius: 6px;
        }
        
        .magnet-split-btn .magnet-arrow {
            width: 10px !important;
            height: 28px !important;
            min-width: 10px !important;
            padding: 0 !important;
            margin: 0 !important;
            margin-left: -2px !important;
            background: transparent;
            border: none;
            border-radius: 0;
            cursor: default;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: #787b86;
            transition: all 0.15s ease;
            box-sizing: border-box !important;
        }
        
        .magnet-split-btn .magnet-arrow svg {
            flex-shrink: 0;
            transform: rotate(-90deg);
        }
        
        .magnet-split-btn .magnet-arrow:hover {
            color: #ffffff;
        }
        
        .magnet-split-btn .magnet-main.active + .magnet-arrow {
            color: #2962ff;
        }
        
        .magnet-split-btn .magnet-main,
        .magnet-split-btn .magnet-arrow {
            pointer-events: auto !important;
            cursor: default !important;
        }

        /* Sidebar magnet arrow styles */
        .magnet-arrow-sidebar {
            width: 34px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #787b86;
            cursor: default;
            margin-top: -4px;
        }

        .magnet-arrow-sidebar:hover {
            color: #ffffff;
        }

        .magnet-split-btn-sidebar .magnet-main.active ~ .magnet-arrow-sidebar {
            color: #2962ff;
        }

        /* Eraser mode visual feedback */
        .eraser-mode .drawing,
        .eraser-mode .drawing *,
        .eraser-mode .drawing:hover,
        .eraser-mode .drawing:hover *,
        .eraser-mode g[data-id],
        .eraser-mode g[data-id] *,
        .eraser-mode g[data-id]:hover,
        .eraser-mode g[data-id]:hover * {
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2'%3E%3Cpath d='M20 20H7L3 16c-.6-.6-.6-1.5 0-2.1l10-10c.6-.6 1.5-.6 2.1 0l7 7c.6.6.6 1.5 0 2.1L14 21'/%3E%3C/svg%3E") 0 24, default !important;
            pointer-events: all !important;
        }

        .eraser-mode .drawing:hover,
        .eraser-mode g[data-id]:hover {
            opacity: 0.5 !important;
        }

        .eraser-mode .drawing:hover *,
        .eraser-mode g[data-id]:hover * {
            stroke: #ff4444 !important;
        }

        .tool-btn-with-label {
            width: auto !important;
            padding: 0 12px !important;
            justify-content: flex-start !important;
            gap: 10px !important;
        }

        .tool-btn-with-label svg {
            flex-shrink: 0;
        }

        .tool-label {
            font-size: 12px;
            font-weight: 500;
            color: #ffffff;
            white-space: nowrap;
        }

        .tool-btn-with-label:hover .tool-label {
            color: #ffffff;
        }

        /* List Dropdown for grouped tools - TradingView Style */
        .tool-dropdown-grid {
            min-width: 280px !important;
            max-width: 380px !important;
            padding: 8px 0 !important;
            background: #050028 !important;
            border: 1px solid rgba(50, 50, 60, 0.9) !important;
            border-radius: 6px !important;
        }

        .tool-dropdown-section {
            margin-bottom: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding-bottom: 4px;
            margin-bottom: 4px;
        }

        .tool-dropdown-section:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .tool-dropdown-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #6b7280;
            padding: 12px 16px 6px;
            letter-spacing: 0.8px;
        }

        .tool-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 6px 0;
        }

        body.light-mode .tool-dropdown-divider {
            background: rgba(0, 0, 0, 0.1);
        }

        .tool-dropdown-row {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .tool-dropdown-grid .tool-btn {
            width: 100% !important;
            min-width: 100% !important;
            box-sizing: border-box !important;
            height: 44px !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 0 40px 0 16px !important;
            justify-content: flex-start !important;
            gap: 12px !important;
            display: flex !important;
            align-items: center !important;
            position: relative !important;
            flex-shrink: 0 !important;
            flex-direction: row !important;
        }

        .tool-dropdown-grid .tool-btn {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        .tool-dropdown-grid .tool-btn:hover {
            background: rgba(41, 98, 255, 0.15) !important;
        }
        
        .tool-dropdown-grid .tool-btn:active {
            background: rgba(41, 98, 255, 0.15) !important;
        }
        
        /* Allow active state on visibility dropdown items */
        #visibility-toolbar-dropdown .tool-btn.active {
            background: rgba(47, 114, 255, 0.25) !important;
            color: #ffffff !important;
        }
        
        /* Allow active state on delete dropdown items */
        #delete-toolbar-dropdown .tool-btn.active {
            background: rgba(47, 114, 255, 0.25) !important;
            color: #ffffff !important;
        }
        
        #visibility-toolbar-dropdown .tool-btn:hover,
        #delete-toolbar-dropdown .tool-btn:hover {
            background: rgba(41, 98, 255, 0.15) !important;
        }
        
        /* Hide favorite stars in visibility and delete dropdowns */
        #visibility-toolbar-dropdown .tool-favorite-star,
        #delete-toolbar-dropdown .tool-favorite-star {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        /* Hide favorite stars on the main visibility and delete buttons */
        #toggleAllDrawingsToolbar .tool-favorite-star,
        #deleteAllDrawingsToolbar .tool-favorite-star {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .tool-dropdown-grid .tool-btn > svg:first-child {
            width: 24px !important;
            height: 24px !important;
            min-width: 24px !important;
            min-height: 24px !important;
            flex-shrink: 0 !important;
            order: 1;
            opacity: 0.85;
            display: block !important;
            margin: 0 !important;
        }

        .tool-dropdown-grid .tool-btn .tool-favorite-star svg {
            width: 16px !important;
            height: 16px !important;
        }

        /* Override tooltip to show inline label instead of floating */
        .tool-dropdown-grid .tool-btn::after {
            content: attr(data-tooltip);
            position: static !important;
            transform: none !important;
            margin-left: 0 !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            opacity: 1 !important;
            pointer-events: none !important;
            font-size: 14px;
            font-weight: 400;
            color: #d1d5db;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            max-width: 200px;
            order: 2 !important;
            letter-spacing: 0.2px;
            text-align: left !important;
        }

        .tool-dropdown-grid .tool-btn:hover::after {
            color: #ffffff;
            opacity: 1 !important;
        }

        .tool-dropdown-grid .tool-btn.active::after {
            color: #2962ff;
        }

        /* Light mode for list dropdown */
        body.light-mode .tool-dropdown-grid {
            background: #ffffff !important;
            border: 1px solid #e0e3eb !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn {
            color: #050028 !important;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn:hover {
            background: rgba(41, 98, 255, 0.08) !important;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn.active {
            background: rgba(41, 98, 255, 0.12) !important;
        }
        
        
        /* Light mode - allow active state on visibility dropdown */
        body.light-mode #visibility-toolbar-dropdown .tool-btn.active {
            background: rgba(41, 98, 255, 0.15) !important;
            color: #2962ff !important;
            box-shadow: none !important;
        }
        
        /* Light mode - allow active state on delete dropdown */
        body.light-mode #delete-toolbar-dropdown .tool-btn.active {
            background: rgba(41, 98, 255, 0.15) !important;
            color: #2962ff !important;
            box-shadow: none !important;
        }
        
        body.light-mode #visibility-toolbar-dropdown .tool-btn:hover,
        body.light-mode #delete-toolbar-dropdown .tool-btn:hover {
            background: rgba(41, 98, 255, 0.08) !important;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn > svg:first-child {
            opacity: 0.8;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn::after {
            color: #475569;
        }

        body.light-mode .tool-dropdown-grid .tool-btn:hover::after {
            color: #1e293b;
        }

        body.light-mode .tool-dropdown-grid .tool-btn.active::after {
            color: #2962ff;
        }

        body.light-mode .tool-dropdown-section {
            border-bottom-color: rgba(0, 0, 0, 0.08);
        }
        
        body.light-mode .tool-dropdown-label {
            color: #6b7280 !important;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn .tool-favorite-star svg {
            color: #787b86;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn .tool-favorite-star:hover svg {
            color: #ffd54f;
        }
        
        body.light-mode .tool-dropdown-grid .tool-btn .tool-favorite-star.active svg {
            color: #ffd54f;
            fill: #ffd54f;
        }

        /* Favorites Toolbar - TradingView Style */
        .favorites-toolbar {
            position: fixed;
            left: 56px;
            top: 44px;
            height: 48px;
            background: #ffffff;
            border: 1px solid #e0e3eb;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 4px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: box-shadow 0.2s ease;
        }

        /* Dark mode favorites toolbar */
        body:not(.light-mode) .favorites-toolbar {
            background: var(--tv-panel-bg);
            border-color: rgba(63, 84, 124, 0.35);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .favorites-toolbar.dragging {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            opacity: 0.95;
            z-index: 10001;
        }

        .favorites-drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            color: #b2b5be;
            cursor: move;
            margin-right: 6px;
            flex-shrink: 0;
        }

        body:not(.light-mode) .favorites-drag-handle {
            color: #5d606b;
        }

        .favorites-drag-handle:active {
            cursor: move;
        }

        .favorites-drag-handle svg {
            width: 16px;
            height: 16px;
        }

        .favorites-tools {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .favorites-tools::-webkit-scrollbar {
            height: 3px;
        }

        .favorites-tools::-webkit-scrollbar-track {
            background: transparent;
        }

        .favorites-tools::-webkit-scrollbar-thumb {
            background: rgba(70, 70, 70, 0.5);
            border-radius: 2px;
        }

        .favorite-tool-btn {
            position: relative;
            width: 38px;
            height: 38px;
            border: none;
            background: transparent;
            color: #1e1e1e;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.15s ease;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .favorite-tool-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .favorite-tool-btn.active {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }

        /* Dark mode favorite tools */
        body:not(.light-mode) .favorite-tool-btn {
            color: #ffffff;
        }

        body:not(.light-mode) .favorite-tool-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }
        
        body:not(.light-mode) .favorite-tool-btn.active {
            background: rgba(41, 98, 255, 0.2);
            color: #2962ff;
        }

        .favorite-tool-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.5;
        }

        .favorite-tool-remove {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 14px;
            height: 14px;
            background: #f23645;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: default;
            border: 1px solid #050028;
        }

        .favorite-tool-remove svg {
            width: 8px;
            height: 8px;
            stroke-width: 3;
            color: #ffffff;
        }

        .favorite-tool-btn:hover .favorite-tool-remove {
            display: none;
        }

        /* Star button for adding to favorites in dropdowns */
        .tool-favorite-star {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: default;
            z-index: 10;
            border: 1px solid rgba(70, 70, 70, 0.5);
        }

        /* Star in list dropdown - matches timeframe dropdown star style exactly */
        .tool-dropdown-grid .tool-btn .tool-favorite-star {
            position: absolute !important;
            right: 12px !important;
            left: auto !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: transparent !important;
            border: none !important;
            width: 16px !important;
            height: 16px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            pointer-events: auto !important;
            z-index: 200 !important;
            cursor: default !important;
            flex-shrink: 0;
        }

        .tool-dropdown-grid .tool-btn:hover .tool-favorite-star {
            opacity: 1;
        }

        /* Match timeframe-dropdown-item-star styling exactly */
        .tool-dropdown-grid .tool-btn .tool-favorite-star svg {
            width: 16px !important;
            height: 16px !important;
            color: #787b86;
            cursor: default;
            transition: color 0.15s ease;
            flex-shrink: 0;
        }

        .tool-dropdown-grid .tool-btn .tool-favorite-star:hover svg {
            color: #ffd54f !important;
        }

        .tool-dropdown-grid .tool-btn .tool-favorite-star.active svg {
            color: #ffd54f !important;
            fill: #ffd54f !important;
        }

        .tool-favorite-star svg {
            width: 16px;
            height: 16px;
            color: #787b86;
            cursor: default;
            transition: color 0.15s ease;
            flex-shrink: 0;
        }

        .tool-favorite-star:hover svg {
            color: #ffd54f;
        }

        .tool-favorite-star.active svg {
            color: #ffd54f;
            fill: #ffd54f;
        }

        .tool-btn:hover .tool-favorite-star,
        .tool-group-btn:hover .tool-favorite-star {
            display: flex;
        }

        .tool-favorite-star.active {
            display: flex;
        }

        /* Drawing Toolbar - Floating toolbar when drawing is selected */
        .drawing-toolbar {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-separator {
            border-left: 1px solid #e0e3eb;
            padding-left: 8px;
            margin-left: 4px;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            transition: all 0.15s ease;
            padding: 4px;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .toolbar-btn.active {
            background: rgba(47, 114, 255, 0.25);
            color: #ffffff;
        }

        .toolbar-btn-danger:hover {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
        }

        .toolbar-btn svg {
            width: 18px;
            height: 18px;
        }
        
        body.light-mode .toolbar-btn {
            color: #050028;
        }
        
        body.light-mode .toolbar-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #000000;
        }
        
        body.light-mode .toolbar-btn.active {
            background: rgba(41, 98, 255, 0.15);
            color: #2962ff;
        }
        
        body.light-mode .toolbar-btn-danger:hover {
            background: #ffebee;
            color: #f23645;
        }

        .toolbar-text {
            font-size: 13px;
            font-weight: 500;
            color: #050028;
            white-space: nowrap;
            margin-left: 4px;
        }

        .toolbar-color-btn {
            position: relative;
            border-bottom: 3px solid transparent !important;
        }

        .toolbar-color-btn:hover {
            background: transparent !important;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            overflow: hidden;
            background: #050028;
            margin-left: 0;
            margin-top: 0;
            flex: 1 1 auto;
            min-height: 250px;
            min-width: 350px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
            border: none !important;
            border-right: none !important;
            border-left: none !important;
        }

        #chart-container {
            position: absolute;
            top: 0;
            left: 46px;
            right: 0;
            bottom: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        #chart-container canvas,
        #chart-container * {
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .chart-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: right 0.28s cubic-bezier(.4,0,.2,1);
        }
        .chart-wrapper.settings-open {
            right: 420px;
        }

        .toolbar-logo {
            display: flex;
            align-items: center;
            padding: 0;
            margin: 0;
            text-decoration: none;
            cursor: default;
            transition: opacity 0.2s;
        }

        .toolbar-logo:hover {
            opacity: 0.8;
        }

        .toolbar-logo img {
            height: 24px;
            width: auto;
            display: block;
        }

        .chart-brand {
            position: absolute;
            left: 0px;
            bottom: 15px;
            display: block;
            pointer-events: none;
            z-index: 5;
        }

        .chart-brand img {
            height: 100px;
            width: auto;
            display: block;
            opacity: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        /* Dark theme: show white logo (logo-05), hide black logo */
        .chart-brand .logo-dark {
            display: block;
        }
        .chart-brand .logo-light {
            display: none;
        }
        
        /* Light theme: show black logo (logo-06), hide white logo */
        body.light-theme .chart-brand .logo-dark {
            display: none;
        }
        body.light-theme .chart-brand .logo-light {
            display: block;
        }

        /* Layout Dropdown - Compact TradingView Style */
        .layout-dropdown {
            position: fixed;
            background: #050028;
            color: #ffffff;
            border: 1px solid #363a45;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            padding: 16px;
        }

        .layout-dropdown-title {
            color: #ffffff;
        }
        
        .layout-dropdown .layout-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 6px;
        }
        
        .layout-dropdown .layout-num {
            font-size: 12px;
            color: #787b86;
            margin-bottom: 6px;
            min-width: 16px;
        }

        .layout-dropdown .sync-section {
            border-top: 1px solid #363a45;
            margin-top: 16px;
            padding-top: 16px;
        }

        .layout-dropdown .sync-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 13px;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layout-dropdown .sync-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .layout-dropdown .sync-row-border {
            border-top: 1px solid #363a45;
            margin-top: 4px;
        }

        .layout-dropdown .sync-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #ffffff;
        }

        .layout-dropdown .sync-info {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #363a45;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            font-size: 10px;
            color: #787b86;
            min-width: 16px;
            text-align: right;
            margin-right: 4px;
        }
        
        .layout-dropdown .layout-icons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .layout-dropdown .layout-option {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px;
            cursor: default;
            color: #787b86;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .layout-dropdown .layout-option:hover {
            background: rgba(255,255,255,0.05);
            color: #ffffff;
        }
        
        .layout-dropdown .layout-option.active {
            border-color: #2962ff;
            color: #2962ff;
        }
        
        .layout-dropdown .layout-option svg {
            width: 28px;
            height: 20px;
        }
        
        .layout-dropdown .sync-section {
            border-top: 1px solid #363a45;
            margin-top: 8px;
            padding-top: 10px;
        }
        
        .layout-dropdown .sync-title {
            font-size: 11px;
            font-weight: 500;
            color: #787b86;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .layout-dropdown .sync-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
        }
        
        .layout-dropdown .sync-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #ffffff;
        }
        
        .layout-dropdown .sync-info {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #363a45;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #787b86;
            cursor: help;
        }
        
        /* Toggle Switch */
        .sync-toggle {
            position: relative;
            width: 36px;
            height: 20px;
        }
        
        .sync-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .sync-toggle-slider {
            position: absolute;
            cursor: default;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #363a45;
            border-radius: 10px;
            transition: 0.2s;
        }
        
        .sync-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background: #787b86;
            border-radius: 50%;
            transition: 0.2s;
        }
        
        .sync-toggle input:checked + .sync-toggle-slider {
            background: #2962ff;
        }
        
        .sync-toggle input:checked + .sync-toggle-slider:before {
            transform: translateX(16px);
            background: white;
        }
        
        /* Light Mode Support for Layout Dropdown */
        body.light-mode .layout-dropdown {
            background: #ffffff;
            color: #050028;
            border-color: #e0e3eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        body.light-mode .layout-dropdown .layout-num {
            color: #787b86;
        }
        
        body.light-mode .layout-dropdown .layout-option {
            color: #787b86;
        }
        
        body.light-mode .layout-dropdown .layout-option:hover {
            background: rgba(0,0,0,0.05);
            color: #050028;
        }
        
        body.light-mode .layout-dropdown .layout-option.active {
            border-color: #2962ff;
            color: #2962ff;
        }
        
        body.light-mode .layout-dropdown .sync-section {
            border-color: #e0e3eb;
        }
        
        body.light-mode .layout-dropdown .sync-title {
            color: #787b86;
        }
        
        body.light-mode .layout-dropdown .sync-label {
            color: #050028;
        }
        
        body.light-mode .layout-dropdown .sync-info {
            background: #e0e3eb;
            color: #787b86;
        }
        
        body.light-mode .sync-toggle-slider {
            background: #e0e3eb;
        }
        
        body.light-mode .sync-toggle-slider:before {
            background: #787b86;
        }
        
        body.light-mode .sync-toggle input:checked + .sync-toggle-slider {
            background: #2962ff;
        }
        
        body.light-mode .sync-toggle input:checked + .sync-toggle-slider:before {
            background: #ffffff;
        }
        
        body.light-mode .layout-dropdown-title {
            color: #050028;
        }

        body.light-mode .layout-dropdown .sync-section {
            border-color: #e0e3eb;
        }

        body.light-mode .layout-dropdown .sync-row-border {
            border-color: #e0e3eb;
        }

        body.light-mode .layout-dropdown .sync-label {
            color: #050028;
        }

        body.light-mode .layout-dropdown .sync-info {
            background: #e0e3eb;
            color: #787b86;
        }

        #chartCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
            user-select: none;
            transition: none;
            z-index: 1;
        }
        
        #chartCanvas.cursor-price-axis {
            cursor: ns-resize !important;
        }
        
        #chartCanvas.cursor-time-axis {
            cursor: ew-resize !important;
        }
        
        /* Axis cursor overlay zones */
        .axis-cursor-zone {
            position: absolute;
            z-index: 10;
            pointer-events: auto;
            /* Debug: uncomment to see zones */
            /* background: rgba(255,0,0,0.2); */
        }
        
        .price-axis-zone {
            right: 0;
            top: 5px;
            width: 60px;
            bottom: 30px;
            cursor: ns-resize !important;
        }
        
        .time-axis-zone {
            left: 0;
            right: 60px;
            bottom: 0;
            height: 30px;
            cursor: ew-resize !important;
        }

        #drawingSvg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            transition: none;
            overflow: hidden;
        }

        /* Crosshair - Dashed lines */
        .crosshair-vertical,
        .crosshair-horizontal {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        .crosshair-vertical {
            width: 1px;
            height: 100%;
            /* Dashed line pattern */
            background: repeating-linear-gradient(
                to bottom,
                rgba(150, 155, 165, 0.8) 0px,
                rgba(150, 155, 165, 0.8) 6px,
                transparent 6px,
                transparent 10px
            );
        }

        .crosshair-horizontal {
            width: 100%;
            height: 1px;
            /* Dashed line pattern */
            background: repeating-linear-gradient(
                to right,
                rgba(150, 155, 165, 0.8) 0px,
                rgba(150, 155, 165, 0.8) 6px,
                transparent 6px,
                transparent 10px
            );
        }

        .price-label,
        .time-label {
            position: absolute;
            background: #434651;
            color: #ffffff;
            padding: 4px 6px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 2px;
            pointer-events: none;
            z-index: 20;
            display: none;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: 0.2px;
        }
        
        .time-label {
            bottom: 38px;
            top: auto !important;
        }
        
        .price-label {
            /* Position set by JS */
            box-sizing: border-box;
        }

        /* OHLC Info Panel - TradingView Style */
        .ohlc-info {
            position: absolute;
            top: 8px;
            left: 10px; /* Base position, shifts right when overlays added */
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 9px;
            z-index: 30;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            pointer-events: none;
            max-width: 600px;
            transition: left 0.2s ease;
        }

        .ohlc-header {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ohlc-symbol-block {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            font-weight: 400;
            color: #ffffff;
        }

        .ohlc-symbol-dot {
            width: 18px;
            height: 18px;
            border-radius: 6px;
            background: rgba(255, 198, 0, 0.18);
            border: 1px solid rgba(255, 198, 0, 0.45);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #ffd54f;
            font-size: 11px;
            font-weight: 700;
        }

        .ohlc-symbol-text {
            letter-spacing: 0.2px;
        }

        .ohlc-separator {
            color: #ffffff;
            font-weight: 400;
        }

        .ohlc-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-weight: 300;
            color: #ffffff;
        }

        .ohlc-item {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .ohlc-label {
            color: #ffffff;
            font-weight: 400;
        }

        .ohlc-value {
            color: #ffffff;
            font-weight: 400;
        }

        .ohlc-value.up,
        .ohlc-value.down {
            color: #ffffff;
        }

        .ohlc-change {
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(2, 192, 118, 0.15);
            color: #ffffff;
            font-weight: 400;
        }

        .ohlc-change.positive,
        .ohlc-change.negative {
            background: rgba(2, 192, 118, 0.15);
            color: #ffffff;
        }

        .ohlc-collapse-btn {
            width: 22px;
            height: 22px;
            border: 1px solid rgba(86, 92, 109, 0.6);
            border-radius: 6px;
            background: rgba(27, 29, 36, 0.85);
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            transition: background 0.15s ease, border-color 0.15s ease, transform 0.2s ease;
        }

        .ohlc-collapse-btn:hover {
            background: rgba(40, 43, 52, 0.85);
            border-color: rgba(120, 128, 148, 0.75);
        }

        .ohlc-info.collapsed .ohlc-collapse-btn svg {
            transform: rotate(-180deg);
        }

        .ohlc-collapse-btn svg {
            width: 10px;
            height: 10px;
            color: #c5c9d3;
        }

        .ohlc-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ohlc-volume-line {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #ffffff;
            pointer-events: auto;
            position: relative;
            z-index: 100;
        }

        .volume-value {
            color: #ffffff;
            font-weight: 400;
        }

        .ohlc-indicators {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 12px;
            pointer-events: auto;
            position: relative;
            z-index: 100;
        }

        .ohlc-indicator-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #000000;
            font-weight: 300;
        }

        .ohlc-info.collapsed .ohlc-body {
            display: none;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 0, 40, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2e39;
            border-top-color: #2962ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #050028;
        }

        ::-webkit-scrollbar-thumb {
            background: #363a45;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #434651;
        }

        /* Context Menu Styling */
        .chart-context-menu {
            background: #050028;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 4px;
            min-width: 200px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 13px;
            color: #ffffff;
            animation: menuFadeIn 0.12s ease-out;
        }
        
        @keyframes menuFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: default;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 400;
            border-radius: 4px;
            margin: 1px 0;
        }

        .context-menu-item:hover {
            background: #2a2e39;
            color: #ffffff;
        }
        
        .context-menu-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }
        
        .context-menu-item:hover svg {
            opacity: 1;
        }
        
        .context-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin: 4px 8px;
        }
        
        .context-menu-shortcut {
            margin-left: auto;
            font-size: 11px;
            color: #787b86;
            font-weight: 500;
        }

        .context-submenu {
            padding-left: 12px;
        }

        /* Drawing Style Editor */
        .drawing-style-editor {
            background: #050028;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            width: 320px;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 13px;
            overflow: visible;
            animation: editorFadeIn 0.15s ease-out;
        }
        
        @keyframes editorFadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .drawing-style-editor .settings-section {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawing-style-editor .settings-section:last-child {
            border-bottom: none;
        }

        .drawing-style-editor label {
            display: block;
            color: #787b86;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .drawing-style-editor input[type="color"],
        .drawing-style-editor input[type="range"],
        .drawing-style-editor input[type="text"],
        .drawing-style-editor textarea,
        .drawing-style-editor select {
            width: 100%;
            padding: 8px;
            background: #050028;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .drawing-style-editor input:focus,
        .drawing-style-editor textarea:focus,
        .drawing-style-editor select:focus {
            border-color: #2962ff;
        }

        .drawing-style-editor button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: default;
            transition: all 0.2s ease;
        }

        .drawing-style-editor button:hover {
            transform: translateY(-1px);
        }

        .drawing-style-editor .tv-color-btn {
            padding: 0;
            transition: none;
        }

        .drawing-style-editor .tv-color-btn,
        .drawing-style-editor .tv-color-btn:hover,
        .drawing-style-editor .tv-color-btn:active,
        .drawing-style-editor .tv-color-btn:focus {
            transform: none !important;
            transition: none !important;
        }

        /* Inline Text Editor */
        .inline-text-editor {
            background: rgba(5, 0, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #2962ff;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(41, 98, 255, 0.3);
        }

        .inline-text-editor textarea {
            background: transparent;
            border: none;
            outline: none;
            color: #ffffff;
            font-family: Arial, sans-serif;
            resize: both;
        }

        /* Chart Tooltip - Dark Theme */
        .chart-tooltip {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: none;
            border-left: 3px solid #3b82f6;
            border-radius: 8px;
            padding: 14px 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            font-size: 13px;
            color: #e2e8f0;
            max-width: 320px;
            z-index: 10000;
        }

        /* Chart Tooltip - Light Theme */
        body.light-mode .chart-tooltip {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: none;
            border-left: 3px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            color: #1e293b;
        }

        /* Resize Handles - Blue Outline Style */
        .resize-handle-group {
            pointer-events: all;
        }

        .resize-handle {
            transition: r 0.15s ease, 
                        stroke-width 0.15s ease;
            cursor: nwse-resize;
            transform-origin: center;
            transform-box: fill-box;
        }

        .resize-handle-bg {
            fill: #0b0c0e;
        }

        body.light-mode .resize-handle-bg {
            fill: #ffffff;
        }

        .resize-handle-group:hover .resize-handle {
            filter: drop-shadow(0 0 4px rgba(41, 98, 255, 0.6));
            cursor: nwse-resize;
        }

        .resize-handle:active {
            cursor: nwse-resize;
            filter: drop-shadow(0 0 6px rgba(41, 98, 255, 0.8));
        }

        /* Chart Settings Menu */
        .chart-settings-menu {
            background: rgba(5, 0, 40, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid #2a2e39;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 280px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .chart-settings-menu.visible {
            visibility: visible;
            opacity: 1;
        }

        .settings-section-title {
            padding: 8px 16px 4px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: default;
            transition: background 0.15s ease;
            font-size: 13px;
            color: #ffffff;
        }

        .settings-item:hover {
            background: rgba(41, 98, 255, 0.1);
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid #2a2e39;
            cursor: default;
            transition: all 0.15s ease;
        }

        .color-preview:hover {
            transform: scale(1.1);
            border-color: #2962ff;
        }

        .settings-toggle {
            width: 40px;
            height: 20px;
            background: #2a2e39;
            border-radius: 10px;
            position: relative;
            transition: background 0.2s ease;
            cursor: default;
        }

        .settings-toggle.active {
            background: #2962ff;
        }

        .settings-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
        }

        .settings-toggle.active::after {
            transform: translateX(20px);
        }

        .settings-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: default;
            transition: background 0.15s ease, color 0.15s ease;
            letter-spacing: 0.2px;
        }

        .settings-btn-save {
            background: rgba(41, 98, 255, 0.9);
            color: #ffffff;
        }

        .settings-btn-save:hover {
            background: rgba(41, 98, 255, 1);
        }

        .settings-btn-save:active {
            background: rgba(30, 83, 229, 1);
        }

        .settings-btn-close {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .settings-btn-close:hover {
            background: rgba(255, 255, 255, 0.12);
            color: #ffffff;
        }

        .settings-btn-close:active {
            background: rgba(255, 255, 255, 0.06);
        }

        /* Notification */
        .chart-notification {
            background: rgba(41, 98, 255, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Right Sidebar - Fixed Icon Bar (moved to left) */
        .right-sidebar-icons {
            position: fixed;
            left: 0;
            top: 44px;
            width: 46px;
            height: calc(100vh - 44px);
            background: #050028;
            border: none !important;
            border-right: 1px solid rgba(63, 84, 124, 0.2) !important;
            z-index: 101;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: none !important;
            padding-top: 12px;
            padding-bottom: 12px;
            gap: 8px;
            outline: none !important;
        }

        body:not(.light-mode) .right-sidebar-icons::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 120px;
            background: none !important;
            background-repeat: no-repeat;
            background-position: 0 0;
            background-size: 100vw 100vh;
            -webkit-mask-image: none !important;
            mask-image: none !important;
            pointer-events: none;
            z-index: 0;
        }

        .right-sidebar-icons > * {
            position: relative;
            z-index: 1;
        }

        .right-sidebar-bottom {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            background: transparent;
            border-top: none;
        }

        body:not(.light-mode) .right-sidebar-bottom {
            background: #050028;
        }
        
        .right-sidebar-icons *,
        .right-sidebar-icons button {
            box-shadow: none !important;
            transition: none !important;
            outline: none !important;
        }

        .right-sidebar-icon-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            max-width: 34px;
            border: none;
            background: transparent;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.15s ease;
            position: relative;
            overflow: visible;
            border-radius: 4px;
            flex-shrink: 0;
            z-index: 1;
            box-shadow: none;
        }

        .right-sidebar-icon-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #a0aec0;
        }

        .right-sidebar-icon-btn.active {
            background: rgba(47, 114, 255, 0.25);
            color: #a0aec0;
        }

        .right-sidebar-icon-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Alert Badge */
        .alert-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            min-width: 16px;
            height: 16px;
            background: #ef4444;
            color: #ffffff;
            font-size: 10px;
            font-weight: 600;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .alert-badge:empty {
            display: none;
        }

        /* Right Sidebar Panel (moved to left) */
        .right-sidebar-panel {
            position: fixed;
            left: 50px;
            top: 44px;
            width: 300px;
            height: calc(100vh - 44px);
            background: #050028;
            border-left: 1px solid rgba(50, 50, 60, 0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            transform: translateX(-350px);
            transition: transform 0.3s ease;
        }

        .right-sidebar-panel.visible {
            transform: translateX(0);
        }

        /* Unified Right Panel  slide from right */
        .unified-right-panel {
            left: auto !important;
            right: -430px !important;
            top: 48px !important;
            width: 420px !important;
            height: calc(100vh - 48px) !important;
            background: #0a0a1a !important;
            border-left: 1px solid rgba(255,255,255,0.07) !important;
            border-right: none !important;
            box-shadow: -8px 0 40px rgba(0,0,0,0.6) !important;
            z-index: 1000009 !important;
            transform: none !important;
            transition: right 0.28s cubic-bezier(.4,0,.2,1) !important;
        }
        .unified-right-panel.visible {
            right: 0 !important;
            transform: none !important;
        }

        .unified-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #050028;
        }

        .unified-panel-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .unified-panel-header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .unified-panel-header-btn {
            background: none;
            border: none;
            color: #8f98ba;
            cursor: default;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .unified-panel-header-btn:hover {
            color: #ffffff;
        }

        .unified-panel-content {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .unified-panel-content.active {
            display: flex;
        }

        /* Watchlist Panel Styles */
        .watchlist-panel {
            width: 350px;
        }

        .watchlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #050028;
        }

        .watchlist-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .watchlist-header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .watchlist-header-btn {
            background: none;
            border: none;
            color: #8f98ba;
            cursor: default;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watchlist-header-btn:hover {
            color: #ffffff;
        }

        .watchlist-search {
            padding: 12px 20px;
        }

        .watchlist-search input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            background: rgba(30, 30, 35, 0.8);
            border: 1px solid #2a2a2e;
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
        }

        .watchlist-search input::placeholder {
            color: #6a6a7a;
        }

        .watchlist-search-wrapper {
            position: relative;
        }

        .watchlist-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6a6a7a;
        }

        .watchlist-add-btn {
            margin: 0 20px 12px;
            padding: 10px;
            background: transparent;
            border: 1px dashed #3a3a4a;
            border-radius: 6px;
            color: #8f98ba;
            font-size: 14px;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .watchlist-add-btn:hover {
            border-color: #5a5a6a;
            color: #ffffff;
            background: rgba(40, 40, 50, 0.5);
        }

        .watchlist-table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            padding: 10px 20px;
            background: rgba(20, 20, 25, 0.8);
            border-bottom: 1px solid #050028;
            font-size: 12px;
            color: #6a6a7a;
            text-transform: uppercase;
        }

        .watchlist-items {
            flex: 1;
            overflow-y: auto;
        }

        .watchlist-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            padding: 12px 20px;
            align-items: center;
            border-bottom: 1px solid rgba(30, 30, 35, 0.5);
            cursor: default;
            transition: background 0.15s;
        }

        .watchlist-item:hover {
            background: rgba(40, 40, 50, 0.5);
        }

        .watchlist-symbol {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .watchlist-symbol-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .watchlist-symbol-name {
            font-weight: 500;
            color: #ffffff;
        }

        .watchlist-price {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
            color: #ffffff;
        }

        .watchlist-price .decimals {
            color: #6a6a7a;
        }

        .watchlist-change {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
        }

        .watchlist-change.positive {
            color: #22c55e;
        }

        .watchlist-change.negative {
            color: #ef4444;
        }

        /* News Panel Styles */
        .news-panel {
            width: 400px;
        }

        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #050028;
        }

        .news-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .news-header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .news-header-btn {
            background: none;
            border: none;
            color: #8f98ba;
            cursor: default;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .news-header-btn:hover {
            color: #ffffff;
        }

        .news-search {
            padding: 12px 20px;
        }

        .news-search-wrapper {
            position: relative;
        }

        .news-search input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            background: rgba(30, 30, 35, 0.8);
            border: 1px solid #2a2a2e;
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
        }

        .news-search input::placeholder {
            color: #6a6a7a;
        }

        .news-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6a6a7a;
        }

        .news-tabs {
            display: flex;
            margin: 0 20px 12px;
            background: rgba(30, 30, 35, 0.5);
            border-radius: 8px;
            padding: 4px;
        }

        .news-tab {
            flex: 1;
            padding: 8px 16px;
            background: none;
            border: none;
            color: #8f98ba;
            font-size: 14px;
            cursor: default;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .news-tab.active {
            background: rgba(47, 114, 255, 0.3);
            color: #4a9eff;
        }

        .news-tab:hover:not(.active) {
            color: #ffffff;
        }

        .news-items {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px;
        }

        .news-item {
            padding: 16px 0;
            border-bottom: 1px solid rgba(30, 30, 35, 0.5);
        }

        .news-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .news-time {
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
        }

        .news-countdown {
            background: rgba(47, 114, 255, 0.2);
            color: #4a9eff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .news-item-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .news-flag {
            font-size: 16px;
        }

        .news-impact {
            display: flex;
            gap: 2px;
        }

        .news-impact-bar {
            width: 3px;
            height: 12px;
            background: #3a3a4a;
            border-radius: 1px;
        }

        .news-impact-bar.active {
            background: #ef4444;
        }

        .news-impact.low .news-impact-bar:nth-child(1) {
            background: #22c55e;
        }

        .news-impact.medium .news-impact-bar:nth-child(1),
        .news-impact.medium .news-impact-bar:nth-child(2) {
            background: #f59e0b;
        }

        .news-impact.high .news-impact-bar:nth-child(1),
        .news-impact.high .news-impact-bar:nth-child(2),
        .news-impact.high .news-impact-bar:nth-child(3) {
            background: #ef4444;
        }

        .news-event-name {
            font-size: 15px;
            font-weight: 500;
            color: #ffffff;
        }

        .news-event-date {
            font-size: 12px;
            color: #6a6a7a;
            margin-left: 32px;
        }

        .news-values {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            margin-left: 32px;
        }

        .news-value {
            font-size: 13px;
        }

        .news-value-label {
            color: #6a6a7a;
        }

        .news-value-data {
            color: #ffffff;
            margin-left: 4px;
        }

        .news-value-data.positive {
            color: #22c55e;
        }

        .news-value-data.negative {
            color: #ef4444;
        }

        /* Clock Panel Styles */
        .clock-display {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #050028;
        }

        .clock-time {
            font-size: 48px;
            font-weight: 300;
            color: #ffffff;
            font-family: 'SF Mono', 'Monaco', monospace;
            letter-spacing: 2px;
        }

        .clock-date {
            font-size: 14px;
            color: #8f98ba;
            margin-top: 8px;
        }

        .clock-timezone-label {
            font-size: 12px;
            font-weight: 600;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .clock-candle-label {
            font-size: 10px;
            color: #5d6673;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clock-timezones {
            padding: 16px 20px;
            border-bottom: 1px solid #050028;
        }

        .timezone-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(30, 30, 35, 0.5);
        }

        .timezone-item:last-child {
            border-bottom: none;
        }

        .timezone-name {
            color: #8f98ba;
            font-size: 13px;
        }

        .timezone-time {
            color: #ffffff;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
        }

        .market-sessions {
            padding: 16px 20px;
        }

        .session-title {
            font-size: 12px;
            color: #6a6a7a;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .session-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3a3a4a;
        }

        .session-dot.sydney { background: #8b5cf6; }
        .session-dot.tokyo { background: #ef4444; }
        .session-dot.london { background: #3b82f6; }
        .session-dot.newyork { background: #22c55e; }

        .session-name {
            flex: 1;
            color: #ffffff;
            font-size: 13px;
        }

        .session-status {
            font-size: 12px;
            color: #6a6a7a;
        }

        .session-status.open {
            color: #22c55e;
        }

        /* Alerts Panel Styles */
        .alerts-actions {
            padding: 16px 20px;
            border-bottom: 1px solid #050028;
        }

        .alerts-add-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: 1px dashed #3a3a4a;
            border-radius: 6px;
            color: #8f98ba;
            font-size: 13px;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .alerts-add-btn:hover {
            border-color: #4a9eff;
            color: #4a9eff;
            background: rgba(47, 114, 255, 0.1);
        }

        .alerts-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px;
        }

        .alert-item {
            padding: 16px 0;
            border-bottom: 1px solid rgba(30, 30, 35, 0.5);
        }

        .alert-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .alert-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        .alert-condition {
            font-size: 12px;
            color: #6a6a7a;
        }

        .alert-value {
            font-size: 16px;
            font-weight: 500;
            color: #4a9eff;
            margin-bottom: 8px;
        }

        .alert-item-actions {
            display: flex;
            gap: 8px;
        }

        .alert-action-btn {
            background: rgba(30, 30, 35, 0.5);
            border: 1px solid #2a2a2e;
            border-radius: 4px;
            padding: 6px;
            color: #8f98ba;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-action-btn:hover {
            background: rgba(47, 114, 255, 0.2);
            color: #4a9eff;
            border-color: #4a9eff;
        }

        .alert-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: #ef4444;
        }

        /* Alerts Search */
        .alerts-search {
            padding: 16px 20px;
            border-bottom: 1px solid #050028;
        }

        .alerts-search-wrapper {
            display: flex;
            align-items: center;
            background: rgba(20, 20, 25, 0.8);
            border: 1px solid #2a2a2e;
            border-radius: 6px;
            padding: 0 12px;
            gap: 8px;
        }

        .alerts-search-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 13px;
            padding: 10px 0;
            outline: none;
        }

        .alerts-search-icon {
            color: #6a6a7a;
        }

        /* Alert System - Enhanced Styles */
        .alerts-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #6a6a7a;
        }

        .alerts-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .alerts-empty p {
            font-size: 16px;
            color: #8f98ba;
            margin: 0 0 8px 0;
        }

        .alerts-empty span {
            font-size: 13px;
            line-height: 1.5;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(30, 30, 35, 0.5);
            cursor: default;
            transition: background 0.15s;
        }

        .alert-item:hover {
            background: rgba(47, 114, 255, 0.05);
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .alert-item.inactive {
            opacity: 0.5;
        }

        .alert-item-color {
            width: 4px;
            height: 100%;
            min-height: 50px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .alert-item-content {
            flex: 1;
            min-width: 0;
        }

        .alert-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .alert-item-symbol {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
        }

        .alert-item-condition {
            font-size: 11px;
            color: #6a6a7a;
            padding: 2px 6px;
            background: rgba(30, 30, 35, 0.8);
            border-radius: 3px;
        }

        .alert-item-price {
            font-size: 18px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 4px;
        }

        .alert-item-message {
            font-size: 12px;
            color: #8f98ba;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .alert-item-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #6a6a7a;
        }

        .alert-item-count {
            color: #ff9800;
        }

        .alert-item-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .alert-item-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: #6a6a7a;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .alert-item-btn:hover {
            background: rgba(47, 114, 255, 0.2);
            color: #4a9eff;
        }

        .alert-item-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .alert-item-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Alert Line Styles (on chart) */
        #alertLinesGroup {
            pointer-events: all !important;
        }
        
        .alert-line-group {
            cursor: default;
            pointer-events: all !important;
        }
        
        .alert-delete-btn {
            pointer-events: all !important;
            cursor: default;
        }

        .alert-line {
            transition: stroke-width 0.15s;
        }

        .alert-line-group:hover .alert-line {
            stroke-width: 2.5;
        }

        .alert-line-flash .alert-line {
            animation: alertFlash 0.5s ease-in-out 3;
        }

        @keyframes alertFlash {
            0%, 100% { opacity: 1; stroke-width: 1.5; }
            50% { opacity: 0.3; stroke-width: 3; }
        }

        /* Alert Context Menu */
        .alert-context-menu {
            position: fixed;
            background: rgba(5, 0, 40, 0.98);
            border: 1px solid #2a2e39;
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            min-width: 160px;
            padding: 6px 0;
        }

        .alert-context-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            color: #d1d5db;
            font-size: 13px;
            cursor: default;
            transition: background 0.15s;
        }

        .alert-context-item:hover {
            background: rgba(47, 114, 255, 0.15);
        }

        .alert-context-item.delete {
            color: #ef4444;
        }

        .alert-context-item.delete:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .alert-context-item svg {
            width: 16px;
            height: 16px;
        }

        .alert-context-divider {
            height: 1px;
            background: #2a2e39;
            margin: 6px 0;
        }

        /* Alert Modal */
        .alert-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
        }

        .alert-modal {
            background: #050028;
            border: 1px solid #2a2e39;
            border-radius: 12px;
            width: 420px;
            max-width: 90vw;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
        }

        .alert-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            border-bottom: 1px solid #2a2e39;
        }

        .alert-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .alert-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #8f98ba;
            font-size: 24px;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .alert-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .alert-modal-body {
            padding: 24px;
        }

        .alert-form-group {
            margin-bottom: 18px;
        }

        .alert-form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #8f98ba;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .alert-form-group input[type="text"],
        .alert-form-group input[type="number"],
        .alert-form-group select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(20, 20, 25, 0.8);
            border: 1px solid #2a2e39;
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s;
        }

        .alert-form-group input:focus,
        .alert-form-group select:focus {
            border-color: #4a9eff;
        }

        .alert-form-group input[readonly] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert-color-picker {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-color-picker input[type="color"] {
            width: 44px;
            height: 44px;
            padding: 0;
            border: 2px solid #2a2e39;
            border-radius: 8px;
            cursor: default;
            transition: border-color 0.15s ease;
        }
        .alert-color-picker input[type="color"]:hover {
            border-color: #2962ff;
        }

        .alert-color-presets {
            display: flex;
            gap: 8px;
        }

        .alert-color-preset {
            width: 28px;
            height: 28px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: default;
            transition: all 0.15s;
        }

        .alert-color-preset:hover {
            transform: scale(1.15);
            border-color: #ffffff;
        }

        .alert-checkboxes {
            display: flex;
            gap: 24px;
        }

        .alert-checkbox-label {
            display: flex !important;
            align-items: center;
            gap: 8px;
            cursor: default;
            font-size: 13px !important;
            text-transform: none !important;
            color: #d1d5db !important;
        }

        .alert-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4a9eff;
        }

        .alert-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 18px 24px;
            border-top: 1px solid #2a2e39;
        }

        .alert-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: default;
            transition: all 0.15s;
        }

        .alert-modal-btn.cancel {
            background: transparent;
            color: #8f98ba;
            border: 1px solid #2a2e39;
        }

        .alert-modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .alert-modal-btn.primary {
            background: #050028;
            color: #ffffff;
        }

        .alert-modal-btn.primary:hover {
            background: #050028;
            transform: translateY(-1px);
        }

        /* Alert Notification Popup */
        .alert-notification {
            position: fixed;
            top: 20px;
            right: 70px;
            width: 320px;
            background: #050028;
            border: 1px solid #ff9800;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(255, 152, 0, 0.3);
            z-index: 10003;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }

        .alert-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .alert-notification-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
        }

        .alert-notification-icon {
            font-size: 20px;
        }

        .alert-notification-symbol {
            flex: 1;
            font-weight: 600;
            color: #ffffff;
            font-size: 15px;
        }

        .alert-notification-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #8f98ba;
            font-size: 20px;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .alert-notification-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .alert-notification-body {
            padding: 14px 16px;
        }

        .alert-notification-message {
            font-size: 14px;
            color: #d1d5db;
            margin-bottom: 10px;
        }

        .alert-notification-price {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #8f98ba;
        }

        .alert-notification-price span:last-child {
            color: #4a9eff;
            font-weight: 500;
        }

        /* Menu Panel Styles */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 20px;
            border-bottom: 1px solid #050028;
        }

        .menu-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            border-radius: 8px;
            cursor: default;
            transition: all 0.2s;
            background: rgba(20, 20, 25, 0.5);
            border: 1px solid transparent;
        }

        .menu-grid-item:hover {
            background: rgba(47, 114, 255, 0.15);
            border-color: rgba(47, 114, 255, 0.3);
        }

        .menu-grid-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8f98ba;
        }

        .menu-grid-icon svg {
            width: 24px;
            height: 24px;
        }

        .menu-grid-item span {
            font-size: 11px;
            color: #8f98ba;
            text-align: center;
        }

        .menu-grid-item:hover .menu-grid-icon {
            color: #4a9eff;
        }

        .menu-grid-item:hover span {
            color: #ffffff;
        }

        .menu-section {
            padding: 16px 20px;
        }

        .menu-section-title {
            font-size: 11px;
            color: #6a6a7a;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .menu-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 6px;
            cursor: default;
            color: #8f98ba;
            transition: all 0.2s;
        }

        .menu-list-item:hover {
            background: rgba(47, 114, 255, 0.15);
            color: #ffffff;
        }

        .menu-list-item span {
            font-size: 13px;
        }

        .trading-panel__content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .trading-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .trading-section__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trading-section__title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #8b92a7;
            letter-spacing: 0.08em;
        }

        .trading-section__actions {
            display: flex;
            gap: 6px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .metric-card {
            background: #050028;
            border: 1px solid rgba(124, 58, 237, 0.18);
            box-shadow: 0 12px 30px rgba(11, 13, 20, 0.4);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .metric-label {
            font-size: 11px;
            color: #8b92a7;
            font-weight: 500;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.02em;
        }

        .order-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-card {
            background: #050028;
            border: 1px solid #2d3142;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .order-card--pending {
            border-left: 3px solid #6366f1;
        }

        .order-card--open.order-card--profit {
            border-left: 3px solid #22c55e;
        }

        .order-card--open.order-card--loss {
            border-left: 3px solid #ef4444;
        }

        .order-card__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .order-card__title {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .order-card__meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            color: #9ca3af;
        }

        .order-card__metrics {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 16px;
            font-size: 12px;
            color: #9ca3af;
            background: #0f1117;
            padding: 12px;
            border-radius: 6px;
        }

        .order-card__metrics span {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .order-card__metrics strong {
            color: #e5e7eb;
            font-weight: 600;
        }

        .order-card__footer {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .order-card__chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .order-card__actions {
            display: flex;
            gap: 8px;
        }

        .order-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            background: #2d3142;
            color: #e5e7eb;
        }

        .order-badge--type {
            background: #6366f1;
            color: #ffffff;
            border: none;
        }

        .order-badge--direction-buy {
            background: #22c55e;
            color: #ffffff;
            border: none;
        }

        .order-badge--direction-sell {
            background: #ef4444;
            color: #ffffff;
            border: none;
        }

        .order-badge--status {
            background: #3b82f6;
            color: #ffffff;
            border: none;
        }

        .order-value--profit {
            color: #4ade80;
            font-weight: 700;
        }

        .order-value--loss {
            color: #f87171;
            font-weight: 700;
        }

        .order-btn {
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: default;
            border: 1px solid #6366f1;
            background: #6366f1;
            color: #ffffff;
            transition: all 0.2s ease;
        }

        .order-btn:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }

        .order-btn--ghost {
            background: transparent;
            border-color: #6366f1;
            color: #6366f1;
        }

        .order-btn--ghost:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .order-btn--destructive {
            background: #ef4444;
            color: #ffffff;
            border-color: #ef4444;
        }

        .order-btn--destructive:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .order-chip {
            font-size: 10px;
            color: #8b92a7;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 36px 16px;
            border-radius: 12px;
            border: 1px dashed rgba(124, 58, 237, 0.25);
            background: rgba(21, 24, 35, 0.8);
            color: #8b92a7;
            font-size: 12px;
            line-height: 1.6;
        }

        .empty-state span {
            display: block;
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
        }

        .order-card__screenshot {
            border: 1px solid #2d3142;
            border-radius: 6px;
            overflow: hidden;
            background: #0f1117;
            transition: all 0.2s ease;
            cursor: default;
        }

        .order-card__screenshot:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .order-card__screenshot img {
            display: block;
            width: 100%;
            height: auto;
        }

        .order-card__screenshot-caption {
            padding: 6px 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            background: #0f1117;
            text-align: center;
        }

        .metric-value--positive {
            color: #4ade80;
        }

        .metric-value--negative {
            color: #f87171;
        }

        .order-chip--positive {
            color: #4ade80;
        }

        .order-chip--negative {
            color: #f87171;
        }

        .object-tree-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #050028;
            background: rgba(8, 8, 8, 0.95);
        }

        .object-tree-tabs {
            display: flex;
            gap: 4px;
        }

        .object-tree-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 12px;
            font-weight: 500;
            cursor: default;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .object-tree-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .object-tree-tab.active {
            background: rgba(47, 114, 255, 0.15);
            color: #ffffff;
        }

        .object-tree-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #787b86;
            cursor: default;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .object-tree-close:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .object-tree-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border-bottom: 1px solid #050028;
            background: rgba(5, 5, 5, 0.95);
        }

        .object-tree-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: #787b86;
            cursor: default;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .object-tree-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        .object-tree-btn svg {
            width: 16px;
            height: 16px;
        }

        .object-tree-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .object-tree-list {
            padding: 8px 0;
        }

        .object-tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            cursor: default;
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
            color: #ffffff;
            font-size: 13px;
            min-height: 36px;
        }

        .object-tree-item:hover {
            background: rgba(26, 26, 26, 0.95);
            border-left-color: #2962ff;
        }

        .object-tree-item.selected {
            background: rgba(47, 114, 255, 0.15);
            border-left-color: #2962ff;
            color: #ffffff;
        }

        .object-tree-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #787b86;
            margin-top: 0;
        }

        .object-tree-item.selected .object-tree-icon {
            color: #2962ff;
        }

        .object-tree-icon svg {
            width: 16px;
            height: 16px;
        }

        .object-tree-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 20px;
            display: flex;
            align-items: center;
        }

        .object-tree-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .object-tree-item:hover .object-tree-actions {
            opacity: 1;
        }

        .object-tree-action-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: #787b86;
            cursor: default;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .object-tree-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .object-tree-action-btn.delete:hover {
            background: rgba(242, 54, 69, 0.2);
            color: #f23645;
        }

        .object-tree-action-btn svg {
            width: 14px;
            height: 14px;
        }

        .object-tree-empty {
            padding: 40px 20px;
            text-align: center;
            color: #787b86;
            font-size: 13px;
        }

        .object-tree-empty-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            opacity: 0.3;
        }

        .object-tree-category {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(8, 8, 8, 0.95);
            border-bottom: 1px solid #050028;
        }

        /* Trade History Items in Journal Tab */
        .trade-history-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            cursor: default;
            transition: all 0.2s;
        }

        .trade-history-item:hover {
            background: rgba(148, 163, 184, 0.05);
            border-left: 3px solid rgba(148, 163, 184, 0.3);
            padding-left: 13px;
        }

        /* Challenge Progress Panel */
        .challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(8, 8, 8, 0.95);
            border-bottom: 1px solid #050028;
        }

        .challenge-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .challenge-refresh {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(47, 114, 255, 0.15);
            border-radius: 6px;
            color: #2f72ff;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .challenge-refresh:hover {
            background: rgba(47, 114, 255, 0.25);
            transform: rotate(180deg);
        }

        .challenge-refresh svg {
            width: 16px;
            height: 16px;
        }

        .challenge-info {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #050028;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .challenge-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .challenge-info-label {
            color: #787b86;
            font-weight: 500;
        }

        .challenge-info-value {
            color: #ffffff;
            font-weight: 600;
        }

        .challenge-content {
            padding: 16px 0;
            overflow-y: auto;
            max-height: calc(100vh - 250px);
        }

        .challenge-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .challenge-item:last-child {
            border-bottom: none;
        }

        .challenge-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: default;
            transition: background 0.2s;
        }

        .challenge-item-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .challenge-item-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
        }

        .challenge-icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        .challenge-icon-success {
            stroke: #22c55e;
        }

        .challenge-icon-pending {
            stroke: #787b86;
        }

        .challenge-icon-danger {
            stroke: #ef4444;
        }

        .challenge-arrow {
            width: 16px;
            height: 16px;
            stroke: #787b86;
            transition: transform 0.3s;
        }

        .challenge-item-header.collapsed .challenge-arrow {
            transform: rotate(-90deg);
        }

        .challenge-item-content {
            padding: 0 20px 20px 56px;
            display: block;
        }

        .challenge-item-header.collapsed + .challenge-item-content {
            display: none;
        }

        .challenge-requirement {
            font-size: 12px;
            color: #787b86;
            margin-bottom: 12px;
        }

        .challenge-requirement span {
            color: #ffffff;
            font-weight: 600;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: #050028;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .challenge-progress-bar-danger .challenge-progress-fill {
            background: #050028;
        }

        .challenge-current-value {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
        }

        /* Compact Challenge Toolbar Button & Dropdown */
        .challenge-toolbar-container {
            position: relative;
        }

        .challenge-toolbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #050028;
            border: none;
            border-radius: 6px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            cursor: default;
            transition: all 0.2s;
            position: relative;
        }

        .challenge-toolbar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(47, 114, 255, 0.4);
        }

        .challenge-toolbar-btn svg {
            width: 18px;
            height: 18px;
        }

        .challenge-status-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #22c55e;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            border: 2px solid #050028;
        }

        .challenge-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 320px;
            background: rgba(18, 20, 31, 0.98);
            border: 1px solid rgba(47, 114, 255, 0.3);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .challenge-dropdown.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .challenge-dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
        }

        .challenge-dropdown-refresh {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(47, 114, 255, 0.15);
            border-radius: 4px;
            color: #2f72ff;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .challenge-dropdown-refresh:hover {
            background: rgba(47, 114, 255, 0.25);
            transform: rotate(180deg);
        }

        .challenge-dropdown-refresh svg {
            width: 12px;
            height: 12px;
        }

        .challenge-dropdown-body {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .challenge-quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .challenge-stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .challenge-stat-item .stat-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
        }

        .challenge-stat-item .stat-value {
            font-size: 13px;
            color: #ffffff;
            font-weight: 700;
        }

        .challenge-dropdown-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .challenge-dropdown-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .challenge-dropdown-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .challenge-dropdown-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .challenge-dropdown-icon.success {
            color: #22c55e;
        }

        .challenge-dropdown-icon.pending {
            color: #787b86;
        }

        .challenge-dropdown-icon.danger {
            color: #ef4444;
        }

        .challenge-dropdown-label {
            font-size: 11px;
            font-weight: 500;
            color: #ffffff;
            flex: 1;
        }

        .challenge-dropdown-value {
            font-size: 11px;
            font-weight: 700;
            color: #787b86;
        }

        .challenge-dropdown-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .challenge-dropdown-progress.danger {
            background: rgba(239, 68, 68, 0.15);
        }

        .challenge-dropdown-progress-fill {
            height: 100%;
            background: #050028;
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }

        .challenge-dropdown-progress.danger .challenge-dropdown-progress-fill {
            background: #050028;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        /* =====================================================
           UNIFIED TOOLTIP VISUAL STYLE
           Only overrides look (bg, radius, font, transition).
           All positioning from per-element rules is preserved.
           ===================================================== */
        #cursorTool::after,
        #indicatorsBtn::after,
        #chartTypeBtn::after,
        #rulerTool::after,
        #symbolWatchlistBtn::after,
        .tool-group-btn[data-group="visibility-toolbar"]::after,
        #keepDrawingModeToolbar::after,
        .tool-group-btn[data-group="delete-toolbar"]::after,
        .tool-group-btn::after,
        .left-sidebar .tool-btn::after,
        .tool-btn::after {
            background: #1e222d !important;
            color: #ffffff !important;
            border-radius: 6px !important;
            border: none !important;
            font-size: 12px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-weight: 400 !important;
            transition: opacity 0s !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5) !important;
            padding: 6px 12px !important;
        }

        /* Exception: dropdown grid inline labels must stay transparent/static */
        .tool-dropdown-grid .tool-btn::after {
            position: static !important;
            transform: none !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            opacity: 1 !important;
            font-size: 14px !important;
            font-weight: 400 !important;
            color: #d1d5db !important;
        }

        /* Bottom toolbar buttons need position:relative for ::after */
        .toolbar-icon-btn-dark,
        .toolbar-icon-btn-light,
        .profile-avatar-btn,
        .right-sidebar-icon-btn,
        .sidebar-timeframe-btn { position: relative; }

        /* Top toolbar  tooltip drops below button */
        .toolbar-icon-btn-dark[data-tooltip]::after,
        .toolbar-icon-btn-light[data-tooltip]::after,
        .profile-avatar-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 4px);
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            background: #1e222d;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0s;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            border: none;
            z-index: 100002;
        }

        .toolbar-icon-btn-dark[data-tooltip]:hover::after,
        .toolbar-icon-btn-light[data-tooltip]:hover::after,
        .profile-avatar-btn[data-tooltip]:hover::after { opacity: 1; }

        /* Allow ::after tooltip to overflow the button bounds */
        .right-sidebar-icons [data-tooltip] { overflow: visible !important; }

        /* Right sidebar icons  tooltip to the left */
        .right-sidebar-icons [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 50%;
            left: auto;
            right: calc(100% + 4px);
            transform: translateY(-50%);
            background: #1e222d;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0s;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            border: none;
            z-index: 100002;
        }

        .right-sidebar-icons [data-tooltip]:hover::after { opacity: 1; }
    </style>
    
    <style>
        /* Prop Firm Challenge Result Modals */
        .challenge-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            animation: fadeIn 0.3s ease;
        }

        .challenge-modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .challenge-modal {
            background: #050028;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideUp {
            from { 
                transform: translateY(30px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .challenge-modal-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .challenge-modal-icon.success {
            background: #050028;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
        }

        .challenge-modal-icon.failure {
            background: #050028;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }

        .challenge-modal-title {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
        }

        .challenge-modal-subtitle {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .challenge-modal-stats {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .challenge-modal-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .challenge-modal-stat:last-child {
            border-bottom: none;
        }

        .challenge-modal-stat-label {
            font-size: 14px;
            color: #9ca3af;
        }

        .challenge-modal-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }

        .challenge-modal-stat-value.positive {
            color: #22c55e;
        }

        .challenge-modal-stat-value.negative {
            color: #ef4444;
        }

        .challenge-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .challenge-modal-btn {
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: default;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .challenge-modal-btn-primary {
            background: #050028;
            color: #fff;
        }

        .challenge-modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(41, 98, 255, 0.3);
        }

        .challenge-modal-btn-success {
            background: #050028;
            color: #fff;
        }

        .challenge-modal-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        .challenge-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .challenge-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
    </style>
    
    <style>
        /* Backtesting Loading Overlay */
        #backtestingLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 0, 40, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 30px;
        }
        
        #backtestingLoader.active {
            display: flex;
        }
        
        .loader-content {
            text-align: center;
            color: #ffffff;
        }
        
        .loader-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 4px solid rgba(124, 58, 237, 0.2);
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .loader-subtitle {
            font-size: 14px;
            color: #787b86;
            margin-bottom: 30px;
        }
        
        .loader-progress-container {
            width: 400px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            height: 100%;
            background: #050028;
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
            animation: progressPulse 2s ease-in-out infinite;
        }
        
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .loader-steps {
            margin-top: 20px;
            font-size: 13px;
            color: #787b86;
        }
        
        .loader-step {
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .loader-step.completed {
            color: #22c55e;
        }
        
        .loader-step.active {
            color: #7c3aed;
        }
        
        .loader-step-icon {
            width: 16px;
            height: 16px;
        }
    </style>
    
    <style>
        /* Order Line Close Buttons */
        .order-close-btn,
        .pending-order-close-btn,
        .sl-close-btn,
        .tp-close-btn {
            pointer-events: all !important;
            cursor: default !important;
        }
        
        .order-close-btn circle,
        .pending-order-close-btn circle,
        .sl-close-btn circle,
        .tp-close-btn circle {
            pointer-events: all !important;
        }
        
        .order-close-btn text,
        .pending-order-close-btn text,
        .sl-close-btn text,
        .tp-close-btn text {
            pointer-events: none !important;
        }
    </style>
    
    <style>
        /* =====================================================
           UNIFIED TOOLBAR BUTTON SIZES & SPACING
           ===================================================== */
        
        /* Standard button size: 32x32px with 18px icons */
        .toolbar-left,
        .toolbar-right,
        .toolbar-drawing-tools,
        .toolbar-drawing-icons,
        .left-sidebar .drawing-tools-vertical {
            gap: 4px !important;
        }
        
        /* ALL toolbar buttons - unified 32x32 */
        .toolbar-icon-btn,
        .toolbar-icon-btn-dark,
        .toolbar-icon-btn-light,
        .tool-group-btn,
        .toolbar-tool-btn,
        .drawing-tool-btn,
        .tool-btn,
        .symbol-plus-btn,
        .toolbar-left .tool-group-btn,
        .toolbar-drawing-tools .tool-group-btn,
        .toolbar-drawing-tools .toolbar-tool-btn,
        .toolbar-drawing-icons .tool-group-btn,
        .left-sidebar .tool-btn,
        .left-sidebar .tool-group-btn {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
            max-width: 32px !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            border-radius: 4px !important;
        }
        
        /* ALL toolbar button icons - unified 18x18 */
        .toolbar-icon-btn svg,
        .toolbar-icon-btn-dark svg,
        .toolbar-icon-btn-light svg,
        .tool-group-btn svg,
        .toolbar-tool-btn svg,
        .drawing-tool-btn svg,
        .tool-btn svg,
        .symbol-plus-btn svg,
        .toolbar-left .tool-group-btn svg,
        .toolbar-drawing-tools .tool-group-btn svg,
        .toolbar-drawing-tools .toolbar-tool-btn svg,
        .toolbar-drawing-icons .tool-group-btn svg,
        .left-sidebar .tool-btn svg,
        .left-sidebar .tool-group-btn svg {
            width: 18px !important;
            height: 18px !important;
        }
        
        /* Toolbar sections - EXACT 6px gap everywhere */
        .toolbar {
            gap: 6px !important;
        }
        
        .toolbar-left {
            gap: 6px !important;
        }
        
        .toolbar-right {
            gap: 6px !important;
        }
        
        /* Drawing tools section - NO extra padding/margin */
        .toolbar-drawing-tools {
            gap: 6px !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
        }
        
        /* Tool groups - no extra spacing */
        .tool-group,
        .toolbar-left .tool-group,
        .toolbar-drawing-tools .tool-group,
        .toolbar-drawing-icons .tool-group {
            margin: 0 !important;
            padding: 0 !important;
            width: 32px !important;
            min-width: 32px !important;
        }
        
        /* Left sidebar drawing tools */
        .left-sidebar .drawing-tools-vertical {
            gap: 6px !important;
        }
        
        .left-sidebar .tool-group {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Dividers - NO margin, let gap handle spacing */
        .divider,
        .toolbar-divider {
            width: 1px !important;
            height: 24px !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-shrink: 0 !important;
            background: rgba(120, 123, 134, 0.3) !important;
        }
        
        /* Help button (circle) - same size but round */
        .toolbar-icon-btn-light {
            border-radius: 50% !important;
        }
        
        /* Buttons with labels - auto width */
        .toolbar-icon-btn.with-label,
        .new-order-btn,
        .replay-mode-btn {
            width: auto !important;
            max-width: none !important;
            padding: 0 10px !important;
            gap: 6px !important;
        }
    </style>
    
    <style>
        /* =====================================================
           MOBILE RESPONSIVE STYLES
           ===================================================== */
        
        /* Tablet (max-width: 1024px) */
        @media screen and (max-width: 1024px) {
            .toolbar {
                padding: 2px 4px;
                gap: 4px;
            }
            
            .toolbar-left {
                gap: 4px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .toolbar-right {
                gap: 4px;
            }
            
            .toolbar-icon-btn,
            .toolbar-icon-btn-dark,
            .toolbar-icon-btn-light {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }
            
            .toolbar-icon-btn svg,
            .toolbar-icon-btn-dark svg,
            .toolbar-icon-btn-light svg {
                width: 16px;
                height: 16px;
            }
            
            .new-order-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .replay-mode-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .replay-mode-btn span {
                display: none;
            }
            
            .divider {
                margin: 0 4px;
            }
        }
        
        /* Mobile (max-width: 768px) */
        @media screen and (max-width: 768px) {
            .toolbar {
                height: 44px;
                padding: 2px 4px;
                gap: 2px;
                flex-wrap: nowrap;
            }
            
            .toolbar-left {
                flex: 1;
                min-width: 0;
                gap: 2px;
                overflow-x: auto;
                overflow-y: hidden;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-right: 4px;
            }
            
            .toolbar-left::-webkit-scrollbar {
                display: none;
            }
            
            .toolbar-right {
                flex-shrink: 0;
                gap: 2px;
            }
            
            /* Hide labels on mobile */
            .toolbar-icon-btn.with-label span,
            .replay-mode-btn span,
            .new-order-btn span {
                display: none !important;
            }
            
            .new-order-btn {
                padding: 6px 8px;
                min-width: 32px;
                justify-content: center;
            }
            
            .replay-mode-btn {
                padding: 4px 6px;
                gap: 0;
            }
            
            /* Smaller buttons */
            .toolbar-icon-btn,
            .toolbar-icon-btn-dark,
            .toolbar-icon-btn-light,
            .tool-group-btn {
                width: 30px !important;
                height: 30px !important;
                min-width: 30px !important;
            }
            
            .toolbar-icon-btn svg,
            .toolbar-icon-btn-dark svg,
            .toolbar-icon-btn-light svg,
            .tool-group-btn svg {
                width: 14px !important;
                height: 14px !important;
            }
            
            /* Drawing tools - keep visible but compact */
            .toolbar-drawing-tools {
                padding: 0 4px !important;
                margin: 0 2px !important;
                gap: 2px !important;
                border-left: none !important;
                border-right: none !important;
            }
            
            .toolbar-drawing-tools .tool-group-btn {
                width: 26px !important;
                height: 26px !important;
                min-width: 26px !important;
            }
            
            .toolbar-drawing-tools .tool-group-btn svg {
                width: 12px !important;
                height: 12px !important;
            }
            
            .divider {
                width: 1px;
                height: 16px;
                margin: 0 2px;
            }
            
            /* Logo smaller */
            .toolbar-logo img {
                height: 22px !important;
            }
            
            /* Symbol selector compact */
            .symbol-selector {
                max-width: 80px;
                padding: 4px 6px !important;
                font-size: 11px !important;
            }
            
            /* Timeframe selector compact */
            .timeframe-btn,
            .timeframe-selector {
                padding: 4px 6px !important;
                font-size: 11px !important;
                min-width: auto !important;
            }
            
            /* Chart container adjustment */
            .container {
                top: 44px;
            }
            
            /* Left sidebar - horizontal scroll */
            .left-sidebar {
                max-width: 100%;
                overflow-x: auto !important;
                overflow-y: hidden !important;
            }
            
            /* Right sidebar icons */
            .right-sidebar-icons {
                width: 36px;
                padding: 4px 2px;
            }
            
            .right-sidebar-icon-btn {
                width: 28px !important;
                height: 28px !important;
                min-width: 28px !important;
            }
            
            .right-sidebar-icon-btn svg {
                width: 14px !important;
                height: 14px !important;
            }
            
            /* Dropdowns full width on mobile */
            .help-dropdown-menu,
            .profile-dropdown-menu,
            .screenshot-dropdown-menu {
                position: fixed !important;
                left: 8px !important;
                right: 8px !important;
                width: auto !important;
                max-width: none !important;
            }
            
            /* Challenge toolbar compact */
            .challenge-toolbar-btn {
                padding: 4px 8px !important;
                font-size: 10px !important;
            }
            
            .challenge-toolbar-btn span {
                display: none !important;
            }
        }
        
        /* Small Mobile (max-width: 480px) */
        @media screen and (max-width: 480px) {
            .toolbar {
                height: 40px;
                padding: 2px;
            }
            
            .toolbar-left {
                gap: 1px;
            }
            
            .toolbar-right {
                gap: 1px;
            }
            
            /* Even smaller buttons */
            .toolbar-icon-btn,
            .toolbar-icon-btn-dark,
            .toolbar-icon-btn-light,
            .tool-group-btn {
                width: 28px !important;
                height: 28px !important;
                min-width: 28px !important;
            }
            
            .toolbar-icon-btn svg,
            .toolbar-icon-btn-dark svg,
            .toolbar-icon-btn-light svg,
            .tool-group-btn svg {
                width: 12px !important;
                height: 12px !important;
            }
            
            /* Hide more elements */
            .toolbar-logo {
                display: none !important;
            }
            
            .divider {
                display: none !important;
            }
            
            /* Compact selectors */
            .symbol-selector {
                max-width: 60px !important;
                padding: 2px 4px !important;
                font-size: 10px !important;
            }
            
            .timeframe-btn,
            .timeframe-selector {
                padding: 2px 4px !important;
                font-size: 10px !important;
            }
            
            /* Chart type button */
            .chart-type-btn {
                width: 28px !important;
                height: 28px !important;
                padding: 0 !important;
            }
            
            .chart-type-btn svg {
                width: 12px !important;
                height: 12px !important;
            }
            
            /* Container adjustment */
            .container {
                top: 40px;
            }
            
            /* Hide help button on very small screens */
            .help-menu-container {
                display: none !important;
            }
            
            /* Right sidebar even smaller */
            .right-sidebar-icons {
                width: 32px;
                padding: 2px;
            }
            
            .right-sidebar-icon-btn {
                width: 24px !important;
                height: 24px !important;
                min-width: 24px !important;
            }
            
            /* Replay toolbar mobile */
            #replayToolbar {
                max-width: calc(100vw - 16px) !important;
                padding: 8px !important;
            }
            
            .speed-option {
                padding: 4px 6px !important;
                font-size: 10px !important;
            }
        }
        
        /* Replay Toolbar Mobile Styles */
        @media screen and (max-width: 768px) {
            #replayToolbar {
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: calc(100vw - 32px);
                padding: 10px;
            }
            
            .replay-toolbar-content {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .speed-select-bar {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .speed-option {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            #replaySlider {
                min-width: 100px;
            }
            
            /* Bottom Replay Bar - Fixed */
            .replay-toolbar {
                padding: 6px 8px !important;
                gap: 4px !important;
                flex-wrap: wrap !important;
                height: auto !important;
                min-height: 36px !important;
            }
            
            .replay-toolbar-content {
                flex-wrap: wrap !important;
                gap: 6px !important;
                justify-content: center !important;
                padding: 0 4px !important;
            }
            
            .replay-toolbar-divider {
                display: none !important;
            }
            
            .replay-toolbar button,
            .replay-toolbar select {
                height: 28px !important;
                padding: 0 8px !important;
                font-size: 10px !important;
            }
            
            .replay-toolbar button.replay-icon-btn {
                width: 28px !important;
                height: 28px !important;
                min-width: 28px !important;
            }
            
            .replay-toolbar button.replay-icon-btn svg {
                width: 14px !important;
                height: 14px !important;
            }
            
            #replayStepForward {
                width: 40px !important;
                height: 36px !important;
                min-width: 40px !important;
            }
            
            #replayStepForward svg {
                width: 34px !important;
                height: 30px !important;
            }
            
            #replayStepForward:hover svg {
                margin-left: -6px;
            }
            
            /* Speed bar compact */
            .speed-select-bar {
                padding: 2px 4px !important;
                gap: 2px !important;
            }
            
            .speed-select-label {
                display: none !important;
            }
            
            .speed-option {
                padding: 4px 6px !important;
                font-size: 9px !important;
                min-width: 28px !important;
            }
            
            /* Hide less important elements */
            .replay-toolbar .replay-time-label,
            .replay-toolbar .nav-integrity-badge,
            .tick-progress-container {
                display: none !important;
            }
            
            /* Balance/Equity display compact */
            .balance-display,
            .realized-display,
            .replay-compact-meta {
                font-size: 9px !important;
                padding: 2px 6px !important;
            }
            
            .replay-compact-meta span {
                font-size: 9px !important;
            }
        }
        
        /* Small Mobile - Replay Bar */
        @media screen and (max-width: 480px) {
            .replay-toolbar {
                padding: 4px !important;
            }
            
            .replay-toolbar-content {
                gap: 4px !important;
            }
            
            .speed-select-bar {
                order: 1;
                width: 100%;
                justify-content: center !important;
            }
            
            .speed-option {
                padding: 3px 5px !important;
                font-size: 8px !important;
                min-width: 24px !important;
            }
            
            /* Stack meta info */
            .replay-compact-meta {
                order: 2;
                width: 100%;
                justify-content: center !important;
                flex-wrap: wrap !important;
            }
            
            .replay-toolbar button.replay-icon-btn {
                width: 24px !important;
                height: 24px !important;
                min-width: 24px !important;
            }
            
            /* Hide more on very small */
            .balance-display,
            .realized-display {
                display: none !important;
            }
        }
        
        /* Bottom Panel Mobile */
        @media screen and (max-width: 768px) {
            .bottom-panel {
                height: auto !important;
                max-height: 40vh;
            }
            
            .bottom-panel-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .bottom-panel-tab {
                padding: 6px 10px;
                font-size: 11px;
                white-space: nowrap;
            }
        }
        
        /* Touch-friendly tap targets */
        @media (hover: none) and (pointer: coarse) {
            .toolbar-icon-btn,
            .toolbar-icon-btn-dark,
            .toolbar-icon-btn-light,
            .tool-group-btn,
            .right-sidebar-icon-btn {
                min-width: 40px !important;
                min-height: 40px !important;
            }
        }
    </style>
    
    <!-- FINAL OVERRIDE: Unified Toolbar Styles - Must be last to override all previous CSS -->
    <style>
        /* ALL toolbar buttons - FINAL 32x32 override */
        .toolbar .toolbar-icon-btn,
        .toolbar .toolbar-icon-btn-dark,
        .toolbar .toolbar-icon-btn-light,
        .toolbar .tool-group-btn,
        .toolbar .toolbar-tool-btn,
        .toolbar .drawing-tool-btn,
        .toolbar .tool-btn,
        .toolbar .symbol-plus-btn,
        .toolbar-left .tool-group-btn,
        .toolbar-drawing-tools .tool-group-btn,
        .toolbar-drawing-tools .toolbar-tool-btn,
        .toolbar-drawing-icons .tool-group-btn,
        .left-sidebar .tool-btn,
        .left-sidebar .tool-group-btn,
        .left-sidebar .drawing-tools-vertical .tool-group-btn {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
            max-width: 32px !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            border-radius: 4px !important;
        }
        
        /* ALL toolbar icons - FINAL 18x18 override */
        .toolbar .toolbar-icon-btn svg,
        .toolbar .toolbar-icon-btn-dark svg,
        .toolbar .toolbar-icon-btn-light svg,
        .toolbar .tool-group-btn svg,
        .toolbar .toolbar-tool-btn svg,
        .toolbar .symbol-plus-btn svg,
        .left-sidebar .tool-btn svg,
        .left-sidebar .tool-group-btn svg {
            width: 18px !important;
            height: 18px !important;
        }
        
        /* FINAL gap override - 6px everywhere */
        .toolbar {
            gap: 6px !important;
        }

        body:not(.light-mode) {
            --tv-settings-gradient-bg: #050028;
            --tv-settings-gradient-bg-overlay: #050028;
            --tv-panel-bg: #050028;
        }

        body:not(.light-mode) .toolbar,
        body:not(.light-mode) .left-sidebar,
        body:not(.light-mode) .right-sidebar-icons,
        body:not(.light-mode) .right-sidebar-panel {
            background: #050028 !important;
        }

        body:not(.light-mode) .replay-toolbar::before {
            background: none !important;
        }
        
        body:not(.light-mode) .right-sidebar-panel {
            background: none !important;
        }

        body:not(.light-mode) .unified-right-panel {
            background: var(--tv-panel-bg) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-left: 1px solid rgba(63, 84, 124, 0.35) !important;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6) !important;
        }

        body:not(.light-mode) .replay-toolbar {
            background: #050028 !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border-top: 1px solid rgba(63, 84, 124, 0.35) !important;
        }

        body:not(.light-mode) #timeAxisZone,
        body:not(.light-mode) .time-axis-zone {
            background: transparent !important;
        }

        body:not(.light-mode) .tool-dropdown,
        body:not(.light-mode) .timeframe-dropdown-menu,
        body:not(.light-mode) #timeframeDropdownMenu,
        body:not(.light-mode) .layout-dropdown,
        body:not(.light-mode) .go-to-menu,
        body:not(.light-mode) .chart-context-menu,
        body:not(.light-mode) .drawing-style-editor,
        body:not(.light-mode) .tv-color-picker {
            background: var(--tv-panel-bg) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-color: rgba(63, 84, 124, 0.35) !important;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6) !important;
        }

        body:not(.light-mode) .timeframe-dropdown-section,
        body:not(.light-mode) .timeframe-dropdown-section-header,
        body:not(.light-mode) .timeframe-dropdown-item {
            background: transparent !important;
        }
        
        .toolbar-left {
            gap: 6px !important;
        }
        
        .toolbar-right {
            gap: 6px !important;
        }
        
        .toolbar-drawing-tools {
            gap: 6px !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
        }
        
        .left-sidebar {
            gap: 6px !important;
        }
        
        .left-sidebar .drawing-tools-vertical {
            gap: 6px !important;
        }
        
        /* Tool groups - no extra spacing */
        .tool-group,
        .toolbar-left .tool-group,
        .toolbar-drawing-tools .tool-group,
        .toolbar-drawing-icons .tool-group,
        .left-sidebar .tool-group {
            margin: 0 !important;
            padding: 0 !important;
            width: 32px !important;
            min-width: 32px !important;
        }
        
        /* Dividers - NO margin, gap handles spacing */
        .toolbar .divider,
        .toolbar-divider,
        .left-sidebar > .divider {
            width: 1px !important;
            height: 24px !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-shrink: 0 !important;
            background: rgba(120, 123, 134, 0.3) !important;
        }
        
        /* Hide first divider in left-sidebar */
        .left-sidebar > .divider:first-child {
            display: none !important;
        }
        
        /* Help button - round but same size */
        .toolbar .toolbar-icon-btn-light {
            border-radius: 50% !important;
        }
        
        /* Buttons with labels - auto width exception */
        .toolbar .toolbar-icon-btn.with-label,
        .toolbar .new-order-btn,
        .toolbar .replay-mode-btn {
            width: auto !important;
            max-width: none !important;
            padding: 0 10px !important;
            gap: 6px !important;
        }
    </style>
</head>
<body>
    <!-- Backtesting Loading Overlay -->
    <div id="backtestingLoader">
        <div class="loader-content">
            <div class="loader-icon"></div>
            <div class="loader-title">Initializing Replay Mode</div>
            <div class="loader-subtitle">Preparing your backtesting session...</div>
            
            <div class="loader-progress-container">
                <div class="loader-progress-bar" id="loaderProgress"></div>
            </div>
            
            <div class="loader-steps">
                <div class="loader-step" id="step1">
                    <span class="loader-step-icon"></span>
                    <span>Loading data...</span>
                </div>
                <div class="loader-step" id="step2">
                    <span class="loader-step-icon"></span>
                    <span>Calculating indicators...</span>
                </div>
                <div class="loader-step" id="step3">
                    <span class="loader-step-icon"></span>
                    <span>Starting replay...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Prop Firm Challenge Failed Modal -->
    <div id="challengeFailedModal" class="challenge-modal-overlay">
        <div class="challenge-modal">
            <div class="challenge-modal-icon failure"></div>
            <div class="challenge-modal-title">Challenge Failed</div>
            <div class="challenge-modal-subtitle" id="challengeFailedReason">
                You have exceeded the maximum loss limit
            </div>
            
            <div class="challenge-modal-stats">
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Final Balance</span>
                    <span class="challenge-modal-stat-value" id="challengeFailedBalance">$9,500.00</span>
                </div>
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Total P&L</span>
                    <span class="challenge-modal-stat-value negative" id="challengeFailedPnL">-$500.00 (-5.00%)</span>
                </div>
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Rule Violated</span>
                    <span class="challenge-modal-stat-value negative" id="challengeFailedRule">Max Daily Loss</span>
                </div>
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Trading Days</span>
                    <span class="challenge-modal-stat-value" id="challengeFailedDays">3</span>
                </div>
            </div>
            
            <div class="challenge-modal-buttons">
                <button class="challenge-modal-btn challenge-modal-btn-primary" onclick="exitToSessionDashboard()">
                    Return to Dashboard
                </button>
            </div>
        </div>
    </div>
    
    <!-- Prop Firm Challenge Passed Modal -->
    <div id="challengePassedModal" class="challenge-modal-overlay">
        <div class="challenge-modal">
            <div class="challenge-modal-icon success"></div>
            <div class="challenge-modal-title">Congratulations!</div>
            <div class="challenge-modal-subtitle">
                You've successfully reached your profit target!
            </div>
            
            <div class="challenge-modal-stats">
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Final Balance</span>
                    <span class="challenge-modal-stat-value" id="challengePassedBalance">$11,000.00</span>
                </div>
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Total Profit</span>
                    <span class="challenge-modal-stat-value positive" id="challengePassedProfit">+$1,000.00 (+10.00%)</span>
                </div>
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Target Required</span>
                    <span class="challenge-modal-stat-value positive" id="challengePassedTarget">10.00%</span>
                </div>
                <div class="challenge-modal-stat">
                    <span class="challenge-modal-stat-label">Trading Days</span>
                    <span class="challenge-modal-stat-value" id="challengePassedDays">5</span>
                </div>
            </div>
            
            <div class="challenge-modal-buttons">
                <button class="challenge-modal-btn challenge-modal-btn-success" onclick="continueTrading()">
                    Continue Trading
                </button>
                <button class="challenge-modal-btn challenge-modal-btn-secondary" onclick="exitToSessionDashboard()">
                    Exit to Dashboard
                </button>
            </div>
        </div>
    </div>
    

    <!-- Compare Symbol Modal - Modern Dark Theme -->
    <div id="compareModalOverlay" class="compare-modal-overlay">
        <div class="compare-modal">
            <div class="compare-modal-header">
                <h3>Add Symbol to Compare</h3>
                <button class="compare-modal-close" id="compareModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Added Symbols Pills -->
            <div class="compare-added-pills" id="compareAddedPills" style="display: none;">
                <!-- Pills will be populated dynamically -->
            </div>
            
            <div class="compare-modal-body">
                <div class="compare-search-box">
                    <svg class="compare-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="compare-search-input" id="compareSearchInput" placeholder="Search symbol...">
                </div>
                
                <!-- Available Symbols Section -->
                <div class="compare-section">
                    <div class="compare-section-title">Available Symbols</div>
                    <div class="compare-section-list" id="compareSymbolsList">
                        <!-- Symbols will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Legend Container (will be populated dynamically) -->
    <div class="overlay-legend" id="overlayLegend" style="display: none;"></div>

    <!-- Overlay Settings Popup -->
    <div id="overlaySettingsPopup" class="overlay-settings-popup">
        <div class="overlay-settings-content">
            <div class="overlay-settings-header">
                <span class="overlay-settings-title" id="overlaySettingsTitle">SYMBOL</span>
                <button class="overlay-settings-close" id="overlaySettingsClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="overlay-settings-tabs">
                <button class="overlay-tab active" data-tab="style">Style</button>
            </div>
            <div class="overlay-settings-body">
                <div class="overlay-setting-row">
                    <label>Style</label>
                    <select id="overlayStyleSelect" class="overlay-select">
                        <option value="line">Line</option>
                        <option value="candles">Candles</option>
                    </select>
                </div>
                <div class="overlay-setting-divider"></div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="overlayShowBody" checked>
                        Body
                    </label>
                    <div class="overlay-color-pair">
                        <div class="overlay-color-swatch" id="overlayBodyUp" data-color="#26a69a" style="background: #26a69a;" title="Up color"></div>
                        <div class="overlay-color-swatch" id="overlayBodyDown" data-color="#ef5350" style="background: #ef5350;" title="Down color"></div>
                    </div>
                </div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="overlayShowBorder" checked>
                        Borders
                    </label>
                    <div class="overlay-color-pair">
                        <div class="overlay-color-swatch" id="overlayBorderUp" data-color="#26a69a" style="background: #26a69a;" title="Up color"></div>
                        <div class="overlay-color-swatch" id="overlayBorderDown" data-color="#ef5350" style="background: #ef5350;" title="Down color"></div>
                    </div>
                </div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="overlayShowWick" checked>
                        Wick
                    </label>
                    <div class="overlay-color-pair">
                        <div class="overlay-color-swatch" id="overlayWickUp" data-color="#26a69a" style="background: #26a69a;" title="Up color"></div>
                        <div class="overlay-color-swatch" id="overlayWickDown" data-color="#ef5350" style="background: #ef5350;" title="Down color"></div>
                    </div>
                </div>
                <div class="overlay-setting-divider"></div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="overlayShowPriceLine" checked>
                        Price line
                    </label>
                </div>
            </div>
            <div class="overlay-settings-footer">
                <button class="overlay-btn-cancel" id="overlaySettingsCancel">Cancel</button>
                <button class="overlay-btn-ok" id="overlaySettingsOk">Ok</button>
            </div>
        </div>
    </div>

    <!-- New Pane Settings Popup -->
    <div id="newPaneSettingsPopup" class="overlay-settings-popup">
        <div class="overlay-settings-content">
            <div class="overlay-settings-header">
                <span class="overlay-settings-title" id="newPaneSettingsTitle">SYMBOL</span>
                <button class="overlay-settings-close" id="newPaneSettingsClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="overlay-settings-tabs">
                <button class="overlay-tab active" data-tab="style">Style</button>
            </div>
            <div class="overlay-settings-body">
                <div class="overlay-setting-row">
                    <label>Chart Style</label>
                    <select id="newPaneStyleSelect" class="overlay-select">
                        <option value="candles">Candles</option>
                        <option value="line">Line</option>
                        <option value="area">Area</option>
                        <option value="bars">Bars</option>
                        <option value="hollow">Hollow Candles</option>
                        <option value="heikin">Heikin Ashi</option>
                    </select>
                </div>
                <div class="overlay-setting-divider"></div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="newPaneShowBody" checked>
                        Body
                    </label>
                    <div class="overlay-color-pair">
                        <div class="overlay-color-swatch" id="newPaneBodyUp" data-color="#089981" style="background: #089981;" title="Up color"></div>
                        <div class="overlay-color-swatch" id="newPaneBodyDown" data-color="#f23645" style="background: #f23645;" title="Down color"></div>
                    </div>
                </div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="newPaneShowBorder" checked>
                        Borders
                    </label>
                    <div class="overlay-color-pair">
                        <div class="overlay-color-swatch" id="newPaneBorderUp" data-color="#089981" style="background: #089981;" title="Up color"></div>
                        <div class="overlay-color-swatch" id="newPaneBorderDown" data-color="#f23645" style="background: #f23645;" title="Down color"></div>
                    </div>
                </div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="newPaneShowWick" checked>
                        Wick
                    </label>
                    <div class="overlay-color-pair">
                        <div class="overlay-color-swatch" id="newPaneWickUp" data-color="#089981" style="background: #089981;" title="Up color"></div>
                        <div class="overlay-color-swatch" id="newPaneWickDown" data-color="#f23645" style="background: #f23645;" title="Down color"></div>
                    </div>
                </div>
                <div class="overlay-setting-divider"></div>
                <div class="overlay-setting-row">
                    <label>
                        <input type="checkbox" id="newPaneShowPriceLine" checked>
                        Price line
                    </label>
                </div>
            </div>
            <div class="overlay-settings-footer">
                <button class="overlay-btn-cancel" id="newPaneSettingsCancel">Cancel</button>
                <button class="overlay-btn-ok" id="newPaneSettingsOk">Ok</button>
            </div>
        </div>
    </div>

    <!-- Session Info Panel -->
    <div id="sessionInfoPanel" class="session-info-panel">
        <div class="session-info-header">
            <div class="session-info-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <span id="sessionName">Session Info</span>
            </div>
            <button class="session-info-toggle" id="sessionInfoToggle" title="Close">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="session-info-content">
            <div class="session-info-row">
                <span class="session-info-label">Status:</span>
                <span class="session-status-badge active" id="sessionStatus">Active</span>
            </div>
            <div class="session-info-row">
                <span class="session-info-label">Market:</span>
                <span class="session-info-value" id="sessionMarket">Forex</span>
            </div>
            <div class="session-info-row">
                <span class="session-info-label">Max Daily Loss:</span>
                <span class="session-info-value" id="sessionMaxDailyLoss">5%</span>
            </div>
            <div class="session-info-row">
                <span class="session-info-label">Max Drawdown:</span>
                <span class="session-info-value" id="sessionMaxDrawdown">20%</span>
            </div>
            <div class="session-info-row">
                <span class="session-info-label">Max Positions:</span>
                <span class="session-info-value" id="sessionMaxPositions">3</span>
            </div>
            <div class="session-info-row">
                <span class="session-info-label">Position Sizing:</span>
                <span class="session-info-value" id="sessionPositionSizing">Risk %</span>
            </div>
            <div class="session-info-row">
                <span class="session-info-label">Min R:R Ratio:</span>
                <span class="session-info-value" id="sessionMinRR">1:1.5</span>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <!-- Sidebar nav -->
        <div class="sp-sidebar">
            <div class="sp-sidebar-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                <span>Settings</span>
            </div>
            <nav class="sp-nav">
                <div class="sp-nav-item active" data-settings="symbol" onclick="event.stopPropagation();window._spLoad&&window._spLoad('symbol',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M18 3H6a1 1 0 0 0-1 1v4l-2 4 2 4v4a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-4l2-4-2-4V4a1 1 0 0 0-1-1z"/></svg>
                    <span>Symbol</span>
                </div>
                <div class="sp-nav-item" data-settings="statusline" onclick="event.stopPropagation();window._spLoad&&window._spLoad('statusline',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    <span>Status line</span>
                </div>
                <div class="sp-nav-item" data-settings="canvas" onclick="event.stopPropagation();window._spLoad&&window._spLoad('canvas',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                    <span>Canvas</span>
                </div>
                <div class="sp-nav-item" data-settings="trading" onclick="event.stopPropagation();window._spLoad&&window._spLoad('trading',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                    <span>Trading</span>
                </div>
                <div class="sp-nav-item" data-settings="watchlist" onclick="event.stopPropagation();window._spLoad&&window._spLoad('watchlist',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/></svg>
                    <span>Watchlist</span>
                </div>
                <div class="sp-nav-item" data-settings="news" onclick="event.stopPropagation();window._spLoad&&window._spLoad('news',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><line x1="10" y1="6" x2="18" y2="6"/><line x1="10" y1="10" x2="18" y2="10"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
                    <span>News</span>
                </div>
                <div class="sp-nav-divider"></div>
                <div class="sp-nav-item" data-settings="alerts" onclick="event.stopPropagation();window._spLoad&&window._spLoad('alerts',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.73 21a2 2 0 0 1-3.46 0" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span>Alerts</span>
                </div>
                <div class="sp-nav-item" data-settings="help" onclick="event.stopPropagation();window._spLoad&&window._spLoad('help',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><circle cx="12" cy="17" r="0.5" fill="currentColor"/></svg>
                    <span>Help</span>
                </div>
                <div class="sp-nav-item" data-settings="profile" onclick="event.stopPropagation();window._spLoad&&window._spLoad('profile',this);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span>Profile</span>
                </div>
            </nav>
        </div>
        <!-- Content area -->
        <div class="sp-content-wrap">
            <div class="sp-content-header">
                <span id="spContentTitle">General Settings</span>
                <button class="sp-close-btn" id="settingsPanelClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="sp-content-body" id="settingsPanelContent">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="side-panel" id="helpPanel">
        <div class="sp-content-header">
            <span class="side-panel-title">Help</span>
            <button class="sp-close-btn" onclick="event.stopPropagation();window._closeSidePanel('helpPanel');">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="side-panel-body">
            <div class="side-panel-item" id="helpContactSupport">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>
                <span>Contact Support</span>
            </div>
            <div class="side-panel-item" id="helpKeyboardShortcuts">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg>
                <span>Keyboard shortcuts</span>
            </div>
            <div class="side-panel-item" id="helpFAQ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><circle cx="12" cy="17" r="0.5" fill="currentColor"/></svg>
                <span>FAQ</span>
            </div>
            <div class="side-panel-item" id="helpEducation">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/></svg>
                <span>Education</span>
            </div>
            <div class="side-panel-divider"></div>
            <div class="side-panel-item" id="helpChangelog">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                <span>Changelog</span>
                <span class="side-panel-badge">1</span>
            </div>
            <div class="side-panel-footer">Current version 1.4.9</div>
        </div>
    </div>

    <!-- Profile Panel -->
    <div class="side-panel" id="profilePanel">
        <div class="sp-content-header">
            <span class="side-panel-title">Profile</span>
            <button class="sp-close-btn" onclick="event.stopPropagation();window._closeSidePanel('profilePanel');">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="side-panel-body">
            <div class="side-panel-item" id="profileLanguage2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                <span>Language</span>
                <span class="side-panel-value">English</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" width="14" height="14" style="color:#555a6e;flex-shrink:0;"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
            <div class="side-panel-item" id="profileTheme2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                <span>Theme</span>
                <span class="side-panel-value" id="profileThemeValue2">Dark</span>
            </div>
            <div class="side-panel-item" id="profileTimezone2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span>Timezone</span>
                <span class="side-panel-value">UTC+1</span>
            </div>
            <div class="side-panel-divider"></div>
            <div class="side-panel-item" id="profileAccount2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>Account Settings</span>
            </div>
            <div class="side-panel-item sp-danger" id="profileLogout2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                <span>Log Out</span>
            </div>
        </div>
    </div>

    <!-- Toolbar - TradingView Style -->
    <div class="toolbar">
            <!-- Left Section: Symbol & Timeframe -->
            <div class="toolbar-left">
                <!-- Logo -->
                <a href="/dashboard/" class="toolbar-logo" title="Go to Sessions">
                    <img src="modules/logo-04.png" alt="Logo" style="height: 28px; width: auto;">
                </a>

                <div class="divider"></div>

                <!-- Symbol Search with Plus -->
                <div class="symbol-search-group" id="symbolSearchGroup">
                    <svg class="symbol-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <span class="symbol-display" id="symbolDisplay">CHART</span>
                    <span class="session-mode-badge" id="sessionModeBadge" style="display: none;"></span>
                    <button class="symbol-plus-btn" id="symbolPlusBtn" title="Compare" onclick="event.stopPropagation(); openCompareSymbolModal();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <div class="divider"></div>
                    <button class="symbol-plus-btn" id="symbolWatchlistBtn" data-tooltip="Watchlist">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="14 2 14 8 20 8" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="13" x2="8" y2="13" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="17" x2="8" y2="17" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="10 9 9 9 8 9" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="divider"></div>
                </div>

                

                <!-- Chart Type Dropdown -->
                <div class="chart-type-selector tool-group" id="chartTypeSelector">
                    <button class="tool-group-btn" id="chartTypeBtn" data-tooltip="Chart Type">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" id="chartTypeIcon">
                            <path d="M9 5v4"/>
                            <rect width="4" height="6" x="7" y="9" rx="1"/>
                            <path d="M9 15v2"/>
                            <path d="M17 3v2"/>
                            <rect width="4" height="8" x="15" y="5" rx="1"/>
                            <path d="M17 13v3"/>
                            <path d="M3 3v16a2 2 0 0 0 2 2h16"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="chartTypeDropdownArrow">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="chart-type-dropdown tool-dropdown" id="chartTypeDropdown">
                        <div class="chart-type-option active" data-type="candles">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 5v4"/>
                                <rect width="4" height="6" x="7" y="9" rx="1"/>
                                <path d="M9 15v2"/>
                                <path d="M17 3v2"/>
                                <rect width="4" height="8" x="15" y="5" rx="1"/>
                                <path d="M17 13v3"/>
                                <path d="M3 3v16a2 2 0 0 0 2 2h16"/>
                            </svg>
                            <span>Candles</span>
                        </div>
                        <div class="chart-type-option" data-type="hollow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="10" width="4" height="10" rx="1"></rect>
                                <rect x="10" y="5" width="4" height="15" rx="1"></rect>
                                <rect x="17" y="8" width="4" height="12" rx="1"></rect>
                                <line x1="5" y1="6" x2="5" y2="10"></line>
                                <line x1="12" y1="2" x2="12" y2="5"></line>
                                <line x1="19" y1="4" x2="19" y2="8"></line>
                            </svg>
                            <span>Hollow Candles</span>
                        </div>
                        <div class="chart-type-option" data-type="heikinashi">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <!-- Heikin Ashi: smooth candles, wicks only on one side -->
                                <!-- Bearish (wick on top only) -->
                                <line x1="6" y1="4" x2="6" y2="7"></line>
                                <rect x="4" y="7" width="4" height="8" rx="0.5" fill="currentColor"></rect>
                                <!-- Bullish (wick on bottom only) -->
                                <rect x="10" y="6" width="4" height="8" rx="0.5"></rect>
                                <line x1="12" y1="14" x2="12" y2="18"></line>
                                <!-- Bullish (wick on bottom only) -->
                                <rect x="16" y="4" width="4" height="8" rx="0.5"></rect>
                                <line x1="18" y1="12" x2="18" y2="16"></line>
                            </svg>
                            <span>Heikin Ashi</span>
                        </div>
                        <div class="chart-type-option" data-type="bars">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="5" y1="4" x2="5" y2="20"></line>
                                <line x1="3" y1="8" x2="5" y2="8"></line>
                                <line x1="5" y1="16" x2="7" y2="16"></line>
                                <line x1="12" y1="6" x2="12" y2="18"></line>
                                <line x1="10" y1="10" x2="12" y2="10"></line>
                                <line x1="12" y1="14" x2="14" y2="14"></line>
                                <line x1="19" y1="5" x2="19" y2="19"></line>
                                <line x1="17" y1="9" x2="19" y2="9"></line>
                                <line x1="19" y1="15" x2="21" y2="15"></line>
                            </svg>
                            <span>Bars</span>
                        </div>
                        <div class="chart-type-option" data-type="line">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polyline points="3 17 8 11 13 15 21 7"></polyline>
                            </svg>
                            <span>Line</span>
                        </div>
                        <div class="chart-type-option" data-type="area">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M3 17 L8 11 L13 15 L21 7 L21 20 L3 20 Z" fill="currentColor" opacity="0.3"></path>
                                <polyline points="3 17 8 11 13 15 21 7"></polyline>
                            </svg>
                            <span>Area</span>
                        </div>
                        <div class="chart-type-option" data-type="baseline">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="3" y1="12" x2="21" y2="12" stroke-dasharray="2,2"></line>
                                <polyline points="3 15 7 9 11 13 15 8 21 10"></polyline>
                            </svg>
                            <span>Baseline</span>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Indicators Button (moved from sidebar) -->
                <button class="toolbar-icon-btn" id="indicatorsBtn" data-tooltip="Indicators" aria-label="Indicators">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="4" y="12" width="3" height="6" rx="1"></rect>
                        <rect x="10" y="10" width="3" height="8" rx="1"></rect>
                        <rect x="16" y="8" width="3" height="10" rx="1"></rect>
                        <path d="M4 8.5 L9 6 L13 9.5 L20 4.5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </button>

                <!-- Favorite Timeframes moved to sidebar - hidden here -->
                <div class="timeframe-selector" id="timeframeFavorites" style="display: none;">
                    <!-- Favorite timeframes now in sidebar -->
                </div>

                <!-- Timeframe Dropdown (hidden - moved to sidebar) -->
                <div class="timeframe-selector" id="timeframeDropdown" style="display: none;">
                    <span class="timeframe-label" id="currentTimeframeLabel">1m</span>
                    <button class="timeframe-dropdown-trigger" id="timeframeDropdownTrigger">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="timeframe-dropdown-menu" id="timeframeDropdownMenu">
                        <!-- Minutes Section -->
                        <div class="timeframe-dropdown-section" data-section="minutes">
                            <div class="timeframe-dropdown-item" data-timeframe="1m">
                                <span>1 minute</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="2m">
                                <span>2 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="3m">
                                <span>3 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="4m">
                                <span>4 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="5m">
                                <span>5 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="10m">
                                <span>10 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="15m">
                                <span>15 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="30m">
                                <span>30 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-item" data-timeframe="45m">
                                <span>45 minutes</span>
                                <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                </svg>
                            </div>
                        </div>

                        <!-- Hours Section -->
                        <div class="timeframe-dropdown-section" data-section="hours">
                            <div class="timeframe-dropdown-section-header">
                                <span>HOURS</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-section-content">
                                <div class="timeframe-dropdown-item" data-timeframe="1h">
                                    <span>1 hour</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                                <div class="timeframe-dropdown-item" data-timeframe="2h">
                                    <span>2 hours</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                                <div class="timeframe-dropdown-item" data-timeframe="4h">
                                    <span>4 hours</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                                <div class="timeframe-dropdown-item" data-timeframe="6h">
                                    <span>6 hours</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                                <div class="timeframe-dropdown-item" data-timeframe="12h">
                                    <span>12 hours</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Days Section -->
                        <div class="timeframe-dropdown-section" data-section="days">
                            <div class="timeframe-dropdown-section-header">
                                <span>DAYS</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="timeframe-dropdown-section-content">
                                <div class="timeframe-dropdown-item" data-timeframe="1D">
                                    <span>1 day</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                                <div class="timeframe-dropdown-item" data-timeframe="1w">
                                    <span>1 week</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                                <div class="timeframe-dropdown-item" data-timeframe="1mo">
                                    <span>1 month</span>
                                    <svg class="timeframe-dropdown-item-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Timeframe Section -->
                        <div class="timeframe-dropdown-section timeframe-custom-section">
                            <div class="timeframe-dropdown-item timeframe-custom-btn" id="customTimeframeBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="width: 16px; height: 16px; margin-right: 8px;">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>Custom</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                
                

                <!-- Compare Symbol Button -->
                <button class="toolbar-icon-btn with-label" id="compareBtn" data-tooltip="Compare Symbols" aria-label="Compare">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M18 20V10" stroke-linecap="round"/>
                        <path d="M12 20V4" stroke-linecap="round"/>
                        <path d="M6 20v-6" stroke-linecap="round"/>
                    </svg>
                    <span>Compare</span>
                </button>

                

               

                <!-- Replay Button (Hidden) -->
                <button id="replayModeBtn" class="replay-mode-btn" title="Enter Replay Mode" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 5v14m-7-7h14" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    Replay
                </button>
                

        <!-- Left Sidebar with Drawing Tools - TradingView Style with Grouped Dropdowns -->
        <div class="left-sidebar">
            
            <div class="drawing-tools-vertical">
                <!-- Cursor Tool with Dropdown -->
                <div class="divider"></div>
                <div class="tool-group">
                    
                    <button class="tool-group-btn active" id="cursorTool" data-tooltip="Cursor">
                        <svg id="cursorIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="cursorDropdownArrow" data-group="cursor" data-tooltip="Cursor Options">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown cursor-dropdown" id="cursor-dropdown">
                        <button class="cursor-option" data-cursor="cross" data-tooltip="Cross">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="12" y1="3" x2="12" y2="21" stroke-dasharray="2,2"/>
                                <line x1="3" y1="12" x2="21" y2="12" stroke-dasharray="2,2"/>
                            </svg>
                            <span>Cross</span>
                        </button>
                        <button class="cursor-option selected" data-cursor="dot" data-tooltip="Dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            </svg>
                            <span>Dot</span>
                        </button>
                        <button class="cursor-option" data-cursor="arrow" data-tooltip="Arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M5 3l14 9-6 1-3 6-5-16z" fill="currentColor" stroke="currentColor" stroke-linejoin="round"/>
                            </svg>
                            <span>Arrow</span>
                        </button>
                        <button class="cursor-option" data-cursor="eraser" data-tooltip="Eraser">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M20 20H7L3 16c-.6-.6-.6-1.5 0-2.1l10-10c.6-.6 1.5-.6 2.1 0l7 7c.6.6.6 1.5 0 2.1L14 21"/>
                                <path d="M6 11l7 7"/>
                            </svg>
                            <span>Eraser</span>
                        </button>
                                            </div>
                </div>
                
                <!-- Lines Group -->
                <div class="tool-group">
                    <button class="tool-group-btn" data-group="lines" data-tooltip="Lines">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="4" y1="18" x2="20" y2="6" stroke-linecap="round"/>
                            <circle cx="4" cy="18" r="0.8" fill="currentColor"/>
                            <circle cx="20" cy="6" r="0.8" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="linesDropdownArrow" data-group="lines">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown tool-dropdown-grid" id="lines-dropdown">
                        <span class="tool-dropdown-label">LINES</span>
                        <button class="tool-btn" id="trendlineTool" data-tooltip="Trend Line">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="18" x2="20" y2="6" stroke-linecap="round"/>
                                <circle cx="4" cy="18" r="0.8" fill="currentColor"/>
                                <circle cx="20" cy="6" r="0.8" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="horizontal-rayTool" data-tooltip="Horizontal Ray">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="12" x2="22" y2="12" stroke-linecap="round"/>
                                <circle cx="4" cy="12" r="0.8" fill="currentColor"/>
                                <path d="M19 9l3 3-3 3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="horizontalTool" data-tooltip="Horizontal Line">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="2" y1="12" x2="22" y2="12" stroke-linecap="round"/>
                                <line x1="2" y1="12" x2="5" y2="9" stroke-linecap="round" opacity="0.5"/>
                                <line x1="2" y1="12" x2="5" y2="15" stroke-linecap="round" opacity="0.5"/>
                                <line x1="22" y1="12" x2="19" y2="9" stroke-linecap="round" opacity="0.5"/>
                                <line x1="22" y1="12" x2="19" y2="15" stroke-linecap="round" opacity="0.5"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="verticalTool" data-tooltip="Vertical Line">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="12" y1="2" x2="12" y2="22" stroke-linecap="round"/>
                                <line x1="12" y1="2" x2="9" y2="5" stroke-linecap="round" opacity="0.5"/>
                                <line x1="12" y1="2" x2="15" y2="5" stroke-linecap="round" opacity="0.5"/>
                                <line x1="12" y1="22" x2="9" y2="19" stroke-linecap="round" opacity="0.5"/>
                                <line x1="12" y1="22" x2="15" y2="19" stroke-linecap="round" opacity="0.5"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="rayTool" data-tooltip="Ray">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="18" x2="20" y2="6" stroke-linecap="round"/>
                                <circle cx="4" cy="18" r="0.8" fill="currentColor"/>
                                <path d="M17 4l4 2-2 4" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="extended-lineTool" data-tooltip="Extended Line">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="2" y1="20" x2="22" y2="4" stroke-linecap="round"/>
                                <circle cx="8" cy="14" r="0.8" fill="currentColor"/>
                                <circle cx="16" cy="8" r="0.8" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="cross-lineTool" data-tooltip="Cross Line">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="12" y1="2" x2="12" y2="22" stroke-linecap="round"/>
                                <line x1="2" y1="12" x2="22" y2="12" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="polylineTool" data-tooltip="Polyline">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <polyline points="4,18 9,8 14,14 20,6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                <circle cx="4" cy="18" r="0.8" fill="currentColor"/>
                                <circle cx="9" cy="8" r="0.8" fill="currentColor"/>
                                <circle cx="14" cy="14" r="0.8" fill="currentColor"/>
                                <circle cx="20" cy="6" r="0.8" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="pathTool" data-tooltip="Path">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <polyline points="2,15 6,8 10,14 14,6 18,12 22,9" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                <circle cx="2" cy="15" r="0.8" fill="currentColor"/>
                                <circle cx="6" cy="8" r="0.8" fill="currentColor"/>
                                <circle cx="10" cy="14" r="0.8" fill="currentColor"/>
                                <circle cx="14" cy="6" r="0.8" fill="currentColor"/>
                                <circle cx="18" cy="12" r="0.8" fill="currentColor"/>
                                <circle cx="22" cy="9" r="0.8" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="curveTool" data-tooltip="Curve">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M4 16 C8 4, 16 20, 20 8" stroke-linecap="round" fill="none"/>
                                <circle cx="4" cy="16" r="0.8" fill="currentColor"/>
                                <circle cx="20" cy="8" r="0.8" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="double-curveTool" data-tooltip="Double Curve">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                <path d="M4 12 C7 4, 10 20, 12 12 C14 4, 17 20, 20 12" stroke-linecap="round" fill="none"/>
                                <circle cx="4" cy="12" r="0.8" fill="currentColor"/>
                                <circle cx="20" cy="12" r="0.8" fill="currentColor"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">SHAPES</span>
                        <button class="tool-btn" id="triangleTool" data-tooltip="Triangle">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M12 4L21 20H3L12 4z" stroke-linejoin="round"/>
                                <circle cx="12" cy="4" r="0.9" fill="currentColor"/>
                                <circle cx="3" cy="20" r="0.9" fill="currentColor"/>
                                <circle cx="21" cy="20" r="0.9" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="rectangleTool" data-tooltip="Rectangle">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="4" y="6" width="16" height="12" rx="1"/>
                                <circle cx="4" cy="6" r="0.9" fill="currentColor"/>
                                <circle cx="20" cy="6" r="0.9" fill="currentColor"/>
                                <circle cx="4" cy="18" r="0.9" fill="currentColor"/>
                                <circle cx="20" cy="18" r="0.9" fill="currentColor"/>
                            </svg>
                        </button>
                        
                        <button class="tool-btn" id="arcTool" data-tooltip="Arc">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M4 18 Q12 2 20 18" stroke-linecap="round" fill="none"/>
                                <circle cx="4" cy="18" r="0.9" fill="currentColor"/>
                                <circle cx="20" cy="18" r="0.9" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="ellipseTool" data-tooltip="Ellipse">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <ellipse cx="12" cy="12" rx="9" ry="6"/>
                                <circle cx="3" cy="12" r="0.9" fill="currentColor"/>
                                <circle cx="21" cy="12" r="0.9" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="circleTool" data-tooltip="Circle">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="8"/>
                                <circle cx="12" cy="4" r="0.9" fill="currentColor"/>
                                <circle cx="12" cy="20" r="0.9" fill="currentColor"/>
                                <circle cx="4" cy="12" r="0.9" fill="currentColor"/>
                                <circle cx="20" cy="12" r="0.9" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Arrows Group -->
                <div class="tool-group">
                    <button class="tool-group-btn" data-group="arrows" data-tooltip="Arrows & Channels">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="5" y1="19" x2="19" y2="5" stroke-linecap="round"/>
                            <path d="M12 5h7v7" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="arrowsDropdownArrow" data-group="arrows">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown tool-dropdown-grid" id="arrows-dropdown">
                        <span class="tool-dropdown-label">BRUSHES</span>
                        <button class="tool-btn" id="brushTool" data-tooltip="Brush (B)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m11 10 3 3"/><path d="M6.5 21A3.5 3.5 0 1 0 3 17.5a2.62 2.62 0 0 1-.708 1.792A1 1 0 0 0 3 21z"/><path d="M9.969 17.031 21.378 5.624a1 1 0 0 0-3.002-3.002L6.967 14.031"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="highlighterTool" data-tooltip="Highlighter (I)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">ARROWS</span>
                        <button class="tool-btn" id="arrow-markerTool" data-tooltip="Arrow Marker">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M12 20V8" stroke-linecap="round"/>
                                <path d="M12 4l-5 6h10l-5-6z" fill="currentColor" stroke="currentColor" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="arrowTool" data-tooltip="Arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="5" y1="19" x2="19" y2="5" stroke-linecap="round"/>
                                <path d="M12 5h7v7" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="5" cy="19" r="2" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="arrow-mark-upTool" data-tooltip="Arrow Mark Up">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 13a1 1 0 0 0-1-1H5.061a1 1 0 0 1-.75-1.811l6.835-6.836a1.207 1.207 0 0 1 1.707 0l6.836 6.836a1 1 0 0 1-.75 1.811H16a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1z"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="arrow-mark-downTool" data-tooltip="Arrow Mark Down">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M15 11a1 1 0 0 0 1 1h2.939a1 1 0 0 1 .75 1.811l-6.835 6.836a1.207 1.207 0 0 1-1.707 0L4.31 13.81a1 1 0 0 1 .75-1.811H8a1 1 0 0 0 1-1V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1z"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">CHANNELS</span>
                        <button class="tool-btn" id="parallel-channelTool" data-tooltip="Parallel Channel">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="2" y1="18" x2="22" y2="10" stroke-linecap="round"/>
                                <line x1="2" y1="12" x2="22" y2="4" stroke-linecap="round" />
                                <circle cx="2" cy="18" r="1.5" fill="currentColor"/>
                                <circle cx="22" cy="10" r="1.5" fill="currentColor"/>
                                <circle cx="2" cy="12" r="1.5" fill="currentColor" />
                                <circle cx="22" cy="4" r="1.5" fill="currentColor" />
                            </svg>
                        </button>
                        <button class="tool-btn" id="regression-trendTool" data-tooltip="Regression Channel">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="2" y1="18" x2="22" y2="6" stroke-linecap="round"/>
                                <line x1="2" y1="12" x2="22" y2="0" stroke-linecap="round" stroke-dasharray="3,2" opacity="0.5"/>
                                <line x1="2" y1="24" x2="22" y2="12" stroke-linecap="round" stroke-dasharray="3,2" opacity="0.5"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="flat-top-bottomTool" data-tooltip="Flat Top/Bottom">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="2" y1="6" x2="22" y2="6" stroke-linecap="round"/>
                                <line x1="2" y1="18" x2="22" y2="12" stroke-linecap="round"/>
                                <circle cx="2" cy="6" r="1.5" fill="currentColor"/>
                                <circle cx="22" cy="6" r="1.5" fill="currentColor"/>
                                <circle cx="2" cy="18" r="1.5" fill="currentColor"/>
                                <circle cx="22" cy="12" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="disjoint-channelTool" data-tooltip="Disjoint Channel">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="2" y1="16" x2="10" y2="10" stroke-linecap="round"/>
                                <line x1="14" y1="14" x2="22" y2="8" stroke-linecap="round"/>
                                <line x1="2" y1="20" x2="10" y2="14" stroke-linecap="round" opacity="0.5"/>
                                <line x1="14" y1="18" x2="22" y2="12" stroke-linecap="round" opacity="0.5"/>
                                <circle cx="2" cy="16" r="1.5" fill="currentColor"/>
                                <circle cx="10" cy="10" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">PITCHFORKS</span>
                        <button class="tool-btn" id="pitchforkTool" data-tooltip="Pitchfork">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <g transform="rotate(-12 12 12)">
                                    <line x1="8" y1="5" x2="8" y2="19" stroke-linecap="round"/>
                                    <line x1="8" y1="6" x2="19" y2="6" stroke-linecap="round"/>
                                    <line x1="8" y1="12" x2="19" y2="12" stroke-linecap="round"/>
                                    <line x1="8" y1="18" x2="19" y2="18" stroke-linecap="round"/>
                                    <line x1="8" y1="12" x2="5" y2="14" stroke-linecap="round"/>
                                </g>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Text Group -->
                <div class="tool-group">
                    <button class="tool-group-btn" data-group="text" data-tooltip="Text & Notes">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M6 5h12M12 5v14M8 19h8" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="textDropdownArrow" data-group="text">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown tool-dropdown-grid" id="text-dropdown">
                        <span class="tool-dropdown-label">TEXTS AND NOTES</span>
                        <button class="tool-btn" id="textTool" data-tooltip="Text">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M5 5h14M12 5v14M8 19h8" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="noteTool" data-tooltip="Note">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                <path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"/>
                                <line x1="9" y1="11" x2="15" y2="11"/>
                                <line x1="9" y1="15" x2="13" y2="15"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="price-noteTool" data-tooltip="Price Note">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="4" y="4" width="16" height="16" rx="2"/>
                                <path d="M12 8v8M9 11c0-1.5 1.5-2 3-2s3 .5 3 2-1.5 2-3 2" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="pinTool" data-tooltip="Pin">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M12 22c0 0-6-7-6-12a6 6 0 1 1 12 0c0 5-6 12-6 12z"/>
                                <circle cx="12" cy="10" r="2"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="calloutTool" data-tooltip="Callout">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M21 5H3a2 2 0 00-2 2v10a2 2 0 002 2h4l3 3 3-3h8a2 2 0 002-2V7a2 2 0 00-2-2z" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="commentTool" data-tooltip="Comment">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="price-label-2Tool" data-tooltip="Price Label">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="4" y="4" width="16" height="10" rx="3" stroke-linejoin="round"/>
                                <path d="M7 14 L5 18" stroke-linecap="round"/>
                                <circle cx="5" cy="18" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="signpost-2Tool" data-tooltip="Signpost">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="12" y1="4" x2="12" y2="16" stroke-linecap="round"/>
                                <rect x="6" y="16" width="12" height="6" rx="2" stroke-linejoin="round"/>
                                <circle cx="12" cy="4" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="flag-markTool" data-tooltip="Flag Mark">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M4 21V4" stroke-linecap="round"/>
                                <path d="M4 4h12l-3 4 3 4H4" stroke-linejoin="round" fill="rgba(255,255,255,0.1)"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="imageTool" data-tooltip="Image">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
                                <path d="M21 15l-5-5L5 21" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">EMOJIS</span>
                        <button class="tool-btn" id="emojiTool" data-tooltip="Emojis & Stickers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Analysis Tools Group (Fibonacci + Positions) -->
                <div class="tool-group">
                    <button class="tool-group-btn" data-group="analysis" data-tooltip="Analysis Tools">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="3" y1="20" x2="21" y2="4" stroke-linecap="round"/>
                            <line x1="3" y1="20" x2="21" y2="20" opacity="0.4"/>
                            <line x1="3" y1="14" x2="21" y2="14" opacity="0.4"/>
                            <line x1="3" y1="8" x2="21" y2="8" opacity="0.4"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="analysisDropdownArrow" data-group="analysis">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown tool-dropdown-grid" id="analysis-dropdown">
                        <span class="tool-dropdown-label">FIBONACCI</span>
                        <button class="tool-btn" id="fibonacci-retracementTool" data-tooltip="Fib Retracement">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="3" y1="20" x2="21" y2="4" stroke-linecap="round"/>
                                <line x1="3" y1="20" x2="21" y2="20" opacity="0.5" stroke="#ffd54f"/>
                                <line x1="3" y1="14" x2="21" y2="14" opacity="0.5" stroke="#26a69a"/>
                                <line x1="3" y1="8" x2="21" y2="8" opacity="0.5" stroke="#ef5350"/>
                                <circle cx="3" cy="20" r="2" fill="currentColor"/>
                                <circle cx="21" cy="4" r="2" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="trend-fib-extensionTool" data-tooltip="Trend-Based Fib Extension">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="3" y1="18" x2="12" y2="6" stroke-linecap="round"/>
                                <line x1="12" y1="6" x2="21" y2="12" stroke-linecap="round"/>
                                <line x1="3" y1="4" x2="21" y2="4" opacity="0.4" stroke-dasharray="2,2"/>
                                <line x1="3" y1="8" x2="21" y2="8" opacity="0.4"/>
                                <line x1="3" y1="14" x2="21" y2="14" opacity="0.4"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-channelTool" data-tooltip="Fib Channel">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="3" y1="18" x2="21" y2="10"/>
                                <line x1="3" y1="14" x2="21" y2="6" opacity="0.5"/>
                                <line x1="3" y1="10" x2="21" y2="2" opacity="0.3"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-timezoneTool" data-tooltip="Fib Time Zone">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="3" y1="4" x2="3" y2="20"/>
                                <line x1="6" y1="4" x2="6" y2="20" opacity="0.7"/>
                                <line x1="11" y1="4" x2="11" y2="20" opacity="0.5"/>
                                <line x1="19" y1="4" x2="19" y2="20" opacity="0.3"/>
                                <circle cx="3" cy="20" r="1.5" fill="currentColor"/>
                                <circle cx="6" cy="20" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-speed-fanTool" data-tooltip="Fib Speed Resistance Fan">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="3" y1="20" x2="21" y2="4"/>
                                <line x1="3" y1="20" x2="21" y2="8" opacity="0.6"/>
                                <line x1="3" y1="20" x2="21" y2="12" opacity="0.4"/>
                                <line x1="3" y1="20" x2="21" y2="16" opacity="0.3"/>
                                <circle cx="3" cy="20" r="2" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="trend-fib-timeTool" data-tooltip="Trend-Based Fib Time">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="4" x2="4" y2="20"/>
                                <line x1="10" y1="4" x2="10" y2="20"/>
                                <line x1="14" y1="4" x2="14" y2="20" opacity="0.5"/>
                                <line x1="20" y1="4" x2="20" y2="20" opacity="0.3" stroke-dasharray="2,2"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-circlesTool" data-tooltip="Fib Circles">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <circle cx="12" cy="12" r="6" opacity="0.6"/>
                                <circle cx="12" cy="12" r="9" opacity="0.3"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-spiralTool" data-tooltip="Fib Spiral">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M12 12 Q16 12 16 8 Q16 4 12 4 Q8 4 8 8 Q8 14 14 14 Q20 14 20 8" fill="none"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-arcsTool" data-tooltip="Fib Speed Resistance Arcs">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="20" x2="20" y2="4"/>
                                <path d="M20 20 Q20 12 12 12" fill="none" opacity="0.6"/>
                                <path d="M20 20 Q20 8 8 8" fill="none" opacity="0.4"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="fib-wedgeTool" data-tooltip="Fib Wedge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="12" x2="20" y2="4"/>
                                <line x1="4" y1="12" x2="20" y2="20"/>
                                <line x1="4" y1="12" x2="20" y2="8" opacity="0.4" stroke-dasharray="2,2"/>
                                <line x1="4" y1="12" x2="20" y2="16" opacity="0.4" stroke-dasharray="2,2"/>
                                <circle cx="4" cy="12" r="2" fill="currentColor"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">GANN</span>
                        <button class="tool-btn" id="gann-boxTool" data-tooltip="Gann Box">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="3" y="3" width="18" height="18"/>
                                <line x1="3" y1="12" x2="21" y2="12" opacity="0.5"/>
                                <line x1="12" y1="3" x2="12" y2="21" opacity="0.5"/>
                                <line x1="3" y1="3" x2="21" y2="21" opacity="0.5"/>
                                <line x1="21" y1="3" x2="3" y2="21" opacity="0.5"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="gann-square-fixedTool" data-tooltip="Gann Square Fixed">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="4" y="4" width="16" height="16"/>
                                <line x1="4" y1="8" x2="20" y2="8" opacity="0.4"/>
                                <line x1="4" y1="12" x2="20" y2="12" opacity="0.4"/>
                                <line x1="4" y1="16" x2="20" y2="16" opacity="0.4"/>
                                <line x1="8" y1="4" x2="8" y2="20" opacity="0.4"/>
                                <line x1="12" y1="4" x2="12" y2="20" opacity="0.4"/>
                                <line x1="16" y1="4" x2="16" y2="20" opacity="0.4"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="gann-fanTool" data-tooltip="Gann Fan">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="20" x2="20" y2="4"/>
                                <line x1="4" y1="20" x2="20" y2="8" opacity="0.6"/>
                                <line x1="4" y1="20" x2="20" y2="12" opacity="0.5"/>
                                <line x1="4" y1="20" x2="20" y2="16" opacity="0.4"/>
                                <line x1="4" y1="20" x2="12" y2="20" opacity="0.3"/>
                                <circle cx="4" cy="20" r="2" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Projections Group -->
                <div class="tool-group">
                    <button class="tool-group-btn" data-group="projections" data-tooltip="Projections">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="4" y="6" width="16" height="12" rx="1" fill="none"/>
                            <line x1="4" y1="12" x2="20" y2="12"/>
                            <line x1="4" y1="6" x2="20" y2="6" stroke="#ef5350" stroke-dasharray="2,2"/>
                            <line x1="4" y1="18" x2="20" y2="18" stroke="#26a69a" stroke-dasharray="2,2"/>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="projectionsDropdownArrow" data-group="projections">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown tool-dropdown-grid" id="projections-dropdown">
                        <span class="tool-dropdown-label">PROJECTIONS</span>
                        <button class="tool-btn" id="short-positionTool" data-tooltip="Short Position">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#ef5350" stroke-width="1">
                                <rect x="4" y="4" width="16" height="12" rx="1" fill="rgba(239,83,80,0.15)"/>
                                <line x1="4" y1="10" x2="20" y2="10" stroke="#ef5350"/>
                                <line x1="4" y1="4" x2="20" y2="4" stroke="#26a69a" stroke-dasharray="2,2"/>
                                <line x1="4" y1="16" x2="20" y2="16" stroke="#ef5350" stroke-dasharray="2,2"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="long-positionTool" data-tooltip="Long Position">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#26a69a" stroke-width="1">
                                <rect x="4" y="8" width="16" height="12" rx="1" fill="rgba(38,166,154,0.15)"/>
                                <line x1="4" y1="14" x2="20" y2="14" stroke="#26a69a"/>
                                <line x1="4" y1="8" x2="20" y2="8" stroke="#ef5350" stroke-dasharray="2,2"/>
                                <line x1="4" y1="20" x2="20" y2="20" stroke="#26a69a" stroke-dasharray="2,2"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="date-price-rangeTool" data-tooltip="Date and Price Range">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="4" y="4" width="16" height="16" rx="1" stroke-dasharray="3,2"/>
                                <line x1="4" y1="12" x2="20" y2="12"/>
                                <line x1="12" y1="4" x2="12" y2="20"/>
                                <circle cx="4" cy="4" r="1.5" fill="currentColor"/>
                                <circle cx="20" cy="4" r="1.5" fill="currentColor"/>
                                <circle cx="4" cy="20" r="1.5" fill="currentColor"/>
                                <circle cx="20" cy="20" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="price-rangeTool" data-tooltip="Price Range">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="12" y1="4" x2="12" y2="20" stroke-linecap="round"/>
                                <line x1="8" y1="4" x2="16" y2="4" stroke-linecap="round"/>
                                <line x1="8" y1="20" x2="16" y2="20" stroke-linecap="round"/>
                                <path d="M12 7l-2-3M12 7l2-3" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 17l-2 3M12 17l2 3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="date-rangeTool" data-tooltip="Date Range">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="4" y1="12" x2="20" y2="12" stroke-linecap="round"/>
                                <line x1="4" y1="8" x2="4" y2="16" stroke-linecap="round"/>
                                <line x1="20" y1="8" x2="20" y2="16" stroke-linecap="round"/>
                                <path d="M7 12l-3-2M7 12l-3 2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M17 12l3-2M17 12l3 2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Patterns Group (includes Elliott Waves and Volume-Based) -->
                <div class="tool-group">
                    <button class="tool-group-btn" data-group="patterns" data-tooltip="Patterns & Waves">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 20L5 14L8 16L11 6L14 10L17 2L20 8L22 6"/>
                            <text x="4" y="13" font-size="4" fill="currentColor" stroke="none">1</text>
                            <text x="10" y="5" font-size="4" fill="currentColor" stroke="none">3</text>
                            <text x="16" y="1" font-size="4" fill="currentColor" stroke="none">5</text>
                        </svg>
                    </button>
                    <button class="dropdown-arrow" id="patternsDropdownArrow" data-group="patterns">
                        <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="tool-dropdown tool-dropdown-grid" id="patterns-dropdown">
                        <span class="tool-dropdown-label">ELLIOTT WAVES</span>
                        <button class="tool-btn" id="elliott-impulseTool" data-tooltip="Elliott Impulse Wave (12345)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 20L5 14L8 16L11 6L14 10L17 2L20 8L22 6"/>
                                <text x="4" y="13" font-size="4" fill="currentColor" stroke="none">1</text>
                                <text x="10" y="5" font-size="4" fill="currentColor" stroke="none">3</text>
                                <text x="16" y="1" font-size="4" fill="currentColor" stroke="none">5</text>
                            </svg>
                        </button>
                        <button class="tool-btn" id="elliott-correctionTool" data-tooltip="Elliott Correction Wave (ABC)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 6L10 16L16 10L22 18"/>
                                <text x="3" y="5" font-size="5" fill="currentColor" stroke="none">A</text>
                                <text x="15" y="9" font-size="5" fill="currentColor" stroke="none">C</text>
                            </svg>
                        </button>
                        <button class="tool-btn" id="elliott-triangleTool" data-tooltip="Elliott Triangle Wave (ABCDE)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 12L6 6L10 10L14 8L18 9L22 12"/>
                                <text x="5" y="5" font-size="4" fill="currentColor" stroke="none">A</text>
                                <text x="17" y="8" font-size="4" fill="currentColor" stroke="none">E</text>
                            </svg>
                        </button>
                        <button class="tool-btn" id="elliott-double-comboTool" data-tooltip="Elliott Double Combo Wave (WXY)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 14L7 6L12 12L17 8L22 14"/>
                                <text x="6" y="5" font-size="4" fill="currentColor" stroke="none">W</text>
                                <text x="16" y="7" font-size="4" fill="currentColor" stroke="none">Y</text>
                            </svg>
                        </button>
                        <button class="tool-btn" id="elliott-triple-comboTool" data-tooltip="Elliott Triple Combo Wave (WXYXZ)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 14L5 6L9 12L13 8L17 11L21 6L23 10"/>
                                <text x="4" y="5" font-size="3" fill="currentColor" stroke="none">W</text>
                                <text x="12" y="7" font-size="3" fill="currentColor" stroke="none">X</text>
                                <text x="20" y="5" font-size="3" fill="currentColor" stroke="none">Z</text>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">PATTERNS</span>
                        <button class="tool-btn" id="xabcd-patternTool" data-tooltip="XABCD Pattern">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 18L6 6L12 14L18 4L22 12"/>
                                <circle cx="2" cy="18" r="1.5" fill="currentColor"/>
                                <circle cx="6" cy="6" r="1.5" fill="currentColor"/>
                                <circle cx="12" cy="14" r="1.5" fill="currentColor"/>
                                <circle cx="18" cy="4" r="1.5" fill="currentColor"/>
                                <circle cx="22" cy="12" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="cypher-patternTool" data-tooltip="Cypher Pattern">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 16L7 4L12 12L17 6L22 14"/>
                                <circle cx="2" cy="16" r="1.5" fill="currentColor"/>
                                <circle cx="7" cy="4" r="1.5" fill="currentColor"/>
                                <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                                <circle cx="17" cy="6" r="1.5" fill="currentColor"/>
                                <circle cx="22" cy="14" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="head-shouldersTool" data-tooltip="Head and Shoulders">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 16L6 12L9 14L12 4L15 14L18 12L22 16"/>
                                <circle cx="6" cy="12" r="1.5" fill="currentColor"/>
                                <circle cx="12" cy="4" r="1.5" fill="currentColor"/>
                                <circle cx="18" cy="12" r="1.5" fill="currentColor"/>
                                <line x1="2" y1="18" x2="22" y2="18" stroke-dasharray="3,2" opacity="0.5"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="abcd-patternTool" data-tooltip="ABCD Pattern">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 18L9 6L15 14L20 6"/>
                                <circle cx="4" cy="18" r="1.5" fill="currentColor"/>
                                <circle cx="9" cy="6" r="1.5" fill="currentColor"/>
                                <circle cx="15" cy="14" r="1.5" fill="currentColor"/>
                                <circle cx="20" cy="6" r="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="triangle-patternTool" data-tooltip="Triangle Pattern">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 8L8 16L13 10L18 14L21 12"/>
                                <line x1="3" y1="6" x2="21" y2="10" opacity="0.5" stroke-dasharray="3,2"/>
                                <line x1="3" y1="18" x2="21" y2="14" opacity="0.5" stroke-dasharray="3,2"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="three-drivesTool" data-tooltip="Three Drives Pattern">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 20L5 14L8 16L11 8L14 12L17 4L22 10"/>
                                <circle cx="5" cy="14" r="1" fill="currentColor"/>
                                <circle cx="11" cy="8" r="1" fill="currentColor"/>
                                <circle cx="17" cy="4" r="1" fill="currentColor"/>
                            </svg>
                        </button>
                        <span class="tool-dropdown-label">VOLUME-BASED</span>
                        <button class="tool-btn" id="anchored-vwapTool" data-tooltip="Anchored VWAP">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M4 16c3-4 6-2 8-6s4-2 8-4" stroke-linecap="round"/>
                                <path d="M4 12c3-2 6-1 8-3s4-1 8-2" stroke-linecap="round" opacity="0.4"/>
                                <path d="M4 20c3-2 6-1 8-3s4-1 8-2" stroke-linecap="round" opacity="0.4"/>
                                <circle cx="4" cy="16" r="2.5" fill="currentColor"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="volume-profileTool" data-tooltip="Fixed Range Volume Profile">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="1"/>
                                <rect x="6" y="5" width="8" height="3" fill="currentColor" opacity="0.6" rx="1"/>
                                <rect x="6" y="9" width="12" height="3" fill="currentColor" opacity="0.8" rx="1"/>
                                <rect x="6" y="13" width="6" height="3" fill="currentColor" opacity="0.5" rx="1"/>
                                <rect x="6" y="17" width="4" height="2" fill="currentColor" opacity="0.4" rx="1"/>
                            </svg>
                        </button>
                        <button class="tool-btn" id="anchored-volume-profileTool" data-tooltip="Anchored Volume Profile">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="6" y1="3" x2="6" y2="21" stroke-dasharray="2,2" opacity="0.7"/>
                                <circle cx="6" cy="12" r="2.5" fill="currentColor"/>
                                <rect x="6" y="5" width="10" height="2.5" fill="currentColor" opacity="0.6" rx="1"/>
                                <rect x="6" y="8.5" width="14" height="2.5" fill="currentColor" opacity="0.8" rx="1"/>
                                <rect x="6" y="12" width="8" height="2.5" fill="currentColor" opacity="0.5" rx="1"/>
                                <rect x="6" y="15.5" width="5" height="2.5" fill="currentColor" opacity="0.4" rx="1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Ruler/Measure Tool -->
                <div class="tool-group">
                    <button class="tool-group-btn" id="rulerTool" data-tooltip="Ruler">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/>
                            <path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/>
                        </svg>
                    </button>
                </div>
                
                <div class="tool-divider"></div>
                
               
                
                <!-- Toggle Favorites Bar (at bottom) -->
                <div class="tool-group">
                    <button class="tool-group-btn active" id="toggleFavoritesBar" data-tooltip="Toggle Favorites Bar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M9 4v6l-2 4v2h10v-2l-2-4V4" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="12" y1="16" x2="12" y2="21" stroke-linecap="round"/>
                            <line x1="8" y1="4" x2="16" y2="4" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="divider"></div>
            <!-- Drawing Tool Icons (moved from sidebar) -->
                <div class="toolbar-drawing-icons">
                    <!-- Visibility Menu -->
                    <div class="tool-group">
                        <button class="tool-group-btn" id="toggleAllDrawingsToolbar" data-group="visibility-toolbar" data-tooltip="Show/Hide All Drawings">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                        <button class="dropdown-arrow" id="visibilityDropdownArrowToolbar" data-group="visibility-toolbar">
                            <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div class="tool-dropdown tool-dropdown-grid" id="visibility-toolbar-dropdown">
                            <span class="tool-dropdown-label">VISIBILITY</span>
                            <button class="tool-btn" id="toggleAllDrawingsToolbarDropdown" data-tooltip="Show/Hide All Drawings" onclick="window.toggleDrawingsVisibility()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <!-- Eye -->
                                    <g transform="translate(0, 2) scale(0.75)">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </g>
                                    <!-- Brush in corner -->
                                    <g transform="translate(10, 8) scale(0.65)">
                                        <path d="m11 10 3 3" stroke-width="2"/>
                                        <path d="M6.5 21A3.5 3.5 0 1 0 3 17.5a2.62 2.62 0 0 1-.708 1.792A1 1 0 0 0 3 21z" stroke-width="2"/>
                                        <path d="M9.969 17.031 21.378 5.624a1 1 0 0 0-3.002-3.002L6.967 14.031" stroke-width="2"/>
                                    </g>
                                </svg>
                            </button>
                            <button class="tool-btn" id="toggleIndicatorsToolbar" data-tooltip="Show/Hide Indicators" onclick="window.toggleIndicatorsVisibility()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <!-- Eye -->
                                    <g transform="translate(0, 2) scale(0.75)">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </g>
                                    <!-- Indicator in corner -->
                                    <g transform="translate(10, 8) scale(0.65)">
                                        <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2" stroke-width="2.5"/>
                                    </g>
                                </svg>
                            </button>
                            <button class="tool-btn" id="togglePositionsToolbar" data-tooltip="Show/Hide Positions" onclick="window.togglePositionsVisibility()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <!-- Eye -->
                                    <g transform="translate(0, 2) scale(0.75)">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </g>
                                    <!-- Dollar sign in corner -->
                                    <g transform="translate(10, 8) scale(0.65)">
                                        <line x1="12" x2="12" y1="2" y2="22" stroke-width="2.5"/>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke-width="2.5"/>
                                    </g>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Magnet Mode -->
                    <div class="tool-group">
                        <button class="tool-group-btn" id="magnetMode" data-tooltip="Magnet Mode (OFF)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m12 15 4 4"/>
                                <path d="M2.352 10.648a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.029-6.029a1 1 0 1 1 3 3l-6.029 6.029a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.365-6.367A1 1 0 0 0 8.716 4.282z"/>
                                <path d="m5 8 4 4"/>
                            </svg>
                        </button>
                        <button class="dropdown-arrow" id="magnetArrow" data-group="magnet">
                            <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div class="tool-dropdown" id="magnetDropdown">
                            <span class="tool-dropdown-label">MAGNET STRENGTH</span>
                            <button class="tool-dropdown-item" data-magnet="off">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m12 15 4 4"/>
                                    <path d="M2.352 10.648a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.029-6.029a1 1 0 1 1 3 3l-6.029 6.029a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.365-6.367A1 1 0 0 0 8.716 4.282z"/>
                                    <path d="m5 8 4 4"/>
                                    <circle cx="18" cy="6" r="2.7"/>
                                    <line x1="16.4" y1="4.4" x2="19.6" y2="7.6"/>
                                </svg>
                                <span>Off</span>
                            </button>
                            <button class="tool-dropdown-item" data-magnet="weak">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m12 15 4 4"/>
                                    <path d="M2.352 10.648a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.029-6.029a1 1 0 1 1 3 3l-6.029 6.029a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.365-6.367A1 1 0 0 0 8.716 4.282z"/>
                                    <path d="m5 8 4 4"/>
                                </svg>
                                <span>Weak</span>
                            </button>
                            <button class="tool-dropdown-item active" data-magnet="strong">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m12 15 4 4"/>
                                    <path d="M2.352 10.648a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.029-6.029a1 1 0 1 1 3 3l-6.029 6.029a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l6.365-6.367A1 1 0 0 0 8.716 4.282z"/>
                                    <path d="m5 8 4 4"/>
                                    <polyline points="6.6,17.6 4.9,20.6 7.1,20.6 5.8,23 8.4,19.6 6.2,19.6"/>
                                    <polyline points="17.4,17.6 15.7,20.6 17.9,20.6 16.6,23 19.2,19.6 17,19.6"/>
                                </svg>
                                <span>Strong</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Keep Drawing Mode -->
                    <button class="toolbar-icon-btn" id="keepDrawingModeToolbar" data-tooltip="Keep Drawing Mode (OFF)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M12 19l7-7 3 3-7 7-3-3z" stroke-linejoin="round"/>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" stroke-linejoin="round"/>
                            <path d="M2 2l7.586 7.586" stroke-linecap="round"/>
                            <circle cx="11" cy="11" r="2" fill="currentColor"/>
                        </svg>
                    </button>
                    
                    <!-- Delete Menu -->
                    <div class="tool-group">
                        <button class="tool-group-btn" id="deleteAllDrawingsToolbar" data-group="delete-toolbar" data-tooltip="Delete All Drawings">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M3 6h18" stroke-linecap="round"/>
                                <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6" stroke-linejoin="round"/>
                                <path d="M10 11v6M14 11v6" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button class="dropdown-arrow" id="deleteDropdownArrowToolbar" data-group="delete-toolbar">
                            <svg viewBox="0 0 12 8" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polyline points="2,2 6,6 10,2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div class="tool-dropdown tool-dropdown-grid" id="delete-toolbar-dropdown">
                            <span class="tool-dropdown-label">DELETE</span>
                            <button class="tool-btn" id="deleteAllDrawingsToolbarDropdown" data-tooltip="Delete All Drawings" onclick="window.selectDeleteDrawings()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <!-- Big Trash can -->
                                    <path d="M3 6h18" stroke-linecap="round"/>
                                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 11v6M14 11v6" stroke-linecap="round"/>
                                    <!-- Brush in corner -->
                                    <g transform="translate(10, 8) scale(0.65)">
                                        <path d="m11 10 3 3" stroke-width="2"/>
                                        <path d="M6.5 21A3.5 3.5 0 1 0 3 17.5a2.62 2.62 0 0 1-.708 1.792A1 1 0 0 0 3 21z" stroke-width="2"/>
                                        <path d="M9.969 17.031 21.378 5.624a1 1 0 0 0-3.002-3.002L6.967 14.031" stroke-width="2"/>
                                    </g>
                                </svg>
                            </button>
                            <button class="tool-btn" id="deleteAllIndicatorsToolbar" data-tooltip="Delete All Indicators" onclick="window.selectDeleteIndicators()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <!-- Big Trash can -->
                                    <path d="M3 6h18" stroke-linecap="round"/>
                                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 11v6M14 11v6" stroke-linecap="round"/>
                                    <!-- Indicator in corner -->
                                    <g transform="translate(10, 8) scale(0.65)">
                                        <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2" stroke-width="2.5"/>
                                    </g>
                                </svg>
                            </button>
                            <button class="tool-btn" id="deleteAllObjectsToolbar" data-tooltip="Delete All Objects" onclick="window.selectDeleteAllObjects()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5">
                                    <!-- Big Trash can -->
                                    <path d="M3 6h18" stroke-linecap="round"/>
                                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 11v6M14 11v6" stroke-linecap="round"/>
                                    <!-- Star/All symbol in corner -->
                                    <g transform="translate(10, 8) scale(0.65)">
                                        <polygon points="12,2 15,9 22,9 16.5,14 18.5,21 12,17 5.5,21 7.5,14 2,9 9,9" stroke-width="2.5"/>
                                    </g>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
        </div>

            </div>


            <!-- Right Section: Actions & Settings -->
            <div class="toolbar-right">
                <!-- Layout Button (placeholder - will be managed by panel-manager) -->
                <button class="toolbar-icon-btn-dark" id="layout-selector-btn" data-tooltip="Panel Layouts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 22V7a1 1 0 0 0-1-1H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5a1 1 0 0 0-1-1H2"/>
                        <rect x="14" y="2" width="8" height="8" rx="1"/>
                    </svg>
                </button>

                <!-- Screenshot Button with Dropdown -->
                <div class="screenshot-dropdown-container" id="screenshotDropdownContainer">
                    <button class="toolbar-icon-btn-dark" id="screenshotBtn" data-tooltip="Take Snapshot">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                    <div class="screenshot-dropdown-menu" id="screenshotDropdownMenu">
                        <div class="screenshot-dropdown-header">CHART SNAPSHOT</div>
                        <div class="screenshot-dropdown-item" id="screenshotDownload">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Download image</span>
                            <span class="screenshot-shortcut">  S</span>
                        </div>
                        <div class="screenshot-dropdown-item" id="screenshotCopy">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy image</span>
                            <span class="screenshot-shortcut">  S</span>
                        </div>
                        <div class="screenshot-dropdown-item" id="screenshotCopyLink">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                            <span>Copy link</span>
                            <span class="screenshot-shortcut"> S</span>
                        </div>
                        <div class="screenshot-dropdown-item" id="screenshotOpenTab">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            <span>Open in new tab</span>
                            <span class="screenshot-shortcut"></span>
                        </div>
                    </div>
                </div>

                <!-- Fullscreen Button -->
                <button class="toolbar-icon-btn-dark" id="fullscreenBtn" data-tooltip="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                    </svg>
                </button>

               

                <!-- Settings Button -->
                <button class="toolbar-icon-btn-dark" id="settingsBtn" data-tooltip="Settings" style="cursor:pointer;" onclick="(function(){var p=document.getElementById('settingsPanel');if(!p)return;var active=p.querySelector('.sp-nav-item.active');var cur=active?active.dataset.settings:'symbol';if(p.classList.contains('open')&&cur==='symbol'){if(window._spToggle)window._spToggle();}else{if(window._spOpen)window._spOpen('symbol');else p.classList.add('open');}})();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
 <!-- Alerts Button -->
                <button class="toolbar-icon-btn-dark" id="toolbarAlertsBtn" data-tooltip="Alerts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <!-- Help Button -->
                <button class="toolbar-icon-btn-light" id="helpBtn" data-tooltip="Help" onclick="event.stopPropagation();window._spOpen&&window._spOpen('help');">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <circle cx="12" cy="17" r="0.5" fill="currentColor"></circle>
                    </svg>
                </button>

                <!-- Profile Avatar -->
                <button class="profile-avatar-btn" id="profileBtn" data-tooltip="Profile" onclick="event.stopPropagation();window._spOpen&&window._spOpen('profile');">
                    <div class="avatar-circle">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                        </svg>
                    </div>
                </button>
                <!-- (profile dropdown kept hidden for legacy JS compatibility) -->
                <div style="display:none" id="profileDropdownMenu">
                        <div class="profile-menu-header">USER PROFILE</div>
                        <div class="profile-menu-items">
                            <div class="profile-menu-item" id="profileLanguage">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                                <span>Language</span>
                                <span class="profile-menu-value">English</span>
                                <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                            <div class="profile-menu-item" id="profileTheme">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                                </svg>
                                <span>Theme</span>
                                <span class="profile-menu-value">Dark</span>
                            </div>
                            <div class="profile-menu-item" id="profileTimezone">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span>Timezone</span>
                                <span class="profile-menu-value">UTC+1</span>
                            </div>
                            <div class="profile-menu-divider"></div>
                            <div class="profile-menu-item" id="profileAccount">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>Account Settings</span>
                            </div>
                            <div class="profile-menu-item logout" id="profileLogout">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                <span>Log Out</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Language Submenu -->
                    <div class="language-submenu" id="languageSubmenu">
                        <div class="language-submenu-header">
                            <button class="language-back-btn" id="languageBackBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <span>Select Language</span>
                        </div>
                        <div class="language-options">
                            <div class="language-option selected" data-lang="en">
                                <span></span>
                                <span>English</span>
                                <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="language-option" data-lang="es">
                                <span></span>
                                <span>Espaol</span>
                            </div>
                            <div class="language-option" data-lang="fr">
                                <span></span>
                                <span>Franais</span>
                            </div>
                            <div class="language-option" data-lang="de">
                                <span></span>
                                <span>Deutsch</span>
                            </div>
                            <div class="language-option" data-lang="pt">
                                <span></span>
                                <span>Portugus</span>
                            </div>
                            <div class="language-option" data-lang="ru">
                                <span></span>
                                <span></span>
                            </div>
                            <div class="language-option" data-lang="zh">
                                <span></span>
                                <span></span>
                            </div>
                            <div class="language-option" data-lang="ja">
                                <span></span>
                                <span></span>
                            </div>
                            <div class="language-option" data-lang="ar">
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Challenge Progress Button (Prop Firm Only) - Hidden -->
                <div class="challenge-toolbar-container" id="challengeToolbarContainer" style="display: none;">
                    <button class="challenge-toolbar-btn" id="challengeToolbarBtn" data-tooltip="Challenge Progress">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        <span>Challenge</span>
                        <div class="challenge-status-badge" id="challengeStatusBadge">1/4</div>
                    </button>
                    
                    <!-- Compact Dropdown Panel -->
                    <div class="challenge-dropdown" id="challengeDropdown">
                        <div class="challenge-dropdown-header">
                            <span>Challenge Progress</span>
                            <button class="challenge-dropdown-refresh" id="challengeDropdownRefresh">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                                </svg>
                            </button>
                        </div>
                        <div class="challenge-dropdown-body">
                            <!-- Quick Stats -->
                            <div class="challenge-quick-stats">
                                <div class="challenge-stat-item">
                                    <span class="stat-label">Balance</span>
                                    <span class="stat-value" id="challengeBalanceDropdown">$10,000</span>
                                </div>
                                <div class="challenge-stat-item">
                                    <span class="stat-label">Leverage</span>
                                    <span class="stat-value" id="challengeLeverageDropdown">1:100</span>
                                </div>
                            </div>
                            
                            <!-- Compact Progress Items -->
                            <div class="challenge-dropdown-item">
                                <div class="challenge-dropdown-item-header">
                                    <svg class="challenge-dropdown-icon success" viewBox="0 0 16 16" fill="currentColor">
                                        <circle cx="8" cy="8" r="8"></circle>
                                        <path d="M6 8l2 2 4-4" stroke="white" stroke-width="1.5" fill="none"></path>
                                    </svg>
                                    <span class="challenge-dropdown-label">Trading Days</span>
                                    <span class="challenge-dropdown-value" id="challengeTradingDaysDropdown">1/1</span>
                                </div>
                                <div class="challenge-dropdown-progress">
                                    <div class="challenge-dropdown-progress-fill" id="challengeTradingDaysBar" style="width: 100%;"></div>
                                </div>
                            </div>
                            
                            <div class="challenge-dropdown-item">
                                <div class="challenge-dropdown-item-header">
                                    <svg class="challenge-dropdown-icon pending" viewBox="0 0 16 16" fill="currentColor">
                                        <circle cx="8" cy="8" r="8"></circle>
                                    </svg>
                                    <span class="challenge-dropdown-label">Profit Target</span>
                                    <span class="challenge-dropdown-value" id="challengeProfitDropdown">0.00% / 10%</span>
                                </div>
                                <div class="challenge-dropdown-progress">
                                    <div class="challenge-dropdown-progress-fill" id="challengeProfitBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <div class="challenge-dropdown-item">
                                <div class="challenge-dropdown-item-header">
                                    <svg class="challenge-dropdown-icon pending" viewBox="0 0 16 16" fill="currentColor">
                                        <circle cx="8" cy="8" r="8"></circle>
                                    </svg>
                                    <span class="challenge-dropdown-label">Daily Loss</span>
                                    <span class="challenge-dropdown-value" id="challengeDailyLossDropdown">0.00% / 5%</span>
                                </div>
                                <div class="challenge-dropdown-progress danger">
                                    <div class="challenge-dropdown-progress-fill" id="challengeDailyLossBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <div class="challenge-dropdown-item">
                                <div class="challenge-dropdown-item-header">
                                    <svg class="challenge-dropdown-icon pending" viewBox="0 0 16 16" fill="currentColor">
                                        <circle cx="8" cy="8" r="8"></circle>
                                    </svg>
                                    <span class="challenge-dropdown-label">Total Loss</span>
                                    <span class="challenge-dropdown-value" id="challengeTotalLossDropdown">0.00% / 10%</span>
                                </div>
                                <div class="challenge-dropdown-progress danger">
                                    <div class="challenge-dropdown-progress-fill" id="challengeTotalLossBar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visibility Menu Placeholder -->
        <div id="visibilityMenu" style="display:none;"></div>

        <!-- Floating Replay Toolbar -->
        <div id="replayToolbar" class="replay-toolbar" data-drag-handle="replayToolbarHandle">
            <div class="replay-toolbar-content">
                <!-- Hidden handle for drag system -->
                <div id="replayToolbarHandle" style="display:none;"></div>

                <!-- Left Group: Time/Timezone -->
                <div class="replay-controls-group replay-controls-left">
                    <!-- Timezone Selector (moved to left) -->
                    <div class="replay-timezone-selector" id="replayTimezoneWrapper">
                        <button id="replayTimezoneToggle" class="replay-tz-btn" title="Select Timezone">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
                                <path d="M2 12h20"></path>
                            </svg>
                            <span id="replayTimezoneLabel">UTC</span>
                        </button>
                        <div id="replayTimezoneMenu" class="replay-tz-menu"></div>
                    </div>
                    
                    <!-- Current Candle Date/Time Display -->
                    <div class="replay-datetime-display">
                        <svg class="replay-datetime-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="replayCurrentTime" class="replay-datetime-value">Loading...</span>
                    </div>
                </div>

                <!-- Center Group: Main Controls -->
                <div class="replay-controls-group replay-controls-center">
                    <!-- Tick Progress Indicator -->
                    <div id="tickProgressContainer" class="tick-progress-container" style="display: none;">
                        <div class="tick-progress-bar">
                            <div id="tickProgressFill" class="tick-progress-fill"></div>
                        </div>
                    </div>
                    <!-- Timeframe Button with Dropdown -->
                
                
                <div class="replay-toolbar-divider"></div>
                    <!-- Speed Slider Placeholder (shown when detached) -->
                    <div class="speed-slider-placeholder" id="speedSliderPlaceholder"></div>
                    <!-- Speed Slider Control -->
                    <div class="speed-slider-control" id="speedSliderControl">
                        <div class="speed-drag-handle" id="speedDragHandle" title="Drag to detach">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="9" cy="6" r="1.5"/>
                                <circle cx="15" cy="6" r="1.5"/>
                                <circle cx="9" cy="12" r="1.5"/>
                                <circle cx="15" cy="12" r="1.5"/>
                                <circle cx="9" cy="18" r="1.5"/>
                                <circle cx="15" cy="18" r="1.5"/>
                            </svg>
                        </div>
                        <div class="speed-slider-play-btn" id="speedSliderPlayBtn">
                            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="6 4 20 12 6 20"></polygon>
                            </svg>
                            <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                                <rect x="5" y="4" width="5" height="16" rx="1"></rect>
                                <rect x="14" y="4" width="5" height="16" rx="1"></rect>
                            </svg>
                        </div>
                        <div class="speed-slider-label">
                            <span>Speed&nbsp;</span>
                            <span class="speed-value" id="speedValueDisplay">1x</span>
                            <span class="speed-rate" id="speedRateDisplay">(~real time)</span>
                        </div>
                        <div class="speed-slider-track-container">
                            <div class="speed-slider-ticks">
                                <span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span><span class="tick"></span>
                            </div>
                            <div class="speed-slider-custom" id="speedSliderCustom">
                                <div class="speed-slider-custom-fill" id="speedSliderFill"></div>
                                <div class="speed-slider-custom-thumb" id="speedSliderThumb"></div>
                            </div>
                            <input type="range" id="replaySpeedSlider" class="speed-slider-input" min="0" max="14" step="1" value="0">
                        </div>
                    </div>
                    
                    <!-- Hidden select for backwards compatibility -->
                    <select id="replaySpeed" title="Playback Speed" style="display: none;">
                        <option value="1" selected>1x</option>
                    </select>
                    
                    <!-- Go Back Button - Pick new start point -->
                    <button id="replayGoBack" class="replay-toolbar-btn" title="Go Back - Pick new start point">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m9 6-6 6 6 6"/>
                            <path d="M3 12h14"/>
                            <path d="M21 19V5"/>
                        </svg>
                        <span></span>
                    </button>
                    
                    <div class="replay-toolbar-divider" style="display: none;"></div>
                    <button id="replayStepBackward" class="replay-toolbar-btn" title="Previous Bar" style="display: none; background: transparent; border: none; margin: 0; padding: 0;">
                    <svg viewBox="0 0 28 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 28px; height: 24px;">
                        <!-- Left arrow -->
                        <polyline points="6 12 2 12" stroke-linecap="round"/>
                        <polyline points="5 9 2 12 5 15" stroke-linecap="round" stroke-linejoin="round"/>
                        <!-- Candle body -->
                        <rect x="10" y="7" width="6" height="10" rx="1" stroke="currentColor" fill="none"/>
                        <!-- Candle wicks -->
                        <line x1="13" y1="4" x2="13" y2="7" stroke-linecap="round"/>
                        <line x1="13" y1="17" x2="13" y2="20" stroke-linecap="round"/>
                    </svg>
                </button>
                <button id="replayPlayPause" class="replay-toolbar-btn replay-paused" title="Play/Pause (Space)" style="display: none !important;">
                    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21"></polygon>
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    <span class="play-text">Play</span>
                    <span class="pause-text" style="display:none;">Pause</span>
                </button>
                <button id="replayStepForward" class="replay-toolbar-btn replay-icon-btn" title="Next Bar">
                    <svg viewBox="0 0 28 24" fill="none" stroke="currentColor" stroke-width="0.5">
                        <!-- Candle body -->
                        <rect x="12" y="7" width="6" height="10" rx="1" stroke="currentColor" fill="none"/>
                        <!-- Candle wicks -->
                        <line x1="15" y1="4" x2="15" y2="7" stroke-linecap="round"/>
                        <line x1="15" y1="17" x2="15" y2="20" stroke-linecap="round"/>
                        <!-- Right arrow -->
                        <polyline points="22 12 26 12" stroke-linecap="round"/>
                        <polyline points="23 9 26 12 23 15" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                 <!-- Go To Control (moved here next to play buttons) -->
                <div class="date-search-wrapper replay-date-search" id="goToControl">
                    
                        <button type="button" id="goToMenuToggle" class="date-time-toggle goto-arrow-btn" title="Go to">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-redo-dot-icon lucide-redo-dot"><circle cx="12" cy="17" r="1"/><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>
                        </button>
                        <div id="goToMenu" class="go-to-menu"></div>
                    
                    <!-- Hidden legacy inputs kept for jumpToDate compatibility -->
                    <input type="date" id="dateSearchInput" class="date-input" style="display:none;">
                    <input type="time" id="timeSearchInput" class="time-input" step="60" style="display:none;">
                    <button id="goToDateTimeBtn" class="go-to-btn" style="display:none;">Go</button>
                </div>

                <div class="replay-toolbar-divider"></div>
                
                <!-- Hidden select for backwards compatibility -->
                <select id="replayTimeframe" title="Step Timeframe" style="display:none;">
                    <option value="sync" selected>Sync timeframe</option>
                    <option value="1m">1m</option>
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                    <option value="30m">30m</option>
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1D">1D</option>
                    
                </select>
                
                </div>

                <!-- Right Group: Account Stats -->
                <div class="replay-controls-group replay-controls-right">
                    <!-- Balance -->
                    <div class="replay-stat-item">
                        <svg class="replay-stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                            <line x1="2" y1="10" x2="22" y2="10"></line>
                        </svg>
                        <span class="replay-stat-label">Start Balance:</span>
                        <span class="replay-stat-value" id="replayBalance">10,000</span>
                    </div>
                    
                    <div class="replay-stat-divider"></div>
                    
                    <!-- Equity -->
                    <div class="replay-stat-item">
                        <svg class="replay-stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                        <span class="replay-stat-label">Equity:</span>
                        <span class="replay-stat-value" id="replayEquity">10,000</span>
                    </div>
                    
                    <div class="replay-stat-divider"></div>
                    
                    <!-- P&L -->
                    <div class="replay-stat-item">
                        <svg class="replay-stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        <span class="replay-stat-label">P&L:</span>
                        <span class="replay-stat-value" id="replayPnL">0</span>
                    </div>
                    
                    <!-- Toggle Visibility Button -->
                    <button class="replay-stat-toggle" id="toggleStatsVisibility" title="Toggle values visibility">
                        <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                        </svg>
                    </button>
                    
                    <!-- Hidden slider for replay system functionality -->
                    <input type="range" id="replaySlider" min="0" max="100" value="0" style="display:none;">
                    
                    <button id="replayExit" class="replay-toolbar-btn replay-danger replay-icon-btn" title="Exit Replay Mode" style="display: none;">
                        <svg viewBox="0 0 24 24" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    
                    <button id="replayTabsToggle" class="replay-toolbar-btn replay-collapse-toggle replay-icon-btn" type="button" title="Toggle Panels">
                        <svg class="toggle-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="replay-tabs-container">
                <div class="replay-tabs-nav">
                    <button class="replay-tab-btn active" data-replay-tab="alltrades">All Trades</button>
                    <button class="replay-tab-btn" data-replay-tab="pending">Pending Orders</button>
                    <button class="replay-tab-btn" data-replay-tab="open">Open Positions</button>
                    <button class="replay-tab-btn" data-replay-tab="history">History</button>
                    <button class="replay-tab-btn" data-replay-tab="analytics" id="replayAnalyticsBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="width:14px;height:14px;margin-right:4px;">
                            <path d="M21 21H3V3"></path>
                            <path d="M21 9l-6 6-4-4-6 6"></path>
                        </svg>
                        Analytics
                    </button>
                </div>
                <div class="replay-tabs-body">
                    <!-- All Trades Tab -->
                    <div class="replay-tab-panel active" id="replayTabAlltrades">
                        <div class="replay-tabs-meta">
                            <div class="replay-meta-item"><span class="label">Current balance:</span><span class="value" id="replayMetaBalanceAll">$20,000</span></div>
                            <div class="replay-meta-item"><span class="label">Total trades:</span><span class="value" id="replayMetaTotalTrades">0</span></div>
                            <div class="replay-meta-item"><span class="label">Pending:</span><span class="value" id="replayMetaPendingAll">0</span></div>
                            <div class="replay-meta-item"><span class="label">Open:</span><span class="value" id="replayMetaOpenAll">0</span></div>
                            <div class="replay-meta-item"><span class="label">Closed:</span><span class="value" id="replayMetaClosedAll">0</span></div>
                            
                            <!-- Close Trades Dropdown -->
                            <div style="position: relative; margin-left: auto;">
                                <button id="closeTradesDropdownBtn" style="
                                    padding: 8px 16px;
                                    background: rgba(239,68,68,0.15);
                                    color: #ef4444;
                                    border: 1px solid rgba(239,68,68,0.3);
                                    border-radius: 6px;
                                    font-size: 12px;
                                    font-weight: 600;
                                    cursor: default;
                                    transition: all 0.2s;
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                " onmouseover="this.style.background='rgba(239,68,68,0.25)'; this.style.borderColor='rgba(239,68,68,0.5)';" onmouseout="this.style.background='rgba(239,68,68,0.15)'; this.style.borderColor='rgba(239,68,68,0.3)';">
                                    Close Trades
                                    <span style="font-size: 10px;"></span>
                                </button>
                                <div id="closeTradesDropdown" style="
                                    position: absolute;
                                    top: 100%;
                                    right: 0;
                                    margin-top: 4px;
                                    background: #1f2937;
                                    border: 1px solid rgba(148,163,184,0.2);
                                    border-radius: 6px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                                    display: none;
                                    z-index: 1000;
                                    min-width: 180px;
                                    overflow: hidden;
                                ">
                                    <button class="close-trades-option" data-action="close-all" style="
                                        width: 100%;
                                        padding: 10px 16px;
                                        background: transparent;
                                        color: #e5e7eb;
                                        border: none;
                                        text-align: left;
                                        font-size: 13px;
                                        cursor: default;
                                        transition: all 0.2s;
                                        border-bottom: 1px solid rgba(148,163,184,0.1);
                                    " onmouseover="this.style.background='rgba(148,163,184,0.1)';" onmouseout="this.style.background='transparent';">
                                        Close All Trades
                                    </button>
                                    <button class="close-trades-option" data-action="close-profit" style="
                                        width: 100%;
                                        padding: 10px 16px;
                                        background: transparent;
                                        color: #22c55e;
                                        border: none;
                                        text-align: left;
                                        font-size: 13px;
                                        cursor: default;
                                        transition: all 0.2s;
                                        border-bottom: 1px solid rgba(148,163,184,0.1);
                                    " onmouseover="this.style.background='rgba(34,197,94,0.1)';" onmouseout="this.style.background='transparent';">
                                        Close Profit Trades
                                    </button>
                                    <button class="close-trades-option" data-action="close-losing" style="
                                        width: 100%;
                                        padding: 10px 16px;
                                        background: transparent;
                                        color: #ef4444;
                                        border: none;
                                        text-align: left;
                                        font-size: 13px;
                                        cursor: default;
                                        transition: all 0.2s;
                                    " onmouseover="this.style.background='rgba(239,68,68,0.1)';" onmouseout="this.style.background='transparent';">
                                        Close Losing Trades
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="replay-tab-scroller">
                            <table class="replay-tab-table" aria-label="All Trades">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Status</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th class="replay-cell-number">Quantity</th>
                                        <th>Type</th>
                                        <th class="replay-cell-number">Entry Price</th>
                                        <th class="replay-cell-number">Current/Exit</th>
                                        <th class="replay-cell-number">P&amp;L</th>
                                        <th class="replay-cell-number">TP</th>
                                        <th class="replay-cell-number">SL</th>
                                        <th>Time</th>
                                        <th class="replay-cell-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allTradesBody">
                                    <tr class="replay-empty-row">
                                        <td colspan="13">
                                            <div class="replay-tab-empty">
                                                No trades yet. Place orders or open positions to see them here.
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pending Orders Tab -->
                    <div class="replay-tab-panel" id="replayTabPending">
                        <div class="replay-tabs-meta">
                            <div class="replay-meta-item"><span class="label">Current balance:</span><span class="value" id="replayMetaBalance">$20,000</span></div>
                            <div class="replay-meta-item"><span class="label">Realized P&amp;L:</span><span class="value" id="replayMetaRealized">$0</span></div>
                            <div class="replay-meta-item"><span class="label">Unrealized P&amp;L:</span><span class="value" id="replayMetaUnrealized">$0</span></div>
                            <div class="replay-meta-item"><span class="label">Pending Orders:</span><span class="value" id="bottomPendingCountMeta">0</span></div>
                        </div>
                        
                        <div class="replay-tab-scroller">
                            <table class="replay-tab-table" aria-label="Pending Orders">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th class="replay-cell-number">Quantity</th>
                                        <th>Type</th>
                                        <th class="replay-cell-number">Price</th>
                                        <th class="replay-cell-number">TP</th>
                                        <th class="replay-cell-number">SL</th>
                                        <th>Created</th>
                                        <th class="replay-cell-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bottomPendingOrdersBody">
                                    <tr class="replay-empty-row">
                                        <td colspan="10">
                                            <div class="replay-tab-empty">
                                                No pending orders. Place a limit or stop order to see it here.
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Open Positions Tab -->
                    <div class="replay-tab-panel" id="replayTabOpen">
                        <div class="replay-tabs-meta">
                            <div class="replay-meta-item"><span class="label">Current balance:</span><span class="value" id="replayMetaBalance2">$20,000</span></div>
                            <div class="replay-meta-item"><span class="label">Realized P&amp;L:</span><span class="value" id="replayMetaRealized2">$0</span></div>
                            <div class="replay-meta-item"><span class="label">Unrealized P&amp;L:</span><span class="value" id="replayMetaUnrealized2">$0</span></div>
                            <div class="replay-meta-item"><span class="label">Open Positions:</span><span class="value" id="bottomPositionsCountMeta">0</span></div>
                        </div>
                        
                        <div class="replay-tab-scroller">
                            <table class="replay-tab-table" aria-label="Open Positions">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th class="replay-cell-number">Quantity</th>
                                        <th class="replay-cell-number">Entry Price</th>
                                        <th class="replay-cell-number">Current Price</th>
                                        <th class="replay-cell-number">P&amp;L</th>
                                        <th class="replay-cell-number">TP</th>
                                        <th class="replay-cell-number">SL</th>
                                        <th class="replay-cell-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bottomOpenPositionsBody">
                                    <tr class="replay-empty-row">
                                        <td colspan="10">
                                            <div class="replay-tab-empty">
                                                No open positions. Use BUY or SELL buttons to open a position.
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Positions History Tab -->
                    <div class="replay-tab-panel" id="replayTabHistory">
                        <div class="replay-tabs-meta">
                            <div class="replay-meta-item"><span class="label">Open positions:</span><span class="value" id="replayMetaOpenCount">0</span></div>
                            <div class="replay-meta-item"><span class="label">Closed positions:</span><span class="value" id="replayMetaClosedCount">0</span></div>
                            <button id="viewAllTradesBottomBtn" style="
                                padding: 8px 16px;
                                background: rgba(148,163,184,0.15);
                                color: #000000 ;
                                border: 1px solid rgba(148,163,184,0.3);
                                border-radius: 6px;
                                font-size: 12px;
                                font-weight: 600;
                                cursor: default;
                                transition: all 0.2s;
                                margin-left: auto;
                            " onmouseover="this.style.background='rgba(148,163,184,0.25)'; this.style.borderColor='rgba(148,163,184,0.5)';" onmouseout="this.style.background='rgba(148,163,184,0.15)'; this.style.borderColor='rgba(148,163,184,0.3)';">
                                View All Trades
                            </button>
                        </div>
                        <div class="replay-tab-scroller">
                            <table class="replay-tab-table" aria-label="Replay position history">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th class="replay-cell-number">Quantity</th>
                                        <th class="replay-cell-center">Entries</th>
                                        <th>Status</th>
                                        <th>Open time</th>
                                        <th>Close time</th>
                                        <th class="replay-cell-number">Entry price</th>
                                        <th class="replay-cell-number">Exit price</th>
                                        <th class="replay-cell-number">P&amp;L</th>
                                        <th class="replay-cell-center">Tags</th>
                                    </tr>
                                </thead>
                                <tbody id="replayPositionsBody">
                                    <tr class="replay-empty-row">
                                        <td colspan="12">
                                            <div class="replay-tab-empty">
                                                No position history captured during replay yet. Once trades are executed, a timeline will appear here.
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="replay-tab-panel" id="replayTabAnalytics">
                        <div class="analytics-container">
                            <!-- Top Stats Row -->
                            <div class="analytics-stats-row">
                                <div class="analytics-stat-card">
                                    <div class="stat-icon profit">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                            <polyline points="17 6 23 6 23 12"></polyline>
                                        </svg>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-label">Total Profit</span>
                                        <span class="stat-value profit" id="analyticsTotalProfit">$0.00</span>
                                    </div>
                                </div>
                                <div class="analytics-stat-card">
                                    <div class="stat-icon loss">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                                            <polyline points="17 18 23 18 23 12"></polyline>
                                        </svg>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-label">Total Loss</span>
                                        <span class="stat-value loss" id="analyticsTotalLoss">$0.00</span>
                                    </div>
                                </div>
                                <div class="analytics-stat-card">
                                    <div class="stat-icon neutral">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                            <path d="M12 2v20M2 12h20"></path>
                                        </svg>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-label">Net P&L</span>
                                        <span class="stat-value" id="analyticsNetPnL">$0.00</span>
                                    </div>
                                </div>
                                <div class="analytics-stat-card">
                                    <div class="stat-icon neutral">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 6v6l4 2"></path>
                                        </svg>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-label">Total Trades</span>
                                        <span class="stat-value" id="analyticsTotalTrades">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Metrics Row -->
                            <div class="analytics-metrics-row">
                                <div class="analytics-metric-card">
                                    <div class="metric-header">
                                        <span class="metric-title">Win Rate</span>
                                        <span class="metric-value" id="analyticsWinRate">0%</span>
                                    </div>
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill win" id="analyticsWinRateBar" style="width: 0%"></div>
                                    </div>
                                    <div class="metric-details">
                                        <span><span class="dot win"></span>Wins: <strong id="analyticsWins">0</strong></span>
                                        <span><span class="dot loss"></span>Losses: <strong id="analyticsLosses">0</strong></span>
                                    </div>
                                </div>
                                <div class="analytics-metric-card">
                                    <div class="metric-header">
                                        <span class="metric-title">Profit Factor</span>
                                        <span class="metric-value" id="analyticsProfitFactor">0.00</span>
                                    </div>
                                    <div class="metric-details single">
                                        <span>Gross Profit / Gross Loss</span>
                                    </div>
                                </div>
                                <div class="analytics-metric-card">
                                    <div class="metric-header">
                                        <span class="metric-title">Avg Win</span>
                                        <span class="metric-value profit" id="analyticsAvgWin">$0.00</span>
                                    </div>
                                    <div class="metric-details single">
                                        <span>Per winning trade</span>
                                    </div>
                                </div>
                                <div class="analytics-metric-card">
                                    <div class="metric-header">
                                        <span class="metric-title">Avg Loss</span>
                                        <span class="metric-value loss" id="analyticsAvgLoss">$0.00</span>
                                    </div>
                                    <div class="metric-details single">
                                        <span>Per losing trade</span>
                                    </div>
                                </div>
                                <div class="analytics-metric-card">
                                    <div class="metric-header">
                                        <span class="metric-title">Risk/Reward</span>
                                        <span class="metric-value" id="analyticsRiskReward">0.00</span>
                                    </div>
                                    <div class="metric-details single">
                                        <span>Avg Win / Avg Loss</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Stats Row -->
                            <div class="analytics-details-row">
                                <div class="analytics-detail-card">
                                    <h4>Trade Statistics</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Largest Win</span>
                                            <span class="detail-value profit" id="analyticsLargestWin">$0.00</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Largest Loss</span>
                                            <span class="detail-value loss" id="analyticsLargestLoss">$0.00</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Avg Trade Duration</span>
                                            <span class="detail-value" id="analyticsAvgDuration">0m</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Max Consecutive Wins</span>
                                            <span class="detail-value" id="analyticsConsecWins">0</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Max Consecutive Losses</span>
                                            <span class="detail-value" id="analyticsConsecLosses">0</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Breakeven Trades</span>
                                            <span class="detail-value" id="analyticsBreakeven">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="analytics-detail-card">
                                    <h4>Account Performance</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Starting Balance</span>
                                            <span class="detail-value" id="analyticsStartBalance">$10,000</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Current Balance</span>
                                            <span class="detail-value" id="analyticsCurrentBalance">$10,000</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Return %</span>
                                            <span class="detail-value" id="analyticsReturn">0.00%</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Max Drawdown</span>
                                            <span class="detail-value loss" id="analyticsMaxDrawdown">$0.00</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Max Drawdown %</span>
                                            <span class="detail-value loss" id="analyticsMaxDrawdownPct">0.00%</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Peak Balance</span>
                                            <span class="detail-value" id="analyticsPeakBalance">$10,000</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="analytics-detail-card">
                                    <h4>Long vs Short</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Long Trades</span>
                                            <span class="detail-value" id="analyticsLongTrades">0</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Long Win Rate</span>
                                            <span class="detail-value" id="analyticsLongWinRate">0%</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Long P&L</span>
                                            <span class="detail-value" id="analyticsLongPnL">$0.00</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Short Trades</span>
                                            <span class="detail-value" id="analyticsShortTrades">0</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Short Win Rate</span>
                                            <span class="detail-value" id="analyticsShortWinRate">0%</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Short P&L</span>
                                            <span class="detail-value" id="analyticsShortPnL">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Go To settings modal -->
        <div id="goToSettingsModal" class="go-to-settings-modal" aria-hidden="true">
            <div class="go-to-settings-backdrop" data-go-to-settings-close></div>
            <div class="go-to-settings-dialog" role="dialog" aria-modal="true" aria-labelledby="goToSettingsTitle">
                <div class="go-to-settings-header">
                    <div id="goToSettingsTitle" class="go-to-settings-title">Custom settings</div>
                    <button id="goToSettingsClose" class="go-to-settings-close" type="button" data-go-to-settings-close aria-label="Close">
                        <svg viewBox="0 0 16 16" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M4 4l8 8m0-8L4 12" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </button>
                </div>
                <div id="goToSettingsBody" class="go-to-settings-body"></div>
                <div class="go-to-settings-footer">
                    <button id="goToSettingsCancel" type="button">Cancel</button>
                    <button id="goToSettingsSave" type="button">Save</button>
                </div>
            </div>
        </div>

        <!-- Date/Time Picker Popover -->
        <div id="dateTimePickerPopover" class="datetime-picker-popover">
            <div class="datetime-picker-header" id="dateTimePickerHeaderLabel">Select date & time</div>
            <div class="datetime-picker-body">
                <div class="datetime-calendar">
                    <div class="datetime-month-header">
                        <span id="dateTimePickerMonthLabel">Month 2025</span>
                        <div class="datetime-month-nav">
                            <button type="button" id="dateTimePickerPrevMonth" class="datetime-month-btn">&#8249;</button>
                            <button type="button" id="dateTimePickerNextMonth" class="datetime-month-btn">&#8250;</button>
                        </div>
                    </div>
                    <div class="datetime-weekdays">
                        <div class="datetime-weekday">S</div>
                        <div class="datetime-weekday">M</div>
                        <div class="datetime-weekday">T</div>
                        <div class="datetime-weekday">W</div>
                        <div class="datetime-weekday">T</div>
                        <div class="datetime-weekday">F</div>
                        <div class="datetime-weekday">S</div>
                    </div>
                    <div id="dateTimePickerDays" class="datetime-days-grid"></div>
                </div>
                <div class="datetime-time-columns">
                    <div class="datetime-time-column">
                        <div class="datetime-time-label">Hour</div>
                        <div id="dateTimePickerHours" class="datetime-time-values"></div>
                    </div>
                    <div class="datetime-time-column">
                        <div class="datetime-time-label">Min</div>
                        <div id="dateTimePickerMinutes" class="datetime-time-values"></div>
                    </div>
                    <div class="datetime-time-column">
                        <div class="datetime-time-label">Sec</div>
                        <div id="dateTimePickerSeconds" class="datetime-time-values"></div>
                    </div>
                </div>
            </div>
            <div class="datetime-picker-footer">
                <button type="button" id="dateTimePickerCancel" class="datetime-btn datetime-btn-cancel">Cancel</button>
                <button type="button" id="dateTimePickerOk" class="datetime-btn datetime-btn-ok">OK</button>
            </div>
        </div>

        <!-- Favorites Toolbar - TradingView Style -->
        <div class="favorites-toolbar" id="favoritesToolbar">
            <div class="favorites-drag-handle" title="Drag to move">
                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                    <circle cx="6" cy="6" r="1.5"/>
                    <circle cx="12" cy="6" r="1.5"/>
                    <circle cx="6" cy="12" r="1.5"/>
                    <circle cx="12" cy="12" r="1.5"/>
                    <circle cx="6" cy="18" r="1.5"/>
                    <circle cx="12" cy="18" r="1.5"/>
                </svg>
            </div>
            <div class="favorites-tools" id="favoritesTools"></div>
        </div>
    
    <div class="container">
        <!-- Chart Container -->
        <div id="chart-container">
            <!-- Panels Container for multi-panel layout (hidden by default) -->
            <div id="panels-container" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: none; z-index: 5; background: #050028;">
                <!-- Panels will be created here dynamically -->
            </div>
                
            <!-- Original single chart (shown by default) -->
            <div class="chart-wrapper" id="chartWrapper">
            <canvas id="chartCanvas"></canvas>
            <svg id="drawingSvg" overflow="hidden"></svg>
            <!-- Axis cursor zones -->
            <div id="priceAxisZone" class="axis-cursor-zone price-axis-zone"></div>
            <div id="timeAxisZone" class="axis-cursor-zone time-axis-zone"></div>
            
            <!-- Follow Button (inside chart-wrapper for proper positioning) -->
            <button id="replayFollow" title="Follow Latest Candle">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 4v16"/>
                    <path d="M6.029 4.285A2 2 0 0 0 3 6v12a2 2 0 0 0 3.029 1.715l9.997-5.998a2 2 0 0 0 .003-3.432z"/>
                </svg>
            </button>
            <div class="chart-brand">
                <img src="modules/logo-05.png" alt="Talaria Pro logo" class="logo-dark">
                <img src="modules/logo-06.png" alt="Talaria Pro logo" class="logo-light">
            </div>
            
            <!-- Crosshair elements -->
            <div class="crosshair-vertical"></div>
            <div class="crosshair-horizontal"></div>
            <div class="price-label"></div>
            <div class="time-label"></div>
            
            <!-- OHLC Info Panel - TradingView Style -->
                <div class="ohlc-info" id="ohlcInfo">
                    <div class="ohlc-header">
                        <div class="ohlc-symbol-block" style="position: relative;">
                            <span class="ohlc-symbol-dot"></span>
                            <span class="ohlc-symbol-text" id="chartSymbol">CHART</span>
                            <button class="add-symbol-btn" id="addCompareSymbolBtn" title="Compare / Add Symbol" onclick="event.stopPropagation(); openCompareSymbolModal();">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                            <span class="ohlc-separator"></span>
                            <span id="chartTimeframe">1m</span>
                            
                        </div>
                        <div class="ohlc-stats">
                            <div class="ohlc-item"><span class="ohlc-label">O</span><span class="ohlc-value" id="open"></span></div>
                            <div class="ohlc-item"><span class="ohlc-label">H</span><span class="ohlc-value" id="high"></span></div>
                            <div class="ohlc-item"><span class="ohlc-label">L</span><span class="ohlc-value" id="low"></span></div>
                            <div class="ohlc-item"><span class="ohlc-label">C</span><span class="ohlc-value" id="close"></span></div>
                            <span class="ohlc-change" id="chartChange"></span>
                        </div>
                        <!-- Navigation Integrity Badge -->
                            <div id="navIntegrityBadge" class="nav-integrity-badge" style="display: none;" onclick="event.stopPropagation(); this.classList.toggle('show-tooltip');">
                                <div class="nav-badge-icon">
                                    <span class="nav-badge-letters">BN</span>
                                    <svg class="nav-badge-circle" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4" y1="4" x2="20" y2="20"></line>
                                    </svg>
                                </div>
                                <div class="nav-badge-tooltip" id="navBadgeTooltip">
                                    <strong>Back Navigation Disabled</strong><br>
                                    Ensures integrity - no going back in time
                                </div>
                            </div>
                    </div>
                    <div class="ohlc-body">
                        <div class="ohlc-volume-line" id="volumeIndicatorLine" style="display: none;">
                            <span class="volume-color-box" style="width: 12px; height: 2px; background: rgba(8, 153, 129, 0.5); border-radius: 1px;"></span>
                            <span class="volume-label" style="color: #787b86; font-size: 11px; font-weight: 500;">Volume</span>
                            <span class="volume-value" id="volume" style="color: #787b86; font-size: 11px;"></span>
                            <span class="volume-actions" style="display: inline-flex; align-items: center; gap: 4px; margin-left: 4px; pointer-events: auto;">
                                <span class="volume-visibility-btn" title="Toggle Visibility" style="display: inline-flex; align-items: center; justify-content: center; padding: 2px 4px; border-radius: 3px; cursor: default; transition: all 0.2s; pointer-events: auto;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="pointer-events: none;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </span>
                                <span class="volume-settings-btn" title="Settings" style="display: inline-flex; align-items: center; justify-content: center; padding: 2px 4px; border-radius: 3px; cursor: default; transition: all 0.2s; pointer-events: auto;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="pointer-events: none;">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </span>
                                <span class="volume-remove-btn" title="Remove" style="display: inline-flex; align-items: center; justify-content: center; padding: 2px 4px; border-radius: 3px; cursor: default; transition: all 0.2s; pointer-events: auto;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="pointer-events: none;">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </span>
                            </span>
                        </div>
                        <div class="ohlc-indicators" id="ohlcIndicators">
                            <!-- Indicators will be added here dynamically -->
                        </div>
                    </div>
                    <!-- Collapse button at the bottom (outside ohlc-body so it stays visible when collapsed) -->
                    <button class="ohlc-collapse-btn" id="ohlcCollapseBtn" aria-label="Collapse OHLC panel" style="margin-top: 4px; align-self: flex-start;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
        </div><!-- /chart-container -->
    </div><!-- /container -->

    <!-- Right Sidebar - Icon Bar -->
        <div class="right-sidebar-icons">
            <button class="sidebar-timeframe-btn" id="undoBtn" data-tooltip="Undo (Ctrl+Z)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M3 10h10c4.42 0 8 3.58 8 8v2"></path>
                    <polyline points="7 14 3 10 7 6"></polyline>
                </svg>
            </button>
            <button class="sidebar-timeframe-btn" id="redoBtn" data-tooltip="Redo (Ctrl+Y)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M21 10H11c-4.42 0-8 3.58-8 8v2"></path>
                    <polyline points="17 14 21 10 17 6"></polyline>
                </svg>
            </button>
            
            <div class="sidebar-timeframe-section" id="sidebarTimeframes">
                <!-- Timeframe buttons will be dynamically populated with dropdown arrow on active one -->
            </div>
            
            <!-- Spacer to push panel icons to bottom -->
            <div style="flex: 1;"></div>
            
            <div class="right-sidebar-bottom">
                <button class="right-sidebar-icon-btn" id="newsIconBtn" data-panel="news" data-tooltip="Economic News" onclick="event.stopPropagation();window._spOpen&&window._spOpen('news');" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="10" y1="6" x2="18" y2="6" stroke-linecap="round"/>
                        <line x1="10" y1="10" x2="18" y2="10" stroke-linecap="round"/>
                        <line x1="10" y1="14" x2="14" y2="14" stroke-linecap="round"/>
                    </svg>
                </button>
                
                <button class="right-sidebar-icon-btn" id="clockIconBtn" data-panel="clock" data-tooltip="Watchlist" onclick="event.stopPropagation();window._spOpen&&window._spOpen('watchlist');" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                        <polyline points="12 6 12 12 16 14" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                
                <button class="right-sidebar-icon-btn" id="darkModeBtn" data-tooltip="Switch to Light Mode" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                </button>
                <button class="right-sidebar-icon-btn" id="lightModeBtn" data-tooltip="Switch to Dark Mode" style="display: none !important;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Unified Right Panel -->
        <div class="right-sidebar-panel unified-right-panel" id="unifiedRightPanel">
            <!-- Dynamic Header -->
            <div class="unified-panel-header">
                <h2 id="unifiedPanelTitle">Watchlist</h2>
                <div class="unified-panel-header-actions">
                    <button class="unified-panel-header-btn" id="unifiedPanelOptions" title="Options">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="5" cy="12" r="2"/>
                            <circle cx="12" cy="12" r="2"/>
                            <circle cx="19" cy="12" r="2"/>
                        </svg>
                    </button>
                    <button class="unified-panel-header-btn" id="closeUnifiedPanel" title="Close">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Watchlist Content -->
            <div class="unified-panel-content active" id="watchlistContent">
                <div class="watchlist-search">
                    <div class="watchlist-search-wrapper">
                        <input type="text" placeholder="Search" id="watchlistSearchInput"/>
                        <svg class="watchlist-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                    </div>
                </div>
                <button class="watchlist-add-btn" id="addSymbolBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Symbol
                </button>
                <div class="watchlist-table-header">
                    <span>Symbol</span>
                    <span>Last</span>
                    <span>Chg</span>
                    <span>Chg%</span>
                </div>
                <div class="watchlist-items" id="watchlistItems">
                    <!-- Watchlist items will be populated dynamically -->
                </div>
            </div>

            <!-- News Content -->
            <div class="unified-panel-content" id="newsContent">
                <div class="news-search">
                    <div class="news-search-wrapper">
                        <svg class="news-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" placeholder="Search" id="newsSearchInput"/>
                    </div>
                </div>
                <div class="news-tabs">
                <button class="news-tab" data-tab="previous">Previous</button>
                <button class="news-tab active" data-tab="upcoming">Upcoming</button>
            </div>
            <div class="news-items" id="newsItems">
                <!-- Sample news items -->
                <div class="news-item">
                    <div class="news-item-header">
                        <span class="news-time">12:30</span>
                        <span class="news-countdown">- 11h 32m 36s</span>
                    </div>
                    <div class="news-item-title">
                        <span class="news-flag"></span>
                        <div class="news-impact high">
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                        </div>
                        <span class="news-event-name">Core PPI m/m</span>
                    </div>
                    <div class="news-event-date">2024.03.14</div>
                    <div class="news-values">
                        <span class="news-value">
                            <span class="news-value-label">Actual:</span>
                            <span class="news-value-data">-</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Forecast:</span>
                            <span class="news-value-data">0.2%</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Previous:</span>
                            <span class="news-value-data positive">0.5%</span>
                        </span>
                    </div>
                </div>
                <div class="news-item">
                    <div class="news-item-header">
                        <span class="news-time">12:30</span>
                        <span class="news-countdown">- 11h 32m 36s</span>
                    </div>
                    <div class="news-item-title">
                        <span class="news-flag"></span>
                        <div class="news-impact high">
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                        </div>
                        <span class="news-event-name">Core Retail Sales m/m</span>
                    </div>
                    <div class="news-event-date">2024.03.14</div>
                    <div class="news-values">
                        <span class="news-value">
                            <span class="news-value-label">Actual:</span>
                            <span class="news-value-data">-</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Forecast:</span>
                            <span class="news-value-data">0.5%</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Previous:</span>
                            <span class="news-value-data negative">-0.8%</span>
                        </span>
                    </div>
                </div>
                <div class="news-item">
                    <div class="news-item-header">
                        <span class="news-time">12:30</span>
                        <span class="news-countdown">- 11h 32m 36s</span>
                    </div>
                    <div class="news-item-title">
                        <span class="news-flag"></span>
                        <div class="news-impact medium">
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                        </div>
                        <span class="news-event-name">PPI m/m</span>
                    </div>
                    <div class="news-event-date">2024.03.14</div>
                    <div class="news-values">
                        <span class="news-value">
                            <span class="news-value-label">Actual:</span>
                            <span class="news-value-data">-</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Forecast:</span>
                            <span class="news-value-data">0.3%</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Previous:</span>
                            <span class="news-value-data">0.3%</span>
                        </span>
                    </div>
                </div>
                <div class="news-item">
                    <div class="news-item-header">
                        <span class="news-time">12:30</span>
                        <span class="news-countdown">- 11h 32m 36s</span>
                    </div>
                    <div class="news-item-title">
                        <span class="news-flag"></span>
                        <div class="news-impact high">
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                        </div>
                        <span class="news-event-name">Retail Sales m/m</span>
                    </div>
                    <div class="news-event-date">2024.03.14</div>
                    <div class="news-values">
                        <span class="news-value">
                            <span class="news-value-label">Actual:</span>
                            <span class="news-value-data">-</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Forecast:</span>
                            <span class="news-value-data">0.8%</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Previous:</span>
                            <span class="news-value-data negative">-1.1%</span>
                        </span>
                    </div>
                </div>
                <div class="news-item">
                    <div class="news-item-header">
                        <span class="news-time">12:30</span>
                        <span class="news-countdown">- 11h 32m 36s</span>
                    </div>
                    <div class="news-item-title">
                        <span class="news-flag"></span>
                        <div class="news-impact medium">
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                            <span class="news-impact-bar"></span>
                        </div>
                        <span class="news-event-name">Unemployment Claims</span>
                    </div>
                    <div class="news-event-date">2024.03.14</div>
                    <div class="news-values">
                        <span class="news-value">
                            <span class="news-value-label">Actual:</span>
                            <span class="news-value-data">-</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Forecast:</span>
                            <span class="news-value-data">218K</span>
                        </span>
                        <span class="news-value">
                            <span class="news-value-label">Previous:</span>
                            <span class="news-value-data">217K</span>
                        </span>
                    </div>
                </div>
                </div>
            </div>

            <!-- Clock Content -->
            <div class="unified-panel-content" id="clockContent">
                <div class="clock-display">
                    <div class="clock-timezone-label" id="clockTimezoneLabel">UTC</div>
                    <div class="clock-time" id="clockTime">12:00:00</div>
                    <div class="clock-date" id="clockDate">Sunday, December 1, 2024</div>
                    <div class="clock-candle-label" id="clockCandleLabel">Current Candle Time</div>
                </div>
                <div class="clock-timezones">
                    <div class="timezone-item">
                        <span class="timezone-name">New York (EST)</span>
                        <span class="timezone-time" id="tzNewYork">--:--</span>
                    </div>
                    <div class="timezone-item">
                        <span class="timezone-name">London (GMT)</span>
                        <span class="timezone-time" id="tzLondon">--:--</span>
                    </div>
                    <div class="timezone-item">
                        <span class="timezone-name">Tokyo (JST)</span>
                        <span class="timezone-time" id="tzTokyo">--:--</span>
                    </div>
                    <div class="timezone-item">
                        <span class="timezone-name">Sydney (AEST)</span>
                        <span class="timezone-time" id="tzSydney">--:--</span>
                    </div>
                </div>
                <div class="market-sessions">
                    <div class="session-title">Market Sessions</div>
                    <div class="session-item">
                        <span class="session-dot sydney"></span>
                        <span class="session-name">Sydney</span>
                        <span class="session-status" id="sessionSydney">Closed</span>
                    </div>
                    <div class="session-item">
                        <span class="session-dot tokyo"></span>
                        <span class="session-name">Tokyo</span>
                        <span class="session-status" id="sessionTokyo">Closed</span>
                    </div>
                    <div class="session-item">
                        <span class="session-dot london"></span>
                        <span class="session-name">London</span>
                        <span class="session-status" id="sessionLondon">Closed</span>
                    </div>
                    <div class="session-item">
                        <span class="session-dot newyork"></span>
                        <span class="session-name">New York</span>
                        <span class="session-status" id="sessionNewYork">Closed</span>
                    </div>
                </div>
            </div>

            <!-- Alerts Content -->
            <div class="unified-panel-content" id="alertsContent">
                <div class="alerts-actions">
                    <button class="alerts-add-btn" id="addAlertBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Create Alert
                    </button>
                </div>
                <div class="alerts-list" id="alertsList">
                    <!-- Alerts will be dynamically populated by AlertSystem -->
                </div>
            </div>

            <!-- Menu Content -->
            <div class="unified-panel-content" id="menuContent">
                <div class="menu-grid">
                    <div class="menu-grid-item" data-action="indicators">
                        <div class="menu-grid-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M3 3v18h18"/>
                                <path d="M7 16l4-4 4 4 5-6"/>
                            </svg>
                        </div>
                        <span>Indicators</span>
                    </div>
                    <div class="menu-grid-item" data-action="templates">
                        <div class="menu-grid-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                        </div>
                        <span>Templates</span>
                    </div>
                    <div class="menu-grid-item" data-action="settings">
                        <div class="menu-grid-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                            </svg>
                        </div>
                        <span>Settings</span>
                    </div>
                    <div class="menu-grid-item" data-action="appearance">
                        <div class="menu-grid-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="5"/>
                                <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                            </svg>
                        </div>
                        <span>Appearance</span>
                    </div>
                    <div class="menu-grid-item" data-action="hotkeys">
                        <div class="menu-grid-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="2" y="6" width="20" height="12" rx="2"/>
                                <line x1="6" y1="10" x2="6" y2="10"/>
                                <line x1="10" y1="10" x2="10" y2="10"/>
                                <line x1="14" y1="10" x2="14" y2="10"/>
                                <line x1="18" y1="10" x2="18" y2="10"/>
                                <line x1="8" y1="14" x2="16" y2="14"/>
                            </svg>
                        </div>
                        <span>Hotkeys</span>
                    </div>
                    <div class="menu-grid-item" data-action="help">
                        <div class="menu-grid-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </div>
                        <span>Help</span>
                    </div>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">Quick Actions</div>
                    <div class="menu-list-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span>Export Chart</span>
                    </div>
                    <div class="menu-list-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        <span>Copy Image</span>
                    </div>
                    <div class="menu-list-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        <span>Share</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar Panel - Object Tree -->
        <div class="right-sidebar-panel" id="objectTreePanel">
            <div class="object-tree-header">
                <div class="object-tree-tabs">
                    <button class="object-tree-tab active" data-tab="objects">Object Tree</button>
                    <button class="object-tree-tab" data-tab="data">Data Window</button>
                    <button class="object-tree-tab" data-tab="journal">Trade Journal</button>
                </div>
                <button class="object-tree-close" id="closeObjectTree" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Object Tree Toolbar (only for objects tab) -->
            <div class="object-tree-toolbar" id="objectTreeToolbar">
                <button class="object-tree-btn" id="showAllObjects" title="Show All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <button class="object-tree-btn" id="hideAllObjects" title="Hide All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
                <button class="object-tree-btn" id="deleteAllObjects" title="Delete All">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Content Panels -->
            <div class="object-tree-content">
                <!-- Object Tree Tab Content -->
                <div class="object-tree-list" id="objectTreeList" data-tab-content="objects" style="display: block;">
                    <!-- Objects will be listed here -->
                </div>
                
                <!-- Data Window Tab Content (already exists elsewhere, placeholder) -->
                <div class="object-tree-list" id="dataWindowContent" data-tab-content="data" style="display: none;">
                    <div style="padding: 20px; text-align: center; color: #64748b;">
                        Data Window
                    </div>
                </div>
                
                <!-- Trade Journal Tab Content -->
                <div class="object-tree-list" id="journalTabContent" data-tab-content="journal" style="display: none; overflow-y: auto; max-height: 100%;">
                    <div id="tradeHistoryList" style="padding: 0;"></div>
                    <div id="noTradesMsg" style="display: block; padding: 40px 20px; text-align: center; color: #64748b; font-size: 13px;">
                        No closed trades yet. Trades will appear here once you close positions.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Timeframe Modal -->
    <div class="custom-timeframe-modal" id="customTimeframeModal">
        <div class="custom-timeframe-content">
            <h3>Add Custom Timeframe</h3>
            <div class="custom-timeframe-row">
                <input type="number" class="custom-timeframe-input" id="customTimeframeValue" placeholder="Enter value" min="1" value="1">
                <select class="custom-timeframe-select" id="customTimeframeUnit">
                    <option value="m">Minutes</option>
                    <option value="h">Hours</option>
                    <option value="d">Days</option>
                    <option value="w">Weeks</option>
                    <option value="mo">Months</option>
                </select>
            </div>
            <div class="custom-timeframe-actions">
                <button class="custom-timeframe-cancel" id="customTimeframeCancel">Cancel</button>
                <button class="custom-timeframe-apply" id="customTimeframeApply">Apply</button>
            </div>
        </div>
    </div>

<!-- Scripts -->
    <script>
        (function() {
            const fallbackSrc = 'https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js';
            let fallbackRequested = false;
            let rejectWaiting = null;

            window.__loadD3Fallback = function() {
                if (fallbackRequested) {
                    return;
                }
                fallbackRequested = true;
                const script = document.createElement('script');
                script.src = fallbackSrc;
                script.crossOrigin = 'anonymous';
                script.referrerPolicy = 'no-referrer';
                script.onload = function() {
                    console.log('[Chart] D3 fallback loaded from jsDelivr');
                };
                script.onerror = function() {
                    const error = new Error('Failed to load D3 from fallback CDN');
                    console.error(error);
                    if (typeof rejectWaiting === 'function') {
                        rejectWaiting(error);
                    }
                };
                document.head.appendChild(script);
            };

            window.waitForD3 = new Promise((resolve, reject) => {
                rejectWaiting = reject;
                const start = performance.now();
                const timeoutMs = 10000;

                (function poll() {
                    if (window.d3 && typeof window.d3.select === 'function') {
                        resolve(window.d3);
                        return;
                    }

                    if (performance.now() - start > timeoutMs) {
                        const error = new Error('Timed out waiting for D3 to load');
                        console.error(error);
                        reject(error);
                        return;
                    }

                    setTimeout(poll, 50);
                })();
            });
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="window.__loadD3Fallback()"></script>

    <!-- Drawing Tools Modules (load in order) -->
    <script src="modules/drawing-tools-base.js?v=20260225_VLINE_EMPTY_TIMELABEL_V1"></script>
       <script src="modules/drawing-tools-lines.js?v=20260225_INFO_FIT_V1"></script>
    <script src="modules/drawing-tools-shapes.js?v=20260222_ALL_TOOLS_TEXT_V6"></script>
     <script src="modules/drawing-tools-fibonacci.js?v=20260127_FIB_RETRACEMENT_SOLID_DEFAULT_V4"></script>
    <script src="modules/drawing-tools-text.js?v=20260126TEXT_UI_UNIFY_BG_BORDER_V1"></script>
    <script src="modules/drawing-tools-emoji.js?v=20260103SMALLHANDLE"></script>
    <script src="modules/drawing-tools-image.js?v=20260117PLACEHOLDERRESIZE"></script>
    <script src="modules/emoji-picker.js?v=20241109005"></script>
    <script src="modules/emoji-picker-simple.js?v=20260117EMOJIPLACE"></script>
    <script src="modules/drawing-tools-advanced-volume.js?v=20260127_GANN_HIT_AREAS_V3"></script>
    <script src="modules/drawing-tools-advanced.js?v=20260124PATH_DEFAULT_END_ARROW_V6"></script>
    <script src="modules/drawing-tools-extended.js?v=20260224_ARROW_PERP_TEXT_V2"></script>
    <script src="modules/drawing-tools-patterns.js?v=20260121BARSPATTERN_V6"></script>
    <script src="modules/drawing-tools-fib-gann.js?v=20260127_GANN_HIT_AREAS_V12"></script>
    <script src="modules/drawing-tools-channels.js?v=20260222_ALL_TOOLS_TEXT_V6"></script>
     <script src="modules/drawing-tools-ui.js?v=20260225_INFO_ROW_CLICK_V1"></script>
    <script src="modules/color-picker.js?v=20260224_EXTENDED_OPTIONS_V2"></script>
    <script src="modules/drawing-toolbar.js?v=20260224_PASS_OPTIONS_V2"></script>
    <script src="modules/undo-redo-manager.js?v=20260224_UNDO_OVERHAUL_V1"></script>
    <script src="modules/drawing-tools-manager.js?v=20260224_CROSSHAIR_D3DRAG_V5"></script>
    <script src="modules/favorites-manager.js?v=20260125HORIZONTAL_RAY_UI_V1"></script>
    <script src="modules/keyboard-shortcuts.js?v=20251216PLAYSYNC2"></script>
    <script src="modules/object-tree.js?v=20251225PATH6PTS2"></script>
    <script src="modules/panel-manager.js?v=20251230NOBORDER"></script>
    <script src="modules/timeframe-favorites.js?v=20251228NOFLASH"></script>
    <script src="modules/propfirm-tracker.js?v=20241124001"></script>
    <script src="modules/compare-overlay.js?v=20251226AXISCURSOR2"></script>
    
    <!-- Timezone Manager - must load before chart.js -->
    <script src="modules/timezone-manager.js?v=20251216NODUP"></script>
    
         <script src="chart.js?v=20260225_PRICE_PRECISION_V1"></script>
         <!-- Replay System -->
        <!-- Replay System -->
    <script src="modules/replay-system.js?v=20260219_REPLAY_FORWARD_PANLOAD_V1"></script>
    
    
    <!-- Order Management System -->
    <script src="modules/order-manager.js?v=20251216POS"></script>
    
    <!-- Screenshot Manager -->
    <script src="modules/screenshot-manager.js?v=20251204NOTIFY"></script>
    
    <!-- Alert System -->
    <script src="modules/alert-system.js?v=20251207ALERTS8"></script>
    
    <!-- Force Screenshot Manager Initialization -->
    <script>
        // Ensure screenshot manager initializes after everything loads
        setTimeout(() => {
            if (!window.screenshotManager && window.chart) {
                console.log(' Force-initializing Screenshot Manager...');
                window.screenshotManager = new ScreenshotManager(window.chart);
                console.log(' Screenshot Manager force-initialized');
            } else if (!window.screenshotManager) {
                console.error(' Cannot initialize Screenshot Manager - chart not found');
            } else {
                console.log(' Screenshot Manager already initialized');
            }
        }, 2000);
    </script>
    
    <!-- Alert System Initialization -->
    <script>
        (function initAlertSystem() {
            // Initialize alert system after chart is ready
            setTimeout(() => {
                if (!window.alertSystem && window.chart) {
                    console.log(' Initializing Alert System...');
                    window.alertSystem = new AlertSystem(window.chart);
                    
                    // Hook into chart render to refresh alert lines
                    const originalRender = window.chart.render;
                    window.chart.render = function() {
                        originalRender.call(this);
                        if (window.alertSystem) {
                            window.alertSystem.renderAlertLines();
                        }
                    };
                    
                    console.log(' Alert System initialized');
                } else if (!window.alertSystem) {
                    console.error(' Cannot initialize Alert System - chart not found');
                }
            }, 2500);
        })();
    </script>
    
    <!-- Fullscreen System -->
    <script>
        (function setupFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (!fullscreenBtn) return;
            
            let isFullscreen = false;
            
            // Fullscreen icons
            const expandIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>`;
            
            const shrinkIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M4 14h6v6m10-10h-6V4m0 6l7-7M3 21l7-7"></path>
            </svg>`;
            
            function enterFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }
            
            function exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
            
            function updateButton() {
                isFullscreen = !!document.fullscreenElement || !!document.webkitFullscreenElement;
                fullscreenBtn.innerHTML = isFullscreen ? shrinkIcon : expandIcon;
                fullscreenBtn.dataset.tooltip = isFullscreen ? 'Exit Fullscreen' : 'Fullscreen';
            }
            
            // Button click handler
            fullscreenBtn.addEventListener('click', () => {
                if (isFullscreen) {
                    exitFullscreen();
                } else {
                    enterFullscreen();
                }
            });
            
            // Listen for fullscreen change events
            document.addEventListener('fullscreenchange', updateButton);
            document.addEventListener('webkitfullscreenchange', updateButton);
            document.addEventListener('msfullscreenchange', updateButton);
            
            // Keyboard shortcut: F11 or Cmd/Ctrl+Shift+F
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F11' || (e.key === 'f' && (e.metaKey || e.ctrlKey) && e.shiftKey)) {
                    e.preventDefault();
                    fullscreenBtn.click();
                }
            });
            
            console.log(' Fullscreen system initialized');
        })();
    </script>
    
    <!-- Debug commands for multi-timeframe testing -->
    
    <!-- Chart Indicators Module (Full version with ADR, ATR, Sessions) -->
    <!-- MUST be loaded AFTER chart.js as it extends the Chart prototype -->
    <script src="modules/chart-indicators-full.js?v=20260223_INDICATOR_LEGEND_FIX"></script>
    <!-- Indicator UI must load AFTER indicators to override updateOHLCIndicators -->
    <script src="modules/indicator-ui.js?v=20251229MENUFIX"></script>
    
    <!-- Initialize Indicator UI -->
    <script>
        // Wait for chart to be available and initialize indicator UI
        (function initIndicatorUI() {
            if (typeof setupIndicatorUI === 'function') {
                // Try to get the chart instance
                const trySetup = () => {
                    if (window.chart || window.mainChart) {
                        const chartInstance = window.chart || window.mainChart;
                        setupIndicatorUI(chartInstance);
                        console.log(' Indicator UI initialized');
                    } else {
                        // Retry after a short delay
                        setTimeout(trySetup, 100);
                    }
                };
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', trySetup);
                } else {
                    trySetup();
                }
            } else {
                console.error(' setupIndicatorUI function not found');
            }
        })();
    </script>
    
    <!-- Navigation Badge Tooltip Handler -->
    <script>
        document.addEventListener('click', (e) => {
            const badge = document.getElementById('navIntegrityBadge');
            if (badge && !badge.contains(e.target)) {
                badge.classList.remove('show-tooltip');
            }
        });
    </script>
    
    <!-- Prevent Browser Drag on Chart -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chartContainer = document.getElementById('chart-container');
            if (chartContainer) {
                chartContainer.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                    return false;
                });
                chartContainer.addEventListener('selectstart', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
        });
    </script>
    
    <!-- Right Sidebar Panel Handler -->
    <script>
        window.addEventListener('load', () => {
            const btn = document.getElementById('objectTreeIconBtn');
            const panel = document.getElementById('objectTreePanel');
            
            if (btn && panel) {
                btn.addEventListener('click', function() {
                    panel.classList.toggle('visible');
                });
            }
            
            // Close button
            const closeBtn = document.getElementById('closeObjectTree');
            if (closeBtn && panel) {
                closeBtn.addEventListener('click', function() {
                    panel.classList.remove('visible');
                });
            }
            
            // Tab switching for Object Tree panel
            const tabs = document.querySelectorAll('.object-tree-tab');
            const toolbar = document.getElementById('objectTreeToolbar');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show/hide content panels
                    document.querySelectorAll('[data-tab-content]').forEach(content => {
                        if (content.getAttribute('data-tab-content') === targetTab) {
                            content.style.display = 'block';
                        } else {
                            content.style.display = 'none';
                        }
                    });
                    
                    // Show toolbar only for objects tab
                    if (toolbar) {
                        toolbar.style.display = targetTab === 'objects' ? 'flex' : 'none';
                    }
                    
                    // Update journal tab when switched to
                    if (targetTab === 'journal' && window.chart && window.chart.orderManager) {
                        window.chart.orderManager.updateJournalTab();
                    }
                });
            });

            // Challenge Progress Toolbar Dropdown
            const challengeToolbarBtn = document.getElementById('challengeToolbarBtn');
            const challengeDropdown = document.getElementById('challengeDropdown');
            const challengeToolbarContainer = document.getElementById('challengeToolbarContainer');
            
            if (challengeToolbarBtn && challengeDropdown) {
                challengeToolbarBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    challengeDropdown.classList.toggle('show');
                    
                    // Sync tracker when opening dropdown
                    if (challengeDropdown.classList.contains('show')) {
                        if (typeof window.syncPropFirmTracker === 'function') {
                            window.syncPropFirmTracker();
                        } else if (typeof updateChallengeProgressCompact === 'function') {
                            updateChallengeProgressCompact();
                        }
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!challengeToolbarContainer.contains(e.target)) {
                        challengeDropdown.classList.remove('show');
                    }
                });
            }

            // Check if it's a propfirm session and show the button
            const session = localStorage.getItem('backtestingSession');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    if (sessionData.type === 'propfirm') {
                        if (challengeToolbarContainer) {
                            challengeToolbarContainer.style.display = 'block';
                        }
                        
                        // Load prop firm rules
                        loadPropFirmRulesCompact(sessionData);
                    }
                } catch (e) {
                    console.error('Error parsing session:', e);
                }
            }

            // Refresh button for dropdown
            const refreshDropdownBtn = document.getElementById('challengeDropdownRefresh');
            if (refreshDropdownBtn) {
                refreshDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (typeof window.syncPropFirmTracker === 'function') {
                        window.syncPropFirmTracker();
                    } else if (typeof updateChallengeProgressCompact === 'function') {
                        updateChallengeProgressCompact();
                    }
                });
            }

            // Unified Right Panel Handler
            const unifiedPanel = document.getElementById('unifiedRightPanel');
            const closeUnifiedPanel = document.getElementById('closeUnifiedPanel');
            const panelTitle = document.getElementById('unifiedPanelTitle');
            
            const watchlistBtn = document.getElementById('watchlistIconBtn');
            const newsBtn = document.getElementById('newsIconBtn');
            const clockBtn = document.getElementById('clockIconBtn');
            const alertsBtn = document.getElementById('alertsIconBtn');
            
            const watchlistContent = document.getElementById('watchlistContent');
            const newsContent = document.getElementById('newsContent');
            const clockContent = document.getElementById('clockContent');
            const alertsContent = document.getElementById('alertsContent');
            
            // Dark/Light Mode Toggle
            const darkModeBtn = document.getElementById('darkModeBtn');
            const lightModeBtn = document.getElementById('lightModeBtn');
            
            if (darkModeBtn && lightModeBtn) {
                darkModeBtn.addEventListener('click', () => {
                    darkModeBtn.classList.add('theme-toggle-animate');
                    setTimeout(() => darkModeBtn.classList.remove('theme-toggle-animate'), 500);
                    
                    document.body.classList.add('light-mode');
                    darkModeBtn.style.display = 'none';
                    lightModeBtn.style.display = 'flex';
                    // Apply light theme to chart immediately
                    if (window.chart) {
                        window.chart.chartSettings.scaleLinesColor = '#f0f3fa';
                        window.chart.chartSettings.scaleTextColor = '#050028';
                        window.chart.chartSettings.backgroundColor = '#ffffff';
                        window.chart.chartSettings.gridColor = 'rgba(42, 46, 57, 0.1)';
                        window.chart.chartSettings.symbolTextColor = '#050028';
                        // Apply background to canvas and container
                        window.chart.canvas.style.backgroundColor = '#ffffff';
                        const container = document.querySelector('.chart-container');
                        if (container) container.style.backgroundColor = '#ffffff';
                        // Apply text color to OHLC info elements
                        const ohlcInfo = document.querySelector('.ohlc-info');
                        if (ohlcInfo) {
                            ohlcInfo.querySelectorAll('.ohlc-symbol-text, .ohlc-label, .ohlc-separator, #chartTimeframe, .volume-label, .volume-value').forEach(el => {
                                el.style.color = '#050028';
                            });
                        }
                        window.chart.render();
                    }
                });
                
                lightModeBtn.addEventListener('click', () => {
                    lightModeBtn.classList.add('theme-toggle-animate');
                    setTimeout(() => lightModeBtn.classList.remove('theme-toggle-animate'), 500);
                    
                    document.body.classList.remove('light-mode');
                    lightModeBtn.style.display = 'none';
                    darkModeBtn.style.display = 'flex';
                    // Apply dark theme to chart immediately
                    if (window.chart) {
                        window.chart.chartSettings.scaleLinesColor = '#050028';
                        window.chart.chartSettings.scaleTextColor = '#ffffff';
                        window.chart.chartSettings.backgroundColor = '#050028';
                        window.chart.chartSettings.gridColor = 'rgba(42, 46, 57, 0.6)';
                        window.chart.chartSettings.symbolTextColor = '#ffffff';
                        // Apply background to canvas and container
                        window.chart.canvas.style.backgroundColor = '#050028';
                        const container = document.querySelector('.chart-container');
                        if (container) container.style.backgroundColor = '#050028';
                        // Apply text color to OHLC info elements
                        const ohlcInfo = document.querySelector('.ohlc-info');
                        if (ohlcInfo) {
                            ohlcInfo.querySelectorAll('.ohlc-symbol-text, .ohlc-label, .ohlc-separator, #chartTimeframe, .volume-label, .volume-value').forEach(el => {
                                el.style.color = '#ffffff';
                            });
                        }
                        window.chart.render();
                    }
                });
            }
            
            let currentPanel = null;
            
            function showPanel(panelType) {
                // Remove active from all buttons
                [watchlistBtn, newsBtn, clockBtn, alertsBtn].forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });
                
                // Hide all content
                [watchlistContent, newsContent, clockContent, alertsContent].forEach(content => {
                    if (content) content.classList.remove('active');
                });
                
                // If clicking same panel, close it
                if (currentPanel === panelType && unifiedPanel.classList.contains('visible')) {
                    unifiedPanel.classList.remove('visible');
                    currentPanel = null;
                    var _w = document.getElementById('chartWrapper'); if (_w) _w.classList.remove('settings-open');
                    var _c = window.chart || window.mainChart;
                    if (_c && _c.resize) setTimeout(function(){ _c.resize(); if (_c.scheduleRender) _c.scheduleRender(); }, 290);
                    return;
                }
                
                // Show panel and activate correct content
                unifiedPanel.classList.add('visible');
                currentPanel = panelType;
                var _w = document.getElementById('chartWrapper'); if (_w) _w.classList.add('settings-open');
                var _c = window.chart || window.mainChart;
                if (_c && _c.resize) setTimeout(function(){ _c.resize(); if (_c.scheduleRender) _c.scheduleRender(); }, 290);
                
                switch(panelType) {
                    case 'watchlist':
                        if (watchlistBtn) watchlistBtn.classList.add('active');
                        if (watchlistContent) watchlistContent.classList.add('active');
                        if (panelTitle) panelTitle.textContent = 'Watchlist';
                        loadWatchlistItems();
                        break;
                    case 'news':
                        if (newsBtn) newsBtn.classList.add('active');
                        if (newsContent) newsContent.classList.add('active');
                        if (panelTitle) panelTitle.textContent = 'News';
                        break;
                    case 'clock':
                        if (clockBtn) clockBtn.classList.add('active');
                        if (clockContent) clockContent.classList.add('active');
                        if (panelTitle) panelTitle.textContent = 'Clock';
                        updateClock();
                        break;
                    case 'alerts':
                        if (alertsBtn) alertsBtn.classList.add('active');
                        if (alertsContent) alertsContent.classList.add('active');
                        if (panelTitle) panelTitle.textContent = 'Alerts';
                        break;
                }
            }
            
            // Make showPanel globally accessible
            window.showPanel = showPanel;
            
            if (watchlistBtn) {
                watchlistBtn.addEventListener('click', () => showPanel('watchlist'));
            }
            /* newsBtn and clockBtn now handled via onclick -> window._spOpen */
            if (alertsBtn) {
                alertsBtn.addEventListener('click', () => showPanel('alerts'));
            }
            // Toolbar alerts button  opens global settings panel on Alerts section
            const toolbarAlertsBtn = document.getElementById('toolbarAlertsBtn');
            if (toolbarAlertsBtn) {
                toolbarAlertsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window._spOpen) window._spOpen('alerts');
                });
            }
            if (closeUnifiedPanel) {
                closeUnifiedPanel.addEventListener('click', function() {
                    unifiedPanel.classList.remove('visible');
                    [watchlistBtn, newsBtn, clockBtn, alertsBtn].forEach(btn => {
                        if (btn) btn.classList.remove('active');
                    });
                    currentPanel = null;
                    var _w = document.getElementById('chartWrapper'); if (_w) _w.classList.remove('settings-open');
                    var _c = window.chart || window.mainChart;
                    if (_c && _c.resize) setTimeout(function(){ _c.resize(); if (_c.scheduleRender) _c.scheduleRender(); }, 290);
                });
            }

            // Close panel when clicking on empty chart area
            document.addEventListener('click', function(e) {
                // Check if panel is open
                if (!unifiedPanel.classList.contains('visible')) return;
                
                // Don't close if clicking inside the panel or on panel buttons
                if (unifiedPanel.contains(e.target)) return;
                if (watchlistBtn && watchlistBtn.contains(e.target)) return;
                if (newsBtn && newsBtn.contains(e.target)) return;
                if (clockBtn && clockBtn.contains(e.target)) return;
                if (alertsBtn && alertsBtn.contains(e.target)) return;
                
                // Don't close if clicking on symbol watchlist button
                const symbolWatchlistBtn = document.getElementById('symbolWatchlistBtn');
                if (symbolWatchlistBtn && symbolWatchlistBtn.contains(e.target)) return;
                
                // Don't close if clicking on toolbar alerts button
                const toolbarAlertsBtn = document.getElementById('toolbarAlertsBtn');
                if (toolbarAlertsBtn && toolbarAlertsBtn.contains(e.target)) return;
                
                // Close the panel
                unifiedPanel.classList.remove('visible');
                [watchlistBtn, newsBtn, clockBtn, alertsBtn].forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });
                currentPanel = null;
                var _w = document.getElementById('chartWrapper'); if (_w) _w.classList.remove('settings-open');
                var _c = window.chart || window.mainChart;
                if (_c && _c.resize) setTimeout(function(){ _c.resize(); if (_c.scheduleRender) _c.scheduleRender(); }, 290);
            });

            // Clock functionality - shows current candle time in selected timezone
            function updateClock() {
                // Get current candle time from chart, fallback to system time
                let candleTime;
                const chart = window.chart || window.mainChart;
                if (chart && chart.data && chart.data.length > 0) {
                    // Get the last visible candle or current candle
                    const lastCandle = chart.data[chart.data.length - 1];
                    candleTime = new Date(lastCandle.t);
                } else {
                    candleTime = new Date();
                }
                
                // Get selected timezone from timezoneManager
                const tzManager = window.timezoneManager;
                const selectedTz = tzManager ? tzManager.getTimezone() : { id: 'UTC', label: 'UTC', offset: 0 };
                
                // Update timezone label
                const tzLabel = document.getElementById('clockTimezoneLabel');
                if (tzLabel) {
                    tzLabel.textContent = selectedTz.label;
                }
                
                // Convert candle time to selected timezone
                const convertedTime = tzManager ? tzManager.convertToTimezone(candleTime.getTime()) : candleTime;
                
                // Main clock - shows candle time in selected timezone
                const clockTime = document.getElementById('clockTime');
                const clockDate = document.getElementById('clockDate');
                if (clockTime) {
                    const hours = String(convertedTime.getHours()).padStart(2, '0');
                    const minutes = String(convertedTime.getMinutes()).padStart(2, '0');
                    const seconds = String(convertedTime.getSeconds()).padStart(2, '0');
                    clockTime.textContent = `${hours}:${minutes}:${seconds}`;
                }
                if (clockDate) {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                    const dayName = days[convertedTime.getDay()];
                    const monthName = months[convertedTime.getMonth()];
                    const day = convertedTime.getDate();
                    const year = convertedTime.getFullYear();
                    clockDate.textContent = `${dayName}, ${monthName} ${day}, ${year}`;
                }
                
                // Timezone times - show candle time in different timezones
                const timezones = [
                    { id: 'tzNewYork', tz: 'America/New_York', offset: -5 },
                    { id: 'tzLondon', tz: 'Europe/London', offset: 0 },
                    { id: 'tzTokyo', tz: 'Asia/Tokyo', offset: 9 },
                    { id: 'tzSydney', tz: 'Australia/Sydney', offset: 10 }
                ];
                
                // Get UTC time of candle
                const candleUtc = candleTime.getTime() + (candleTime.getTimezoneOffset() * 60000);
                
                timezones.forEach(({ id, offset }) => {
                    const el = document.getElementById(id);
                    if (el) {
                        const tzTime = new Date(candleUtc + (offset * 60 * 60 * 1000));
                        const hours = String(tzTime.getHours()).padStart(2, '0');
                        const minutes = String(tzTime.getMinutes()).padStart(2, '0');
                        el.textContent = `${hours}:${minutes}`;
                    }
                });
                
                // Update market sessions based on candle time
                const utcHour = new Date(candleUtc).getUTCHours();
                const sessions = {
                    sydney: (utcHour >= 21 || utcHour < 6),
                    tokyo: (utcHour >= 0 && utcHour < 9),
                    london: (utcHour >= 7 && utcHour < 16),
                    newyork: (utcHour >= 12 && utcHour < 21)
                };
                
                Object.entries(sessions).forEach(([name, isOpen]) => {
                    const el = document.getElementById('session' + name.charAt(0).toUpperCase() + name.slice(1));
                    if (el) {
                        el.textContent = isOpen ? 'Open' : 'Closed';
                        el.className = 'session-status' + (isOpen ? ' open' : '');
                    }
                });
            }
            
            // Update clock every second if panel is open
            setInterval(() => {
                if (currentPanel === 'clock') {
                    updateClock();
                }
            }, 1000);

            // News tabs switching
            const newsTabs = document.querySelectorAll('.news-tab');
            newsTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    newsTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Load watchlist items from available files
            async function loadWatchlistItems() {
                const container = document.getElementById('watchlistItems');
                if (!container) return;
                
                try {
                    const response = await fetch('/api/files');
                    const files = await response.json();
                    
                    container.innerHTML = '';
                    
                    for (const file of files) {
                        // Get the last price data for each file
                        const fileData = await getFileLastPrice(file.id);
                        const item = createWatchlistItem(file, fileData);
                        container.appendChild(item);
                    }
                } catch (error) {
                    console.error('Error loading watchlist:', error);
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6a6a7a;">No files available</div>';
                }
            }

            async function getFileLastPrice(fileId) {
                try {
                    const response = await fetch(`/api/file/${fileId}`);
                    const data = await response.json();
                    if (data.candles && data.candles.length > 0) {
                        const lastCandle = data.candles[data.candles.length - 1];
                        const firstCandle = data.candles[0];
                        const change = lastCandle.close - firstCandle.open;
                        const changePercent = ((change / firstCandle.open) * 100);
                        return {
                            price: lastCandle.close,
                            change: change,
                            changePercent: changePercent
                        };
                    }
                } catch (error) {
                    console.error('Error fetching file data:', error);
                }
                return { price: 0, change: 0, changePercent: 0 };
            }

            function createWatchlistItem(file, priceData) {
                const item = document.createElement('div');
                item.className = 'watchlist-item';
                item.setAttribute('data-file-id', file.id);
                
                // Extract symbol from filename
                const symbol = file.symbol || file.name.replace('.csv', '').toUpperCase();
                
                // Format price with decimal coloring
                const priceStr = priceData.price.toFixed(5);
                const mainPrice = priceStr.slice(0, -2);
                const decimals = priceStr.slice(-2);
                
                // Determine color based on change
                const changeClass = priceData.change >= 0 ? 'positive' : 'negative';
                const changeSign = priceData.change >= 0 ? '' : '';
                
                // Get currency flag icon
                const flagIcon = getCurrencyFlag(symbol);
                
                item.innerHTML = `
                    <div class="watchlist-symbol">
                        <div class="watchlist-symbol-icon">${flagIcon}</div>
                        <span class="watchlist-symbol-name">${symbol}</span>
                    </div>
                    <span class="watchlist-price">${mainPrice}<span class="decimals">${decimals}</span></span>
                    <span class="watchlist-change ${changeClass}">${changeSign}${priceData.change.toFixed(5)}</span>
                    <span class="watchlist-change ${changeClass}">${priceData.changePercent.toFixed(2)}%</span>
                `;
                
                // Click to load this symbol
                item.addEventListener('click', function() {
                    if (window.loadFileData) {
                        window.loadFileData(file.id);
                    }
                });
                
                return item;
            }

            function getCurrencyFlag(symbol) {
                const flags = {
                    'EUR': '', 'USD': '', 'GBP': '', 'JPY': '',
                    'AUD': '', 'CAD': '', 'CHF': '', 'NZD': '',
                    'CNY': '', 'HKD': '', 'SGD': '', 'SEK': '',
                    'NOK': '', 'MXN': '', 'ZAR': '', 'TRY': '',
                    'XAU': '', 'XAG': '', 'BTC': '', 'ETH': ''
                };
                
                // Try to match first 3 chars of symbol
                const base = symbol.substring(0, 3).toUpperCase();
                return flags[base] || '';
            }
        });

        // Toggle challenge item expand/collapse
        function toggleChallengeItem(header) {
            header.classList.toggle('collapsed');
        }

        // Load prop firm rules from session
        function loadPropFirmRules(sessionData) {
            console.log('Loading prop firm rules:', sessionData);
            
            // Set balance
            const balanceEl = document.getElementById('challengeBalance');
            if (balanceEl && sessionData.balance) {
                balanceEl.textContent = '$' + sessionData.balance.toLocaleString();
            }

            // Set period (start and end date)
            const periodEl = document.getElementById('challengePeriod');
            if (periodEl && sessionData.startDate && sessionData.endDate) {
                const startDate = new Date(sessionData.startDate);
                const endDate = new Date(sessionData.endDate);
                const options = { month: 'short', day: 'numeric' };
                periodEl.textContent = startDate.toLocaleDateString('en-US', options) + ' - ' + endDate.toLocaleDateString('en-US', options);
            }

            // Set leverage
            const leverageEl = document.getElementById('challengeLeverage');
            if (leverageEl && sessionData.leverage) {
                leverageEl.textContent = '1:' + sessionData.leverage;
            }

            // Set minimum trading days
            const minDaysEl = document.getElementById('minTradingDaysValue');
            if (minDaysEl) {
                minDaysEl.textContent = sessionData.minTradingDays || 1;
            }

            // Set profit target
            const profitTargetEl = document.getElementById('profitTargetValue');
            if (profitTargetEl && sessionData.profitTarget) {
                profitTargetEl.textContent = sessionData.profitTarget + '%';
            }

            // Set max daily loss
            const maxDailyLossEl = document.getElementById('maxDailyLossValue');
            if (maxDailyLossEl && sessionData.maxDailyLoss) {
                maxDailyLossEl.textContent = sessionData.maxDailyLoss.percent + '%';
            }

            // Set max total loss
            const maxTotalLossEl = document.getElementById('maxTotalLossValue');
            if (maxTotalLossEl && sessionData.maxTotalLoss) {
                maxTotalLossEl.textContent = sessionData.maxTotalLoss.percent + '%';
            }
        }

        // Update challenge progress with real-time data
        function updateChallengeProgress() {
            // This function should be called when orders change
            // For now, using placeholder logic
            
            // Trading Days (would need to track actual trading days)
            const tradingDays = 1; // Calculate from order history
            const minTradingDays = parseInt(document.getElementById('minTradingDaysValue').textContent) || 1;
            const tradingDaysPercent = Math.min((tradingDays / minTradingDays) * 100, 100);
            
            document.getElementById('currentTradingDays').textContent = tradingDays;
            document.getElementById('tradingDaysProgress').style.width = tradingDaysPercent + '%';
            
            // Update icon status
            const tradingDaysIcon = document.querySelector('.challenge-item:nth-child(1) .challenge-icon');
            if (tradingDays >= minTradingDays) {
                tradingDaysIcon.classList.remove('challenge-icon-pending');
                tradingDaysIcon.classList.add('challenge-icon-success');
            }

            // Profit Target (would calculate from account balance)
            const session = JSON.parse(localStorage.getItem('backtestingSession') || '{}');
            const startBalance = session.balance || 10000;
            const currentBalance = startBalance; // Get from chart/order manager
            const profitPercent = ((currentBalance - startBalance) / startBalance) * 100;
            const profitTarget = parseFloat(document.getElementById('profitTargetValue').textContent) || 10;
            const profitProgress = Math.min((profitPercent / profitTarget) * 100, 100);
            
            document.getElementById('currentProfit').textContent = profitPercent.toFixed(2) + '%';
            document.getElementById('profitProgress').style.width = Math.max(0, profitProgress) + '%';

            // Max Daily Loss
            const dailyLoss = 0; // Calculate from today's trades
            const maxDailyLoss = parseFloat(document.getElementById('maxDailyLossValue').textContent) || 5;
            const dailyLossProgress = Math.min((Math.abs(dailyLoss) / maxDailyLoss) * 100, 100);
            
            document.getElementById('currentDailyLoss').textContent = dailyLoss.toFixed(2) + '%';
            document.getElementById('dailyLossProgress').style.width = dailyLossProgress + '%';
            
            // Update icon if loss limit breached
            const dailyLossIcon = document.querySelector('.challenge-item:nth-child(3) .challenge-icon');
            if (Math.abs(dailyLoss) >= maxDailyLoss) {
                dailyLossIcon.classList.remove('challenge-icon-pending');
                dailyLossIcon.classList.add('challenge-icon-danger');
            }

            // Max Total Loss
            const totalLoss = profitPercent < 0 ? profitPercent : 0;
            const maxTotalLoss = parseFloat(document.getElementById('maxTotalLossValue').textContent) || 10;
            const totalLossProgress = Math.min((Math.abs(totalLoss) / maxTotalLoss) * 100, 100);
            
            document.getElementById('currentTotalLoss').textContent = Math.abs(totalLoss).toFixed(2) + '%';
            document.getElementById('totalLossProgress').style.width = totalLossProgress + '%';
            
            // Update icon if loss limit breached
            const totalLossIcon = document.querySelector('.challenge-item:nth-child(4) .challenge-icon');
            if (Math.abs(totalLoss) >= maxTotalLoss) {
                totalLossIcon.classList.remove('challenge-icon-pending');
                totalLossIcon.classList.add('challenge-icon-danger');
            }
        }

        // Expose function globally so it can be called from other scripts
        window.updateChallengeProgress = updateChallengeProgress;

        // Compact Toolbar Dropdown Functions
        function loadPropFirmRulesCompact(sessionData) {
            console.log('Loading compact prop firm rules:', sessionData);
            
            // Set balance
            const balanceEl = document.getElementById('challengeBalanceDropdown');
            if (balanceEl && sessionData.balance) {
                balanceEl.textContent = '$' + sessionData.balance.toLocaleString();
            }

            // Set leverage
            const leverageEl = document.getElementById('challengeLeverageDropdown');
            if (leverageEl && sessionData.leverage) {
                leverageEl.textContent = '1:' + sessionData.leverage;
            }

            // Store targets for progress calculations
            window.propFirmTargets = {
                minTradingDays: sessionData.minTradingDays || 1,
                profitTarget: sessionData.profitTarget || 10,
                maxDailyLoss: sessionData.maxDailyLoss?.percent || 5,
                maxTotalLoss: sessionData.maxTotalLoss?.percent || 10,
                startBalance: sessionData.balance || 10000
            };
        }

        function updateChallengeProgressCompact() {
            if (!window.propFirmTargets) return;
            
            const targets = window.propFirmTargets;
            
            // Trading Days
            const tradingDays = 1; // Calculate from order history
            const tradingDaysPercent = Math.min((tradingDays / targets.minTradingDays) * 100, 100);
            
            document.getElementById('challengeTradingDaysDropdown').textContent = `${tradingDays}/${targets.minTradingDays}`;
            document.getElementById('challengeTradingDaysBar').style.width = tradingDaysPercent + '%';
            
            // Update status badge
            let completedTasks = tradingDays >= targets.minTradingDays ? 1 : 0;
            
            // Profit Target
            const currentBalance = targets.startBalance; // Get from chart/order manager
            const profitPercent = ((currentBalance - targets.startBalance) / targets.startBalance) * 100;
            const profitProgress = Math.min((profitPercent / targets.profitTarget) * 100, 100);
            
            document.getElementById('challengeProfitDropdown').textContent = 
                `${profitPercent.toFixed(2)}% / ${targets.profitTarget}%`;
            document.getElementById('challengeProfitBar').style.width = Math.max(0, profitProgress) + '%';
            
            if (profitPercent >= targets.profitTarget) completedTasks++;
            
            // Max Daily Loss
            const dailyLoss = 0; // Calculate from today's trades
            const dailyLossPercent = Math.abs(dailyLoss);
            const dailyLossProgress = Math.min((dailyLossPercent / targets.maxDailyLoss) * 100, 100);
            
            document.getElementById('challengeDailyLossDropdown').textContent = 
                `${dailyLossPercent.toFixed(2)}% / ${targets.maxDailyLoss}%`;
            document.getElementById('challengeDailyLossBar').style.width = dailyLossProgress + '%';
            
            if (dailyLossPercent < targets.maxDailyLoss) completedTasks++;
            
            // Max Total Loss
            const totalLoss = profitPercent < 0 ? Math.abs(profitPercent) : 0;
            const totalLossProgress = Math.min((totalLoss / targets.maxTotalLoss) * 100, 100);
            
            document.getElementById('challengeTotalLossDropdown').textContent = 
                `${totalLoss.toFixed(2)}% / ${targets.maxTotalLoss}%`;
            document.getElementById('challengeTotalLossBar').style.width = totalLossProgress + '%';
            
            if (totalLoss < targets.maxTotalLoss) completedTasks++;
            
            // Update badge
            const badgeEl = document.getElementById('challengeStatusBadge');
            if (badgeEl) {
                badgeEl.textContent = `${completedTasks}/4`;
                
                // Change color based on progress
                if (completedTasks === 4) {
                    badgeEl.style.background = '#22c55e';
                } else if (completedTasks >= 2) {
                    badgeEl.style.background = '#f59e0b';
                } else {
                    badgeEl.style.background = '#ef4444';
                }
            }
        }

        // Expose compact functions globally
        window.updateChallengeProgressCompact = updateChallengeProgressCompact;
    </script>
    
    <!-- Tool Group Dropdown Handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle dropdown groups
            const groupButtons = document.querySelectorAll('.tool-group-btn[data-group]');
            let currentOpenDropdown = null;
            let isDeselecting = false; // Flag to prevent re-activation during deselection

            // Close any open Visibility menu(s) (supports multi-panel setups)
            window.closeVisibilityMenus = function() {
                const candidates = [];
                if (window.chart) candidates.push(window.chart);
                if (window.mainChart && window.mainChart !== window.chart) candidates.push(window.mainChart);
                if (window.panelManager && Array.isArray(window.panelManager.panels)) {
                    window.panelManager.panels.forEach(p => {
                        if (p && p.chartInstance) candidates.push(p.chartInstance);
                    });
                }
                if (window.panelManager && typeof window.panelManager.getSelectedPanel === 'function') {
                    const selected = window.panelManager.getSelectedPanel();
                    if (selected && selected.chartInstance) candidates.push(selected.chartInstance);
                }

                let closedViaApi = false;
                candidates.forEach(ch => {
                    if (ch && ch.visibilityMenuVisible && typeof ch.hideVisibilityMenu === 'function') {
                        ch.hideVisibilityMenu();
                        closedViaApi = true;
                    }
                });

                // Force-hide any visibility menus in the DOM (covers multi-panel/state-desync cases)
                document.querySelectorAll('.visibility-menu').forEach(menu => {
                    menu.classList.remove('visible');
                    menu.style.display = 'none';
                });
            };

            // Close any open tool dropdowns (lines/arrows/etc.) and magnet dropdown
            window.closeAllToolDropdowns = function() {
                document.querySelectorAll('.tool-dropdown').forEach(dd => {
                    dd.classList.remove('show');
                    if (dd.id === 'visibility-toolbar-dropdown' || dd.id === 'delete-toolbar-dropdown') {
                        dd.style.display = 'none';
                    }
                });
                document.querySelectorAll('.tool-group-btn[data-group]').forEach(btn => {
                    btn.classList.remove('dropdown-open');
                });
                document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow').forEach(arr => {
                    arr.classList.remove('dropdown-open');
                });

                const magnetDropdownMenu = document.getElementById('magnetDropdown');
                if (magnetDropdownMenu) {
                    magnetDropdownMenu.style.display = 'none';
                }
            };

            // When opening Visibility, always close any other dropdowns first (capture phase)
            const visibilityButtons = [
                document.getElementById('toggleVisibilityMenu'),
                document.getElementById('toggleVisibilityMenuToolbar')
            ];
            visibilityButtons.forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', function() {
                    if (typeof window.closeAllToolDropdowns === 'function') {
                        window.closeAllToolDropdowns();
                    }
                }, true);
            });
            
            // Handle separate cursor dropdown arrow button
            // Handle all dropdown arrows (cursor + other tool groups)
            const allDropdownArrows = document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow');
            
            allDropdownArrows.forEach(arrow => {
                arrow.addEventListener('click', function(e) {
                    e.stopPropagation();

                    // Close visibility menu when opening any dropdown
                    if (typeof window.closeVisibilityMenus === 'function') {
                        window.closeVisibilityMenus();
                    }

                    // Also hide the magnet dropdown (it uses display:block instead of .show)
                    const magnetDropdownMenu = document.getElementById('magnetDropdown');
                    if (magnetDropdownMenu) {
                        magnetDropdownMenu.style.display = 'none';
                    }
                    
                    const group = this.dataset.group;
                    const dropdown = document.getElementById(group + '-dropdown');
                    
                    if (!dropdown) return;
                    
                    // Close other dropdowns
                    document.querySelectorAll('.tool-dropdown').forEach(dd => {
                        if (dd !== dropdown) {
                            dd.classList.remove('show');
                            if (dd.id === 'visibility-toolbar-dropdown' || dd.id === 'delete-toolbar-dropdown') {
                                dd.style.display = 'none';
                            }
                        }
                    });
                    document.querySelectorAll('.tool-group-btn[data-group]').forEach(btn => {
                        btn.classList.remove('dropdown-open');
                    });
                    document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow').forEach(arr => {
                        if (arr !== this) {
                            arr.classList.remove('dropdown-open');
                        }
                    });
                    
                    // Toggle dropdown
                    const isShowing = dropdown.classList.contains('show');
                    dropdown.classList.toggle('show');
                    if (!isShowing) dropdown.style.display = '';
                    this.classList.toggle('dropdown-open', !isShowing);
                    currentOpenDropdown = isShowing ? null : dropdown;
                    
                    // Position dropdown below the arrow
                    if (!isShowing) {
                        const buttonRect = this.getBoundingClientRect();
                        
                        if (dropdown.parentElement !== document.body) {
                            document.body.appendChild(dropdown);
                        }
                        
                        dropdown.style.position = 'fixed';
                        dropdown.style.top = (buttonRect.bottom + 4) + 'px';
                        dropdown.style.left = buttonRect.left + 'px';
                        dropdown.style.right = 'auto';
                        dropdown.style.bottom = 'auto';
                    }
                });
            });
            
            // Set default tools for each group
            const defaultTools = {
                'lines': 'trendlineTool',
                'arrows': 'arrowTool',
                'text': 'textTool',
                'analysis': 'fibonacci-retracementTool',
                'projections': 'long-positionTool',
                'patterns': 'elliott-impulseTool'
            };
            
            // Initialize default tools for groups
            groupButtons.forEach(button => {
                const group = button.dataset.group;
                if (defaultTools[group] && !button.dataset.lastSelectedTool) {
                    button.dataset.lastSelectedTool = defaultTools[group];
                }
            });
            
            let isGroupButtonClick = false; // Flag to track group button clicks
            groupButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Check if this group button is already active - if so, deselect it
                    const isAlreadyActive = this.classList.contains('active');
                    
                    if (isAlreadyActive) {
                        // Deselect the tool and return to cursor mode
                        const chart = window.chart || window.mainChart;
                        if (chart && chart.drawingManager) {
                            chart.drawingManager.clearTool();
                        }
                        
                        // Remove active from all tools
                        document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tool-group-btn:not(#magnetMode):not(#magnetModeToolbar)').forEach(b => b.classList.remove('active'));
                        
                        // Activate cursor tool
                        const cursorBtn = document.getElementById('cursorTool');
                        if (cursorBtn) cursorBtn.classList.add('active');
                        
                        console.log(' Tool deselected, returned to cursor mode');
                        return;
                    }
                    
                    // Close any open dropdowns
                    document.querySelectorAll('.tool-dropdown').forEach(dd => {
                        dd.classList.remove('show');
                    });
                    document.querySelectorAll('.tool-group-btn[data-group]').forEach(btn => {
                        btn.classList.remove('dropdown-open');
                    });
                    document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow').forEach(btn => {
                        btn.classList.remove('dropdown-open');
                    });
                    currentOpenDropdown = null;
                    
                    // Always activate the last selected tool (or default)
                    const toolId = this.dataset.lastSelectedTool;
                    if (toolId) {
                        const toolBtn = document.getElementById(toolId);
                        if (toolBtn) {
                            isGroupButtonClick = true; // Set flag before programmatic click
                            toolBtn.click();
                            setTimeout(() => { isGroupButtonClick = false; }, 100); // Clear flag after
                        }
                    }
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                // Don't close if clicking on emoji picker panel
                if (e.target.closest('.emoji-picker-panel')) {
                    return;
                }
                if (!e.target.closest('.tool-group') && !e.target.closest('.tool-dropdown')) {
                    document.querySelectorAll('.tool-dropdown').forEach(dd => {
                        dd.classList.remove('show');
                        if (dd.id === 'visibility-toolbar-dropdown' || dd.id === 'delete-toolbar-dropdown') {
                            dd.style.display = 'none';
                        }
                    });
                    document.querySelectorAll('.tool-group-btn').forEach(btn => {
                        btn.classList.remove('dropdown-open');
                    });
                    document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow').forEach(btn => {
                        btn.classList.remove('dropdown-open');
                    });
                    currentOpenDropdown = null;
                }
            });
            
            // Close dropdown when selecting a tool and update group button icon
            let isActivatingTool = false; // Flag to prevent double-activation
            document.querySelectorAll('.tool-dropdown .tool-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    // Stop propagation to prevent click from reaching SVG/canvas
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // Don't close dropdown for emoji tool - it has its own picker
                    if (this.id === 'emojiTool') {
                        return;
                    }
                    
                    // Prevent double-activation from programmatic clicks
                    if (isActivatingTool) {
                        console.log(' Skipping duplicate tool activation');
                        return;
                    }
                    
                    // Check if this tool is already active - if so, deselect it
                    // BUT skip this check if triggered by group button click OR if dropdown is currently open
                    const chart = window.chart || window.mainChart;
                    const toolName = (this.id && this.id.endsWith('Tool')) ? this.id.slice(0, -4) : null;
                    const dropdown = this.closest('.tool-dropdown');
                    const isDropdownOpen = dropdown && dropdown.classList.contains('show');
                    const isAlreadyActive = !isGroupButtonClick && !isDropdownOpen && toolName && chart && chart.drawingManager && chart.drawingManager.currentTool === toolName;
                    
                    if (isAlreadyActive) {
                        isDeselecting = true; // Set flag to prevent re-activation
                        
                        // Deselect the tool and return to cursor mode
                        if (chart && chart.drawingManager) {
                            chart.drawingManager.clearTool();
                        }
                        
                        // Remove active from all tools
                        document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tool-group-btn:not(#magnetMode):not(#magnetModeToolbar)').forEach(b => b.classList.remove('active'));
                        
                        // Activate cursor tool
                        const cursorBtn = document.getElementById('cursorTool');
                        if (cursorBtn) cursorBtn.classList.add('active');
                        
                        // Close dropdown
                        setTimeout(() => {
                            document.querySelectorAll('.tool-dropdown').forEach(dd => dd.classList.remove('show'));
                            document.querySelectorAll('.tool-group-btn').forEach(btn => btn.classList.remove('dropdown-open'));
                            document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow').forEach(btn => btn.classList.remove('dropdown-open'));
                            currentOpenDropdown = null;
                            isDeselecting = false; // Clear flag after dropdown closes
                        }, 150);
                        
                        console.log(' Tool deselected, returned to cursor mode');
                        return;
                    }
                    
                    // Update the group button to show the selected tool's icon
                    // (reuse dropdown variable from above)
                    // Skip for delete and visibility dropdowns - they don't activate tools
                    if (dropdown && dropdown.id !== 'delete-toolbar-dropdown' && dropdown.id !== 'visibility-toolbar-dropdown') {
                        const dropdownId = dropdown.id;
                        const groupName = dropdownId.replace('-dropdown', '');
                        const groupButton = document.querySelector(`[data-group="${groupName}"]`);
                        
                        if (groupButton) {
                            // Store the last selected tool ID for quick re-activation
                            groupButton.dataset.lastSelectedTool = this.id;
                            
                            // Remove active class from ALL tool buttons (not just this dropdown)
                            document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(t => t.classList.remove('active'));
                            document.querySelectorAll('.tool-group-btn:not(#magnetMode):not(#magnetModeToolbar)').forEach(t => t.classList.remove('active'));
                            
                            // Add active class to the selected tool
                            this.classList.add('active');
                            
                            // Clone the clicked tool's SVG (excluding dropdown arrow)
                            const toolSvg = this.querySelector('svg:not(.dropdown-arrow)');
                            const groupSvg = groupButton.querySelector('svg:not(.dropdown-arrow)');
                            
                            if (toolSvg && groupSvg) {
                                // Copy the inner content of the tool SVG to the group button SVG
                                groupSvg.innerHTML = toolSvg.innerHTML;
                                // Copy attributes like viewBox, stroke-width, etc.
                                groupSvg.setAttribute('viewBox', toolSvg.getAttribute('viewBox') || '0 0 24 24');
                                groupSvg.setAttribute('stroke-width', toolSvg.getAttribute('stroke-width') || '1.5');
                                if (toolSvg.getAttribute('stroke-linecap')) {
                                    groupSvg.setAttribute('stroke-linecap', toolSvg.getAttribute('stroke-linecap'));
                                }
                                if (toolSvg.getAttribute('stroke-linejoin')) {
                                    groupSvg.setAttribute('stroke-linejoin', toolSvg.getAttribute('stroke-linejoin'));
                                }
                            }
                            
                            // Update tooltip to show selected tool name
                            const toolTooltip = this.getAttribute('data-tooltip');
                            if (toolTooltip) {
                                groupButton.setAttribute('data-tooltip', toolTooltip);
                            }
                            
                            // Mark the group button as active too
                            groupButton.classList.add('active');
                        }
                    }
                    
                    // Actually activate the drawing tool (only if not deselecting)
                    if (!isDeselecting && toolName) {
                        isActivatingTool = true; // Set flag before activation
                        const activateTool = () => {
                            const chart = window.chart || window.mainChart;
                            if (chart && chart.drawingManager) {
                                chart.drawingManager.setTool(toolName);
                                console.log(' Activated tool:', toolName);
                                // Clear flag after activation
                                setTimeout(() => {
                                    isActivatingTool = false;
                                }, 100);
                            } else {
                                console.warn(' Chart not ready, retrying in 100ms...');
                                setTimeout(activateTool, 100);
                            }
                        };
                        activateTool();
                    }
                    
                    setTimeout(() => {
                        document.querySelectorAll('.tool-dropdown').forEach(dd => {
                            dd.classList.remove('show');
                        });
                        document.querySelectorAll('.tool-group-btn').forEach(btn => {
                            btn.classList.remove('dropdown-open');
                        });
                        document.querySelectorAll('.cursor-dropdown-arrow, .dropdown-arrow').forEach(btn => {
                            btn.classList.remove('dropdown-open');
                        });
                        currentOpenDropdown = null;
                    }, 150);
                });
            });
            
            //  Delete toolbar button handlers 
            window.selectDeleteDrawings = function() {
                var c = window.chart || window.mainChart;
                if (c && typeof c.clearOnlyDrawings === 'function') {
                    c.clearOnlyDrawings({ confirmPrompt: false });
                } else if (c && c.drawingManager) {
                    var dm = c.drawingManager;
                    var all = (dm.drawings || []).slice();
                    all.forEach(function(d){ dm.deleteDrawing(d); });
                }
                document.querySelectorAll('.tool-dropdown').forEach(function(dd){ dd.classList.remove('show'); dd.style.display=''; });
            };
            window.selectDeleteIndicators = function() {
                var c = window.chart || window.mainChart;
                if (c && typeof c.clearOnlyIndicators === 'function') {
                    c.clearOnlyIndicators({ confirmPrompt: false });
                } else if (c && c.indicators && Array.isArray(c.indicators.active)) {
                    c.indicators.active = [];
                    if (c.render) c.render();
                }
                document.querySelectorAll('.tool-dropdown').forEach(function(dd){ dd.classList.remove('show'); dd.style.display=''; });
            };
            window.selectDeleteAllObjects = function() {
                var c = window.chart || window.mainChart;
                if (c && typeof c.clearDrawingsAndIndicators === 'function') {
                    c.clearDrawingsAndIndicators({ confirmPrompt: false });
                } else {
                    window.selectDeleteDrawings();
                    window.selectDeleteIndicators();
                }
                document.querySelectorAll('.tool-dropdown').forEach(function(dd){ dd.classList.remove('show'); dd.style.display=''; });
            };

            // Main delete toolbar button  opens the dropdown
            var deleteMainBtn = document.getElementById('deleteAllDrawingsToolbar');
            var deleteArrowBtn = document.getElementById('deleteDropdownArrowToolbar');
            if (deleteMainBtn) {
                deleteMainBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (deleteArrowBtn) deleteArrowBtn.click();
                });
            }

            // Handle cursor tool button click - reactivate last selected tool or clear
            const cursorToolBtn = document.getElementById('cursorTool');
            if (cursorToolBtn) {
                cursorToolBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // If there's a last selected drawing tool, reactivate it
                    if (this.dataset.lastSelectedDrawingTool) {
                        const lastToolName = this.dataset.lastSelectedDrawingTool;
                        
                        // Reactivate the drawing tool
                        if (typeof chart !== 'undefined' && chart.drawingManager) {
                            chart.drawingManager.setTool(lastToolName);
                        }
                        
                        // Update UI - remove active from all tools
                        document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        document.querySelectorAll('.tool-group-btn:not(#magnetMode):not(#magnetModeToolbar)').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Set cursor tool as active
                        this.classList.add('active');
                        
                        console.log(' Reactivated drawing tool:', lastToolName);
                    } else {
                        // No last tool, just clear and return to cursor mode
                        if (typeof chart !== 'undefined' && chart.drawingManager) {
                            chart.drawingManager.clearTool();
                        }
                        
                        // Update UI - remove active from all tools
                        document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        document.querySelectorAll('.tool-group-btn').forEach(btn => {
                            if (btn.id === 'magnetMode' || btn.id === 'magnetModeToolbar') return;
                            btn.classList.remove('active');
                        });
                        document.querySelectorAll('.cursor-option').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Set cursor tool as active
                        this.classList.add('active');
                        
                        console.log(' Cursor tool activated');
                    }
                });
            }
            
            // Handle brush tools in cursor dropdown - activate drawing and close dropdown
            document.querySelectorAll('#cursor-dropdown [data-drawing-tool]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const toolName = this.getAttribute('data-drawing-tool');
                    const clickedBtn = this;
                    
                    console.log(' Brush/Highlighter clicked:', toolName);
                    
                    // Activate the drawing tool FIRST
                    if (toolName && typeof chart !== 'undefined' && chart.drawingManager) {
                        console.log(' Setting drawing tool:', toolName);
                        chart.drawingManager.setTool(toolName);
                    } else {
                        console.warn(' Chart not ready, trying again in 100ms');
                        setTimeout(() => {
                            if (typeof chart !== 'undefined' && chart.drawingManager) {
                                chart.drawingManager.setTool(toolName);
                            }
                        }, 100);
                    }
                    
                    // Remove selected from all cursor-option items
                    document.querySelectorAll('#cursor-dropdown .cursor-option').forEach(b => {
                        b.classList.remove('active');
                        b.classList.remove('selected');
                    });
                    
                    // Mark this one as selected
                    clickedBtn.classList.add('selected');
                    
                    // Update UI
                    if (typeof chart !== 'undefined' && chart.drawingManager) {
                        
                        // Store the last selected drawing tool in cursor button
                        const cursorBtn = document.getElementById('cursorTool');
                        if (cursorBtn) {
                            cursorBtn.dataset.lastSelectedDrawingTool = toolName;
                            
                            // Update cursor button icon to show the selected tool
                            const toolIcon = clickedBtn.querySelector('svg');
                            const cursorIcon = cursorBtn.querySelector('svg');
                            if (toolIcon && cursorIcon) {
                                cursorIcon.innerHTML = toolIcon.innerHTML;
                                cursorIcon.setAttribute('viewBox', toolIcon.getAttribute('viewBox') || '0 0 24 24');
                                cursorIcon.setAttribute('stroke-width', toolIcon.getAttribute('stroke-width') || '1.5');
                            }
                            
                            // Update active state on toolbar
                            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                            document.querySelectorAll('.tool-group-btn:not(#magnetMode):not(#magnetModeToolbar)').forEach(b => b.classList.remove('active'));
                            cursorBtn.classList.add('active');
                        }
                    }
                    
                    // Close the cursor dropdown
                    setTimeout(() => {
                        const cursorDropdown = document.getElementById('cursor-dropdown');
                        if (cursorDropdown) {
                            cursorDropdown.classList.remove('show');
                        }
                        document.querySelectorAll('.tool-group-btn').forEach(b => {
                            b.classList.remove('dropdown-open');
                        });
                        document.querySelectorAll('.cursor-dropdown-arrow').forEach(btn => {
                            btn.classList.remove('dropdown-open');
                        });
                        currentOpenDropdown = null;
                    }, 150);
                });
            });
            
            console.log(' Trading Chart Pro - Drawing Tools Loaded');
            console.log('');
            console.log(' Drawing Tools (Grouped):');
            console.log('   Lines (4): Trendline, Horizontal, Vertical, Ray');
            console.log('   Shapes (5): Rectangle, Ellipse, Triangle, Arrow, Label');
            console.log('   Text (2): Text, Note Box');
            console.log('   Fibonacci (2): Retracement, Extension');
            console.log('   Measurement (2): Ruler, Risk-Reward');
            console.log('   Freeform (2): Path/Pen, Brush');
            console.log('');
            console.log(' Keyboard Shortcuts:');
            console.log('  Esc - Cursor tool / Cancel drawing');
            console.log('  T - Trend line');
            console.log('  H - Horizontal line');
            console.log('  V - Vertical line');
            console.log('  R - Rectangle');
            console.log('  F - Fibonacci Retracement');
            console.log('  M - Toggle magnet mode (snap to OHLC)');
            console.log('  Delete - Delete selected drawing');
            console.log('');
            console.log(' Click group icons to expand tool options!');
            
            // Initialize Panel Manager
            const panelsContainer = document.getElementById('panels-container');
            console.log(' Panels container found:', !!panelsContainer);
            console.log(' PanelManager class available:', typeof PanelManager !== 'undefined');
            
            if (panelsContainer && typeof PanelManager !== 'undefined') {
                try {
                    window.panelManager = new PanelManager(panelsContainer);
                    console.log(' Panel Manager initialized successfully');
                    console.log('   Current layout:', window.panelManager.getCurrentLayout());
                    
                    // Setup settings button to open chart settings menu
                    const settingsBtn = document.getElementById('syncPanelSettingsBtn');
                    if (settingsBtn) {
                        settingsBtn.addEventListener('click', () => {
                            if (typeof chart !== 'undefined' && chart.showSettingsMenu) {
                                chart.showSettingsMenu(0, 0);
                            }
                        });
                    }
                    
                    // Listen for panel creation to render charts
                    window.addEventListener('panelsCreated', (event) => {
                        console.log(' Panels created!', event.detail.panels.length, 'panels');
                        console.log('   Layout:', event.detail.layout);
                        const panels = event.detail.panels;
                        
                        // Check visibility
                        console.log('   Panels container display:', panelsContainer.style.display);
                        console.log('   Chart wrapper display:', document.getElementById('chartWrapper')?.style.display);
                        
                        // Wait a bit for panels to be fully sized, then render charts
                        setTimeout(() => {
                            console.log(' Checking for chart data...');
                            console.log('   Chart object exists:', typeof chart !== 'undefined');
                            console.log('   Chart has data:', typeof chart !== 'undefined' && chart.data ? chart.data.length : 0);
                            
                            if (typeof chart !== 'undefined' && chart.data && chart.data.length > 0) {
                                console.log(' Initializing Chart instances in panels...');
                                panels.forEach((panel, idx) => {
                                    console.log(`   Creating chart for panel ${idx}...`);
                                    initPanelChart(panel);
                                });
                            } else {
                                console.log(' Panels ready - upload CSV to see charts');
                                console.log('   Panels are visible with placeholders');
                            }
                        }, 200);
                        
                        // Intercept timeframe button clicks
                        setupTimeframeInterception();
                    });
                    
                    // Listen for panel selection - clear ALL drawing tools when switching panels
                    window.addEventListener('panelSelected', (event) => {
                        console.log(' Panel selected:', event.detail.panelIndex);
                        
                        // Clear drawing tool from ALL charts when switching panels
                        // This ensures one-shot drawing: select tool, draw once, done
                        
                        // Clear main chart
                        if (window.chart && window.chart.drawingManager && window.chart.drawingManager.currentTool) {
                            window.chart.drawingManager.clearTool();
                        }
                        
                        // Clear all panel charts
                        if (window.panelManager && window.panelManager.panels) {
                            window.panelManager.panels.forEach(panel => {
                                if (panel.chartInstance && panel.chartInstance.drawingManager && panel.chartInstance.drawingManager.currentTool) {
                                    panel.chartInstance.drawingManager.clearTool();
                                }
                            });
                        }
                        
                        // Update toolbar UI to show cursor as active
                        document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(btn => btn.classList.remove('active'));
                        const cursorBtn = document.getElementById('cursorTool');
                        if (cursorBtn) cursorBtn.classList.add('active');
                        
                        // Update timeframe bar to show selected panel's timeframe
                        const panelTimeframe = event.detail.timeframe;
                        if (panelTimeframe) {
                            // Remove active from all timeframe buttons
                            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
                            
                            // Find and activate the matching timeframe button
                            const matchingBtn = document.querySelector(`.timeframe-btn[data-timeframe="${panelTimeframe}"]`);
                            if (matchingBtn) {
                                matchingBtn.classList.add('active');
                                console.log(` Timeframe bar updated to: ${panelTimeframe}`);
                            }
                        }
                    });
                    
                    // Listen for return to single panel mode to clear drawing tools
                    window.addEventListener('returnedToSinglePanel', (event) => {
                        console.log(' Returned to single panel mode');
                        
                        // Clear any active drawing tool
                        if (typeof chart !== 'undefined' && chart.drawingManager) {
                            if (chart.drawingManager.currentTool) {
                                console.log(' Clearing drawing tool:', chart.drawingManager.currentTool);
                                chart.drawingManager.clearTool();
                                
                                // Update toolbar UI to show cursor as active
                                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                                const cursorBtn = document.getElementById('cursorTool');
                                if (cursorBtn) cursorBtn.classList.add('active');
                            }
                        }
                    });
                } catch (err) {
                    console.error(' Error initializing Panel Manager:', err);
                }
            } else {
                console.error(' Cannot initialize Panel Manager:');
                if (!panelsContainer) console.error('   - Panels container not found');
                if (typeof PanelManager === 'undefined') console.error('   - PanelManager class not loaded');
            }
            
            // Global window resize handler for all panel charts
            window.addEventListener('resize', () => {
                if (window.panelManager && window.panelManager.panels) {
                    window.panelManager.panels.forEach(panel => {
                        if (panel.chartInstance && panel.chartInstance.resize) {
                            panel.chartInstance.resize();
                            panel.chartInstance.render();
                        }
                    });
                }
            });
            
            // Setup timeframe button interception for panels
            let timeframeInterceptionActive = false;
            function setupTimeframeInterception() {
                if (timeframeInterceptionActive) return;
                timeframeInterceptionActive = true;
                
                const timeframeButtons = document.querySelectorAll('.timeframe-btn');
                console.log(' Intercepting', timeframeButtons.length, 'timeframe buttons');
                
                timeframeButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Check if we're in multi-panel mode
                        if (window.panelManager && window.panelManager.getCurrentLayout() !== '1') {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            
                            const timeframe = btn.dataset.timeframe;
                            console.log(` Timeframe ${timeframe}  Update selected panel`);
                            
                            // Update the selected panel's timeframe
                            window.panelManager.updateSelectedPanelTimeframe(timeframe);
                            
                            return false;
                        }
                        // In single panel mode, let normal behavior happen
                    }, true); // Use capture phase to intercept early
                });
            }
            
            // Global crosshair sync control (enabled by default)
            window.crosshairSyncEnabled = true;
            
            // Function to toggle crosshair sync across all panels
            window.toggleCrosshairSync = function() {
                window.crosshairSyncEnabled = !window.crosshairSyncEnabled;
                
                // Update all chart instances
                if (typeof chart !== 'undefined') {
                    chart.syncCrosshair = window.crosshairSyncEnabled;
                }
                if (window.panelManager && window.panelManager.panels) {
                    window.panelManager.panels.forEach(panel => {
                        if (panel.chartInstance) {
                            panel.chartInstance.syncCrosshair = window.crosshairSyncEnabled;
                        }
                    });
                }
                
                console.log(` Crosshair sync ${window.crosshairSyncEnabled ? 'enabled' : 'disabled'}`);
                return window.crosshairSyncEnabled;
            };
            
            // Function to sync settings from main chart to all panels
            function syncAllPanelSettings() {
                if (typeof chart === 'undefined') {
                    console.log(' Cannot sync: No main chart');
                    return;
                }
                
                // Check if we're in multi-panel mode
                if (!window.panelManager || window.panelManager.getCurrentLayout() === '1') {
                    console.log(' In single panel mode - refreshing main chart');
                    if (chart.render) {
                        chart.render();
                        if (chart.showNotification) {
                            chart.showNotification(' Chart refreshed');
                        }
                    }
                    return;
                }
                
                const panels = window.panelManager.getPanels();
                if (!panels || panels.length === 0) {
                    console.log(' No panels to sync');
                    return;
                }
                
                console.log(` Syncing settings from main chart to ${panels.length} panels...`);
                
                let syncedCount = 0;
                panels.forEach((panel, idx) => {
                    if (!panel.chartInstance) {
                        console.log(`    Panel ${idx} has no chart instance`);
                        return;
                    }
                    
                    // Copy settings
                    if (chart.chartSettings) {
                        panel.chartInstance.chartSettings = JSON.parse(JSON.stringify(chart.chartSettings));
                        
                        // Apply background color immediately
                        if (panel.chartInstance.canvas) {
                            panel.chartInstance.canvas.style.backgroundColor = chart.chartSettings.backgroundColor;
                        }
                        
                        console.log(`    Settings synced to panel ${idx}`);
                        syncedCount++;
                    }
                    
                    // Re-render the panel
                    panel.chartInstance.render();
                });
                
                console.log(` Settings synced to ${syncedCount} panels`);
                
                // Show notification
                if (chart.showNotification) {
                    chart.showNotification(` Settings applied to ${syncedCount} panel${syncedCount !== 1 ? 's' : ''}`);
                }
            }
            
            // Make it globally available
            window.syncAllPanelSettings = syncAllPanelSettings;
            
            // Function to create/initialize chart in a panel
            function initPanelChart(panel) {
                // Skip main chart (Panel 0) - it already exists
                if (panel.isMainChart) {
                    console.log(`Panel 0 is main chart - already initialized`);
                    return panel.chartInstance;
                }
                
                if (!panel.canvas || !panel.svg) {
                    console.error(`Panel ${panel.index} missing canvas or SVG`);
                    return;
                }
                
                // Check if panel already has a chart instance
                if (panel.chartInstance) {
                    console.log(`Panel ${panel.index} already has chart instance`);
                    return panel.chartInstance;
                }
                
                try {
                    console.log(` Creating Chart instance for panel ${panel.index}...`);
                    
                    // Hide placeholder
                    if (panel.placeholder) {
                        panel.placeholder.style.display = 'none';
                    }
                    
                    // Create Chart instance for this panel
                    const panelChart = new Chart(panel.canvas, panel.svg);
                    
                    // Store panel reference for synchronization
                    panelChart.panel = panel;
                    panelChart.panelIndex = panel.index;
                    panelChart.isPanel = true;
                    
                    // Enable crosshair sync for panels
                    panelChart.syncCrosshair = true;
                    
                    // Set panel timeframe
                    if (panel.timeframe) {
                        panelChart.currentTimeframe = panel.timeframe;
                    }
                    
                    // Copy settings and data from main chart
                    if (typeof chart !== 'undefined') {
                        // Copy chart appearance settings
                        if (chart.chartSettings) {
                            panelChart.chartSettings = JSON.parse(JSON.stringify(chart.chartSettings));
                            console.log(`    Copied chart settings to panel ${panel.index}`);
                            
                            // Apply background color immediately
                            if (panelChart.canvas) {
                                panelChart.canvas.style.backgroundColor = panelChart.chartSettings.backgroundColor;
                                console.log(`    Applied background: ${panelChart.chartSettings.backgroundColor}`);
                            }
                        }
                        
                        // Sync cursor type from main chart
                        if (chart.cursorType) {
                            panelChart.setCursorType(chart.cursorType, true); // skipSync to avoid loop
                            console.log(`    Synced cursor type: ${chart.cursorType}`);
                        }
                        
                        // Link to main chart's replay and order systems
                        if (chart.replaySystem) {
                            panelChart.replaySystem = chart.replaySystem;
                            console.log(`    Linked to main chart's replay system`);
                        }
                        if (chart.orderManager) {
                            panelChart.orderManager = chart.orderManager;
                            console.log(`    Linked to main chart's order manager`);
                        }
                        
                        // Copy data if available
                        if (chart.rawData && chart.rawData.length > 0) {
                            panelChart.rawData = chart.rawData;
                            panelChart.data = panelChart.resampleData(chart.rawData, panel.timeframe || '1m');
                            panelChart.currentSymbol = chart.currentSymbol;
                            panelChart.totalCandles = chart.totalCandles;
                            
                            console.log(` Panel ${panel.index} initialized with ${panelChart.data.length} candles`);
                        } else {
                            console.log(` Panel ${panel.index} initialized without data`);
                        }
                    }
                    
                    // Render the chart (even if no data, to show background)
                    panelChart.fitToView();
                    panelChart.render();
                    
                    // Update the OHLC symbol and timeframe display for this panel
                    if (panelChart.currentSymbol) {
                        panelChart.updateChartOHLCSymbol(panelChart.currentSymbol);
                    }
                    
                    // Initialize drawing manager for this panel
                    if (typeof DrawingToolsManager !== 'undefined' && panel.svg && typeof d3 !== 'undefined') {
                        // Set the SVG as a D3 selection on the chart (required by DrawingToolsManager)
                        panelChart.svg = d3.select(panel.svg);
                        panelChart.drawingManager = new DrawingToolsManager(panelChart);
                        console.log(` Drawing manager initialized for panel ${panel.index}`);
                    } else {
                        console.warn(` Could not init drawing manager for panel ${panel.index}: DrawingToolsManager=${typeof DrawingToolsManager}, svg=${!!panel.svg}, d3=${typeof d3}`);
                    }
                    
                    // Store chart instance in panel
                    panel.chartInstance = panelChart;
                    
                    // Inherit cursor type and crosshair sync from main chart
                    if (window.chart) {
                        panelChart.cursorType = window.chart.cursorType || 'cross';
                        panelChart.showCrosshairLines = window.chart.showCrosshairLines !== false;
                        panelChart.syncCrosshair = window.chart.syncCrosshair !== false;
                        panelChart.syncDrawings = window.chart.syncDrawings !== false;
                        
                        // Apply cursor type to canvas
                        if (panelChart.setCursorType) {
                            panelChart.setCursorType(panelChart.cursorType, true); // skipSync to prevent loop
                        }
                    }
                    
                    // Load saved panel-specific settings
                    if (window.panelManager && window.panelManager.loadPanelSettings) {
                        window.panelManager.loadPanelSettings(panel.index);
                    }
                    
                    // Add resize observer for this panel's container
                    if (typeof ResizeObserver !== 'undefined' && panel.chartContainer) {
                        const resizeObserver = new ResizeObserver((entries) => {
                            for (const entry of entries) {
                                if (panelChart && panelChart.resize) {
                                    panelChart.resize();
                                    panelChart.render();
                                }
                            }
                        });
                        resizeObserver.observe(panel.chartContainer);
                        panel.resizeObserver = resizeObserver; // Store for cleanup
                        console.log(` Resize observer added for panel ${panel.index}`);
                    }
                    
                    return panelChart;
                    
                } catch (err) {
                    console.error(`Error creating chart for panel ${panel.index}:`, err);
                    return null;
                }
            }
            
            // Legacy function for compatibility - now just calls initPanelChart
            function renderPanelChart(panel, sourceData) {
                if (!panel.chartInstance) {
                    initPanelChart(panel);
                }
                
                // Update data and settings if provided
                if (sourceData && panel.chartInstance) {
                    // Copy latest settings from main chart
                    if (typeof chart !== 'undefined' && chart.chartSettings) {
                        panel.chartInstance.chartSettings = JSON.parse(JSON.stringify(chart.chartSettings));
                        
                        // Apply background color
                        if (panel.chartInstance.canvas) {
                            panel.chartInstance.canvas.style.backgroundColor = panel.chartInstance.chartSettings.backgroundColor;
                        }
                    }
                    
                    // Copy symbol from main chart
                    if (typeof chart !== 'undefined' && chart.currentSymbol) {
                        panel.chartInstance.currentSymbol = chart.currentSymbol;
                    }
                    
                    panel.chartInstance.rawData = chart.rawData || [];
                    panel.chartInstance.data = panel.chartInstance.resampleData(
                        panel.chartInstance.rawData, 
                        panel.timeframe || '1m'
                    );
                    panel.chartInstance.fitToView();
                    panel.chartInstance.render();
                    
                    // Update OHLC panel with symbol and timeframe
                    if (panel.chartInstance.currentSymbol) {
                        panel.chartInstance.updateChartOHLCSymbol(panel.chartInstance.currentSymbol);
                    }
                }
                
            }
            
            // Panel interactions are handled by Chart instances
            // (no longer needed - Chart instances handle everything)
            
            // ===== DRAWING SYNCHRONIZATION SYSTEM =====
            // Sync drawings across panels with the same timeframe
            
            window.panelDrawingSync = {
                enabled: true,
                
                // Sync a drawing to all panels with same timeframe
                syncDrawing(sourcePanel, drawing, action = 'add') {
                    console.log(` syncDrawing called:`, {
                        enabled: this.enabled,
                        hasManager: !!window.panelManager,
                        sourcePanel: sourcePanel.index,
                        sourceTimeframe: sourcePanel.timeframe,
                        action: action
                    });
                    
                    if (!this.enabled || !window.panelManager) {
                        console.log(' Sync disabled or no panel manager');
                        return;
                    }
                    
                    const panels = window.panelManager.getPanels();
                    const sourceTimeframe = sourcePanel.timeframe;
                    
                    console.log(` Syncing drawing (${action}) from panel ${sourcePanel.index} [${sourceTimeframe}]`);
                    console.log(`   Total panels: ${panels.length}`);
                    
                    panels.forEach(targetPanel => {
                        console.log(`   Checking panel ${targetPanel.index}: timeframe=${targetPanel.timeframe}, hasInstance=${!!targetPanel.chartInstance}`);
                        
                        // Skip source panel and panels with different timeframes
                        if (targetPanel.index === sourcePanel.index) {
                            console.log(`    Skipping source panel ${targetPanel.index}`);
                            return;
                        }
                        if (targetPanel.timeframe !== sourceTimeframe) {
                            console.log(`    Skipping panel ${targetPanel.index} - different timeframe (${targetPanel.timeframe} vs ${sourceTimeframe})`);
                            return;
                        }
                        if (!targetPanel.chartInstance) {
                            console.log(`    Panel ${targetPanel.index} has no chart instance`);
                            return;
                        }
                        
                        console.log(`    Syncing to panel ${targetPanel.index} [${targetPanel.timeframe}]`);
                        
                        if (action === 'add' || action === 'update') {
                            // Clone the drawing
                            const clonedDrawing = JSON.parse(JSON.stringify(drawing));
                            
                            // Check if drawing already exists (by comparing points)
                            const existingIdx = targetPanel.chartInstance.drawings.findIndex(d => 
                                this.isSameDrawing(d, drawing)
                            );
                            
                            if (existingIdx >= 0) {
                                // Update existing
                                targetPanel.chartInstance.drawings[existingIdx] = clonedDrawing;
                            } else {
                                // Add new
                                targetPanel.chartInstance.drawings.push(clonedDrawing);
                            }
                        } else if (action === 'delete') {
                            // Find and remove matching drawing
                            const idx = targetPanel.chartInstance.drawings.findIndex(d => 
                                this.isSameDrawing(d, drawing)
                            );
                            if (idx >= 0) {
                                targetPanel.chartInstance.drawings.splice(idx, 1);
                            }
                        }
                        
                        // Re-render target panel
                        targetPanel.chartInstance.render();
                    });
                },
                
                // Check if two drawings are the same (compare key properties)
                isSameDrawing(d1, d2) {
                    if (d1.type !== d2.type) return false;
                    
                    // Compare timestamps (drawings created at same time are likely the same)
                    if (d1.x1 === d2.x1 && d1.y1 === d2.y1) {
                        if (d1.x2 === d2.x2 && d1.y2 === d2.y2) {
                            return true;
                        }
                    }
                    
                    return false;
                },
                
                // Sync all drawings from source to targets with same timeframe
                syncAllDrawings(sourcePanel) {
                    if (!this.enabled || !window.panelManager) return;
                    
                    const panels = window.panelManager.getPanels();
                    const sourceTimeframe = sourcePanel.timeframe;
                    const sourceDrawings = sourcePanel.chartInstance?.drawings || [];
                    
                    console.log(` Syncing ALL drawings from panel ${sourcePanel.index} [${sourceTimeframe}]`);
                    
                    panels.forEach(targetPanel => {
                        if (targetPanel.index === sourcePanel.index) return;
                        if (targetPanel.timeframe !== sourceTimeframe) return;
                        if (!targetPanel.chartInstance) return;
                        
                        // Replace all drawings
                        targetPanel.chartInstance.drawings = JSON.parse(JSON.stringify(sourceDrawings));
                        targetPanel.chartInstance.render();
                        
                        console.log(`    Synced ${sourceDrawings.length} drawings to panel ${targetPanel.index}`);
                    });
                }
            };
            
            // Make functions available globally
            window.renderPanelChart = renderPanelChart;
            window.initPanelChart = initPanelChart;
            
            // Listen for panel timeframe changes
            window.addEventListener('panelTimeframeChanged', (event) => {
                const { panelIndex, timeframe, panel } = event.detail;
                console.log(` Panel ${panelIndex} timeframe changed to: ${timeframe}`);
                
                // Update the panel's chart instance timeframe
                if (panel && panel.chartInstance) {
                    panel.chartInstance.setTimeframe(timeframe);
                    console.log(` Panel ${panelIndex} updated to ${timeframe}`);
                    
                    // Sync interval to other panels if enabled
                    if (window.panelManager && window.panelManager.syncSettings.interval) {
                        window.panelManager.syncInterval(panel, timeframe);
                    }
                } else if (window.panelManager) {
                    const panels = window.panelManager.getPanels();
                    const targetPanel = panels[panelIndex];
                    if (targetPanel && targetPanel.chartInstance) {
                        targetPanel.chartInstance.setTimeframe(timeframe);
                        console.log(` Panel ${panelIndex} updated to ${timeframe}`);
                        
                        // Sync interval to other panels if enabled
                        if (window.panelManager.syncSettings.interval) {
                            window.panelManager.syncInterval(targetPanel, timeframe);
                        }
                    }
                }
            });
            
            // Listen for data loaded event to render panels
            window.addEventListener('chartDataLoaded', (event) => {
                console.log(' Chart data loaded event received');
                
                // Check if we're in panel mode
                if (window.panelManager && window.panelManager.getCurrentLayout() !== '1') {
                    const panels = window.panelManager.getPanels();
                    if (panels && panels.length > 0) {
                        console.log(` Updating ${panels.length} panel charts with new data...`);
                        panels.forEach((panel, idx) => {
                            if (!panel.chartInstance) {
                                // Create chart instance if it doesn't exist
                                initPanelChart(panel);
                            } else {
                                // Update existing chart with new data
                                renderPanelChart(panel, event.detail.data);
                            }
                        });
                        console.log(' All panels updated with new data');
                    }
                }
            });
            
            // Listen for chart scroll/zoom events for panel sync
            window.addEventListener('chartScrolled', (event) => {
                const { panel, offsetX, candleWidth } = event.detail;
                
                if (!window.panelManager || window.panelManager.getCurrentLayout() === '1') return;
                if (!panel) return;
                
                if (window.panelManager.syncSettings.time || window.panelManager.syncSettings.dateRange) {
                    window.panelManager.syncScroll(panel, offsetX, candleWidth);
                }
            });
            
            // Listen for file/symbol changes for symbol sync
            window.addEventListener('chartFileLoaded', (event) => {
                const { fileId, filename, panel } = event.detail || {};
                
                if (!window.panelManager || window.panelManager.getCurrentLayout() === '1') return;
                if (!panel) return;
                
                // Symbol sync
                if (window.panelManager.syncSettings.symbol) {
                    const symbol = filename ? filename.replace(/\.csv$/i, '') : fileId;
                    window.panelManager.syncSymbol(panel, symbol, fileId);
                }
            });
            
            // ===== INDICATORS BUTTON =====
            // Note: Indicator button event listener is handled by indicator-ui.js setupIndicatorUI()
            // The showIndicatorsMenu() function below is kept for reference but not actively used
            
            // Function to show indicators menu
            // TradingView Style Indicators Menu
// Replace the showIndicatorsMenu function in your HTML file with this:

function showIndicatorsMenu() {
    console.log(' showIndicatorsMenu called');
    
    // Determine target chart based on panel layout
    let targetChart;
    
    // Check if we're in multi-panel mode
    if (window.panelManager && window.panelManager.currentLayout !== '1') {
        // Get the selected panel
        const selectedPanel = window.panelManager.getSelectedPanel();
        
        if (selectedPanel && selectedPanel.chartInstance) {
            targetChart = selectedPanel.chartInstance;
            console.log(` Using Panel ${selectedPanel.index + 1} chart instance`);
        } else {
            // Fall back to main chart if no panel is selected
            targetChart = window.mainChart || window.chart;
            console.log(' No panel selected, using main chart');
        }
    } else {
        // Single panel mode - use main chart
        targetChart = window.mainChart || window.chart;
        console.log(' Single panel mode - using main chart');
    }
    
    if (!targetChart) {
        alert('Chart is still initializing. Please try again in a moment.');
        return;
    }
    if (!targetChart.data || targetChart.data.length === 0) {
        alert('Please load chart data before adding indicators.');
        return;
    }
    
    // Create overlay backdrop
    const backdrop = document.createElement('div');
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9999;
        backdrop-filter: blur(2px);
    `;
    
    // Create menu container
    const menu = document.createElement('div');
    menu.className = 'indicators-menu-container';
    
    // Check if dark mode is active
    const isDarkMode = !document.body.classList.contains('light-mode');
    
    menu.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${isDarkMode ? '#000000' : '#ffffff'};
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, ${isDarkMode ? '0.5' : '0.3'});
        z-index: 10000;
        width: 480px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    `;
    
    // Determine which panel is being targeted
    let panelInfo = '';
    if (window.panelManager && window.panelManager.currentLayout !== '1') {
        const selectedPanel = window.panelManager.getSelectedPanel();
        if (selectedPanel) {
            panelInfo = `<span style="font-size: 12px; color: #2962ff; margin-left: 8px;">Panel ${selectedPanel.index + 1} (${selectedPanel.timeframe || '1m'})</span>`;
        }
    }
    
    menu.innerHTML = `
        <!-- Header -->
        <div class="indicator-header" style="padding: 16px 20px; border-bottom: 1px solid ${isDarkMode ? '#363a45' : '#e0e3eb'}; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: ${isDarkMode ? '#ffffff' : '#050028'};">Indicators</h3>
                ${panelInfo}
            </div>
            <button id="closeIndicatorsMenu" style="background: none; border: none; cursor: default; padding: 4px; display: flex; align-items: center; color: #787b86; transition: color 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <!-- Search Bar -->
        <div class="indicator-search" style="padding: 12px 20px; border-bottom: 1px solid ${isDarkMode ? '#363a45' : '#e0e3eb'};">
            <div style="position: relative;">
                <input 
                    type="text" 
                    id="indicatorSearch" 
                    placeholder="Search indicators..."
                    style="
                        width: 100%;
                        padding: 8px 12px 8px 36px;
                        border: 1px solid ${isDarkMode ? '#363a45' : '#e0e3eb'};
                        border-radius: 6px;
                        font-size: 14px;
                        color: ${isDarkMode ? '#ffffff' : '#050028'};
                        background: ${isDarkMode ? '#2a2e39' : '#f8f9fd'};
                        outline: none;
                        transition: all 0.2s;
                        box-sizing: border-box;
                    "
                >
                <svg style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); default-events: none;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
        </div>
        
        <!-- Indicators List -->
        <div class="indicator-list" style="flex: 1; overflow-y: auto; padding: 8px 0;">
            <!-- Moving Averages -->
            <div class="indicator-category">
                <div style="padding: 8px 20px; font-size: 11px; font-weight: 600; color: #787b86; text-transform: uppercase; letter-spacing: 0.5px;">
                    Moving Averages
                </div>
                <button class="indicator-item" data-type="sma">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #e3effd; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2962ff" stroke-width="1">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Simple Moving Average</div>
                            <div style="font-size: 12px; color: #787b86;">SMA</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="sma" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
                
                <button class="indicator-item" data-type="ema">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #ffebee; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f23645" stroke-width="1">
                                <path d="M3 12 Q 6 4, 12 12 T 21 12"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Exponential Moving Average</div>
                            <div style="font-size: 12px; color: #787b86;">EMA</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="ema" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
                
                <button class="indicator-item" data-type="wma">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #fff3e0; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="1">
                                <path d="M2 18 L6 12 L10 16 L14 8 L18 14 L22 10"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Weighted Moving Average</div>
                            <div style="font-size: 12px; color: #787b86;">WMA</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="wma" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>

                
            </div>
            
            <!-- Volatility -->
            <div class="indicator-category">
                <div style="padding: 8px 20px; font-size: 11px; font-weight: 600; color: #787b86; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px;">
                    Volatility
                </div>
                <button class="indicator-item" data-type="bb">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #e0f2f1; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#089981" stroke-width="1">
                                <path d="M2 20 Q 6 4, 12 12 T 22 4" opacity="0.5"/>
                                <path d="M2 12 Q 6 8, 12 12 T 22 12"/>
                                <path d="M2 4 Q 6 20, 12 12 T 22 20" opacity="0.5"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Bollinger Bands</div>
                            <div style="font-size: 12px; color: #787b86;">BB</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="bb" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
            </div>
            
            <!-- Volume -->
            <div class="indicator-category">
                <div style="padding: 8px 20px; font-size: 11px; font-weight: 600; color: #787b86; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px;">
                    Volume
                </div>
                <button class="indicator-item" data-type="vwap">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #f3e5f5; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9c27b0" stroke-width="1">
                                <rect x="3" y="10" width="4" height="11"/>
                                <rect x="10" y="7" width="4" height="14"/>
                                <rect x="17" y="3" width="4" height="18"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Volume Weighted Average Price</div>
                            <div style="font-size: 12px; color: #787b86;">VWAP</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="vwap" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
            </div>
            
            <!-- Oscillators -->
            <div class="indicator-category">
                <div style="padding: 8px 20px; font-size: 11px; font-weight: 600; color: #787b86; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px;">
                    Oscillators
                </div>
                <button class="indicator-item" data-type="rsi">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #f3e5f5; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9c27b0" stroke-width="1">
                                <path d="M3 12h4l3 8 4-16 3 8h4"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Relative Strength Index</div>
                            <div style="font-size: 12px; color: #787b86;">RSI</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="rsi" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
                
                <button class="indicator-item" data-type="macd">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #fff3e0; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff6f00" stroke-width="1">
                                <rect x="3" y="14" width="3" height="7"/>
                                <rect x="7" y="10" width="3" height="11"/>
                                <rect x="11" y="12" width="3" height="9"/>
                                <rect x="15" y="8" width="3" height="13"/>
                                <rect x="19" y="11" width="3" height="10"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Moving Average Convergence Divergence</div>
                            <div style="font-size: 12px; color: #787b86;">MACD</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="macd" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
                
                <button class="indicator-item" data-type="stochastic">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="width: 32px; height: 32px; background: #e0f7fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00acc1" stroke-width="1">
                                <path d="M2 12 Q 6 4, 12 12 T 22 12"/>
                                <path d="M2 14 Q 6 8, 12 14 T 22 14" opacity="0.5"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #050028;">Stochastic Oscillator</div>
                            <div style="font-size: 12px; color: #787b86;">Stochastic</div>
                        </div>
                    </div>
                    <div class="indicator-item-actions">
                        <span class="indicator-settings-trigger" data-type="stochastic" title="Configure">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 4.6V4a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#787b86" stroke-width="1">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
        <div class="indicator-settings-panel" style="display:none; flex: 1; overflow-y: auto; padding: 20px;"></div>
    `;
    
    document.body.appendChild(backdrop);
    document.body.appendChild(menu);
    
    // Add CSS styles for items
    const style = document.createElement('style');
    style.textContent = `
        .indicator-item {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: default;
            transition: background 0.15s;
            border-left: 3px solid transparent;
        }
        .indicator-item:hover {
            background: #f8f9fd;
            border-left-color: #2962ff;
        }
        .indicator-item:active {
            background: #e3effd;
        }
        .indicator-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .indicator-settings-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .indicator-settings-trigger:hover {
            background: rgba(41, 98, 255, 0.12);
        }
        .indicator-settings-panel h4 {
            font-size: 16px;
            font-weight: 600;
            color: #050028;
            margin: 0 0 12px 0;
        }
        .indicator-settings-panel form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .indicator-settings-panel label {
            font-size: 12px;
            color: #787b86;
            display: block;
            margin-bottom: 4px;
        }
        .indicator-settings-panel input[type="number"],
        .indicator-settings-panel input[type="text"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e0e3eb;
            font-size: 13px;
            color: #050028;
        }
        .indicator-settings-panel input[type="color"] {
            width: 48px;
            height: 28px;
            padding: 0;
            border: 2px solid transparent;
            border-radius: 4px;
            background: transparent;
            cursor: default;
            transition: border-color 0.15s ease;
        }
        .indicator-settings-panel input[type="color"]:hover {
            border-color: #2962ff;
        }
        .indicator-settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .indicator-settings-actions button {
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: default;
            transition: background 0.2s;
        }
        .indicator-settings-actions .apply-btn {
            background: #2962ff;
            color: #fff;
        }
        .indicator-settings-actions .apply-btn:hover {
            background: #1e53e5;
        }
        .indicator-settings-actions .back-btn {
            background: #f0f3fa;
            color: #050028;
        }
        .indicator-settings-actions .back-btn:hover {
            background: #e0e3eb;
        }
        #indicatorSearch:focus {
            background: white;
            border-color: #2962ff;
        }
        #closeIndicatorsMenu:hover {
            color: #050028;
        }
        
        /* Dark Mode Styles for Indicator Menu */
        body:not(.light-mode) .indicators-menu-container {
            background: #050028 !important;
        }
        body:not(.light-mode) .indicators-menu-container h3 {
            color: #ffffff !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-header {
            border-color: #363a45 !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-search {
            border-color: #363a45 !important;
        }
        body:not(.light-mode) .indicators-menu-container #indicatorSearch {
            background: #2a2e39 !important;
            border-color: #363a45 !important;
            color: #ffffff !important;
        }
        body:not(.light-mode) .indicators-menu-container #indicatorSearch::placeholder {
            color: #787b86 !important;
        }
        body:not(.light-mode) .indicators-menu-container #indicatorSearch:focus {
            background: #2a2e39 !important;
            border-color: #2962ff !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-category > div:first-child {
            color: #787b86 !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-item {
            background: transparent !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-item:hover {
            background: #2a2e39 !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-item:active {
            background: #363a45 !important;
        }
        /* Target indicator item text - title */
        body:not(.light-mode) .indicators-menu-container .indicator-item div div div:first-child {
            color: #ffffff !important;
        }
        /* Target indicator item text - subtitle */
        body:not(.light-mode) .indicators-menu-container .indicator-item div div div:last-child {
            color: #787b86 !important;
        }
        body:not(.light-mode) .indicators-menu-container #closeIndicatorsMenu {
            color: #787b86 !important;
        }
        body:not(.light-mode) .indicators-menu-container #closeIndicatorsMenu:hover {
            color: #ffffff !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-settings-panel {
            border-color: #363a45 !important;
            background: #050028 !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-settings-panel h4 {
            color: #ffffff !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-settings-panel label {
            color: #787b86 !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-settings-panel input[type="number"],
        body:not(.light-mode) .indicators-menu-container .indicator-settings-panel input[type="text"] {
            background: #2a2e39 !important;
            border-color: #363a45 !important;
            color: #ffffff !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-settings-actions .back-btn {
            background: #2a2e39 !important;
            color: #ffffff !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-settings-actions .back-btn:hover {
            background: #363a45 !important;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-list {
            border-color: #363a45 !important;
        }
        /* Dark mode scrollbar for indicator list */
        body:not(.light-mode) .indicators-menu-container .indicator-list::-webkit-scrollbar {
            width: 8px;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-list::-webkit-scrollbar-track {
            background: #050028;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-list::-webkit-scrollbar-thumb {
            background: #363a45;
            border-radius: 4px;
        }
        body:not(.light-mode) .indicators-menu-container .indicator-list::-webkit-scrollbar-thumb:hover {
            background: #4a4e59;
        }
    `;
    document.head.appendChild(style);
    
    // Apply dark mode colors to indicator item text if in dark mode
    if (isDarkMode) {
        menu.querySelectorAll('.indicator-item').forEach(item => {
            // Find title and subtitle divs
            const textContainer = item.querySelector('div > div[style*="text-align: left"]');
            if (textContainer) {
                const title = textContainer.querySelector('div:first-child');
                const subtitle = textContainer.querySelector('div:last-child');
                if (title) title.style.color = '#ffffff';
                if (subtitle) subtitle.style.color = '#787b86';
            }
        });
    }
    
    // Search functionality
    const searchInput = document.getElementById('indicatorSearch');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const items = menu.querySelectorAll('.indicator-item');
        const categories = menu.querySelectorAll('.indicator-category');
        
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            const matches = text.includes(searchTerm);
            item.style.display = matches ? 'flex' : 'none';
        });
        
        // Hide empty categories
        categories.forEach(cat => {
            const visibleItems = cat.querySelectorAll('.indicator-item[style*="display: flex"], .indicator-item:not([style*="display: none"])');
            cat.style.display = visibleItems.length > 0 ? 'block' : 'none';
        });
    });
    
    const searchWrap = menu.querySelector('.indicator-search');
    const listWrap = menu.querySelector('.indicator-list');
    const settingsPanel = menu.querySelector('.indicator-settings-panel');

    const indicatorDefinitions = {
        sma: { name: 'Simple Moving Average', params: [{ id: 'period', label: 'Length', type: 'number', min: 1, default: 20 }, { id: 'color', label: 'Color', type: 'color', default: '#2962ff' }] },
        ema: { name: 'Exponential Moving Average', params: [{ id: 'period', label: 'Length', type: 'number', min: 1, default: 20 }, { id: 'color', label: 'Color', type: 'color', default: '#f23645' }] },
        wma: { name: 'Weighted Moving Average', params: [{ id: 'period', label: 'Length', type: 'number', min: 1, default: 20 }, { id: 'color', label: 'Color', type: 'color', default: '#ff9800' }] },
        bb: { name: 'Bollinger Bands', params: [
            { id: 'period', label: 'Length', type: 'number', min: 1, default: 20 },
            { id: 'stdDev', label: 'Std Dev', type: 'number', min: 0.1, step: 0.1, default: 2 },
            { id: 'upperColor', label: 'Upper Color', type: 'color', default: '#2962ff' },
            { id: 'middleColor', label: 'Middle Color', type: 'color', default: '#787b86' },
            { id: 'lowerColor', label: 'Lower Color', type: 'color', default: '#2962ff' },
            { id: 'fillColor', label: 'Fill Color (RGBA)', type: 'text', default: 'rgba(41,98,255,0.05)' }
        ] },
        vwap: { name: 'Volume Weighted Average Price', params: [{ id: 'color', label: 'Color', type: 'color', default: '#9c27b0' }] },
        rsi: { name: 'Relative Strength Index', params: [{ id: 'period', label: 'Length', type: 'number', min: 1, default: 14 }, { id: 'color', label: 'Color', type: 'color', default: '#9c27b0' }] },
        macd: { name: 'Moving Average Convergence Divergence', params: [
            { id: 'fast', label: 'Fast Length', type: 'number', min: 1, default: 12 },
            { id: 'slow', label: 'Slow Length', type: 'number', min: 1, default: 26 },
            { id: 'signal', label: 'Signal Length', type: 'number', min: 1, default: 9 },
            { id: 'macdColor', label: 'MACD Color', type: 'color', default: '#2962ff' },
            { id: 'signalColor', label: 'Signal Color', type: 'color', default: '#f23645' },
            { id: 'histogramColor', label: 'Histogram Color', type: 'color', default: '#787b86' }
        ] },
        stochastic: { name: 'Stochastic Oscillator', params: [
            { id: 'period', label: 'Length', type: 'number', min: 1, default: 14 },
            { id: 'smoothK', label: '%K Smoothing', type: 'number', min: 1, default: 3 },
            { id: 'smoothD', label: '%D Smoothing', type: 'number', min: 1, default: 3 },
            { id: 'kColor', label: '%K Color', type: 'color', default: '#2962ff' },
            { id: 'dColor', label: '%D Color', type: 'color', default: '#f23645' }
        ] }
    };

    function addIndicator(type, overrides = {}) {
        const def = indicatorDefinitions[type];
        if (!def) return;
        const params = {};
        def.params.forEach(p => {
            let value = overrides[p.id];
            if (value === undefined || value === null || value === '') value = p.default;
            if (p.type === 'number') value = parseFloat(value);
            params[p.id] = value;
        });

        if (typeof targetChart.addIndicator === 'function') {
            try {
                targetChart.addIndicator(type, params);
                
                // Show notification with panel info
                let message = ` Added ${type.toUpperCase()} indicator`;
                if (window.panelManager && window.panelManager.currentLayout !== '1') {
                    const selectedPanel = window.panelManager.getSelectedPanel();
                    if (selectedPanel) {
                        message += ` to Panel ${selectedPanel.index + 1}`;
                    }
                }
                
                console.log(message, params);
                
                // Show notification if available
                if (targetChart.showNotification) {
                    targetChart.showNotification(message);
                }
            } catch (err) {
                console.error(' Error adding indicator:', err);
                if (targetChart.showNotification) {
                    targetChart.showNotification(' Failed to add indicator');
                }
            }
        }
    }

    function showSettings(type) {
        const def = indicatorDefinitions[type];
        if (!def) return;

        searchWrap.style.display = 'none';
        listWrap.style.display = 'none';
        settingsPanel.style.display = 'block';

        const formId = `indicator-settings-${type}`;
        settingsPanel.innerHTML = `
            <h4>${def.name} Settings</h4>
            <form id="${formId}">
                ${def.params.map(p => {
                    const attrs = [];
                    if (p.min !== undefined) attrs.push(`min="${p.min}"`);
                    if (p.max !== undefined) attrs.push(`max="${p.max}"`);
                    if (p.step !== undefined) attrs.push(`step="${p.step}"`);
                    const value = p.default;
                    return `
                        <div>
                            <label for="${formId}-${p.id}">${p.label}</label>
                            <input id="${formId}-${p.id}" name="${p.id}" type="${p.type === 'text' ? 'text' : p.type}" value="${value}" ${attrs.join(' ')} />
                        </div>
                    `;
                }).join('')}
                <div class="indicator-settings-actions">
                    <button type="button" class="back-btn">Back</button>
                    <button type="submit" class="apply-btn">Add Indicator</button>
                </div>
            </form>
        `;

        const form = settingsPanel.querySelector('form');
        const backBtn = form.querySelector('.back-btn');

        backBtn.addEventListener('click', () => {
            settingsPanel.style.display = 'none';
            searchWrap.style.display = 'block';
            listWrap.style.display = 'block';
        });

        form.addEventListener('submit', evt => {
            evt.preventDefault();
            const formData = new FormData(form);
            const params = {};
            formData.forEach((value, key) => {
                const paramDef = def.params.find(p => p.id === key);
                if (!paramDef) return;
                if (paramDef.type === 'number') {
                    params[key] = parseFloat(value);
                } else {
                    params[key] = value;
                }
            });

            addIndicator(type, params);

            backdrop.remove();
            menu.remove();
            style.remove();
        });
    }

    menu.querySelectorAll('.indicator-item').forEach(btn => {
        btn.addEventListener('click', e => {
            if (e.target.closest('.indicator-settings-trigger')) return;
            addIndicator(btn.dataset.type);
            backdrop.remove();
            menu.remove();
            style.remove();
        });
    });

    menu.querySelectorAll('.indicator-settings-trigger').forEach(trigger => {
        trigger.addEventListener('click', e => {
            e.stopPropagation();
            showSettings(trigger.dataset.type);
        });
    });
    
    // Close button
    document.getElementById('closeIndicatorsMenu').addEventListener('click', () => {
        backdrop.remove();
        menu.remove();
        style.remove();
    });
    
    // Close on backdrop click
    backdrop.addEventListener('click', () => {
        backdrop.remove();
        menu.remove();
        style.remove();
    });
    
    // Auto-focus search
    setTimeout(() => searchInput.focus(), 100);
}
});
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Start with panels collapsed by default
            document.body.classList.add('replay-tabs-collapsed');
            
            const tabButtons = Array.from(document.querySelectorAll('.replay-tab-btn'));
            const tabPanels = Array.from(document.querySelectorAll('.replay-tab-panel'));
            const collapseToggle = document.getElementById('replayTabsToggle');
            const ordersBody = document.getElementById('replayOrdersBody');
            const positionsBody = document.getElementById('replayPositionsBody');
            const replayToolbar = document.getElementById('replayToolbar');
            const container = document.querySelector('.container');
            const chartWrapper = document.getElementById('chartWrapper');

            // Simple function to update container bottom based on toolbar height
            const updateContainerBottom = () => {
                if (!replayToolbar || !container) return;
                
                const toolbarHeight = replayToolbar.getBoundingClientRect().height;
                container.style.bottom = `${toolbarHeight}px`;
                
                // Single resize call after transition completes
                if (window.chart && typeof window.chart.resize === 'function') {
                    setTimeout(() => {
                        window.chart.resize();
                    }, 350);
                }
            };

            const getPanelId = (key) => {
                if (!key) return null;
                const capitalized = key.charAt(0).toUpperCase() + key.slice(1);
                return `replayTab${capitalized}`;
            };

            tabButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const targetKey = button.dataset.replayTab;
                    const targetId = getPanelId(targetKey);
                    if (!targetId) return;

                    tabButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
                    tabPanels.forEach((panel) => panel.classList.toggle('active', panel.id === targetId));
                });
            });
            
            // View All Trades button click handler
            const viewAllTradesBtn = document.getElementById('viewAllTradesBottomBtn');
            if (viewAllTradesBtn) {
                viewAllTradesBtn.addEventListener('click', () => {
                    if (window.chart && window.chart.orderManager) {
                        window.chart.orderManager.showAllTradesTable();
                    }
                });
            }
            
            // Stats Visibility Toggle (Balance, Equity, P&L)
            const statsToggleBtn = document.getElementById('toggleStatsVisibility');
            const balanceValue = document.getElementById('replayBalance');
            const equityValue = document.getElementById('replayEquity');
            const pnlValue = document.getElementById('replayPnL');
            let statsHidden = false;
            let actualValues = { balance: '10,000', equity: '10,000', pnl: '0' };
            
            if (statsToggleBtn) {
                statsToggleBtn.addEventListener('click', () => {
                    statsHidden = !statsHidden;
                    statsToggleBtn.classList.toggle('hidden', statsHidden);
                    
                    if (statsHidden) {
                        if (balanceValue) {
                            actualValues.balance = balanceValue.textContent;
                            balanceValue.textContent = '****';
                        }
                        if (equityValue) {
                            actualValues.equity = equityValue.textContent;
                            equityValue.textContent = '****';
                        }
                        if (pnlValue) {
                            actualValues.pnl = pnlValue.textContent;
                            pnlValue.textContent = '****';
                        }
                    } else {
                        if (balanceValue) balanceValue.textContent = actualValues.balance;
                        if (equityValue) equityValue.textContent = actualValues.equity;
                        if (pnlValue) pnlValue.textContent = actualValues.pnl;
                    }
                });
            }
            
            // Sync account stats from order manager
            const syncAccountStats = () => {
                if (!window.chart || !window.chart.orderManager) return;
                if (statsHidden) return; // Don't update if hidden
                
                const om = window.chart.orderManager;
                const balanceEl = document.getElementById('replayBalance');
                const equityEl = document.getElementById('replayEquity');
                const pnlEl = document.getElementById('replayPnL');
                
                if (balanceEl && om.balance !== undefined) {
                    actualValues.balance = om.balance.toLocaleString();
                    balanceEl.textContent = actualValues.balance;
                }
                
                if (equityEl) {
                    const equity = om.balance + (om.unrealizedPnL || 0);
                    actualValues.equity = equity.toLocaleString();
                    equityEl.textContent = actualValues.equity;
                }
                
                if (pnlEl) {
                    const pnl = om.realizedPnL || 0;
                    actualValues.pnl = pnl.toLocaleString();
                    pnlEl.textContent = actualValues.pnl;
                    pnlEl.classList.remove('positive', 'negative');
                    if (pnl > 0) pnlEl.classList.add('positive');
                    else if (pnl < 0) pnlEl.classList.add('negative');
                }
            };
            
            // Update stats periodically
            setInterval(syncAccountStats, 500);
            
            
            // Timeframe dropdown handler
            const timeframeToggle = document.getElementById('timeframeMenuToggle');
            const timeframeMenu = document.getElementById('timeframeMenu');
            const timeframeSelect = document.getElementById('replayTimeframe');
            
            console.log('Timeframe setup:', { timeframeToggle, timeframeMenu, timeframeSelect });
            
            if (timeframeToggle && timeframeMenu) {
                timeframeToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Timeframe button clicked');
                    
                    if (timeframeMenu.classList.contains('show')) {
                        timeframeMenu.classList.remove('show');
                    } else {
                        // Position the menu above the button
                        const rect = timeframeToggle.getBoundingClientRect();
                        timeframeMenu.style.left = rect.left + 'px';
                        timeframeMenu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                        timeframeMenu.classList.add('show');
                        console.log('Menu should be visible now');
                    }
                });
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!timeframeToggle.contains(e.target) && !timeframeMenu.contains(e.target)) {
                        timeframeMenu.classList.remove('show');
                    }
                });
                
                // Handle option selection
                const timeframeOptions = timeframeMenu.querySelectorAll('.timeframe-option');
                const timeframeLabel = document.getElementById('timeframeMenuLabel');
                timeframeOptions.forEach(function(option) {
                    option.addEventListener('click', function() {
                        const value = option.getAttribute('data-value');
                        
                        // Update visual selection
                        timeframeOptions.forEach(function(opt) { opt.classList.remove('selected'); });
                        option.classList.add('selected');
                        
                        // Update label text
                        if (timeframeLabel) {
                            timeframeLabel.textContent = option.textContent;
                        }
                        
                        // Update hidden select for compatibility
                        if (timeframeSelect) {
                            timeframeSelect.value = value;
                            timeframeSelect.dispatchEvent(new Event('change'));
                        }
                        
                        timeframeMenu.classList.remove('show');
                    });
                });
            } else {
                console.log('Timeframe elements not found!');
            }
            
            // Close Trades dropdown handler
            const closeTradesBtn = document.getElementById('closeTradesDropdownBtn');
            const closeTradesDropdown = document.getElementById('closeTradesDropdown');
            
            if (closeTradesBtn && closeTradesDropdown) {
                // Toggle dropdown
                closeTradesBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isVisible = closeTradesDropdown.style.display === 'block';
                    closeTradesDropdown.style.display = isVisible ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!closeTradesBtn.contains(e.target) && !closeTradesDropdown.contains(e.target)) {
                        closeTradesDropdown.style.display = 'none';
                    }
                });
                
                // Handle close actions
                const closeOptions = closeTradesDropdown.querySelectorAll('.close-trades-option');
                closeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const action = option.getAttribute('data-action');
                        closeTradesDropdown.style.display = 'none';
                        
                        if (window.chart && window.chart.orderManager) {
                            const orderManager = window.chart.orderManager;
                            
                            if (action === 'close-all') {
                                // Close all open positions
                                const count = orderManager.openPositions.length;
                                if (count === 0) {
                                    alert('No open positions to close');
                                    return;
                                }
                                if (confirm(`Close all ${count} open position(s)?`)) {
                                    const positionIds = orderManager.openPositions.map(p => p.id);
                                    positionIds.forEach(id => orderManager.closePosition(id));
                                    orderManager.showNotification(` Closed ${count} position(s)`, 'success');
                                }
                            } else if (action === 'close-profit') {
                                // Close profitable positions only
                                const currentCandle = orderManager.getCurrentCandle();
                                if (!currentCandle) return;
                                
                                const profitPositions = orderManager.openPositions.filter(pos => {
                                    const currentPrice = currentCandle.c;
                                    if (pos.type === 'BUY') {
                                        return currentPrice > pos.openPrice;
                                    } else {
                                        return currentPrice < pos.openPrice;
                                    }
                                });
                                
                                if (profitPositions.length === 0) {
                                    alert('No profitable positions to close');
                                    return;
                                }
                                
                                if (confirm(`Close ${profitPositions.length} profitable position(s)?`)) {
                                    profitPositions.forEach(pos => orderManager.closePosition(pos.id));
                                    orderManager.showNotification(` Closed ${profitPositions.length} profitable position(s)`, 'success');
                                }
                            } else if (action === 'close-losing') {
                                // Close losing positions only
                                const currentCandle = orderManager.getCurrentCandle();
                                if (!currentCandle) return;
                                
                                const losingPositions = orderManager.openPositions.filter(pos => {
                                    const currentPrice = currentCandle.c;
                                    if (pos.type === 'BUY') {
                                        return currentPrice < pos.openPrice;
                                    } else {
                                        return currentPrice > pos.openPrice;
                                    }
                                });
                                
                                if (losingPositions.length === 0) {
                                    alert('No losing positions to close');
                                    return;
                                }
                                
                                if (confirm(`Close ${losingPositions.length} losing position(s)?`)) {
                                    losingPositions.forEach(pos => orderManager.closePosition(pos.id));
                                    orderManager.showNotification(` Closed ${losingPositions.length} losing position(s)`, 'success');
                                }
                            }
                        }
                    });
                });
            }

            if (collapseToggle) {
                collapseToggle.addEventListener('click', () => {
                    document.body.classList.toggle('replay-tabs-collapsed');
                    // Update immediately and after transition
                    updateContainerBottom();
                    setTimeout(updateContainerBottom, 50);
                    setTimeout(updateContainerBottom, 350);
                });
            }

            // Watch toolbar for size changes
            if (window.ResizeObserver && replayToolbar) {
                const toolbarObserver = new ResizeObserver(() => {
                    updateContainerBottom();
                });
                toolbarObserver.observe(replayToolbar);
            }

            // Watch chart wrapper for size changes and debounce resize
            if (window.ResizeObserver && chartWrapper) {
                let resizeTimer;
                
                const wrapperObserver = new ResizeObserver(() => {
                    // Clear previous timer
                    clearTimeout(resizeTimer);
                    
                    // Only resize after changes settle (debounce)
                    resizeTimer = setTimeout(() => {
                        if (window.chart && typeof window.chart.resize === 'function') {
                            window.chart.resize();
                        }
                    }, 320);
                });
                wrapperObserver.observe(chartWrapper);
            }

            // Initial setup
            updateContainerBottom();
            
            // Window resize handler
            window.addEventListener('resize', updateContainerBottom);

            const hasDataRows = (tbody) => {
                if (!tbody) return false;
                return Array.from(tbody.querySelectorAll('tr')).some((row) => !row.classList.contains('replay-empty-row'));
            };

            const toggleEmptyState = (tbody, isEmpty) => {
                if (!tbody) return;
                const emptyRow = tbody.querySelector('.replay-empty-row');
                if (emptyRow) {
                    emptyRow.style.display = isEmpty ? '' : 'none';
                }
            };

            toggleEmptyState(ordersBody, !hasDataRows(ordersBody));
            toggleEmptyState(positionsBody, !hasDataRows(positionsBody));

            window.replayTabs = {
                refreshEmptyStates: () => {
                    toggleEmptyState(ordersBody, !hasDataRows(ordersBody));
                    toggleEmptyState(positionsBody, !hasDataRows(positionsBody));
                }
            };
        });
    </script>
    
    <!-- Emoji Picker Integration -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Create a single global emoji picker instance
            const simplePicker = new SimpleEmojiPicker();
            window.simplePicker = simplePicker; // Make it globally available for multi-panel support
            
            // Wire up the emoji toolbar button (in Text dropdown)
            const emojiBtn = document.getElementById('emojiTool');
            if (emojiBtn) {
                emojiBtn.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    simplePicker.toggle(emojiBtn);
                };
                
                // Set up emoji selection handler
                simplePicker.onSelect = (options) => {
                    const activePanelChart = window.panelManager && typeof window.panelManager.getSelectedPanel === 'function'
                        ? window.panelManager.getSelectedPanel()?.chartInstance
                        : null;
                    const targetChart = activePanelChart || window.chart || chart;

                    if (targetChart && targetChart.drawingManager && targetChart.drawingManager.handleEmojiSelection) {
                        targetChart.drawingManager.handleEmojiSelection(options);
                        // Don't deactivate keepDrawingMode or magnetMode buttons
                        document.querySelectorAll('.tool-btn:not(#keepDrawingMode):not(#magnetMode)').forEach(b => b.classList.remove('active'));
                        emojiBtn.classList.add('active');

                        // Close any open dropdowns so the next click can place the emoji
                        document.querySelectorAll('.tool-dropdown').forEach(dd => {
                            dd.classList.remove('show');
                        });
                    }
                };
            }
            
            console.log(' Emoji picker initialized and available globally for all panels');
        });
    </script>
    
    <!-- Magnet Mode Dropdown Handler -->
    <script>
        // Wait for everything to load
        window.addEventListener('load', function() {
            setTimeout(function() {
                const magnetBtn = document.getElementById('magnetMode');
                const magnetArrow = document.getElementById('magnetArrow');
                const magnetDropdown = document.getElementById('magnetDropdown');
                
                if (!magnetBtn) {
                    console.warn(' Magnet button not found');
                    return;
                }
                
                console.log(' Magnet button found, initializing handler...');
                
                // Store the last selected magnet type (default to 'strong')
                let lastMagnetType = localStorage.getItem('magnetType') || 'strong';
                let magnetActive = false;
                
                // Function to apply magnet mode
                function applyMagnetMode(mode) {
                    console.log(' Applying magnet mode:', mode);
                    // Try to set on drawing manager
                    if (window.chart && window.chart.drawingManager) {
                        window.chart.drawingManager.setMagnetMode(mode);
                        window.chart.drawingManager.magnetMode = mode;
                        console.log(' Set on drawingManager');
                    }
                    // Also set on chart object
                    if (window.chart) {
                        window.chart.magnetMode = mode;
                        console.log(' Set on chart');
                    }
                    // Store globally as fallback
                    window.magnetMode = mode;
                    console.log(' Set globally:', window.magnetMode);

                    if (window.chart && typeof window.chart.syncMagnetButton === 'function') {
                        window.chart.syncMagnetButton();
                    }
                }

                function updateMagnetButtons(mode) {
                    const btns = [document.getElementById('magnetMode'), document.getElementById('magnetModeToolbar')];
                    magnetActive = mode !== 'off';
                    btns.forEach((btn) => {
                        if (!btn) return;
                        btn.classList.remove('magnet-weak', 'magnet-strong');
                        if (magnetActive) {
                            btn.classList.add('active');
                            btn.classList.add(mode === 'strong' ? 'magnet-strong' : 'magnet-weak');
                            btn.setAttribute('data-tooltip', `Magnet Mode (${mode === 'weak' ? 'Weak' : 'Strong'}) - Use dropdown to change/off`);
                        } else {
                            btn.classList.remove('active');
                            btn.setAttribute('data-tooltip', 'Magnet Mode (OFF) - Click to enable');
                        }
                    });
                }

                function getCurrentMagnetMode() {
                    const mode = (window.chart && window.chart.drawingManager)
                        ? window.chart.drawingManager.magnetMode
                        : (window.chart?.magnetMode || window.magnetMode || 'off');
                    if (mode === true) return 'weak';
                    if (mode === false || mode == null) return 'off';
                    return mode;
                }

                function toggleMagnetOnOff(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const currentMode = getCurrentMagnetMode();

                    // Only enable magnet on button click. Turning OFF is done via dropdown "Off".
                    if (currentMode === 'off') {
                        const nextMode = lastMagnetType;
                        applyMagnetMode(nextMode);
                        updateMagnetButtons(nextMode);
                        console.log(` Magnet mode ON (${nextMode})`);
                    }
                }

                const magnetBtns = [document.getElementById('magnetMode'), document.getElementById('magnetModeToolbar')];
                magnetBtns.forEach((btn) => {
                    if (!btn) return;
                    btn.addEventListener('click', toggleMagnetOnOff, true);
                });
            
            // Arrow click - toggle dropdown (only if dropdown exists)
            if (magnetArrow && magnetDropdown) {
                magnetArrow.addEventListener('click', function(e) {
                    e.stopPropagation();

                    // Close visibility menu when opening magnet dropdown
                    if (typeof window.closeVisibilityMenus === 'function') {
                        window.closeVisibilityMenus();
                    }

                    // Close any open tool dropdowns (including visibility/delete toolbar dropdowns)
                    if (typeof window.closeAllToolDropdowns === 'function') {
                        window.closeAllToolDropdowns();
                    }

                    const isVisible = magnetDropdown.style.display === 'block';
                    
                    if (!isVisible) {
                        // Position dropdown relative to arrow button
                        const arrowRect = magnetArrow.getBoundingClientRect();
                        magnetDropdown.style.position = 'fixed';
                        magnetDropdown.style.top = (arrowRect.bottom + 4) + 'px';
                        magnetDropdown.style.left = arrowRect.left + 'px';
                        magnetDropdown.style.display = 'block';
                    } else {
                        magnetDropdown.style.display = 'none';
                    }
                });
                
                // Handle dropdown item clicks - select type
                magnetDropdown.querySelectorAll('.tool-dropdown-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const type = this.getAttribute('data-magnet');

                        if (type === 'off') {
                            // Update active state in dropdown
                            magnetDropdown.querySelectorAll('.tool-dropdown-item').forEach(i => i.classList.remove('active'));
                            this.classList.add('active');

                            applyMagnetMode('off');
                            updateMagnetButtons('off');
                            magnetDropdown.style.display = 'none';
                            console.log(' Magnet type set to: OFF');
                            return;
                        }
                        
                        // Update active state in dropdown
                        magnetDropdown.querySelectorAll('.tool-dropdown-item').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Store the selected type
                        lastMagnetType = type;
                        localStorage.setItem('magnetType', type);
                        
                        // Apply the selected type immediately (also turns magnet ON)
                        applyMagnetMode(type);
                        updateMagnetButtons(type);
                        
                        // Close dropdown
                        magnetDropdown.style.display = 'none';
                        
                        console.log(` Magnet type set to: ${type.toUpperCase()}`);
                    });
                });

                updateMagnetButtons(getCurrentMagnetMode());
            }
            
            // Close dropdown when clicking elsewhere (only if dropdown exists)
            if (magnetDropdown) {
                document.addEventListener('click', function(e) {
                    // Don't close if clicking on magnet elements
                    if (e.target.closest('.magnet-split-btn-sidebar') || e.target.closest('#magnetDropdown')) {
                        return;
                    }
                    magnetDropdown.style.display = 'none';
                });
                
                // Also close on mousedown for chart area clicks
                document.addEventListener('mousedown', function(e) {
                    // Close magnet dropdown if clicking outside
                    if (!e.target.closest('.magnet-split-btn-sidebar') && !e.target.closest('#magnetDropdown')) {
                        magnetDropdown.style.display = 'none';
                    }
                
                // Close visibility menu if clicking outside
                const activeChart = window.chart || window.mainChart;
                if (activeChart && activeChart.visibilityMenuVisible) {
                    const visibilityMenu = document.querySelector('.visibility-menu');
                    const visibilityBtn = document.getElementById('toggleVisibilityMenu');
                    if (visibilityMenu && !visibilityMenu.contains(e.target) && 
                        visibilityBtn && !visibilityBtn.contains(e.target)) {
                        if (typeof activeChart.hideVisibilityMenu === 'function') {
                            activeChart.hideVisibilityMenu();
                        }
                    }
                }
                });
            }
            
            // Snap to indicators toggle
            const snapToggle = document.getElementById('snapIndicatorToggle');
            const snapToggleItem = document.getElementById('snapToIndicators');
            let snapToIndicators = localStorage.getItem('snapToIndicators') === 'true';
            
            // Initialize toggle state
            if (snapToggle) {
                snapToggle.checked = snapToIndicators;
                
                // Handle toggle change
                snapToggle.addEventListener('change', function(e) {
                    e.stopPropagation();
                    snapToIndicators = this.checked;
                    localStorage.setItem('snapToIndicators', snapToIndicators);
                    
                    // Set snap to indicators globally and in managers
                    window.snapToIndicators = snapToIndicators;
                    if (window.chart && window.chart.drawingManager) {
                        window.chart.drawingManager.snapToIndicators = snapToIndicators;
                    }
                    if (window.chart) {
                        window.chart.snapToIndicators = snapToIndicators;
                    }
                    
                    console.log(` Snap to indicators: ${snapToIndicators ? 'ON' : 'OFF'}`);
                });
                
                // Make the whole row clickable
                if (snapToggleItem) {
                    snapToggleItem.addEventListener('click', function(e) {
                        if (e.target !== snapToggle && !e.target.closest('.magnet-toggle')) {
                            e.stopPropagation();
                            snapToggle.checked = !snapToggle.checked;
                            snapToggle.dispatchEvent(new Event('change'));
                        }
                    });
                }
                
                // Initialize globally and in chart
                window.snapToIndicators = snapToIndicators;
                if (window.chart) {
                    window.chart.snapToIndicators = snapToIndicators;
                    if (window.chart.drawingManager) {
                        window.chart.drawingManager.snapToIndicators = snapToIndicators;
                    }
                }
                console.log(` Snap to indicators initialized: ${snapToIndicators ? 'ON' : 'OFF'}`);
            }
            
            // Initialize dropdown to show saved type (only if dropdown exists)
            if (magnetDropdown) {
                const currentMode = getCurrentMagnetMode();
                const activeKey = currentMode === 'off' ? 'off' : lastMagnetType;
                magnetDropdown.querySelectorAll('.tool-dropdown-item').forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-magnet') === activeKey);
                });
            }
            
            // Sync function for keyboard shortcut
            window.syncMagnetButton = function() {
                const mode = (window.chart && window.chart.drawingManager) 
                    ? window.chart.drawingManager.magnetMode 
                    : (window.chart?.magnetMode || window.magnetMode || 'off');

                const normalizedMode = mode === true ? 'weak' : (mode === false || mode == null ? 'off' : mode);
                magnetActive = normalizedMode !== 'off';
                if (magnetActive) {
                    lastMagnetType = normalizedMode;
                    localStorage.setItem('magnetType', normalizedMode);
                }

                updateMagnetButtons(normalizedMode);
                
                // Update dropdown active state (only if dropdown exists)
                if (magnetDropdown) {
                    const activeKey = normalizedMode === 'off' ? 'off' : lastMagnetType;
                    magnetDropdown.querySelectorAll('.tool-dropdown-item').forEach(item => {
                        item.classList.toggle('active', item.getAttribute('data-magnet') === activeKey);
                    });
                }
            };
            
            // Make it available on chart object
            if (window.chart) {
                window.chart.syncMagnetButton = window.syncMagnetButton;
            }
            
            console.log(' Magnet mode split button initialized');
            }, 500); // End setTimeout
        });
    </script>
    
    <!-- Navigation Integrity System -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load backtesting session settings
            const sessionData = localStorage.getItem('backtestingSession');
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const sessionType = session.type || 'standard';
                    console.log(` ${sessionType === 'propfirm' ? 'Prop Firm' : 'Standard Backtesting'} session loaded:`, session);
                    
                    // Store settings globally for access by other modules
                    window.backtestingSettings = {
                        type: sessionType,
                        marketType: session.marketType || 'forex',
                        defaultRisk: session.defaultRisk || 1,
                        allowBackNavigation: session.allowBackNavigation !== false, // Default to true if not specified
                        
                        // Prop firm specific settings (only if prop firm mode)
                        ...(sessionType === 'propfirm' && {
                            isPropFirm: true,
                            balance: session.balance,
                            profitTarget: session.profitTarget,
                            maxDailyLoss: session.maxDailyLoss,
                            maxTotalLoss: session.maxTotalLoss,
                            minTradingDays: session.minTradingDays,
                            leverage: session.leverage,
                            timezone: session.timezone,
                            sessionCloseTime: session.sessionCloseTime
                        })
                    };
                    
                    // Freeze settings to prevent console manipulation
                    Object.freeze(window.backtestingSettings);
                    
                    // Initialize navigation integrity system
                    initNavigationIntegrity(window.backtestingSettings.allowBackNavigation);
                    
                    console.log(` ${sessionType === 'propfirm' ? 'Prop Firm' : 'Standard'} settings initialized (locked)`);
                } catch (error) {
                    console.error(' Error loading backtesting session:', error);
                }
            } else {
                // No session data, default to allowing back navigation
                window.backtestingSettings = Object.freeze({
                    type: 'standard',
                    marketType: 'forex',
                    defaultRisk: 1,
                    allowBackNavigation: true
                });
                console.log(' No backtesting session found, using defaults (locked)');
            }
        });
        
        function initNavigationIntegrity(allowBackNav) {
            const badge = document.getElementById('navIntegrityBadge');
            const badgeLetters = badge ? badge.querySelector('.nav-badge-letters') : null;
            const badgeTooltip = badge ? badge.querySelector('.nav-badge-tooltip') : null;
            const stepBackwardBtn = document.getElementById('replayStepBackward');
            const stepForwardBtn = document.getElementById('replayStepForward');
            const goBackBtn = document.getElementById('replayGoBack');
            
            if (!badge || !badgeLetters || !stepBackwardBtn || !stepForwardBtn) {
                console.warn(' Navigation integrity elements not found');
                return;
            }
            
            // Click to toggle tooltip visibility
            badge.addEventListener('click', (e) => {
                e.stopPropagation();
                badge.classList.toggle('show-tooltip');
            });
            
            // Hide tooltip when clicking elsewhere
            document.addEventListener('click', () => {
                badge.classList.remove('show-tooltip');
            });
            
            // Function to update badge and buttons
            function updateNavigationMode(isAllowed) {
                if (isAllowed) {
                    // Back navigation ENABLED - show LB
                    badge.classList.remove('disabled');
                    badge.classList.add('enabled');
                    badgeLetters.textContent = 'LB';
                    if (badgeTooltip) {
                        badgeTooltip.classList.remove('disabled-tip');
                        badgeTooltip.classList.add('enabled-tip');
                        badgeTooltip.innerHTML = '<strong>Live Back Enabled</strong><br>You can navigate back in time';
                    }
                    
                    // Enable buttons
                    stepBackwardBtn.disabled = false;
                    stepBackwardBtn.style.opacity = '1';
                    stepBackwardBtn.style.cursor = 'default';
                    stepBackwardBtn.title = 'Previous Bar';
                    
                    if (goBackBtn) {
                        goBackBtn.disabled = false;
                        goBackBtn.style.opacity = '1';
                        goBackBtn.style.cursor = 'default';
                        goBackBtn.title = 'Go Back - Pick new start point';
                    }
                } else {
                    // Back navigation DISABLED - show BN with strikethrough
                    badge.classList.remove('enabled');
                    badge.classList.add('disabled');
                    badgeLetters.textContent = 'BN';
                    if (badgeTooltip) {
                        badgeTooltip.classList.remove('enabled-tip');
                        badgeTooltip.classList.add('disabled-tip');
                        badgeTooltip.innerHTML = '<strong>Back Nav Disabled</strong><br>Ensures integrity - no going back';
                    }
                    
                    // Disable back button
                    stepBackwardBtn.disabled = true;
                    stepBackwardBtn.style.opacity = '0.3';
                    stepBackwardBtn.style.cursor = 'not-allowed';
                    stepBackwardBtn.title = 'Back navigation disabled for integrity';
                    
                    if (goBackBtn) {
                        goBackBtn.disabled = true;
                        goBackBtn.style.opacity = '0.3';
                        goBackBtn.style.cursor = 'not-allowed';
                        goBackBtn.title = 'Back navigation disabled for integrity';
                    }
                }
                
                // Forward button always enabled
                stepForwardBtn.disabled = false;
                stepForwardBtn.style.opacity = '1';
            }
            
            // Initial setup
            updateNavigationMode(allowBackNav);
            
            // Show badge when replay mode is active
            // Listen for replay mode events
            const replayToolbar = document.querySelector('.replay-toolbar');
            if (replayToolbar) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'class' || mutation.attributeName === 'style') {
                            const isVisible = replayToolbar.classList.contains('visible') || 
                                            replayToolbar.style.display !== 'none';
                            
                            if (isVisible) {
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    });
                });
                
                observer.observe(replayToolbar, {
                    attributes: true,
                    attributeFilter: ['class', 'style']
                });
            }
            
            // Also listen for manual replay mode activation
            const replayModeBtn = document.getElementById('replayModeBtn');
            if (replayModeBtn) {
                replayModeBtn.addEventListener('click', function() {
                    // Show badge when replay is activated
                    setTimeout(() => {
                        const toolbar = document.querySelector('.replay-toolbar');
                        if (toolbar && (toolbar.classList.contains('visible') || toolbar.style.display !== 'none')) {
                            badge.style.display = 'flex';
                        }
                    }, 100);
                });
            }
            
            // Listen for replay exit
            const replayExitBtn = document.getElementById('replayExit');
            if (replayExitBtn) {
                replayExitBtn.addEventListener('click', function() {
                    badge.style.display = 'none';
                });
            }
            
            // Navigation integrity is locked - no global access for security
            console.log(' Navigation integrity system locked:', allowBackNav ? 'Back nav allowed' : 'Back nav disabled (secured)');
        }
    </script>

    <!-- Backtesting Session Manager -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load backtesting session configuration
            const sessionData = localStorage.getItem('backtestingSession');
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    console.log(' Backtesting session configuration loaded:', session);
                    
                    // Store session globally for access by other modules
                    window.backtestingSession = session;
                    
                    // Show session mode badge
                    const modeBadge = document.getElementById('sessionModeBadge');
                    if (modeBadge) {
                        const sessionType = session.type || 'standard'; // Default to standard if type not set
                        console.log(' Session type detected:', sessionType);
                        
                        if (sessionType === 'propfirm') {
                            modeBadge.textContent = ' Prop Firm';
                            modeBadge.className = 'session-mode-badge propfirm';
                        } else {
                            modeBadge.textContent = ' Standard';
                            modeBadge.className = 'session-mode-badge standard';
                        }
                        modeBadge.style.display = 'inline-block';
                        console.log(' Mode badge displayed:', modeBadge.textContent);
                    } else {
                        console.warn(' Mode badge element not found');
                    }
                    
                    // Initialize session info panel
                    initSessionInfoPanel(session);
                    
                    // Initialize session manager
                    initSessionManager(session);
                    
                    // Auto-apply protection preset if specified
                    if (session.protectionPreset) {
                        console.log(' Auto-applying protection preset:', session.protectionPreset.name);
                        // Wait for OrderManager to be initialized
                        setTimeout(() => {
                            if (window.chart && window.chart.orderManager) {
                                window.chart.orderManager.applyProtectionSettings(session.protectionPreset);
                                console.log(' Protection preset applied successfully');
                            } else {
                                console.warn(' OrderManager not yet initialized, preset will need to be applied manually');
                            }
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error(' Error loading backtesting session:', error);
                }
            }
        });

        function initSessionInfoPanel(session) {
            const panel = document.getElementById('sessionInfoPanel');
            if (!panel) return;

            // Populate session info
            document.getElementById('sessionName').textContent = session.sessionName || 'Backtesting Session';
            document.getElementById('sessionMarket').textContent = String(session.marketType || 'forex').toUpperCase();
            document.getElementById('sessionMaxDailyLoss').textContent = `${session.maxDailyLoss || 5}%`;
            document.getElementById('sessionMaxDrawdown').textContent = `${session.maxDrawdown || 20}%`;
            document.getElementById('sessionMaxPositions').textContent = session.maxPositions || 3;
            
            // Position sizing display
            const positionSizingMap = {
                'fixed-lots': 'Fixed Lots',
                'percent-risk': 'Risk %',
                'fixed-dollar': 'Fixed $',
                'kelly': 'Kelly',
                'martingale': 'Martingale'
            };
            document.getElementById('sessionPositionSizing').textContent = positionSizingMap[session.positionSizing] || 'Risk %';
            
            // R:R Ratio
            if (session.enforceRiskReward) {
                document.getElementById('sessionMinRR').textContent = `1:${session.minRiskReward || 1.5}`;
            } else {
                document.getElementById('sessionMinRR').textContent = 'None';
            }

            // Show panel when replay mode starts
            const replayToolbar = document.querySelector('.replay-toolbar');
            if (replayToolbar) {
                const observer = new MutationObserver(() => {
                    const isVisible = replayToolbar.classList.contains('visible') || 
                                    replayToolbar.style.display !== 'none';
                    
                    if (isVisible && window.backtestingSession) {
                        panel.classList.add('active');
                    }
                });
                
                observer.observe(replayToolbar, {
                    attributes: true,
                    attributeFilter: ['class', 'style']
                });
            }

            // Toggle panel
            document.getElementById('sessionInfoToggle').addEventListener('click', () => {
                panel.classList.remove('active');
            });

            console.log(' Session info panel initialized');
        }

        function initSessionManager(session) {
            // Create global session manager
            window.sessionManager = {
                session: session,
                status: 'active',
                stats: {
                    tradesCount: 0,
                    winCount: 0,
                    lossCount: 0,
                    totalProfit: 0,
                    totalLoss: 0,
                    currentDrawdown: 0,
                    maxDrawdown: 0,
                    dailyPnL: 0,
                    lastTradeDate: null,
                    sessionStartBalance: parseFloat(session.startBalance) || 10000,
                    currentBalance: parseFloat(session.startBalance) || 10000
                },

                // Check if trading is allowed
                canTrade() {
                    if (this.status !== 'active') {
                        console.warn(' Session is not active');
                        return { allowed: false, reason: 'Session is paused or stopped' };
                    }

                    // Check trading time restrictions
                    const timeCheck = this.checkTradingTime();
                    if (!timeCheck.allowed) {
                        return timeCheck;
                    }

                    // Check max positions
                    if (window.orderManager) {
                        const openPositions = window.orderManager.getOpenPositions ? 
                            window.orderManager.getOpenPositions().length : 0;
                        
                        if (openPositions >= (this.session.maxPositions || 3)) {
                            return { 
                                allowed: false, 
                                reason: `Max positions reached (${this.session.maxPositions})` 
                            };
                        }
                    }

                    // Check daily loss limit
                    if (this.session.maxDailyLoss) {
                        const dailyLossPercent = (this.stats.dailyPnL / this.stats.sessionStartBalance) * 100;
                        if (dailyLossPercent < -(this.session.maxDailyLoss || 5)) {
                            this.pauseSession('Max daily loss reached');
                            return { 
                                allowed: false, 
                                reason: `Daily loss limit reached (${this.session.maxDailyLoss}%)` 
                            };
                        }
                    }

                    // Check max drawdown
                    if (this.session.maxDrawdown) {
                        const drawdownPercent = (this.stats.currentDrawdown / this.stats.sessionStartBalance) * 100;
                        if (drawdownPercent > (this.session.maxDrawdown || 20)) {
                            this.stopSession('Max drawdown exceeded');
                            return { 
                                allowed: false, 
                                reason: `Drawdown limit exceeded (${this.session.maxDrawdown}%)` 
                            };
                        }
                    }

                    // Check profit target
                    if (this.session.profitTargetType !== 'none' && this.session.profitTargetValue) {
                        const profit = this.stats.totalProfit - Math.abs(this.stats.totalLoss);
                        
                        if (this.session.profitTargetType === 'dollar' && profit >= this.session.profitTargetValue) {
                            this.stopSession('Profit target reached');
                            return { 
                                allowed: false, 
                                reason: `Profit target reached ($${this.session.profitTargetValue})` 
                            };
                        }
                        
                        if (this.session.profitTargetType === 'percent') {
                            const profitPercent = (profit / this.stats.sessionStartBalance) * 100;
                            if (profitPercent >= this.session.profitTargetValue) {
                                this.stopSession('Profit target reached');
                                return { 
                                    allowed: false, 
                                    reason: `Profit target reached (${this.session.profitTargetValue}%)` 
                                };
                            }
                        }
                    }

                    // Check trade count goal
                    if (this.session.tradeCountGoal && this.session.tradeCountGoal > 0) {
                        if (this.stats.tradesCount >= this.session.tradeCountGoal) {
                            this.stopSession('Trade count goal reached');
                            return { 
                                allowed: false, 
                                reason: `Trade count goal reached (${this.session.tradeCountGoal})` 
                            };
                        }
                    }

                    return { allowed: true };
                },

                // Check trading time restrictions
                checkTradingTime() {
                    // Get current time from chart data or use real time
                    let currentTime;
                    if (window.chart && window.chart.data && window.chart.data.length > 0) {
                        // Use chart's current visible time (for replay mode)
                        const lastCandle = window.chart.data[window.chart.data.length - 1];
                        currentTime = new Date(lastCandle.t);
                    } else {
                        currentTime = new Date();
                    }

                    // Check trading days
                    if (this.session.tradingDays && this.session.tradingDays.length > 0) {
                        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        const currentDay = dayNames[currentTime.getDay()];
                        
                        if (!this.session.tradingDays.includes(currentDay)) {
                            return { 
                                allowed: false, 
                                reason: `Trading not allowed on ${currentDay}s` 
                            };
                        }
                    }

                    // Check trading sessions
                    if (this.session.tradingSessions && this.session.tradingSessions.length > 0) {
                        const currentHour = currentTime.getUTCHours();
                        const currentMinutes = currentTime.getUTCMinutes();
                        const currentTimeDecimal = currentHour + (currentMinutes / 60);
                        
                        const sessionRanges = {
                            'sydney': { start: 22, end: 7 },
                            'tokyo': { start: 0, end: 9 },
                            'london': { start: 8, end: 17 },
                            'newyork': { start: 13, end: 22 }
                        };

                        let inSession = false;

                        for (const session of this.session.tradingSessions) {
                            const range = sessionRanges[session];
                            if (!range) continue;

                            // Handle sessions that cross midnight
                            if (range.start > range.end) {
                                if (currentTimeDecimal >= range.start || currentTimeDecimal < range.end) {
                                    inSession = true;
                                    break;
                                }
                            } else {
                                if (currentTimeDecimal >= range.start && currentTimeDecimal < range.end) {
                                    inSession = true;
                                    break;
                                }
                            }
                        }

                        // Check custom time range if enabled
                        if (this.session.useCustomTimeRange && !inSession) {
                            const customStart = this.parseTimeString(this.session.customStartTime);
                            const customEnd = this.parseTimeString(this.session.customEndTime);
                            
                            if (customStart !== null && customEnd !== null) {
                                if (customStart > customEnd) {
                                    // Crosses midnight
                                    inSession = currentTimeDecimal >= customStart || currentTimeDecimal < customEnd;
                                } else {
                                    inSession = currentTimeDecimal >= customStart && currentTimeDecimal < customEnd;
                                }
                            }
                        }

                        if (!inSession) {
                            return { 
                                allowed: false, 
                                reason: 'Outside trading session hours' 
                            };
                        }
                    }

                    return { allowed: true };
                },

                // Parse time string (HH:MM) to decimal hours
                parseTimeString(timeStr) {
                    if (!timeStr) return null;
                    const parts = timeStr.split(':');
                    if (parts.length !== 2) return null;
                    const hours = parseInt(parts[0]);
                    const minutes = parseInt(parts[1]);
                    if (isNaN(hours) || isNaN(minutes)) return null;
                    return hours + (minutes / 60);
                },

                // Calculate total trading costs (spread + slippage + commission)
                calculateTradingCosts(order) {
                    let totalCost = 0;
                    const lotSize = order.lotSize || 1;
                    const entryPrice = order.entryPrice || 0;

                    // 1. Spread cost (in pips converted to $)
                    if (this.session.averageSpread) {
                        const spreadPips = this.session.averageSpread;
                        // Assuming pip value of $10 for standard lot (adjust per instrument)
                        const pipValue = 10 * lotSize;
                        const spreadCost = spreadPips * pipValue;
                        totalCost += spreadCost;
                        console.log(` Spread cost: ${spreadPips} pips = $${spreadCost.toFixed(2)}`);
                    }

                    // 2. Slippage cost
                    if (this.session.slippage) {
                        const slippagePips = this.session.slippage;
                        const pipValue = 10 * lotSize;
                        const slippageCost = slippagePips * pipValue;
                        totalCost += slippageCost;
                        console.log(` Slippage cost: ${slippagePips} pips = $${slippageCost.toFixed(2)}`);
                    }

                    // 3. Commission
                    if (this.session.commissionType && this.session.commissionType !== 'none') {
                        let commissionCost = 0;
                        
                        switch(this.session.commissionType) {
                            case 'per-lot':
                                commissionCost = (this.session.commissionValue || 0) * lotSize;
                                break;
                            case 'per-trade':
                                commissionCost = this.session.commissionValue || 0;
                                break;
                            case 'percent':
                                const tradeValue = entryPrice * lotSize * 100000; // Standard lot size
                                commissionCost = (tradeValue * (this.session.commissionValue || 0)) / 100;
                                break;
                        }
                        
                        totalCost += commissionCost;
                        console.log(` Commission: $${commissionCost.toFixed(2)}`);
                    }

                    return totalCost;
                },

                // Calculate swap fees (overnight holding costs)
                calculateSwapFees(order, daysHeld) {
                    if (!this.session.includeSwap || daysHeld <= 0) {
                        return 0;
                    }

                    const lotSize = order.lotSize || 1;
                    const isLong = order.type === 'buy' || order.direction === 'long';
                    const swapPips = isLong ? (this.session.swapLong || 0) : (this.session.swapShort || 0);
                    const pipValue = 10 * lotSize;
                    const swapCost = Math.abs(swapPips) * pipValue * daysHeld;

                    console.log(` Swap fees: ${swapPips} pips  ${daysHeld} days = $${swapCost.toFixed(2)}`);
                    return swapCost;
                },

                // Apply costs to order profit/loss
                applyTradingCosts(order, profit) {
                    const costs = this.calculateTradingCosts(order);
                    
                    // Calculate days held for swap
                    let daysHeld = 0;
                    if (order.entryTime && order.exitTime) {
                        const msPerDay = 24 * 60 * 60 * 1000;
                        daysHeld = Math.floor((order.exitTime - order.entryTime) / msPerDay);
                    }
                    
                    const swapFees = this.calculateSwapFees(order, daysHeld);
                    const totalCosts = costs + swapFees;
                    
                    const netProfit = profit - totalCosts;
                    
                    console.log(` Trade P&L: Gross = $${profit.toFixed(2)}, Costs = $${totalCosts.toFixed(2)}, Net = $${netProfit.toFixed(2)}`);
                    
                    return {
                        grossProfit: profit,
                        tradingCosts: costs,
                        swapFees: swapFees,
                        totalCosts: totalCosts,
                        netProfit: netProfit
                    };
                },

                // Validate Risk-Reward Ratio
                validateRiskReward(entryPrice, stopLoss, takeProfit) {
                    if (!this.session.enforceRiskReward) {
                        return { valid: true };
                    }

                    if (!stopLoss || !takeProfit || !entryPrice) {
                        return { 
                            valid: false, 
                            reason: 'Entry, Stop Loss, and Take Profit are required' 
                        };
                    }

                    const risk = Math.abs(entryPrice - stopLoss);
                    const reward = Math.abs(takeProfit - entryPrice);
                    
                    if (risk === 0) {
                        return { 
                            valid: false, 
                            reason: 'Stop Loss cannot equal Entry Price' 
                        };
                    }

                    const riskRewardRatio = reward / risk;
                    const minRR = this.session.minRiskReward || 1.5;

                    if (riskRewardRatio < minRR) {
                        return { 
                            valid: false, 
                            reason: `R:R ratio ${riskRewardRatio.toFixed(2)} is below minimum ${minRR}`,
                            currentRR: riskRewardRatio,
                            requiredRR: minRR
                        };
                    }

                    return { 
                        valid: true, 
                        riskRewardRatio: riskRewardRatio 
                    };
                },

                // Calculate optimal stop loss based on strategy rules
                calculateStopLoss(entryPrice, direction) {
                    const stopLossType = this.session.stopLossType || 'fixed-pips';
                    const stopLossValue = this.session.stopLossValue || 20;
                    const pipSize = window.chart?.orderManager?.pipSize || 0.0001;
                    let stopLoss = null;

                    switch(stopLossType) {
                        case 'fixed-pips':
                            const pipDistance = stopLossValue * pipSize;
                            stopLoss = direction === 'long' ? 
                                entryPrice - pipDistance : 
                                entryPrice + pipDistance;
                            break;

                        case 'fixed-percent':
                            const percentDistance = entryPrice * (stopLossValue / 100);
                            stopLoss = direction === 'long' ? 
                                entryPrice - percentDistance : 
                                entryPrice + percentDistance;
                            break;

                        case 'atr':
                            // ATR-based (would need ATR calculation from chart data)
                            // Placeholder: use fixed pips as fallback
                            const atrDistance = stopLossValue * pipSize;
                            stopLoss = direction === 'long' ? 
                                entryPrice - atrDistance : 
                                entryPrice + atrDistance;
                            console.warn(' ATR calculation not yet implemented, using fixed pips');
                            break;

                        case 'trailing':
                            const trailDistance = stopLossValue * pipSize;
                            stopLoss = direction === 'long' ? 
                                entryPrice - trailDistance : 
                                entryPrice + trailDistance;
                            break;

                        default:
                            stopLoss = direction === 'long' ? 
                                entryPrice - (20 * pipSize) : 
                                entryPrice + (20 * pipSize);
                    }

                    // Check max stop loss limit
                    if (this.session.maxStopLoss && this.session.maxStopLoss > 0) {
                        const maxDistance = this.session.maxStopLoss * pipSize;
                        const actualDistance = Math.abs(entryPrice - stopLoss);
                        
                        if (actualDistance > maxDistance) {
                            console.warn(` Stop loss ${actualDistance.toFixed(5)} exceeds max ${maxDistance.toFixed(5)}`);
                            stopLoss = direction === 'long' ? 
                                entryPrice - maxDistance : 
                                entryPrice + maxDistance;
                        }
                    }

                    return stopLoss;
                },

                // Calculate optimal take profit based on strategy rules
                calculateTakeProfit(entryPrice, stopLoss, direction) {
                    const takeProfitType = this.session.takeProfitType || 'fixed-pips';
                    const takeProfitValue = this.session.takeProfitValue || 40;
                    const pipSize = window.chart?.orderManager?.pipSize || 0.0001;
                    let takeProfit = null;

                    switch(takeProfitType) {
                        case 'fixed-pips':
                            const pipDistance = takeProfitValue * pipSize;
                            takeProfit = direction === 'long' ? 
                                entryPrice + pipDistance : 
                                entryPrice - pipDistance;
                            break;

                        case 'risk-reward':
                            // TP = Entry + (Risk  Multiplier)
                            const risk = Math.abs(entryPrice - stopLoss);
                            const rewardMultiple = takeProfitValue; // e.g., 2 for 1:2 R:R
                            takeProfit = direction === 'long' ? 
                                entryPrice + (risk * rewardMultiple) : 
                                entryPrice - (risk * rewardMultiple);
                         break;

                        case 'fixed-percent':
                            const percentDistance = entryPrice * (takeProfitValue / 100);
                            takeProfit = direction === 'long' ? 
                                entryPrice + percentDistance : 
                                entryPrice - percentDistance;
                            break;

                        case 'trailing':
                            const trailDistance = takeProfitValue * pipSize;
                            takeProfit = direction === 'long' ? 
                                entryPrice + trailDistance : 
                                entryPrice - trailDistance;
                            break;

                        default:
                            takeProfit = direction === 'long' ? 
                                entryPrice + (40 * pipSize) : 
                                entryPrice - (40 * pipSize);
                    }

                    return takeProfit;
                },

                // Update statistics
                updateStats(trade) {
                    this.stats.tradesCount++;
                    
                    if (trade.profit > 0) {
                        this.stats.winCount++;
                        this.stats.totalProfit += trade.profit;
                    } else {
                        this.stats.lossCount++;
                        this.stats.totalLoss += trade.profit;
                    }

                    this.stats.currentBalance += trade.profit;
                    
                    // Update drawdown
                    const peakBalance = Math.max(this.stats.sessionStartBalance, this.stats.currentBalance);
                    this.stats.currentDrawdown = peakBalance - this.stats.currentBalance;
                    this.stats.maxDrawdown = Math.max(this.stats.maxDrawdown, this.stats.currentDrawdown);

                    // Reset daily P&L if new day
                    const tradeDate = new Date(trade.closeTime || Date.now()).toDateString();
                    if (this.stats.lastTradeDate !== tradeDate) {
                        this.stats.dailyPnL = 0;
                        this.stats.lastTradeDate = tradeDate;
                    }
                    this.stats.dailyPnL += trade.profit;

                    console.log(' Session stats updated:', this.stats);
                },

                pauseSession(reason) {
                    this.status = 'paused';
                    this.updateStatusUI();
                    console.warn(` Session paused: ${reason}`);
                    alert(` Session paused:\n${reason}`);
                },

                stopSession(reason) {
                    this.status = 'stopped';
                    this.updateStatusUI();
                    console.warn(` Session stopped: ${reason}`);
                    alert(` Session stopped:\n${reason}\n\nCheck your results in the History tab.`);
                },

                updateStatusUI() {
                    const statusBadge = document.getElementById('sessionStatus');
                    if (statusBadge) {
                        statusBadge.className = `session-status-badge ${this.status}`;
                        statusBadge.textContent = this.status.charAt(0).toUpperCase() + this.status.slice(1);
                    }
                }
            };

            console.log(' Session manager initialized with rules:', {
                maxDailyLoss: session.maxDailyLoss,
                maxDrawdown: session.maxDrawdown,
                maxPositions: session.maxPositions,
                profitTarget: session.profitTargetValue,
                enforceRR: session.enforceRiskReward
            });
        }

        // Export for use in other modules
        window.getSessionManager = function() {
            return window.sessionManager;
        };
        
        // Global function to set replay speed from buttons
        window.setReplaySpeed = function(speed, button) {
            console.log(' Speed button clicked:', speed);
            
            // Update active state on buttons
            const allButtons = document.querySelectorAll('.speed-option');
            allButtons.forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');
            
            // Set speed on replay system
            if (window.chart && window.chart.replaySystem) {
                window.chart.replaySystem.setSpeed(speed);
            } else {
                console.log(' Replay system not found, storing speed for later');
                window._pendingReplaySpeed = speed;
            }
            
            // Update the speed display
            updateSpeedDisplay(speed);
        };

        // Speed slider handler
        (function() {
            const speedSlider = document.getElementById('replaySpeedSlider');
            const speedValueDisplay = document.getElementById('speedValueDisplay');
            const speedRateDisplay = document.getElementById('speedRateDisplay');
            
            // Speed values mapped to slider positions
            // 1x = real time, 60x = 1m bar/sec, 300x = 5m bar/sec, etc.
            const speedValues = [1, 2, 5, 10, 30, 60, 120, 300, 900, 1800, 3600, 7200, 14400, 43200, 86400];
            const speedLabels = [
                '1x', '2x', '5x', '10x', '30x', '60x', '120x', '300x', '900x', '1800x', '3600x', '7200x', '14400x', '43200x', '86400x'
            ];
            const speedRates = [
                '(real time)',
                '(2 sec for 1sec)',
                '',
                '',
                '',
                '(1m bar/sec)',
                '',
                '(5m bar/sec)',
                '(15m bar/sec)',
                '(30m bar/sec)',
                '(1h bar/sec)',
                '(2h/sec)',
                '(4h/sec)',
                '(12h/sec)',
                '(1D bar/sec)'
            ];
            
            // Custom smooth slider elements
            const sliderTrack = document.getElementById('speedSliderCustom');
            const sliderThumb = document.getElementById('speedSliderThumb');
            const sliderFill = document.getElementById('speedSliderFill');
            
            let currentIndex = 5;
            const maxIndex = 14;
            
            // Update slider position
            function updateSliderPosition(index, animate = true) {
                if (!sliderTrack || !sliderThumb || !sliderFill) return;
                
                const percent = (index / maxIndex) * 100;
                
                if (!animate) {
                    sliderThumb.style.transition = 'none';
                    sliderFill.style.transition = 'none';
                }
                
                sliderThumb.style.left = percent + '%';
                sliderFill.style.width = percent + '%';
                
                if (!animate) {
                    // Force reflow then restore transitions
                    sliderThumb.offsetHeight;
                    sliderThumb.style.transition = '';
                    sliderFill.style.transition = '';
                }
                
                // Update hidden input for compatibility
                if (speedSlider) speedSlider.value = index;
            }
            
            // Set speed by index
            function setSpeedByIndex(index) {
                index = Math.max(0, Math.min(maxIndex, Math.round(index)));
                currentIndex = index;
                
                const speed = speedValues[index];
                
                // Update display
                if (speedValueDisplay) speedValueDisplay.textContent = speedLabels[index];
                if (speedRateDisplay) speedRateDisplay.textContent = speedRates[index];
                
                // Update slider position with animation
                updateSliderPosition(index, true);
                
                // Set speed on replay system
                if (window.chart && window.chart.replaySystem) {
                    window.chart.replaySystem.setSpeed(speed);
                } else {
                    window._pendingReplaySpeed = speed;
                }
            }
            
            window.updateSpeedDisplay = function(speed) {
                const index = speedValues.indexOf(speed);
                if (index !== -1) {
                    currentIndex = index;
                    if (speedValueDisplay) speedValueDisplay.textContent = speedLabels[index];
                    if (speedRateDisplay) speedRateDisplay.textContent = speedRates[index];
                    updateSliderPosition(index, true);
                }
            };
            
            // Custom slider drag handling
            if (sliderTrack && sliderThumb) {
                let isDragging = false;
                
                // Get index from mouse position
                function getIndexFromPosition(clientX) {
                    const rect = sliderTrack.getBoundingClientRect();
                    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                    return percent * maxIndex;
                }
                
                // Mouse down on thumb
                sliderThumb.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    sliderThumb.classList.add('dragging');
                    e.preventDefault();
                });
                
                // Click on track
                sliderTrack.addEventListener('click', (e) => {
                    if (e.target === sliderThumb) return;
                    const index = Math.round(getIndexFromPosition(e.clientX));
                    setSpeedByIndex(index);
                });
                
                // Mouse move
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const rawIndex = getIndexFromPosition(e.clientX);
                    const snappedIndex = Math.round(rawIndex);
                    
                    // Smooth position during drag (no transition)
                    const percent = (rawIndex / maxIndex) * 100;
                    sliderThumb.style.transition = 'transform 0.1s, box-shadow 0.15s';
                    sliderFill.style.transition = 'none';
                    sliderThumb.style.left = percent + '%';
                    sliderFill.style.width = percent + '%';
                    
                    // Update display based on nearest snap point
                    if (snappedIndex !== currentIndex) {
                        currentIndex = snappedIndex;
                        if (speedValueDisplay) speedValueDisplay.textContent = speedLabels[snappedIndex];
                        if (speedRateDisplay) speedRateDisplay.textContent = speedRates[snappedIndex];
                    }
                    
                    e.preventDefault();
                });
                
                // Mouse up
                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    sliderThumb.classList.remove('dragging');
                    
                    // Snap to nearest and apply speed
                    const rawIndex = getIndexFromPosition(e.clientX);
                    const snappedIndex = Math.round(rawIndex);
                    
                    // Restore transitions and snap
                    sliderThumb.style.transition = '';
                    sliderFill.style.transition = '';
                    
                    setSpeedByIndex(snappedIndex);
                });
                
                // Initialize position at 60x (1 candle/second default)
                updateSliderPosition(5, false);
            }
            
            // Play button handler
            const playBtn = document.getElementById('replayPlayPause');
            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    if (window.chart && window.chart.replaySystem) {
                        const isPlaying = window.chart.replaySystem.isPlaying;
                        if (isPlaying) {
                            window.chart.replaySystem.pause();
                            this.classList.remove('playing');
                        } else {
                            window.chart.replaySystem.play();
                            this.classList.add('playing');
                        }
                    }
                });
            }
            
            // Speed slider play button handler
            const speedSliderPlayBtn = document.getElementById('speedSliderPlayBtn');
            if (speedSliderPlayBtn) {
                speedSliderPlayBtn.addEventListener('click', function() {
                    if (window.chart && window.chart.replaySystem) {
                        const isPlaying = window.chart.replaySystem.isPlaying;
                        if (isPlaying) {
                            window.chart.replaySystem.pause();
                            this.classList.remove('playing');
                            if (playBtn) playBtn.classList.remove('playing');
                        } else {
                            window.chart.replaySystem.play();
                            this.classList.add('playing');
                            if (playBtn) playBtn.classList.add('playing');
                        }
                    }
                });
            }
            
            // Speed Bar Drag System - Creates duplicate instead of moving original
            const speedSliderControl = document.getElementById('speedSliderControl');
            const speedDragHandle = document.getElementById('speedDragHandle');
            const speedPlaceholder = document.getElementById('speedSliderPlaceholder');
            
            if (speedSliderControl && speedDragHandle && speedPlaceholder) {
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };
                let floatingClone = null;

                function setOriginalSpeedBarOpacity(opacity) {
                    const fadeIds = ['speedSliderControl', 'replayGoBack', 'replayStepForward', 'goToControl'];
                    fadeIds.forEach((id) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.opacity = opacity;
                        }
                    });

                    document.body.classList.toggle('speed-slider-clone-active', opacity !== '1');
                }
                
                // Create close button for clone
                function addCloseButton(clone) {
                    const closeBtn = document.createElement('button');
                    closeBtn.id = 'speedCloneCloseBtn';
                    closeBtn.className = 'speed-clone-close-btn';
                    closeBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="10" height="10">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    `;
                    closeBtn.style.cssText = `
                        position: absolute !important;
                        top: -6px !important;
                        right: -6px !important;
                        transform: none !important;
                        width: 16px !important;
                        height: 16px !important;
                        border-radius: 50% !important;
                        background: rgba(239, 68, 68, 0.7) !important;
                        background-color: rgba(239, 68, 68, 0.7) !important;
                        border: none !important;
                        color: #ffffff !important;
                        cursor: pointer !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        z-index: 10002 !important;
                        transition: background 0.15s ease !important;
                        padding: 0 !important;
                        outline: none !important;
                        box-shadow: none !important;
                    `;
                    
                    closeBtn.addEventListener('mouseenter', () => {
                        closeBtn.style.setProperty('background', '#dc2626', 'important');
                        closeBtn.style.setProperty('background-color', '#dc2626', 'important');
                    });
                    closeBtn.addEventListener('mouseleave', () => {
                        closeBtn.style.setProperty('background', 'rgba(239, 68, 68, 0.7)', 'important');
                        closeBtn.style.setProperty('background-color', 'rgba(239, 68, 68, 0.7)', 'important');
                    });
                    
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const existingMenu = document.getElementById('goToMenu');
                        if (existingMenu && existingMenu.classList.contains('open')) {
                            existingMenu.classList.remove('open');
                            existingMenu.style.visibility = '';
                            existingMenu.style.position = '';
                            existingMenu.style.left = '';
                            existingMenu.style.top = '';
                        }
                        clone.remove();
                        localStorage.removeItem('speedSliderClonePosition');
                        setOriginalSpeedBarOpacity('1');
                    });
                    
                    clone.appendChild(closeBtn);
                }
                
                // Make clone draggable
                function makeCloneDraggable(clone) {
                    let cloneDragging = false;
                    let cloneOffset = { x: 0, y: 0 };
                    
                    const cloneHandle = clone.querySelector('.speed-drag-handle');
                    if (!cloneHandle) return;
                    
                    cloneHandle.addEventListener('mousedown', (e) => {
                        cloneDragging = true;
                        const rect = clone.getBoundingClientRect();
                        cloneOffset.x = e.clientX - rect.left;
                        cloneOffset.y = e.clientY - rect.top;
                        clone.classList.add('dragging');
                        e.preventDefault();
                        e.stopPropagation();
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (!cloneDragging) return;
                        let left = e.clientX - cloneOffset.x;
                        let top = e.clientY - cloneOffset.y;
                        
                        // Constrain to viewport
                        const rect = clone.getBoundingClientRect();
                        left = Math.max(0, Math.min(left, window.innerWidth - rect.width));
                        top = Math.max(0, Math.min(top, window.innerHeight - rect.height));
                        
                        clone.style.left = left + 'px';
                        clone.style.top = top + 'px';
                        
                        // Check if near original position - show snap indicator
                        const originalRect = speedSliderControl.getBoundingClientRect();
                        const distance = Math.sqrt(
                            Math.pow(left - originalRect.left, 2) + 
                            Math.pow(top - originalRect.top, 2)
                        );
                        if (distance < 80) {
                            clone.classList.add('snap-ready');
                        } else {
                            clone.classList.remove('snap-ready');
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        if (!cloneDragging) return;
                        cloneDragging = false;
                        clone.classList.remove('dragging');
                        
                        // Check if near original position - close clone
                        const rect = clone.getBoundingClientRect();
                        const originalRect = speedSliderControl.getBoundingClientRect();
                        const distance = Math.sqrt(
                            Math.pow(rect.left - originalRect.left, 2) + 
                            Math.pow(rect.top - originalRect.top, 2)
                        );
                        
                        if (distance < 80) {
                            // Close clone when dropped near original position
                            clone.remove();
                            localStorage.removeItem('speedSliderClonePosition');
                            setOriginalSpeedBarOpacity('1');
                            return;
                        }
                        
                        clone.classList.remove('snap-ready');
                        
                        // Save position
                        try {
                            localStorage.setItem('speedSliderClonePosition', JSON.stringify({ left: rect.left, top: rect.top }));
                        } catch (err) {}
                    });
                }
                
                // Make clone fully functional like original
                function syncCloneWithOriginal(clone) {
                    // Speed values (same as original)
                    const speedValues = [1, 2, 5, 10, 30, 60, 120, 300, 900, 1800, 3600, 7200, 14400, 43200, 86400];
                    const speedLabels = ['1x', '2x', '5x', '10x', '30x', '60x', '120x', '300x', '900x', '1800x', '3600x', '7200x', '14400x', '43200x', '86400x'];
                    const speedRates = ['(real time)', '(2 sec for 1sec)', '', '', '', '(1m bar/sec)', '', '(5m bar/sec)', '(15m bar/sec)', '(30m bar/sec)', '(1h bar/sec)', '(2h/sec)', '(4h/sec)', '(12h/sec)', '(1D bar/sec)'];
                    const maxIndex = 14;
                    
                    // Get clone elements (using correct class names from HTML)
                    const clonePlayBtn = clone.querySelector('.speed-slider-play-btn');
                    const cloneSliderTrack = clone.querySelector('.speed-slider-custom');
                    const cloneSliderThumb = clone.querySelector('.speed-slider-custom-thumb');
                    const cloneSliderFill = clone.querySelector('.speed-slider-custom-fill');
                    const cloneValueLabel = clone.querySelector('.speed-value');
                    const cloneTimeLabel = clone.querySelector('.speed-rate');
                    
                    // Get original elements for syncing
                    const originalThumb = document.getElementById('speedSliderThumb');
                    const originalFill = document.getElementById('speedSliderFill');
                    const originalValueLabel = document.getElementById('speedValueDisplay');
                    const originalTimeLabel = document.getElementById('speedRateDisplay');
                    const originalPlayBtn = document.getElementById('speedSliderPlayBtn');
                    
                    // Play button - toggle play/pause
                    if (clonePlayBtn) {
                        clonePlayBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // Toggle play state on replay system
                            if (window.chart && window.chart.replaySystem) {
                                if (window.chart.replaySystem.isPlaying) {
                                    window.chart.replaySystem.pause();
                                } else {
                                    window.chart.replaySystem.play();
                                }
                            }
                            // Sync button states
                            setTimeout(() => {
                                const isPlaying = window.chart && window.chart.replaySystem && window.chart.replaySystem.isPlaying;
                                if (isPlaying) {
                                    clonePlayBtn.classList.add('playing');
                                    if (originalPlayBtn) originalPlayBtn.classList.add('playing');
                                } else {
                                    clonePlayBtn.classList.remove('playing');
                                    if (originalPlayBtn) originalPlayBtn.classList.remove('playing');
                                }
                            }, 10);
                        });
                    }
                    
                    // Clone slider drag functionality
                    if (cloneSliderTrack && cloneSliderThumb) {
                        let cloneSliderDragging = false;
                        
                        function getIndexFromPosition(clientX) {
                            const rect = cloneSliderTrack.getBoundingClientRect();
                            const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                            return percent * maxIndex;
                        }
                        
                        function setSpeedFromClone(index) {
                            index = Math.max(0, Math.min(maxIndex, Math.round(index)));
                            const speed = speedValues[index];
                            const percent = (index / maxIndex) * 100;
                            
                            // Update clone display
                            if (cloneValueLabel) cloneValueLabel.textContent = speedLabels[index];
                            if (cloneTimeLabel) cloneTimeLabel.textContent = speedRates[index];
                            if (cloneSliderThumb) cloneSliderThumb.style.left = percent + '%';
                            if (cloneSliderFill) cloneSliderFill.style.width = percent + '%';
                            
                            // Update original display
                            if (originalValueLabel) originalValueLabel.textContent = speedLabels[index];
                            if (originalTimeLabel) originalTimeLabel.textContent = speedRates[index];
                            if (originalThumb) originalThumb.style.left = percent + '%';
                            if (originalFill) originalFill.style.width = percent + '%';
                            
                            // Set speed on replay system
                            if (window.chart && window.chart.replaySystem) {
                                window.chart.replaySystem.setSpeed(speed);
                            }
                        }
                        
                        // Mouse down on clone thumb
                        cloneSliderThumb.addEventListener('mousedown', (e) => {
                            cloneSliderDragging = true;
                            cloneSliderThumb.classList.add('dragging');
                            e.preventDefault();
                            e.stopPropagation();
                        });
                        
                        // Click on clone track
                        cloneSliderTrack.addEventListener('click', (e) => {
                            if (e.target === cloneSliderThumb) return;
                            const index = Math.round(getIndexFromPosition(e.clientX));
                            setSpeedFromClone(index);
                            e.stopPropagation();
                        });
                        
                        // Mouse move for clone slider
                        const cloneMouseMove = (e) => {
                            if (!cloneSliderDragging) return;
                            
                            const rawIndex = getIndexFromPosition(e.clientX);
                            const snappedIndex = Math.round(rawIndex);
                            const percent = (rawIndex / maxIndex) * 100;
                            
                            // Update both clone and original slider positions
                            if (cloneSliderThumb) cloneSliderThumb.style.left = percent + '%';
                            if (cloneSliderFill) cloneSliderFill.style.width = percent + '%';
                            if (originalThumb) originalThumb.style.left = percent + '%';
                            if (originalFill) originalFill.style.width = percent + '%';
                            
                            // Update displays on both
                            if (cloneValueLabel) cloneValueLabel.textContent = speedLabels[snappedIndex];
                            if (cloneTimeLabel) cloneTimeLabel.textContent = speedRates[snappedIndex];
                            if (originalValueLabel) originalValueLabel.textContent = speedLabels[snappedIndex];
                            if (originalTimeLabel) originalTimeLabel.textContent = speedRates[snappedIndex];
                            
                            e.preventDefault();
                        };
                        
                        // Mouse up for clone slider
                        const cloneMouseUp = (e) => {
                            if (!cloneSliderDragging) return;
                            
                            cloneSliderDragging = false;
                            if (cloneSliderThumb) cloneSliderThumb.classList.remove('dragging');
                            
                            // Get final position and set speed
                            const thumbLeft = parseFloat(cloneSliderThumb.style.left) || 0;
                            const index = Math.round((thumbLeft / 100) * maxIndex);
                            setSpeedFromClone(index);
                        };
                        
                        document.addEventListener('mousemove', cloneMouseMove);
                        document.addEventListener('mouseup', cloneMouseUp);
                    }
                    
                    // Sync original changes to clone (when original is used)
                    if (originalThumb && cloneSliderThumb) {
                        const thumbObserver = new MutationObserver(() => {
                            if (!cloneSliderThumb.classList.contains('dragging')) {
                                cloneSliderThumb.style.left = originalThumb.style.left;
                            }
                        });
                        thumbObserver.observe(originalThumb, { attributes: true, attributeFilter: ['style'] });
                    }
                    
                    if (originalFill && cloneSliderFill) {
                        const fillObserver = new MutationObserver(() => {
                            cloneSliderFill.style.width = originalFill.style.width;
                        });
                        fillObserver.observe(originalFill, { attributes: true, attributeFilter: ['style'] });
                    }
                    
                    if (originalValueLabel && cloneValueLabel) {
                        const valueObserver = new MutationObserver(() => {
                            cloneValueLabel.textContent = originalValueLabel.textContent;
                        });
                        valueObserver.observe(originalValueLabel, { childList: true, characterData: true, subtree: true });
                    }
                    
                    if (originalTimeLabel && cloneTimeLabel) {
                        const timeObserver = new MutationObserver(() => {
                            cloneTimeLabel.textContent = originalTimeLabel.textContent;
                        });
                        timeObserver.observe(originalTimeLabel, { childList: true, characterData: true, subtree: true });
                    }
                    
                    // Sync play button state from original to clone
                    if (originalPlayBtn && clonePlayBtn) {
                        const playObserver = new MutationObserver(() => {
                            if (originalPlayBtn.classList.contains('playing')) {
                                clonePlayBtn.classList.add('playing');
                            } else {
                                clonePlayBtn.classList.remove('playing');
                            }
                        });
                        playObserver.observe(originalPlayBtn, { attributes: true, attributeFilter: ['class'] });
                        
                        // Initial sync
                        if (originalPlayBtn.classList.contains('playing')) {
                            clonePlayBtn.classList.add('playing');
                        }
                    }
                    
                    // Initial sync of slider position
                    if (originalThumb && cloneSliderThumb) {
                        cloneSliderThumb.style.left = originalThumb.style.left || '0%';
                    }
                    if (originalFill && cloneSliderFill) {
                        cloneSliderFill.style.width = originalFill.style.width || '0%';
                    }
                }
                
                // Mouse down on drag handle
                speedDragHandle.addEventListener('mousedown', (e) => {
                    // Check if clone already exists
                    const existingClone = document.getElementById('speedSliderClone');
                    if (existingClone) return;
                    
                    isDragging = true;
                    
                    const rect = speedSliderControl.getBoundingClientRect();
                    dragOffset.x = e.clientX - rect.left;
                    dragOffset.y = e.clientY - rect.top;
                    
                    // Create wrapper that includes speed slider + control buttons
                    floatingClone = document.createElement('div');
                    floatingClone.id = 'speedSliderClone';
                    floatingClone.classList.add('detached', 'dragging');
                    floatingClone.style.cssText = `
                        position: fixed;
                        left: ${rect.left}px;
                        top: ${rect.top}px;
                        z-index: 10001;
                        opacity: 0.9;
                        pointer-events: none;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        background: #050028;
                        border-radius: 8px;
                        padding: 6px 12px;
                        border: 1px solid rgba(124, 58, 237, 0.3);
                        transition: opacity 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
                    `;
                    
                    // Clone speed slider
                    const speedClone = speedSliderControl.cloneNode(true);
                    speedClone.id = 'speedSliderControlClone';
                    floatingClone.appendChild(speedClone);
                    
                    // Add divider
                    const divider = document.createElement('div');
                    divider.style.cssText = 'width: 1px; height: 24px; background: rgba(255,255,255,0.1);';
                    floatingClone.appendChild(divider);
                    
                    // Create Go Back button from scratch
                    const goBackClone = document.createElement('button');
                    goBackClone.id = 'replayGoBackClone';
                    goBackClone.title = 'Go Back';
                    goBackClone.style.cssText = 'display: flex; align-items: center; justify-content: center; background: transparent; border: none; padding: 6px; cursor: pointer; color: rgba(209, 212, 220, 0.6); border-radius: 4px; transition: all 0.15s ease;';
                    goBackClone.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m9 6-6 6 6 6"/><path d="M3 12h14"/><path d="M21 19V5"/>
                    </svg>`;
                    goBackClone.onmouseenter = () => { goBackClone.style.background = 'rgba(255,255,255,0.08)'; goBackClone.style.color = 'rgba(209, 212, 220, 0.9)'; };
                    goBackClone.onmouseleave = () => { goBackClone.style.background = 'transparent'; goBackClone.style.color = 'rgba(209, 212, 220, 0.6)'; };
                    goBackClone.onclick = () => {
                        const rs = window.chart && window.chart.replaySystem;
                        if (rs && typeof rs.goBackToPickPoint === 'function') {
                            rs.goBackToPickPoint();
                        }
                    };
                    floatingClone.appendChild(goBackClone);
                    
                    // Create Next Bar button from scratch
                    const stepForwardClone = document.createElement('button');
                    stepForwardClone.id = 'replayStepForwardClone';
                    stepForwardClone.title = 'Next Bar';
                    stepForwardClone.style.cssText = 'display: flex; align-items: center; justify-content: center; background: transparent; border: none; padding: 6px; cursor: pointer; color: rgba(209, 212, 220, 0.6); border-radius: 4px; transition: all 0.15s ease;';
                    stepForwardClone.innerHTML = `<svg viewBox="0 0 28 24" width="20" height="18" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="12" y="7" width="6" height="10" rx="1" fill="none"/>
                        <line x1="15" y1="4" x2="15" y2="7" stroke-linecap="round"/>
                        <line x1="15" y1="17" x2="15" y2="20" stroke-linecap="round"/>
                        <polyline points="22 12 26 12" stroke-linecap="round"/>
                        <polyline points="23 9 26 12 23 15" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>`;
                    stepForwardClone.onmouseenter = () => { stepForwardClone.style.background = 'rgba(255,255,255,0.08)'; stepForwardClone.style.color = 'rgba(209, 212, 220, 0.9)'; };
                    stepForwardClone.onmouseleave = () => { stepForwardClone.style.background = 'transparent'; stepForwardClone.style.color = 'rgba(209, 212, 220, 0.6)'; };
                    stepForwardClone.onclick = () => {
                        const rs = window.chart && window.chart.replaySystem;
                        if (rs && typeof rs.stepForward === 'function') {
                            rs.stepForward();
                        }
                    };
                    floatingClone.appendChild(stepForwardClone);

                    // Go To button (use existing goToMenu to avoid duplicate IDs)
                    const goToClone = document.createElement('button');
                    goToClone.id = 'goToMenuToggleClone';
                    goToClone.title = 'Go to';
                    goToClone.style.cssText = 'display: flex; align-items: center; justify-content: center; background: transparent; border: none; padding: 6px; cursor: pointer; color: rgba(209, 212, 220, 0.6); border-radius: 4px; transition: all 0.15s ease;';
                    goToClone.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="17" r="1"/><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>`;
                    goToClone.onmouseenter = () => { goToClone.style.background = 'rgba(255,255,255,0.08)'; goToClone.style.color = 'rgba(209, 212, 220, 0.9)'; };
                    goToClone.onmouseleave = () => { goToClone.style.background = 'transparent'; goToClone.style.color = 'rgba(209, 212, 220, 0.6)'; };
                    goToClone.addEventListener('click', (e2) => {
                        e2.stopPropagation();

                        const chart = window.chart;
                        const menu = document.getElementById('goToMenu');
                        if (!chart || !menu || typeof chart.renderGoToMenu !== 'function') return;

                        // Toggle open/close
                        if (menu.classList.contains('open')) {
                            menu.classList.remove('open');
                            menu.style.visibility = '';
                            menu.style.position = '';
                            menu.style.left = '';
                            menu.style.top = '';
                            return;
                        }

                        // Move menu to body to escape clipping
                        if (menu.parentElement !== document.body) {
                            document.body.appendChild(menu);
                        }

                        chart.renderGoToMenu(menu);
                        menu.classList.add('open');
                        menu.style.position = 'fixed';
                        menu.style.zIndex = '100000';

                        const rect2 = goToClone.getBoundingClientRect();
                        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
                        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                        const menuWidth = menu.offsetWidth || 680;
                        const menuHeight = menu.offsetHeight || 400;
                        let left2 = rect2.left;
                        let top2 = rect2.bottom + 8;

                        if (left2 + menuWidth > viewportWidth - 8) {
                            left2 = viewportWidth - menuWidth - 8;
                        }
                        if (left2 < 8) left2 = 8;

                        if (top2 + menuHeight > viewportHeight - 8) {
                            top2 = rect2.top - menuHeight - 8;
                        }
                        if (top2 < 8) top2 = 8;

                        menu.style.left = `${left2}px`;
                        menu.style.top = `${top2}px`;
                        menu.style.visibility = 'visible';
                    });
                    floatingClone.appendChild(goToClone);
                    
                    document.body.appendChild(floatingClone);

                    setOriginalSpeedBarOpacity('0.2');
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                // Mouse move
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging || !floatingClone) return;
                    
                    let left = e.clientX - dragOffset.x;
                    let top = e.clientY - dragOffset.y;
                    
                    // Constrain to viewport
                    const rect = floatingClone.getBoundingClientRect();
                    const maxLeft = window.innerWidth - rect.width;
                    const maxTop = window.innerHeight - rect.height;
                    
                    left = Math.max(0, Math.min(left, maxLeft));
                    top = Math.max(0, Math.min(top, maxTop));
                    
                    floatingClone.style.left = left + 'px';
                    floatingClone.style.top = top + 'px';
                    
                    // Visual effect when near original position
                    const originalRect = speedSliderControl.getBoundingClientRect();
                    const distance = Math.sqrt(
                        Math.pow(left - originalRect.left, 2) + 
                        Math.pow(top - originalRect.top, 2)
                    );
                    
                    if (distance < 80) {
                        floatingClone.style.opacity = '0.5';
                        floatingClone.style.transform = 'scale(0.95)';
                        floatingClone.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                    } else if (distance < 150) {
                        const fadeOpacity = 0.5 + (distance - 80) / 140 * 0.4;
                        floatingClone.style.opacity = fadeOpacity.toString();
                        floatingClone.style.transform = 'scale(0.98)';
                        floatingClone.style.borderColor = 'rgba(124, 58, 237, 0.3)';
                    } else {
                        floatingClone.style.opacity = '0.9';
                        floatingClone.style.transform = 'scale(1)';
                        floatingClone.style.borderColor = 'rgba(124, 58, 237, 0.3)';
                    }
                    
                    e.preventDefault();
                });
                
                // Mouse up
                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    
                    if (floatingClone) {
                        const cloneRect = floatingClone.getBoundingClientRect();
                        const originalRect = speedSliderControl.getBoundingClientRect();
                        
                        // Check if dragged far enough (at least 50px)
                        const distance = Math.sqrt(
                            Math.pow(cloneRect.left - originalRect.left, 2) + 
                            Math.pow(cloneRect.top - originalRect.top, 2)
                        );
                        
                        if (distance > 50) {
                            // Keep clone as floating
                            floatingClone.classList.remove('dragging');
                            floatingClone.style.pointerEvents = 'auto';
                            floatingClone.style.opacity = '1';
                            floatingClone.style.paddingRight = '32px';
                            
                            // Add close button
                            addCloseButton(floatingClone);
                            
                            // Make clone draggable
                            makeCloneDraggable(floatingClone);
                            
                            // Sync with original
                            syncCloneWithOriginal(floatingClone);
                            
                            // Save position
                            try {
                                localStorage.setItem('speedSliderClonePosition', JSON.stringify({ left: cloneRect.left, top: cloneRect.top }));
                            } catch (err) {}
                        } else {
                            // Not far enough, remove clone
                            floatingClone.remove();
                            setOriginalSpeedBarOpacity('1');
                        }
                        
                        floatingClone = null;
                    }
                });

                // Restore clone from saved position (if any)
                try {
                    localStorage.removeItem('speedSliderClonePosition');
                } catch (err) {}
                setOriginalSpeedBarOpacity('1');
            }
        })();

        // Help Menu Toggle  disabled, helpBtn now opens unified settings panel
        (function() {
            const helpBtn = document.getElementById('helpBtn');
            const helpMenu = document.getElementById('helpDropdownMenu');
            
            if (helpBtn && helpMenu) {
                /* click handler removed  helpBtn.onclick uses window._spOpen('help') */
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!helpMenu.contains(e.target) && !helpBtn.contains(e.target)) {
                        helpMenu.classList.remove('open');
                    }
                });
                
                // Handle menu item clicks
                document.getElementById('helpKeyboardShortcuts')?.addEventListener('click', function() {
                    helpMenu.classList.remove('open');
                    // Show keyboard shortcuts modal from KeyboardShortcutsManager
                    if (window.chart && window.chart.keyboardShortcuts) {
                        window.chart.keyboardShortcuts.showShortcutsHelp();
                    } else if (typeof KeyboardShortcutsManager !== 'undefined') {
                        // Try to create a temporary instance to show modal
                        const tempManager = new KeyboardShortcutsManager(window.chart);
                        tempManager.showShortcutsHelp();
                    }
                });
                
                document.getElementById('helpContactSupport')?.addEventListener('click', function() {
                    helpMenu.classList.remove('open');
                    alert('Contact Support: support@talaria.com');
                });
                
                document.getElementById('helpChangelog')?.addEventListener('click', function() {
                    helpMenu.classList.remove('open');
                    alert('Version 1.4.4 Changelog:\n\n Consistent divider styling across all toolbars\n Fixed replay toolbar button sizes and hover effects\n Real-time text size updates in drawing settings\n Improved Go To button styling\n Balance visibility toggle refinements\n\nPrevious (1.4.3):\n Volume is now an indicator - add via Indicators panel\n Volume indicator with settings and remove buttons\n Configurable volume colors (up/down)\n Volume value displays only when indicator is active');
                });
                
                document.getElementById('helpFAQ')?.addEventListener('click', function() {
                    helpMenu.classList.remove('open');
                    showHelpModal('FAQ', `
                        <div class="help-modal-section">
                            <h3>How do I add indicators?</h3>
                            <p>Click the "Indicators" button in the top toolbar to open the indicator selection menu. Choose an indicator to add it to your chart.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>How do I draw on the chart?</h3>
                            <p>Use the drawing tools in the left sidebar. Click on a tool, then click on the chart to start drawing.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>How do I change timeframes?</h3>
                            <p>Use the timeframe buttons in the top toolbar (1m, 5m, 15m, etc.) or click the dropdown arrow for more options.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>How do I save my chart?</h3>
                            <p>Your drawings and settings are automatically saved. Use the screenshot feature (camera icon) to export your chart as an image.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>How do I use replay mode?</h3>
                            <p>Click the "Replay" button to enter replay mode. Use the controls to step through candles or play at different speeds.</p>
                        </div>
                    `);
                });
                
                document.getElementById('helpEducation')?.addEventListener('click', function() {
                    helpMenu.classList.remove('open');
                    showHelpModal('Education', `
                        <div class="help-modal-section">
                            <h3>Candlestick Patterns</h3>
                            <p>Learn to identify key candlestick patterns like Doji, Hammer, Engulfing, and Morning/Evening Star patterns for better trading decisions.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>Technical Indicators</h3>
                            <p>Master indicators like Moving Averages (SMA, EMA), RSI, MACD, and Bollinger Bands to analyze market trends and momentum.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>Support & Resistance</h3>
                            <p>Understand how to identify key price levels where buying or selling pressure is likely to emerge.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>Risk Management</h3>
                            <p>Learn proper position sizing, stop-loss placement, and risk-to-reward ratios to protect your capital.</p>
                        </div>
                        <div class="help-modal-section">
                            <h3>Trading Sessions</h3>
                            <p>Understand the different trading sessions (Asia, London, New York) and their characteristics for optimal entry timing.</p>
                        </div>
                    `);
                });
            }
        })();
        
        // Helper function to show help modals
        function showHelpModal(title, content) {
            // Remove existing modal
            const existing = document.getElementById('helpModalOverlay');
            if (existing) existing.remove();
            
            const overlay = document.createElement('div');
            overlay.id = 'helpModalOverlay';
            overlay.innerHTML = `
                <div class="help-modal">
                    <div class="help-modal-header">
                        <h2>${title}</h2>
                        <button class="help-modal-close">&times;</button>
                    </div>
                    <div class="help-modal-content">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close handlers
            overlay.querySelector('.help-modal-close').addEventListener('click', () => overlay.remove());
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
            document.addEventListener('keydown', function closeOnEsc(e) {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            });
        }

        // Profile Menu Toggle  disabled, profileBtn now opens unified settings panel
        (function() {
            const profileBtn = document.getElementById('profileBtn');
            const profileMenu = document.getElementById('profileDropdownMenu');
            const languageSubmenu = document.getElementById('languageSubmenu');
            const languageItem = document.getElementById('profileLanguage');
            const languageBackBtn = document.getElementById('languageBackBtn');
            
            if (profileBtn && profileMenu) {
                /* click handler removed  profileBtn.onclick uses window._spOpen('profile') */
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target) && 
                        !languageSubmenu.contains(e.target)) {
                        profileMenu.classList.remove('open');
                        languageSubmenu.classList.remove('open');
                    }
                });
                
                // Open language submenu
                languageItem?.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileMenu.classList.remove('open');
                    languageSubmenu.classList.add('open');
                });
                
                // Back to profile menu
                languageBackBtn?.addEventListener('click', function(e) {
                    e.stopPropagation();
                    languageSubmenu.classList.remove('open');
                    profileMenu.classList.add('open');
                });
                
                // Handle language selection
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const lang = this.dataset.lang;
                        const langName = this.querySelector('span:nth-child(2)').textContent;
                        
                        // Update selected state
                        document.querySelectorAll('.language-option').forEach(opt => {
                            opt.classList.remove('selected');
                            const check = opt.querySelector('.check-icon');
                            if (check) check.remove();
                        });
                        
                        this.classList.add('selected');
                        if (!this.querySelector('.check-icon')) {
                            const checkSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            checkSvg.classList.add('check-icon');
                            checkSvg.setAttribute('viewBox', '0 0 24 24');
                            checkSvg.setAttribute('fill', 'none');
                            checkSvg.setAttribute('stroke', 'currentColor');
                            checkSvg.setAttribute('stroke-width', '2');
                            checkSvg.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
                            this.appendChild(checkSvg);
                        }
                        
                        // Update profile menu value
                        const valueEl = document.querySelector('#profileLanguage .profile-menu-value');
                        if (valueEl) valueEl.textContent = langName;
                        
                        // Close submenu and go back to profile
                        languageSubmenu.classList.remove('open');
                        profileMenu.classList.add('open');
                        
                        console.log('Language changed to:', lang);
                    });
                });
                
                // Logout handler
                document.getElementById('profileLogout')?.addEventListener('click', function() {
                    profileMenu.classList.remove('open');
                    if (confirm('Are you sure you want to log out?')) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('refresh_token');
                        localStorage.removeItem('talaria_current_user');
                        localStorage.removeItem('is_admin');
                        window.location.href = '/';
                    }
                });
            }
        })();

        // Symbol Watchlist Button Handler
        (function() {
            const symbolWatchlistBtn = document.getElementById('symbolWatchlistBtn');
            
            if (symbolWatchlistBtn) {
                symbolWatchlistBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Directly open watchlist panel
                    // Wait for showPanel function to be defined
                    if (typeof showPanel === 'function') {
                        showPanel('watchlist');
                    } else {
                        // Retry after a short delay if function not yet defined
                        setTimeout(() => {
                            if (typeof showPanel === 'function') {
                                showPanel('watchlist');
                            }
                        }, 100);
                    }
                });
            }
        })();

        // Open Compare Symbol Modal (called by + button)
        function openCompareSymbolModal() {
            console.log(' Opening Compare Symbol modal');
            if (window.chart && window.chart.compareOverlay) {
                window.chart.compareOverlay.openModal();
            } else {
                // Fallback: directly open modal
                const modal = document.getElementById('compareModalOverlay');
                if (modal) {
                    modal.classList.add('open');
                }
            }
        }
        
        // Make it globally accessible
        window.openCompareSymbolModal = openCompareSymbolModal;

        // Chart Type Selector - Initialize when DOM is ready
        function initChartTypeSelector() {
            const chartTypeBtn = document.getElementById('chartTypeBtn');
            const chartTypeDropdown = document.getElementById('chartTypeDropdown');
            
            if (!chartTypeBtn || !chartTypeDropdown) {
                console.log('Chart type elements not found, retrying...');
                setTimeout(initChartTypeSelector, 100);
                return;
            }
            
            console.log(' Chart type selector initialized');
            
            // Move dropdown to body to prevent clipping
            document.body.appendChild(chartTypeDropdown);
            
            // Handle dropdown arrow click only
            const chartTypeArrow = document.getElementById('chartTypeDropdownArrow');
            if (chartTypeArrow) {
                chartTypeArrow.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const isOpen = chartTypeDropdown.classList.contains('show');
                    
                    // Close all other dropdowns first
                    document.querySelectorAll('.tool-dropdown.show').forEach(dd => {
                        if (dd !== chartTypeDropdown) dd.classList.remove('show');
                    });
                    
                    if (!isOpen) {
                        // Position dropdown below arrow
                        const rect = chartTypeArrow.getBoundingClientRect();
                        
                        if (chartTypeDropdown.parentElement !== document.body) {
                            document.body.appendChild(chartTypeDropdown);
                        }
                        
                        chartTypeDropdown.style.position = 'fixed';
                        chartTypeDropdown.style.top = (rect.bottom + 4) + 'px';
                        chartTypeDropdown.style.left = rect.left + 'px';
                        chartTypeDropdown.classList.add('show');
                        chartTypeArrow.classList.add('dropdown-open');
                    } else {
                        chartTypeDropdown.classList.remove('show');
                        chartTypeArrow.classList.remove('dropdown-open');
                    }
                    
                    console.log('Chart type dropdown toggled:', chartTypeDropdown.classList.contains('show'));
                });
            }
            
            // Close when clicking outside
            document.addEventListener('click', function(e) {
                if (!chartTypeDropdown.contains(e.target) && !chartTypeArrow.contains(e.target)) {
                    chartTypeDropdown.classList.remove('show');
                    if (chartTypeArrow) chartTypeArrow.classList.remove('dropdown-open');
                }
            });
            
            // Handle chart type selection
            chartTypeDropdown.querySelectorAll('.chart-type-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const chartType = this.dataset.type;
                    
                    // Update active state
                    chartTypeDropdown.querySelectorAll('.chart-type-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update button icon
                    const chartTypeIcon = chartTypeBtn.querySelector('svg:first-child');
                    const newIcon = this.querySelector('svg').cloneNode(true);
                    if (chartTypeIcon && newIcon) {
                        chartTypeIcon.replaceWith(newIcon);
                    }
                    
                    // Close dropdown
                    chartTypeDropdown.classList.remove('show');
                    if (chartTypeArrow) chartTypeArrow.classList.remove('dropdown-open');
                    
                    // Apply chart type to chart
                    if (window.chart) {
                        window.chart.chartSettings.chartType = chartType;
                        window.chart.render();
                        console.log('Chart type changed to:', chartType);
                    }
                });
            });
        }
        
        // Run when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initChartTypeSelector);
        } else {
            initChartTypeSelector();
        }

        // ========== Symbol Switcher (DISABLED - now uses Compare Modal) ==========
        /*
        (function() {
            function initSymbolSwitcher() {
                const symbolPlusBtn = document.getElementById('symbolPlusBtn');
                const symbolSwitcherDropdown = document.getElementById('symbolSwitcherDropdown');
                const symbolSwitcherList = document.getElementById('symbolSwitcherList');
                const symbolDisplay = document.getElementById('symbolDisplay');
                
                if (!symbolPlusBtn || !symbolSwitcherDropdown) {
                    console.log('Symbol switcher elements not found, retrying...');
                    setTimeout(initSymbolSwitcher, 100);
                    return;
                }
                
                // Move dropdown to body
                document.body.appendChild(symbolSwitcherDropdown);
                
                // Toggle dropdown
                symbolPlusBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const isOpen = symbolSwitcherDropdown.classList.contains('open');
                    
                    if (!isOpen) {
                        // Position dropdown
                        const rect = symbolPlusBtn.getBoundingClientRect();
                        symbolSwitcherDropdown.style.top = (rect.bottom + 5) + 'px';
                        symbolSwitcherDropdown.style.left = rect.left + 'px';
                        
                        // Populate symbols from session
                        populateSymbolList();
                    }
                    
                    symbolSwitcherDropdown.classList.toggle('open');
                });
                
                // Close on outside click
                document.addEventListener('click', function(e) {
                    if (!symbolSwitcherDropdown.contains(e.target) && !symbolPlusBtn.contains(e.target)) {
                        symbolSwitcherDropdown.classList.remove('open');
                    }
                });
                
                // Populate symbol list from session
                function populateSymbolList() {
                    const session = JSON.parse(localStorage.getItem('backtestingSession') || '{}');
                    const files = session.files || [];
                    const activeFileId = session.fileId;
                    
                    if (files.length === 0) {
                        symbolSwitcherList.innerHTML = '<div class="symbol-switcher-empty">No symbols available.<br>Select multiple files when creating a backtest.</div>';
                        return;
                    }
                    
                    symbolSwitcherList.innerHTML = files.map((file, index) => {
                        const isActive = file.id === activeFileId;
                        const initials = file.name.substring(0, 2).toUpperCase();
                        
                        if (isActive) {
                            // Current symbol - show checkmark
                            return `
                                <div class="symbol-switcher-item active" data-file-id="${file.id}" data-file-name="${file.name}" data-index="${index}">
                                    <div class="symbol-icon">${initials}</div>
                                    <span class="symbol-name">${file.name}</span>
                                    <svg class="symbol-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                            `;
                        } else {
                            // Other symbols - show 3 options
                            return `
                                <div class="symbol-switcher-item" data-file-id="${file.id}" data-file-name="${file.name}" data-index="${index}">
                                    <div class="symbol-icon">${initials}</div>
                                    <span class="symbol-name">${file.name}</span>
                                    <div class="symbol-switcher-options">
                                        <button class="symbol-switcher-option-btn" data-mode="same-scale" data-file-id="${file.id}" data-file-name="${file.name}">Same % scale</button>
                                        <button class="symbol-switcher-option-btn" data-mode="new-scale" data-file-id="${file.id}" data-file-name="${file.name}">New price scale</button>
                                        <button class="symbol-switcher-option-btn" data-mode="new-pane" data-file-id="${file.id}" data-file-name="${file.name}">New pane</button>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    // Add click handlers for option buttons
                    symbolSwitcherList.querySelectorAll('.symbol-switcher-option-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const mode = this.dataset.mode;
                            const fileId = this.dataset.fileId;
                            const fileName = this.dataset.fileName;
                            
                            handleSymbolAdd(fileId, fileName, mode);
                            symbolSwitcherDropdown.classList.remove('open');
                        });
                    });
                }
                
                // Handle symbol add with mode
                function handleSymbolAdd(fileId, fileName, mode) {
                    // Ensure fileId is an integer
                    const numericFileId = parseInt(fileId);
                    const symbolName = fileName.replace(/\.(csv|CSV)$/, '');
                    
                    console.log(`Adding symbol ${symbolName} (fileId: ${numericFileId}) with mode: ${mode}`);
                    
                    switch (mode) {
                        case 'same-scale':
                            // Add as overlay with same scale
                            if (window.chart && window.chart.compareOverlay) {
                                window.chart.compareOverlay.addOverlay(numericFileId, symbolName);
                            } else {
                                console.error('Compare overlay not available');
                            }
                            break;
                            
                        case 'new-scale':
                            // Add as overlay with separate Y-axis (for now same as same-scale)
                            if (window.chart && window.chart.compareOverlay) {
                                window.chart.compareOverlay.addOverlay(numericFileId, symbolName);
                            } else {
                                console.error('Compare overlay not available');
                            }
                            break;
                            
                        case 'new-pane':
                            // Apply 2-panel layout (top/bottom) with DIRECT scroll sync
                            if (window.panelManager) {
                                // Get main chart's timeframe and symbol BEFORE applying layout
                                const mainTimeframe = window.chart?.currentTimeframe || '1m';
                                const mainSymbol = window.chart?.currentSymbol || symbolName || 'Symbol';
                                
                                // Apply 2h layout (top/bottom stacked)
                                window.panelManager.applyLayout('2h');
                                
                                // Wait for panels to be created and initialized
                                setTimeout(() => {
                                    const panels = window.panelManager.panels;
                                    if (panels.length > 1) {
                                        const panel1 = panels[1];
                                        
                                        // Force same timeframe on panel 1's chart instance
                                        if (panel1.chartInstance) {
                                            // Resample data to main chart's timeframe
                                            if (panel1.chartInstance.rawData && panel1.chartInstance.rawData.length > 0) {
                                                panel1.chartInstance.data = panel1.chartInstance.resampleData(
                                                    panel1.chartInstance.rawData, 
                                                    mainTimeframe
                                                );
                                                panel1.chartInstance.currentTimeframe = mainTimeframe;
                                                panel1.timeframe = mainTimeframe;
                                                
                                                // Sync scroll position (offsetX) from main chart
                                                if (window.chart) {
                                                    panel1.chartInstance.offsetX = window.chart.offsetX || 0;
                                                    panel1.chartInstance.candleWidth = window.chart.candleWidth || 8;
                                                }
                                                
                                                // Re-render with correct timeframe and position
                                                panel1.chartInstance.render();
                                                
                                                // Update symbol and timeframe display in panel's existing OHLC info
                                                const symbolEl = document.getElementById(`chartSymbol${panel1.index}`);
                                                const tfEl = document.getElementById(`chartTimeframe${panel1.index}`);
                                                if (symbolEl) symbolEl.textContent = mainSymbol;
                                                if (tfEl) tfEl.textContent = mainTimeframe;
                                                
                                                // ===== DIRECT SCROLL SYNC - Move together like one chart =====
                                                // Store original render methods
                                                const mainRender = window.chart.render.bind(window.chart);
                                                const panel1Render = panel1.chartInstance.render.bind(panel1.chartInstance);
                                                
                                                // Override main chart render to sync panel1
                                                window.chart.render = function() {
                                                    mainRender();
                                                    if (panel1.chartInstance && !window._syncingFromPanel) {
                                                        window._syncingFromMain = true;
                                                        panel1.chartInstance.offsetX = window.chart.offsetX;
                                                        panel1.chartInstance.candleWidth = window.chart.candleWidth;
                                                        panel1Render();
                                                        window._syncingFromMain = false;
                                                    }
                                                };
                                                
                                                // Override panel1 render to sync main chart
                                                panel1.chartInstance.render = function() {
                                                    panel1Render();
                                                    if (window.chart && !window._syncingFromMain) {
                                                        window._syncingFromPanel = true;
                                                        window.chart.offsetX = panel1.chartInstance.offsetX;
                                                        window.chart.candleWidth = panel1.chartInstance.candleWidth;
                                                        mainRender();
                                                        window._syncingFromPanel = false;
                                                    }
                                                };
                                                
                                                // Store for cleanup when returning to single panel
                                                window._linkedPaneData = {
                                                    mainRender: mainRender,
                                                    panel1Render: panel1Render,
                                                    symbol: mainSymbol,
                                                    panel1: panel1,  // Store panel reference for timeframe sync
                                                    mainChart: window.chart  // Store main chart for reverse sync
                                                };
                                                
                                                // ===== ADD CONTROLS TO EXISTING OHLC INFO =====
                                                const ohlcSymbolLine = panel1.chartContainer.querySelector('.ohlc-symbol-line');
                                                if (ohlcSymbolLine) {
                                                    // Add controls container after timeframe
                                                    const controls = document.createElement('div');
                                                    controls.className = 'new-pane-controls';
                                                    controls.style.cssText = 'display: inline-flex; align-items: center; gap: 6px; margin-left: 10px; position: relative; z-index: 1000; default-events: auto;';
                                                    controls.innerHTML = `
                                                        <button class="new-pane-vis-btn" title="Toggle visibility" style="background: transparent; border: none; color: #787b86; cursor: default; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: 4px; default-events: auto;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                                <circle cx="12" cy="12" r="3"></circle>
                                                            </svg>
                                                        </button>
                                                        <button class="new-pane-settings-btn" title="Settings" style="background: transparent; border: none; color: #787b86; cursor: default; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: 4px; default-events: auto;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                                <circle cx="12" cy="12" r="3"></circle>
                                                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                                            </svg>
                                                        </button>
                                                        <button class="new-pane-del-btn" title="Remove pane" style="background: transparent; border: none; color: #787b86; cursor: default; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: 4px; default-events: auto;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                            </svg>
                                                        </button>
                                                    `;
                                                    
                                                    // Insert before collapse button
                                                    const collapseBtn = ohlcSymbolLine.querySelector('.ohlc-collapse-btn');
                                                    if (collapseBtn) {
                                                        ohlcSymbolLine.insertBefore(controls, collapseBtn);
                                                    } else {
                                                        ohlcSymbolLine.appendChild(controls);
                                                    }
                                                    
                                                    // Visibility toggle
                                                    const visBtn = controls.querySelector('.new-pane-vis-btn');
                                                    let isVisible = true;
                                                    visBtn.addEventListener('click', (e) => {
                                                        e.stopPropagation();
                                                        isVisible = !isVisible;
                                                        panel1.canvas.style.opacity = isVisible ? '1' : '0.15';
                                                        visBtn.style.opacity = isVisible ? '1' : '0.4';
                                                    });
                                                    visBtn.addEventListener('mouseenter', () => visBtn.style.background = 'rgba(255,255,255,0.1)');
                                                    visBtn.addEventListener('mouseleave', () => visBtn.style.background = 'transparent');
                                                    
                                                    // Settings button - open new pane settings popup
                                                    const settingsBtn = controls.querySelector('.new-pane-settings-btn');
                                                    settingsBtn.addEventListener('click', (e) => {
                                                        e.stopPropagation();
                                                        const popup = document.getElementById('newPaneSettingsPopup');
                                                        const titleEl = document.getElementById('newPaneSettingsTitle');
                                                        if (popup) {
                                                            if (titleEl) titleEl.textContent = mainSymbol;
                                                            popup.classList.add('open');
                                                            
                                                            // Store reference to panel for applying settings
                                                            window._newPaneSettingsTarget = panel1;
                                                        }
                                                    });
                                                    settingsBtn.addEventListener('mouseenter', () => settingsBtn.style.background = 'rgba(255,255,255,0.1)');
                                                    settingsBtn.addEventListener('mouseleave', () => settingsBtn.style.background = 'transparent');
                                                    
                                                    // Delete button - return to single panel
                                                    const delBtn = controls.querySelector('.new-pane-del-btn');
                                                    delBtn.addEventListener('click', (e) => {
                                                        e.stopPropagation();
                                                        // Restore original render methods and cleanup
                                                        if (window._linkedPaneData) {
                                                            window.chart.render = window._linkedPaneData.mainRender;
                                                            delete window._linkedPaneData;
                                                        }
                                                        window.panelManager.applyLayout('1');
                                                    });
                                                    delBtn.addEventListener('mouseenter', () => { delBtn.style.color = '#ef5350'; delBtn.style.background = 'rgba(239,83,80,0.1)'; });
                                                    delBtn.addEventListener('mouseleave', () => { delBtn.style.color = '#787b86'; delBtn.style.background = 'transparent'; });
                                                }
                                                
                                                console.log(` Panel 1 synced: timeframe=${mainTimeframe}, DIRECT scroll sync enabled`);
                                            }
                                        }
                                    }
                                }, 600);
                            } else {
                                console.error('Panel manager not available');
                            }
                            break;
                    }
                }
                
                // Load data into a specific panel
                async function loadDataIntoPanel(panel, fileId, fileName, timeframe) {
                    try {
                        // Use passed timeframe or get from main chart
                        const mainTimeframe = timeframe || window.chart?.currentTimeframe || '1m';
                        const apiUrl = window.chart?.apiUrl || window.CHART_API_URL || '/api';
                        
                        console.log(`Loading ${fileName} into panel ${panel.index} with timeframe ${mainTimeframe}`);
                        
                        // Fetch data from API (same format as compare overlay)
                        const response = await fetch(`${apiUrl}/file/${fileId}?offset=0&limit=50000`);
                        if (!response.ok) throw new Error('Failed to fetch file data');
                        
                        const result = await response.json();
                        if (!result.data) {
                            console.warn('No data in response');
                            return;
                        }
                        
                        // Parse CSV data like compare overlay does
                        const rawData = parseCSVDataForPanel(result.data);
                        if (rawData.length === 0) {
                            console.warn('No candles parsed from CSV');
                            return;
                        }
                        
                        // Use the SAME timeframe resampling as main chart
                        let candles = rawData;
                        
                        // Resample to match main chart's timeframe
                        if (mainTimeframe && mainTimeframe !== '1m' && window.chart && window.chart.resampleData) {
                            candles = window.chart.resampleData(rawData, mainTimeframe);
                        }
                        
                        // Store raw data for replay sync
                        panel.rawData = rawData;
                        panel.data = candles;
                        panel.mainTimeframe = mainTimeframe;
                        
                        // Remove placeholder
                        if (panel.placeholder) {
                            panel.placeholder.style.display = 'none';
                        }
                        
                        // Draw candles on panel canvas
                        drawCandlesOnPanel(panel, candles);
                        
                        // Setup replay sync for this panel
                        setupPanelReplaySync(panel);
                    } catch (error) {
                        console.error('Error loading panel data:', error);
                    }
                }
                
                // Setup replay synchronization for custom panel (simplified - no render patching)
                function setupPanelReplaySync(panel) {
                    if (!panel || !panel.rawData) return;
                    
                    // Only sync during replay - check every 200ms
                    panel._replaySyncInterval = setInterval(() => {
                        if (!window.chart?.replaySystem?.isActive) return;
                        
                        try {
                            const mainData = window.chart.data || [];
                            if (mainData.length === 0) return;
                            
                            const lastVisibleTime = mainData[mainData.length - 1]?.timestamp;
                            if (!lastVisibleTime) return;
                            
                            // Filter panel data up to current replay time
                            const filtered = panel.rawData.filter(c => c.timestamp <= lastVisibleTime);
                            if (filtered.length === 0) return;
                            
                            panel.data = filtered;
                            drawCandlesOnPanel(panel, filtered);
                        } catch (e) {
                            // Silent fail
                        }
                    }, 200);
                    
                }
                
                // Parse CSV data (same logic as compare overlay)
                function parseCSVDataForPanel(csvText) {
                    const data = [];
                    const lines = csvText.trim().split('\n').filter(line => line.trim().length > 0);
                    if (lines.length < 1) return data;
                    
                    // Detect header
                    const firstLine = lines[0].toLowerCase();
                    const hasHeader = firstLine.includes('open') || firstLine.includes('high') || 
                                     firstLine.includes('low') || firstLine.includes('close') ||
                                     firstLine.includes('ticker') || firstLine.includes('time');
                    
                    const dataStartIdx = hasHeader ? 1 : 0;
                    
                    for (let i = dataStartIdx; i < lines.length; i++) {
                        const cols = lines[i].split(',').map(c => c.trim());
                        if (cols.length < 5) continue;
                        
                        // Try different column formats
                        let timestamp, open, high, low, close, volume;
                        
                        // MetaTrader format: ticker,time,open,high,low,close,volume
                        if (cols.length >= 7 && !isNaN(parseFloat(cols[2]))) {
                            timestamp = new Date(cols[1]).getTime();
                            open = parseFloat(cols[2]);
                            high = parseFloat(cols[3]);
                            low = parseFloat(cols[4]);
                            close = parseFloat(cols[5]);
                            volume = parseFloat(cols[6]) || 0;
                        }
                        // Standard format: timestamp,open,high,low,close,volume
                        else {
                            timestamp = new Date(cols[0]).getTime();
                            open = parseFloat(cols[1]);
                            high = parseFloat(cols[2]);
                            low = parseFloat(cols[3]);
                            close = parseFloat(cols[4]);
                            volume = parseFloat(cols[5]) || 0;
                        }
                        
                        if (!isNaN(timestamp) && !isNaN(open) && !isNaN(high) && !isNaN(low) && !isNaN(close)) {
                            data.push({ timestamp, open, high, low, close, volume });
                        }
                    }
                    
                    return data.sort((a, b) => a.timestamp - b.timestamp);
                }
                
                // Simple candle drawing for panel
                // Make it globally accessible for render sync
                const drawCandlesOnPanel = window.drawCandlesOnPanel = function(panel, candles) {
                    console.log(' drawCandlesOnPanel called with', candles?.length, 'candles');
                    
                    if (!panel || !panel.canvas) {
                        console.error('No panel or canvas');
                        return;
                    }
                    if (!candles || candles.length === 0) {
                        console.error('No candles to draw');
                        return;
                    }
                    
                    const canvas = panel.canvas;
                    const ctx = canvas.getContext('2d');
                    
                    // Get canvas dimensions from panel element
                    const rect = panel.element.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    
                    console.log('Canvas size:', canvas.width, 'x', canvas.height);
                    
                    const width = canvas.width;
                    const height = canvas.height;
                    const padding = { top: 40, right: 60, bottom: 30, left: 10 };
                    
                    // Clear canvas with dark background
                    ctx.fillStyle = '#050028';
                    ctx.fillRect(0, 0, width, height);
                    
                    // Calculate how many candles fit
                    const chartWidth = width - padding.left - padding.right;
                    const candleWidth = 8;
                    const spacing = 2;
                    const totalWidth = candleWidth + spacing;
                    const maxCandles = Math.floor(chartWidth / totalWidth);
                    
                    // Show last N candles that fit
                    let visibleCandles = candles;
                    if (candles.length > maxCandles) {
                        visibleCandles = candles.slice(-maxCandles);
                    }
                    
                    console.log('Showing', visibleCandles.length, 'of', candles.length, 'candles');
                    
                    if (visibleCandles.length === 0) {
                        ctx.fillStyle = '#787b86';
                        ctx.font = '14px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('No data in visible range', width / 2, height / 2);
                        return;
                    }
                    
                    // Calculate price range from visible candles only
                    const prices = visibleCandles.flatMap(c => [c.high, c.low]);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const priceRange = maxPrice - minPrice || 1;
                    const pricePadding = priceRange * 0.1;
                    const adjustedMin = minPrice - pricePadding;
                    const adjustedMax = maxPrice + pricePadding;
                    const adjustedRange = adjustedMax - adjustedMin;
                    
                    const drawWidth = width - padding.left - padding.right;
                    const drawHeight = height - padding.top - padding.bottom;
                    
                    // Price to Y conversion function
                    const priceToY = (price) => {
                        return padding.top + (1 - (price - adjustedMin) / adjustedRange) * drawHeight;
                    };
                    
                    // Draw candles with proper spacing
                    visibleCandles.forEach((candle, i) => {
                        const x = padding.left + i * (candleWidth + spacing) + (candleWidth + spacing) / 2;
                        const isGreen = candle.close >= candle.open;
                        
                        const openY = priceToY(candle.open);
                        const closeY = priceToY(candle.close);
                        const highY = priceToY(candle.high);
                        const lowY = priceToY(candle.low);
                        
                        // Draw wick
                        ctx.strokeStyle = isGreen ? '#26a69a' : '#ef5350';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(x, highY);
                        ctx.lineTo(x, lowY);
                        ctx.stroke();
                        
                        // Draw body
                        ctx.fillStyle = isGreen ? '#26a69a' : '#ef5350';
                        const bodyTop = Math.min(openY, closeY);
                        const bodyHeight = Math.max(1, Math.abs(closeY - openY));
                        ctx.fillRect(x - candleWidth / 2, bodyTop, candleWidth, bodyHeight);
                    });
                    
                    // Draw current price line (dotted)
                    const lastCandle = visibleCandles[visibleCandles.length - 1];
                    if (lastCandle) {
                        const currentPriceY = priceToY(lastCandle.close);
                        const isGreen = lastCandle.close >= lastCandle.open;
                        
                        ctx.strokeStyle = isGreen ? '#26a69a' : '#ef5350';
                        ctx.setLineDash([2, 2]);
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(padding.left, currentPriceY);
                        ctx.lineTo(width - padding.right, currentPriceY);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Price label on right
                        ctx.fillStyle = isGreen ? '#26a69a' : '#ef5350';
                        ctx.fillRect(width - padding.right, currentPriceY - 8, padding.right - 5, 16);
                        ctx.fillStyle = '#fff';
                        ctx.font = '10px sans-serif';
                        ctx.textAlign = 'left';
                        ctx.fillText(lastCandle.close.toFixed(5), width - padding.right + 3, currentPriceY + 3);
                    }
                    
                    // Draw price scale on right
                    ctx.fillStyle = '#787b86';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'right';
                    
                    const priceSteps = 5;
                    for (let i = 0; i <= priceSteps; i++) {
                        const price = adjustedMin + (adjustedRange * i / priceSteps);
                        const y = padding.top + (1 - i / priceSteps) * drawHeight;
                        ctx.fillText(price.toFixed(5), width - 5, y + 3);
                    }
                    
                    // Draw time axis at bottom
                    ctx.fillStyle = '#787b86';
                    ctx.textAlign = 'center';
                    const timeSteps = Math.min(5, visibleCandles.length);
                    const step = Math.floor(visibleCandles.length / timeSteps);
                    for (let i = 0; i < timeSteps; i++) {
                        const idx = i * step;
                        if (idx < visibleCandles.length) {
                            const candle = visibleCandles[idx];
                            const x = padding.left + idx * (candleWidth + spacing) + (candleWidth + spacing) / 2;
                            const date = new Date(candle.timestamp);
                            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                            ctx.fillText(timeStr, x, height - 5);
                        }
                    }
                }
                
                
                console.log(' Symbol switcher initialized');
            }
            
            // Run when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSymbolSwitcher);
            } else {
                initSymbolSwitcher();
            }
        })();
        */

        // ========== New Pane Settings Popup ==========
        (function() {
            const popup = document.getElementById('newPaneSettingsPopup');
            const closeBtn = document.getElementById('newPaneSettingsClose');
            const cancelBtn = document.getElementById('newPaneSettingsCancel');
            const okBtn = document.getElementById('newPaneSettingsOk');
            const styleSelect = document.getElementById('newPaneStyleSelect');
            
            if (!popup) return;
            
            // Close popup
            function closePopup() {
                popup.classList.remove('open');
            }
            
            if (closeBtn) closeBtn.addEventListener('click', closePopup);
            if (cancelBtn) cancelBtn.addEventListener('click', closePopup);
            
            // Click outside to close
            popup.addEventListener('click', (e) => {
                if (e.target === popup) closePopup();
            });
            
            // Apply settings
            if (okBtn) {
                okBtn.addEventListener('click', () => {
                    const panel = window._newPaneSettingsTarget;
                    if (panel && panel.chartInstance) {
                        const chart = panel.chartInstance;
                        const chartType = styleSelect?.value || 'candles';
                        
                        // Ensure chartSettings exists
                        if (!chart.chartSettings) {
                            chart.chartSettings = {};
                        }
                        
                        // Apply chart type to panel
                        chart.chartSettings.chartType = chartType;
                        
                        // Get color settings
                        const bodyUp = document.getElementById('newPaneBodyUp')?.dataset.color || '#089981';
                        const bodyDown = document.getElementById('newPaneBodyDown')?.dataset.color || '#f23645';
                        const borderUp = document.getElementById('newPaneBorderUp')?.dataset.color || '#089981';
                        const borderDown = document.getElementById('newPaneBorderDown')?.dataset.color || '#f23645';
                        const wickUp = document.getElementById('newPaneWickUp')?.dataset.color || '#089981';
                        const wickDown = document.getElementById('newPaneWickDown')?.dataset.color || '#f23645';
                        
                        // Apply colors to panel chart settings (use correct property names)
                        chart.chartSettings.candleUpColor = bodyUp;
                        chart.chartSettings.candleDownColor = bodyDown;
                        chart.chartSettings.bodyUpColor = bodyUp;
                        chart.chartSettings.bodyDownColor = bodyDown;
                        chart.chartSettings.borderUpColor = borderUp;
                        chart.chartSettings.borderDownColor = borderDown;
                        chart.chartSettings.wickUpColor = wickUp;
                        chart.chartSettings.wickDownColor = wickDown;
                        
                        // Get checkbox states
                        const showBody = document.getElementById('newPaneShowBody')?.checked ?? true;
                        const showBorder = document.getElementById('newPaneShowBorder')?.checked ?? true;
                        const showWick = document.getElementById('newPaneShowWick')?.checked ?? true;
                        const showPriceLine = document.getElementById('newPaneShowPriceLine')?.checked ?? true;
                        
                        chart.chartSettings.showCandleBody = showBody;
                        chart.chartSettings.showCandleBorders = showBorder;
                        chart.chartSettings.showCandleWick = showWick;
                        chart.chartSettings.showPriceLine = showPriceLine;
                        
                        // Apply chart settings if method exists
                        if (chart.applyChartSettings) {
                            chart.applyChartSettings();
                        }
                        
                        // Re-render
                        chart.render();
                        console.log(` Applied settings to panel: chartType=${chartType}, colors applied`, chart.chartSettings);
                    }
                    closePopup();
                });
            }
            
            // Color swatches - click to open color picker
            const colorSwatches = popup.querySelectorAll('.overlay-color-swatch');
            colorSwatches.forEach(swatch => {
                swatch.style.cursor = 'default';
                swatch.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'color';
                    input.value = swatch.dataset.color;
                    input.style.position = 'absolute';
                    input.style.opacity = '0';
                    document.body.appendChild(input);
                    input.click();
                    input.addEventListener('input', (e) => {
                        swatch.style.background = e.target.value;
                        swatch.dataset.color = e.target.value;
                    });
                    input.addEventListener('change', () => {
                        document.body.removeChild(input);
                    });
                    input.addEventListener('blur', () => {
                        if (document.body.contains(input)) {
                            document.body.removeChild(input);
                        }
                    });
                });
            });
            
            console.log(' New pane settings popup initialized');
        })();

    </script>
    <script>
/* settings panel color swatch handler  must be global */
/*  CROSSHAIR PICKER (global, outside IIFE)  */
window._applyCrosshairSettings=function(color,opacity,width,lineStyle){
    var c=window.chart||window.mainChart;if(!c)return;
    var m=String(color).match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
    var finalColor=m?'rgba('+m[1]+','+m[2]+','+m[3]+','+opacity+')':color;
    c.chartSettings=c.chartSettings||{};
    c.chartSettings.crosshairColor=finalColor;
    c.chartSettings.crosshairWidth=width;
    c.chartSettings.crosshairPattern=lineStyle;
    var btn=document.getElementById('cv_crossBtn');
    if(btn)btn.style.background=finalColor;
    if(c.scheduleRender)c.scheduleRender();
    try{if(c.saveSettings)c.saveSettings();}catch(e){try{localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}catch(e2){}}
};
window._openCrosshairPicker=function(btn){
    var existing=document.getElementById('_crosshairPickerPopup');
    if(existing){existing.remove();return;}
    var c=window.chart||window.mainChart;
    var cs=(c&&c.chartSettings)||{};
    var curColor=cs.crosshairColor||'rgba(120,123,134,0.4)';
    var m=String(curColor).match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)[,\s]*([\d.]*)/);
    var curOpacity=m&&m[4]!==''?parseFloat(m[4]):1;
    var curWidth=cs.crosshairWidth||1;
    var curStyle=cs.crosshairPattern||'dashed';
    var colors=['#ffffff','#d1d4dc','#787b86','#434651','#131722','#f23645','#ff9800','#ffeb3b','#26a69a','#2962ff','#9c27b0','#e91e63','#00bcd4','#4caf50','#ff5722'];
    var swatches=colors.map(function(col){return '<div onclick="window._crosshairPickColor(\''+col+'\')" style="width:22px;height:22px;border-radius:4px;background:'+col+';cursor:pointer;border:2px solid transparent;flex-shrink:0;"></div>';}).join('');
    var thickBtns=[1,2,3,4].map(function(w){return '<div onclick="window._crosshairPickWidth('+w+')" data-w="'+w+'" style="flex:1;height:36px;border-radius:6px;border:2px solid '+(curWidth===w?'#2962ff':'rgba(255,255,255,0.12)')+';background:'+(curWidth===w?'rgba(41,98,255,0.15)':'transparent')+';cursor:pointer;display:flex;align-items:center;justify-content:center;"><div style="width:80%;height:'+w+'px;background:#d1d4dc;border-radius:1px;"></div></div>';}).join('');
    var styleLabels={'solid':'Solid','dashed':'Dashed','dotted':'Dotted'};
    var styleBtns=['solid','dashed','dotted'].map(function(s){return '<div onclick="window._crosshairPickStyle(\''+s+'\')" data-s="'+s+'" style="flex:1;height:36px;border-radius:6px;border:2px solid '+(curStyle===s?'#2962ff':'rgba(255,255,255,0.12)')+';background:'+(curStyle===s?'rgba(41,98,255,0.15)':'transparent')+';cursor:pointer;display:flex;align-items:center;justify-content:center;color:#d1d4dc;font-size:11px;font-weight:600;">'+styleLabels[s]+'</div>';}).join('');
    var popup=document.createElement('div');
    popup.id='_crosshairPickerPopup';
    popup.style.cssText='position:fixed;z-index:1000020;background:#1e222d;border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:16px;width:260px;box-shadow:0 8px 32px rgba(0,0,0,0.5);';
    popup.innerHTML='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">'+swatches+'</div><div style="height:1px;background:rgba(255,255,255,0.08);margin-bottom:12px;"></div><div style="color:#d1d4dc;font-size:12px;margin-bottom:6px;">Opacity</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;"><input id="_cxOpacity" type="range" min="0" max="1" step="0.05" value="'+curOpacity+'" style="flex:1;height:6px;-webkit-appearance:none;appearance:none;border-radius:3px;cursor:pointer;outline:none;background:linear-gradient(to right,#2962ff '+(curOpacity*100)+'%,#363a45 '+(curOpacity*100)+'%);"><span id="_cxOpacityVal" style="color:#2962ff;font-size:12px;font-weight:600;min-width:38px;text-align:right;">'+(Math.round(curOpacity*100))+'%</span></div><div style="color:#d1d4dc;font-size:12px;margin-bottom:6px;">Thickness</div><div style="display:flex;gap:6px;margin-bottom:14px;">'+thickBtns+'</div><div style="color:#d1d4dc;font-size:12px;margin-bottom:6px;">Line style</div><div style="display:flex;gap:6px;">'+styleBtns+'</div>';
    var rect=btn.getBoundingClientRect();
    popup.style.left=Math.min(rect.left,window.innerWidth-280)+'px';
    popup.style.top=(rect.bottom+6)+'px';
    document.body.appendChild(popup);
    popup._color=curColor;popup._opacity=curOpacity;popup._width=curWidth;popup._style=curStyle;
    var opSlider=document.getElementById('_cxOpacity');
    var opVal=document.getElementById('_cxOpacityVal');
    opSlider.addEventListener('input',function(){
        var v=parseFloat(opSlider.value);
        opSlider.style.background='linear-gradient(to right,#2962ff '+(v*100)+'%,#363a45 '+(v*100)+'%)';
        opVal.textContent=Math.round(v*100)+'%';
        popup._opacity=v;
        window._applyCrosshairSettings(popup._color,popup._opacity,popup._width,popup._style);
    });
    setTimeout(function(){
        document.addEventListener('mousedown',function _close(e){
            if(!popup.contains(e.target)&&e.target!==btn){popup.remove();document.removeEventListener('mousedown',_close);}
        });
    },100);
};
window._crosshairPickColor=function(color){var p=document.getElementById('_crosshairPickerPopup');if(!p)return;p._color=color;window._applyCrosshairSettings(p._color,p._opacity,p._width,p._style);};
window._crosshairPickWidth=function(w){var p=document.getElementById('_crosshairPickerPopup');if(!p)return;p._width=w;p.querySelectorAll('[data-w]').forEach(function(d){var a=parseInt(d.dataset.w)===w;d.style.borderColor=a?'#2962ff':'rgba(255,255,255,0.12)';d.style.background=a?'rgba(41,98,255,0.15)':'transparent';});window._applyCrosshairSettings(p._color,p._opacity,p._width,p._style);};
window._crosshairPickStyle=function(s){var p=document.getElementById('_crosshairPickerPopup');if(!p)return;p._style=s;p.querySelectorAll('[data-s]').forEach(function(d){var a=d.dataset.s===s;d.style.borderColor=a?'#2962ff':'rgba(255,255,255,0.12)';d.style.background=a?'rgba(41,98,255,0.15)':'transparent';});window._applyCrosshairSettings(p._color,p._opacity,p._width,p._style);};
window._openCrosshairColorPicker=function(btn){
    var c=window.chart||window.mainChart;
    var cs=(c&&c.chartSettings)||{};
    var curColor=cs.crosshairColor||'#787b86';
    var curWidth=cs.crosshairWidth||1;
    var curStyle=cs.crosshairPattern||'dashed';
    if(window.openColorPicker){
        window.openColorPicker(curColor,function(v){
            var swatch=document.getElementById('_cxColorSwatch');
            if(swatch)swatch.style.background=v;
            var c2=window.chart||window.mainChart;
            if(!c2)return;
            c2.chartSettings=c2.chartSettings||{};
            c2.chartSettings.crosshairColor=v;
            if(c2.scheduleRender)c2.scheduleRender();
            try{if(c2.saveSettings)c2.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c2.chartSettings));}
        },btn,{
            showThickness:true,
            thickness:curWidth,
            onThickness:function(w){
                var c2=window.chart||window.mainChart;
                if(!c2)return;
                c2.chartSettings=c2.chartSettings||{};
                c2.chartSettings.crosshairWidth=w;
                if(c2.scheduleRender)c2.scheduleRender();
                try{if(c2.saveSettings)c2.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c2.chartSettings));}
            },
            showLineStyle:true,
            lineStyle:curStyle,
            onLineStyle:function(s){
                var c2=window.chart||window.mainChart;
                if(!c2)return;
                c2.chartSettings=c2.chartSettings||{};
                c2.chartSettings.crosshairPattern=s;
                if(c2.scheduleRender)c2.scheduleRender();
                try{if(c2.saveSettings)c2.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c2.chartSettings));}
                var dashMap={solid:'none',dashed:'8 4',dotted:'2 4'};
                var lineEl=document.getElementById('_cxLinePreview');
                if(lineEl)lineEl.setAttribute('stroke-dasharray',dashMap[s]||'none');
            }
        });
    }
};
window._spClr=function(btn){
    var c=btn.dataset.color||'#2962ff';
    console.log('[SP] _spClr called, color=',c,'openColorPicker=',typeof window.openColorPicker);
    if(window.openColorPicker){
        window.openColorPicker(c,function(v){
            console.log('[SP] color picked:',v);
            btn.style.background=v;
            btn.dataset.color=v;
            if(btn._onChange)btn._onChange(v);
        },btn);
    } else {
        console.error('[SP] window.openColorPicker not defined!');
    }
};
/*  SETTINGS PANEL  fully inlined v3  */
try{
(function(){
var P={};

/* helpers */
function ch(){ return window.chart||window.mainChart||null; }
function apply(){ var c=ch(); if(!c)return; if(c.applyChartSettings)c.applyChartSettings(); if(c.scheduleRender)c.scheduleRender(); else if(c.render)c.render(); try{if(c.saveSettings)c.saveSettings();}catch(e){try{localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}catch(e2){}} }
function set(k,v){ var c=ch(); if(!c)return; c.chartSettings=c.chartSettings||{}; c.chartSettings[k]=v; apply(); }
function sess(){ try{return window.backtestingSession||JSON.parse(localStorage.getItem('backtestingSession')||'{}')||{};}catch(e){return{};} }
function saveSess(s){ window.backtestingSession=s; try{localStorage.setItem('backtestingSession',JSON.stringify(s));}catch(e){} var c=ch(); if(c)c.backtestingSession=s; }
function gLoad(){ try{return JSON.parse(localStorage.getItem('talaria_general_settings')||'{}');}catch(e){return{};} }
function gSave(p){ var c=Object.assign({},gLoad(),p); try{localStorage.setItem('talaria_general_settings',JSON.stringify(c));}catch(e){} window.generalSettings=c; return c; }

/* builders */
var CSV='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
function sec(c){ return '<div class="settings-section">'+c+'</div>'; }
function st(t){ return '<div class="settings-section-title" style="margin-top:4px;">'+t+'</div>'; }
function chk(label,id,on){ return '<div class="settings-checkbox-item'+(on?' checked':'')+'" id="ck_'+id+'" style="cursor:pointer;"><div class="settings-checkbox">'+CSV+'</div><span class="settings-checkbox-label">'+label+'</span></div>'; }
function irow(label,id,val,mn,mx,step){ return '<div class="settings-input-row"><span class="settings-input-label">'+label+'</span><input type="number" id="nr_'+id+'" class="settings-input" value="'+val+'" min="'+mn+'" max="'+mx+'" step="'+(step||1)+'"></div>'; }
function sel(label,id,opts,cur){ var o=opts.map(function(x){return '<option value="'+x[0]+'"'+(x[0]===String(cur)?' selected':'')+'>'+x[1]+'</option>';}).join(''); return '<div class="settings-input-row"><span class="settings-input-label">'+label+'</span><select id="sl_'+id+'" class="settings-select" style="margin-left:auto;max-width:168px;">'+o+'</select></div>'; }
function selI(id,opts,cur,w){ var o=opts.map(function(x){return '<option value="'+x[0]+'"'+(x[0]===String(cur)?' selected':'')+'>'+x[1]+'</option>';}).join(''); return '<select id="sl_'+id+'" class="settings-select" style="width:'+(w||'130px')+';flex-shrink:0;">'+o+'</select>'; }
function clr(label,id,val){ var safeVal=String(val||'#000000'); return '<div class="settings-input-row"><span class="settings-input-label">'+label+'</span><button id="sw_'+id+'" data-color="'+safeVal+'" onclick="window._spClr(this)" style="width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.18);background:'+safeVal+';cursor:pointer;flex-shrink:0;transition:transform .12s,box-shadow .12s;" onmouseover="this.style.transform=\'scale(1.1)\';this.style.boxShadow=\'0 0 0 2px rgba(41,98,255,0.45)\'" onmouseout="this.style.transform=\'scale(1)\';this.style.boxShadow=\'none\'"></button></div>'; }
function rng(label,id,val,mn,mx){ return '<div class="settings-slider-group"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div class="settings-slider-label" style="margin:0;">'+label+'</div><span id="rv_'+id+'" style="color:#2962ff;font-size:12px;font-weight:600;">'+val+'</span></div><input type="range" class="settings-slider" id="rng_'+id+'" min="'+mn+'" max="'+mx+'" value="'+val+'"><div style="display:flex;justify-content:space-between;font-size:11px;color:#787b86;margin-top:5px;"><span>'+mn+'</span><span>'+mx+'</span></div></div>'; }
function savebtn(id,label){ return '<button id="'+id+'" style="width:100%;padding:10px;background:#2962ff;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;margin-top:12px;">'+label+'</button>'; }
function cancelbtn(id,label){ return '<button id="'+id+'" style="width:100%;padding:10px;background:transparent;color:#787b86;border:1px solid rgba(255,255,255,0.1);border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;margin-top:6px;">'+label+'</button>'; }
function toHex(c){ if(!c)return '#000000'; if(/^#[0-9a-f]{6}$/i.test(c))return c; var m=String(c).match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/); if(m)return '#'+[m[1],m[2],m[3]].map(function(n){return('0'+parseInt(n).toString(16)).slice(-2);}).join(''); return '#000000'; }

/* wirers */
function wChk(id,fn){ var el=document.getElementById('ck_'+id); if(el)el.addEventListener('click',function(){this.classList.toggle('checked');fn(this.classList.contains('checked'));}); }
function wSel(id,fn){ var el=document.getElementById('sl_'+id); if(el)el.addEventListener('change',function(){fn(this.value);}); }
function wNum(id,fn){ var el=document.getElementById('nr_'+id); if(el)el.addEventListener('change',function(){fn(parseFloat(this.value)||0);}); }
function wRng(id,fn){ var el=document.getElementById('rng_'+id),rv=document.getElementById('rv_'+id); if(el)el.addEventListener('input',function(){if(rv)rv.textContent=this.value;fn(parseFloat(this.value));}); }
function wClr(id,fn){
    var sw=document.getElementById('sw_'+id);
    if(sw)sw._onChange=fn;
}

/*  SYMBOL  */
P['symbol']={title:'Symbol',build:function(){
    var c=ch(),cs=(c&&c.chartSettings)||{};
    var type=cs.chartType||'candles';
    var bU=cs.bodyUpColor||cs.candleUpColor||'#089981',bD=cs.bodyDownColor||cs.candleDownColor||'#f23645';
    var brU=cs.borderUpColor||bU,brD=cs.borderDownColor||bD,wU=cs.wickUpColor||bU,wD=cs.wickDownColor||bD;
    var lC=cs.lineColor||bU;
    var aL=cs.areaLineColor||bU,aF=cs.areaFillColor||'rgba(8,153,129,0.28)';
    var isCandleType=['candles','hollow','heikinashi'].indexOf(type)!==-1;
    var colorSec='';
    if(isCandleType){
        colorSec=sec(st('CANDLES')+
            '<div class="tv-row">'+chk('Body','showBody',cs.showCandleBody!==false)+clr('','bodyUp',bU)+clr('','bodyDn',bD)+'</div>'+
            '<div class="tv-row">'+chk('Borders','showBdr',cs.showCandleBorders!==false)+clr('','bdrUp',brU)+clr('','bdrDn',brD)+'</div>'+
            '<div class="tv-row">'+chk('Wick','showWick',cs.showCandleWick!==false)+clr('','wkUp',wU)+clr('','wkDn',wD)+'</div>');
    } else if(type==='bars'){
        colorSec=sec(st('BARS')+
            '<div class="tv-row">'+chk('Up bar','showBody',cs.showCandleBody!==false)+clr('','bodyUp',bU)+'</div>'+
            '<div class="tv-row">'+chk('Down bar','showBdr',true)+clr('','bodyDn',bD)+'</div>');
    } else if(type==='line'){
        colorSec=sec(st('LINE')+clr('Line color','bodyUp',lC));
    } else if(type==='area'){
        colorSec=sec(st('AREA')+clr('Line color','bodyUp',aL)+clr('Fill color','areaFill',aF));
    } else if(type==='baseline'){
        colorSec=sec(st('BASELINE')+clr('Upper color','bodyUp',bU)+clr('Lower color','bodyDn',bD));
    }
    return sec(st('CHART TYPE')+sel('Type','sym_type',[['candles','Candlestick'],['hollow','Hollow Candles'],['heikinashi','Heikin Ashi'],['bars','Bar'],['line','Line'],['area','Area'],['baseline','Baseline']],type))+
    colorSec+
    sec(st('DATA')+
        sel('Precision','sym_prec',[['default','Default'],['0','0'],['1','0.0'],['2','0.00'],['3','0.000'],['4','0.0000'],['5','0.00000']],cs.pricePrecision||'default')+
        sel('Timezone','sym_tz',[['UTC','UTC'],['America/New_York','(UTC-5) New York'],['America/Chicago','(UTC-6) Chicago'],['America/Los_Angeles','(UTC-8) Los Angeles'],['Europe/London','(UTC+0) London'],['Europe/Paris','(UTC+1) Paris'],['Europe/Moscow','(UTC+3) Moscow'],['Asia/Dubai','(UTC+4) Dubai'],['Asia/Tokyo','(UTC+9) Tokyo'],['Asia/Shanghai','(UTC+8) Shanghai'],['Australia/Sydney','(UTC+10) Sydney']],cs.timezone||sess().timezone||'America/New_York'));
},wire:function(){
    wChk('showBody',function(v){set('showCandleBody',v);});
    wChk('showBdr',function(v){set('showCandleBorders',v);});
    wChk('showWick',function(v){set('showCandleWick',v);});
    wClr('bodyUp',function(v){set('bodyUpColor',v);set('candleUpColor',v);set('lineColor',v);set('areaLineColor',v);});
    wClr('bodyDn',function(v){set('bodyDownColor',v);set('candleDownColor',v);});
    wClr('bdrUp',function(v){set('borderUpColor',v);});
    wClr('bdrDn',function(v){set('borderDownColor',v);});
    wClr('wkUp',function(v){set('wickUpColor',v);});
    wClr('wkDn',function(v){set('wickDownColor',v);});
    wClr('areaFill',function(v){set('areaFillColor',v);});
    wSel('sym_type',function(v){set('chartType',v);loadSection('symbol');});
    wSel('sym_prec',function(v){set('pricePrecision',v);var c=ch();if(c){c.chartSettings=c.chartSettings||{};c.chartSettings.pricePrecision=v;if(c.scheduleRender)c.scheduleRender();}});
    wSel('sym_tz',function(v){set('timezone',v);var s=sess();s.timezone=v;saveSess(s);if(window.timezoneManager&&window.timezoneManager.setTimezone)window.timezoneManager.setTimezone(v);});
}};

/*  STATUS LINE  */
P['statusline']={title:'Status line',build:function(){
    var cs=(ch()&&ch().chartSettings)||{};
    return sec(st('OHLC BAR')+chk('Show OHLC values on chart','showVals',cs.showChartValues!==false)+chk('Show bar change % values','showBar',cs.showBarChangeValues!==false))+
    sec(st('INDICATOR LEGEND')+chk('Show indicator titles','indTitles',cs.showIndicatorTitles!==false)+chk('Show indicator arguments','indArgs',cs.showIndicatorArguments!==false)+chk('Show indicator values','indVals',cs.showIndicatorValues!==false))+
    sec(st('SYMBOL LABEL')+chk('Show symbol name','symTitle',cs.symbolTitle!==false)+sel('Label format','symFmt',[['Description','Description'],['Ticker','Ticker'],['Both','Ticker + Description']],cs.symbolTitleFormat||'Description')+clr('Label color','symClr',cs.symbolTextColor||'#d1d4dc'));
},wire:function(){
    wChk('showVals',function(v){set('showChartValues',v);});wChk('showBar',function(v){set('showBarChangeValues',v);});
    wChk('indTitles',function(v){set('showIndicatorTitles',v);});wChk('indArgs',function(v){set('showIndicatorArguments',v);});wChk('indVals',function(v){set('showIndicatorValues',v);});
    wChk('symTitle',function(v){set('symbolTitle',v);});wSel('symFmt',function(v){set('symbolTitleFormat',v);});wClr('symClr',function(v){set('symbolTextColor',v);});
}};

/*  SCALES AND LINES  */
P['scales']={title:'Scales and lines',build:function(){
    var c=ch(),cs=(c&&c.chartSettings)||{};
    var pm=(c&&c.priceScale&&c.priceScale.mode)||cs.priceScaleMode||'linear';
    return sec(st('PRICE SCALE')+sel('Mode','sc_mode',[['linear','Normal (linear)'],['log','Logarithmic'],['percent','Percentage']],pm)+chk('Show price line','sc_priceLine',cs.showPriceLine!==false)+clr('Price line color','sc_priceClr',cs.priceLineColor||'#2962ff'))+
    sec(st('GRID')+chk('Show grid lines','sc_grid',cs.showGrid!==false)+clr('Grid color','sc_gridClr',cs.gridColor||'rgba(42,46,57,0.6)'))+
    sec(st('CROSSHAIR')+chk('Show crosshair','sc_cross',cs.showCrosshair!==false)+clr('Crosshair color','sc_crossClr',cs.crosshairColor||'rgba(120,123,134,0.6)')+sel('Style','sc_crossStyle',[['dashed','Dashed'],['solid','Solid'],['dotted','Dotted']],cs.crosshairPattern||'dashed')+chk('Magnet to OHLC','sc_magnet',!!(gLoad().magnetCrosshair)))+
    sec(st('SCALE LABELS')+clr('Text color','sc_textClr',cs.scaleTextColor||'#d1d4dc')+sel('Font size','sc_font',[['10','10px'],['11','11px'],['12','12px'],['14','14px'],['16','16px']],String(cs.scaleFontSize||'12'))+irow('Right margin (bars)','sc_rOff',(c&&c.timeScale&&c.timeScale.rightOffset)||50,0,300));
},wire:function(){
    wSel('sc_mode',function(v){var c=ch();if(!c)return;c.priceScale=c.priceScale||{};c.priceScale.mode=v;set('priceScaleMode',v);});
    wChk('sc_priceLine',function(v){set('showPriceLine',v);});wClr('sc_priceClr',function(v){set('priceLineColor',v);});
    wChk('sc_grid',function(v){set('showGrid',v);});wClr('sc_gridClr',function(v){set('gridColor',v);});
    wChk('sc_cross',function(v){set('showCrosshair',v);});wClr('sc_crossClr',function(v){set('crosshairColor',v);});wSel('sc_crossStyle',function(v){set('crosshairPattern',v);});
    wChk('sc_magnet',function(v){gSave({magnetCrosshair:v});var c=ch();if(!c)return;c.magnetMode=v?'on':'off';});
    wClr('sc_textClr',function(v){set('scaleTextColor',v);});
    wSel('sc_font',function(v){var n=parseInt(v);set('scaleFontSize',n);set('scaleAxisFontSize',n);});
    wNum('sc_rOff',function(v){var c=ch();if(!c)return;c.timeScale=c.timeScale||{};c.timeScale.rightOffset=v;apply();});
}};

/*  CANVAS  */
P['canvas']={title:'Canvas',build:function(){
    var c=ch(),cs=(c&&c.chartSettings)||{};
    var gridStyle=cs.gridStyle||'Vert and horz';
    var ro=(c&&c.timeScale&&c.timeScale.rightOffset!=null)?c.timeScale.rightOffset:10;
    return sec(st('CHART BASIC STYLES')+
        '<div class="tv-row" style="margin-bottom:10px;">'+
            '<span class="settings-input-label" style="flex:1;">Background</span>'+
            clr('','cv_bg',cs.backgroundColor||'#050028')+
        '</div>'+
        '<div class="tv-row" style="margin-bottom:10px;">'+
            '<span class="settings-input-label" style="flex:1;">Grid lines</span>'+
            selI('cv_grid',[['Vert and horz','Vert and horz'],['Vertical','Vert only'],['Horizontal','Horz only'],['None','No lines']],gridStyle)+
            clr('','cv_gridClr',cs.gridColor||'rgba(42,46,57,0.6)')+
        '</div>'+
        '<div class="tv-row" style="margin-bottom:10px;">'+
            '<span class="settings-input-label" style="flex:1;">Crosshair</span>'+
            (function(){
                var col=cs.crosshairColor||'#787b86';
                var dashMap={solid:'none',dashed:'8 4',dotted:'2 4'};
                var dash=dashMap[cs.crosshairPattern||'dashed']||'8 4';
                return '<button onclick="window._openCrosshairColorPicker(this)" style="display:flex;align-items:center;gap:6px;padding:4px 8px;height:28px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;cursor:pointer;flex-shrink:0;"><div id="_cxColorSwatch" style="width:13px;height:13px;border-radius:3px;background:'+col+';flex-shrink:0;"></div><svg width="32" height="10"><line id="_cxLinePreview" x1="2" y1="5" x2="30" y2="5" stroke="#d1d4dc" stroke-width="1.5" stroke-dasharray="'+dash+'"/></svg></button>';
            })()+
        '</div>')+
    sec(st('SCALES')+
            '<div class="tv-row" style="margin-bottom:10px;">'+
                '<span class="settings-input-label" style="flex:1;">Text</span>'+
                clr('','cv_scaleText',cs.scaleTextColor||'#ffffff')+
                selI('cv_scaleFont',[['8','8'],['9','9'],['10','10'],['11','11'],['12','12'],['13','13'],['14','14']],String(cs.scaleTextSize||cs.scaleFontSize||'12'),'72px')+
            '</div>'+
            '<div class="tv-row" style="margin-bottom:4px;">'+
                '<span class="settings-input-label" style="flex:1;">Lines</span>'+
                clr('','cv_scaleLines',cs.scaleLinesColor||'#2a2e39')+
            '</div>')+
    sec(st('MARGINS')+
        irow('Right (bars)','cv_marginRight',ro,0,300));
},wire:function(){
    wClr('cv_bg',function(v){
        var c=ch();if(!c)return;
        c.chartSettings.backgroundColor=v;
        c.canvas.style.backgroundColor=v;
        var el=document.querySelector('.chart-container');if(el)el.style.backgroundColor=v;
        if(c.scheduleRender)c.scheduleRender();
        try{if(c.saveSettings)c.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}
    });
    wSel('cv_grid',function(v){
        var c=ch();if(!c)return;
        c.chartSettings.gridStyle=v;
        c.chartSettings.showGrid=(v!=='None');
        if(c.scheduleRender)c.scheduleRender();
        try{if(c.saveSettings)c.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}
    });
    wClr('cv_gridClr',function(v){set('gridColor',v);});
    wClr('cv_scaleText',function(v){
        var c=ch();if(!c)return;
        c.chartSettings.scaleTextColor=v;
        if(c.applyChartSettings)c.applyChartSettings();
        if(c.scheduleRender)c.scheduleRender();
        try{if(c.saveSettings)c.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}
    });
    wSel('cv_scaleFont',function(v){
        var n=parseInt(v);
        var c=ch();if(!c)return;
        c.chartSettings.scaleTextSize=n;
        c.chartSettings.scaleFontSize=n;
        if(c.scheduleRender)c.scheduleRender();
        try{if(c.saveSettings)c.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}
    });
    wClr('cv_scaleLines',function(v){
        var c=ch();if(!c)return;
        c.chartSettings.scaleLinesColor=v;
        c.chartSettings.cursorLabelBgColor=v;
        var pl=document.querySelector('.price-label'),tl=document.querySelector('.time-label');
        if(pl)pl.style.background=v;
        if(tl)tl.style.background=v;
        if(c.scheduleRender)c.scheduleRender();
        try{if(c.saveSettings)c.saveSettings();}catch(e){localStorage.setItem('chartSettings',JSON.stringify(c.chartSettings));}
    });
    wNum('cv_marginRight',function(v){var c=ch();if(!c)return;c.timeScale=c.timeScale||{};c.timeScale.rightOffset=v;if(c.scheduleRender)c.scheduleRender();});
}};

/*  TRADING  */
P['trading']={title:'Trading',build:function(){
    var g=gLoad(),s=sess(),mode=g.orderPlacementMode||'instant',lev=parseInt(s.leverage||100,10);
    return sec(st('ORDER PLACEMENT')+
        '<div class="settings-radio-group">'+
        '<div class="settings-radio-item'+(mode==='instant'?' selected':'')+'" id="rad_instant" style="cursor:pointer;"><div class="settings-radio-circle"></div><div class="settings-radio-content"><h4>Instant</h4><p>Orders placed immediately at market price</p></div></div>'+
        '<div class="settings-radio-item'+(mode==='confirmation'?' selected':'')+'" id="rad_confirm" style="cursor:pointer;"><div class="settings-radio-circle"></div><div class="settings-radio-content"><h4>Confirmation</h4><p>Show a modal before each order is placed</p></div></div>'+
        '</div>')+
    sec(st('CHART OVERLAYS')+chk('Show order history on chart','tr_orderHist',g.showOrderHistory!==false)+chk('Show open orders on chart','tr_openOrders',g.showOpenOrders!==false))+
    sec(st('LEVERAGE')+rng('Leverage (1:x)','tr_lev',lev,1,500)+irow('Enter value','tr_levVal',lev,1,500))+
    sec(st('COMMISSIONS')+irow('Average spread (pips)','tr_spread',s.averageSpread||0,0,100,0.1)+irow('Slippage (pips)','tr_slip',s.slippage||0,0,100,0.1)+sel('Commission type','tr_commType',[['none','None'],['per_trade','Per trade (fixed)'],['per_lot','Per lot'],['percent','% of value']],s.commissionType||'none')+irow('Commission value','tr_commVal',s.commissionValue||0,0,1000,0.01))+
    savebtn('tr_save','Save Trading Settings');
},wire:function(){
    ['instant','confirm'].forEach(function(v){var el=document.getElementById('rad_'+v);if(!el)return;el.addEventListener('click',function(){document.querySelectorAll('.settings-radio-item').forEach(function(r){r.classList.remove('selected');});this.classList.add('selected');var m=v==='instant'?'instant':'confirmation';gSave({orderPlacementMode:m});window.orderPlacementMode=m;var c=ch();if(c&&c.orderManager)c.orderManager.placementMode=m;});});
    wChk('tr_orderHist',function(v){gSave({showOrderHistory:v});set('showOrderHistory',v);});
    wChk('tr_openOrders',function(v){gSave({showOpenOrders:v});set('showOpenOrders',v);});
    var rnEl=document.getElementById('rng_tr_lev'),nmEl=document.getElementById('nr_tr_levVal');
    if(rnEl&&nmEl){rnEl.addEventListener('input',function(){nmEl.value=this.value;var rv=document.getElementById('rv_tr_lev');if(rv)rv.textContent=this.value;});nmEl.addEventListener('change',function(){var v=Math.max(1,Math.min(500,parseInt(this.value)||1));rnEl.value=v;var rv=document.getElementById('rv_tr_lev');if(rv)rv.textContent=v;});}
    var sb=document.getElementById('tr_save');
    if(sb)sb.addEventListener('click',function(){
        var lv=parseInt((nmEl?nmEl.value:100))||100;
        function nv(id){var el=document.getElementById('nr_'+id);return el?parseFloat(el.value)||0:0;}
        function sv(id){var el=document.getElementById('sl_'+id);return el?el.value:'none';}
        var s=sess();s.leverage=lv;s.averageSpread=nv('tr_spread');s.slippage=nv('tr_slip');s.commissionType=sv('tr_commType');s.commissionValue=nv('tr_commVal');saveSess(s);
        gSave({});
        document.querySelectorAll('#challengeLeverage,.leverage-value').forEach(function(el){el.textContent='1:'+lv;});
        this.textContent='Saved ';this.style.background='#089981';var self=this;setTimeout(function(){self.textContent='Save Trading Settings';self.style.background='#2962ff';},1800);
    });
}};

/*  aliases for any legacy callers  */
P['general']=P['symbol']; P['chart']=P['scales']; P['project']=P['trading']; P['leverage']=P['trading']; P['commissions']=P['trading'];

/*  Watchlist  */
P['watchlist']={
    build:function(){
        var src=document.getElementById('watchlistContent');
        return src?src.innerHTML:'<p style="color:#787b86;padding:20px 0;">Watchlist not available.</p>';
    },
    wire:function(){
        var ctx=document.getElementById('settingsPanelContent'); if(!ctx)return;
        var inp=ctx.querySelector('#watchlistSearchInput');
        if(inp&&window.loadWatchlistItems) window.loadWatchlistItems();
        var addBtn=ctx.querySelector('#addSymbolBtn');
        var origAdd=document.getElementById('addSymbolBtn');
        if(addBtn&&origAdd) addBtn.onclick=function(){ origAdd.click(); };
        if(window.loadWatchlistItems) window.loadWatchlistItems();
    }
};

/*  News  */
P['news']={
    build:function(){
        var src=document.getElementById('newsContent');
        return src?src.innerHTML:'<p style="color:#787b86;padding:20px 0;">News not available.</p>';
    },
    wire:function(){}
};

/*  Alerts  */
P['alerts']={
    build:function(){
        var src=document.getElementById('alertsContent');
        return src?src.innerHTML:'<p style="color:#787b86;padding:20px 0;">No alerts yet.</p>';
    },
    wire:function(){
        var ctx=document.getElementById('settingsPanelContent'); if(!ctx)return;
        var newList=ctx.querySelector('#alertsList');
        var addBtn=ctx.querySelector('#addAlertBtn');
        if(window.alertSystem){
            if(newList){window.alertSystem.alertsList=newList;window.alertSystem.refreshAlertsList();}
            if(addBtn){addBtn.onclick=function(){window.alertSystem.showCreateAlertModal();};}
        }
    }
};

/*  Help  */
P['help']={
    build:function(){
        var src=document.querySelector('#helpPanel .side-panel-body');
        return src?src.innerHTML:'';
    },
    wire:function(){
        var ctx=document.getElementById('settingsPanelContent'); if(!ctx)return;
        var c=ctx.querySelector('#helpContactSupport'); if(c)c.onclick=function(){window.open('mailto:support@talaria.com','_blank');};
        var k=ctx.querySelector('#helpKeyboardShortcuts'); if(k)k.onclick=function(){if(window.toggleKeyboardShortcuts)window.toggleKeyboardShortcuts();};
    }
};

/*  Profile  */
P['profile']={
    build:function(){
        var src=document.querySelector('#profilePanel .side-panel-body');
        return src?src.innerHTML:'';
    },
    wire:function(){
        var ctx=document.getElementById('settingsPanelContent'); if(!ctx)return;
        var t=ctx.querySelector('#profileTheme2');
        if(t)t.onclick=function(){
            document.body.classList.toggle('light-mode');
            var v=ctx.querySelector('#profileThemeValue2');
            if(v)v.textContent=document.body.classList.contains('light-mode')?'Light':'Dark';
        };
        var a=ctx.querySelector('#profileAccount2'); if(a)a.onclick=function(){window.location.href='/profile';};
        var l=ctx.querySelector('#profileLogout2'); if(l)l.onclick=function(){window.location.href='/logout';};
    }
};

/*  DOM wiring  */
function loadSection(type){
    var titles={symbol:'Symbol',statusline:'Status line',scales:'Scales and lines',canvas:'Canvas',trading:'Trading',general:'Symbol',chart:'Scales and lines',project:'Trading',leverage:'Trading',commissions:'Trading',alerts:'Alerts',help:'Help',profile:'Profile'};
    var titleEl=document.getElementById('spContentTitle');
    if(titleEl)titleEl.textContent=titles[type]||type;
    document.querySelectorAll('.sp-nav-item').forEach(function(n){n.classList.toggle('active',n.dataset.settings===type);});
    var el=document.getElementById('settingsPanelContent');
    if(!el)return;
    var def=P[type]||(window._spPanels&&window._spPanels[type]);
    try{ el.innerHTML=def?def.build():'<p style="color:#787b86;padding:20px 0;">Coming soon.</p>'; }catch(e){ el.innerHTML='<p style="color:#f23645;">Error: '+e.message+'</p>'; console.error(e); }
    try{ if(def&&def.wire)def.wire(); }catch(e){ console.error(e); }
}

window._spLoad=function(type,el){document.querySelectorAll('.sp-nav-item').forEach(function(n){n.classList.remove('active');});if(el)el.classList.add('active');loadSection(type);};

var panel=null,btn=null,closeB=null;

var _spBottomInterval=null;
function _syncSpBottom(){if(!panel)return;var ct=document.querySelector('.container');var b=ct?parseFloat(ct.style.bottom)||0:0;panel.style.bottom=b+'px';}
function openPanel(section){if(!panel)return;['helpPanel','profilePanel'].forEach(function(pid){var p=document.getElementById(pid);if(p)p.classList.remove('open');});panel.classList.add('open');_syncSpBottom();loadSection(section||'symbol');var w=document.getElementById('chartWrapper');if(w)w.classList.add('settings-open');_spBottomInterval=setInterval(_syncSpBottom,200);var c=ch();if(c&&c.resize){setTimeout(function(){c.resize();if(c.scheduleRender)c.scheduleRender();},290);}}
function closePanel(){if(!panel)return;panel.classList.remove('open');if(_spBottomInterval){clearInterval(_spBottomInterval);_spBottomInterval=null;}var w=document.getElementById('chartWrapper');if(w)w.classList.remove('settings-open');var c=ch();if(c&&c.resize){setTimeout(function(){c.resize();if(c.scheduleRender)c.scheduleRender();},290);}}
window._spToggle=function(){if(!panel)panel=document.getElementById('settingsPanel');if(!panel)return;panel.classList.contains('open')?closePanel():openPanel();};  
window._spOpen=function(section){if(!panel)panel=document.getElementById('settingsPanel');if(!panel)return;var navItem=document.querySelector('.sp-nav-item[data-settings="'+section+'"]');document.querySelectorAll('.sp-nav-item').forEach(function(n){n.classList.remove('active');});if(navItem)navItem.classList.add('active');if(panel.classList.contains('open')){loadSection(section);}else{openPanel(section);}};
/*  Side Panel management  */
window._openSidePanel=function(id){
    var all=['helpPanel','profilePanel'];
    if(!panel)panel=document.getElementById('settingsPanel');
    if(panel&&panel.classList.contains('open'))closePanel();
    all.forEach(function(pid){
        if(pid!==id){var p=document.getElementById(pid);if(p)p.classList.remove('open');}
    });
    var p=document.getElementById(id);
    if(p){if(p.classList.contains('open'))p.classList.remove('open');else p.classList.add('open');}
};
window._closeSidePanel=function(id){
    var p=document.getElementById(id);
    if(p)p.classList.remove('open');
};
document.addEventListener('click',function(e){
    var triggerIds=['toolbarAlertsBtn','helpBtn','profileBtn'];
    var isBtn=triggerIds.some(function(id){var b=document.getElementById(id);return b&&b.contains(e.target);});
    if(isBtn)return;
    var cp=document.getElementById('custom-color-picker');
    if(cp&&cp.contains(e.target))return;
    ['helpPanel','profilePanel'].forEach(function(pid){
        var p=document.getElementById(pid);
        if(p&&p.classList.contains('open')&&!p.contains(e.target))p.classList.remove('open');
    });
},true);
window._spLoad=function(type,el){if(!panel)panel=document.getElementById('settingsPanel');document.querySelectorAll('.sp-nav-item').forEach(function(n){n.classList.remove('active');});if(el)el.classList.add('active');loadSection(type);};

function _spWireDom(){
    panel  = document.getElementById('settingsPanel');
    btn    = document.getElementById('settingsBtn');
    closeB = document.getElementById('settingsPanelClose');
    if(!panel){console.error('[SP] settingsPanel element not found!');return;}
    console.log('[SP] DOM wired. panel=',!!panel,'btn=',!!btn);
    if(closeB)closeB.addEventListener('click',function(e){e.stopPropagation();closePanel();});
    document.querySelectorAll('.sp-nav-item[data-settings]').forEach(function(item){
        item.addEventListener('click',function(e){e.stopPropagation();window._spLoad(this.dataset.settings,this);});
    });
}

if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',_spWireDom);
}else{
    _spWireDom();
}

/*  Register Help / Profile / Alerts sections in settings panel  */
(function registerExtraSections(){
    function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',fn); else fn(); }
    ready(function(){
        var P=window._spPanels; if(!P){ setTimeout(arguments.callee,200); return; }

        P['help']={
            title:'Help',
            build:function(){
                var src=document.querySelector('#helpPanel .side-panel-body');
                return '<div class="sp-embedded">'+(src?src.innerHTML:'')+'</div>';
            },
            wire:function(){
                var ctx=document.getElementById('settingsPanelContent');
                if(!ctx) return;
                var c=ctx.querySelector('#helpContactSupport');
                if(c) c.onclick=function(){ window.open('mailto:support@talaria.com','_blank'); };
                var k=ctx.querySelector('#helpKeyboardShortcuts');
                if(k) k.onclick=function(){ if(window.toggleKeyboardShortcuts) window.toggleKeyboardShortcuts(); };
            }
        };

        P['profile']={
            title:'Profile',
            build:function(){
                var src=document.querySelector('#profilePanel .side-panel-body');
                return '<div class="sp-embedded">'+(src?src.innerHTML:'')+'</div>';
            },
            wire:function(){
                var ctx=document.getElementById('settingsPanelContent');
                if(!ctx) return;
                var t=ctx.querySelector('#profileTheme2');
                if(t) t.onclick=function(){
                    document.body.classList.toggle('light-mode');
                    var isDark=!document.body.classList.contains('light-mode');
                    var v=ctx.querySelector('#profileThemeValue2');
                    if(v) v.textContent=isDark?'Dark':'Light';
                    var v2=document.getElementById('profileThemeValue2');
                    if(v2&&v2!==v) v2.textContent=isDark?'Dark':'Light';
                };
                var a=ctx.querySelector('#profileAccount2');
                if(a) a.onclick=function(){ window.location.href='/profile'; };
                var l=ctx.querySelector('#profileLogout2');
                if(l) l.onclick=function(){ window.location.href='/logout'; };
            }
        };

        P['alerts']={
            title:'Alerts',
            build:function(){
                var src=document.getElementById('alertsContent');
                return '<div class="sp-embedded" style="padding:0;">'+(src?src.innerHTML:'<p style="color:#787b86;padding:20px;">No alerts yet.</p>')+'</div>';
            },
            wire:function(){
                var ctx=document.getElementById('settingsPanelContent');
                if(!ctx) return;
                var newList=ctx.querySelector('#alertsList');
                var addBtn=ctx.querySelector('#addAlertBtn');
                if(window.alertSystem){
                    if(newList){ window.alertSystem.alertsList=newList; window.alertSystem.refreshAlertsList(); }
                    if(addBtn){ addBtn.onclick=function(){ window.alertSystem.showCreateAlertModal(); }; }
                }
            }
        };
    });
})();

/*  Side Panel item wiring  */
(function wireSidePanelItems(){
    function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',fn); else fn(); }
    ready(function(){
        /* Help panel items */
        var hcs=document.getElementById('helpContactSupport');
        if(hcs) hcs.addEventListener('click',function(){ window.open('mailto:support@talaria.com','_blank'); });
        var hks=document.getElementById('helpKeyboardShortcuts');
        if(hks) hks.addEventListener('click',function(){ if(window.toggleKeyboardShortcuts) window.toggleKeyboardShortcuts(); else alert('Keyboard shortcuts: Ctrl+Z Undo, Delete Remove, Ctrl+C Copy, Ctrl+V Paste'); });
        /* Profile panel items */
        var pth=document.getElementById('profileTheme2');
        if(pth) pth.addEventListener('click',function(){
            var body=document.body;
            body.classList.toggle('light-mode');
            var isDark=!body.classList.contains('light-mode');
            var val=document.getElementById('profileThemeValue2');
            if(val) val.textContent=isDark?'Dark':'Light';
        });
        var plo=document.getElementById('profileLogout2');
        if(plo) plo.addEventListener('click',function(){ window.location.href='/logout'; });
        var pac=document.getElementById('profileAccount2');
        if(pac) pac.addEventListener('click',function(){ window.location.href='/profile'; });
    });
})();

/* startup apply */
setTimeout(function(){
    var c=ch();if(!c)return;
    var g=gLoad();if(!Object.keys(g).length)return;
    c.chartSettings=c.chartSettings||{};
    if(g.showOrderHistory!==undefined)c.chartSettings.showOrderHistory=g.showOrderHistory;
    if(g.showOpenOrders!==undefined)c.chartSettings.showOpenOrders=g.showOpenOrders;
    if(g.scaleFontSize){c.chartSettings.scaleFontSize=g.scaleFontSize;c.chartSettings.scaleAxisFontSize=g.scaleFontSize;}
    if(g.orderPlacementMode)window.orderPlacementMode=g.orderPlacementMode;
    if(g.playSound!==undefined)window.playSoundEnabled=g.playSound;
    if(g.volume!==undefined)window.soundVolume=g.volume/100;
    if(c.applyChartSettings)c.applyChartSettings();
    var s=sess();
    if(s.leverage)document.querySelectorAll('#challengeLeverage,.leverage-value').forEach(function(el){el.textContent='1:'+s.leverage;});
},1200);

console.log('[SP] inlined settings panel ready. Panels:', Object.keys(P));
})();

/*  UTC Timezone Dropdown (bottom bar)  */
(function(){
    var TIMEZONES = [
        { id: 'UTC',                        label: 'UTC',                   offset: 'UTC0'  },
        { id: 'Pacific/Midway',             label: 'Midway Island',         offset: 'UTC-11' },
        { id: 'Pacific/Honolulu',           label: 'Honolulu',              offset: 'UTC-10' },
        { id: 'America/Anchorage',          label: 'Anchorage',             offset: 'UTC-9'  },
        { id: 'America/Los_Angeles',        label: 'Los Angeles',           offset: 'UTC-8'  },
        { id: 'America/Vancouver',          label: 'Vancouver',             offset: 'UTC-8'  },
        { id: 'America/Denver',             label: 'Denver',                offset: 'UTC-7'  },
        { id: 'America/Phoenix',            label: 'Phoenix',               offset: 'UTC-7'  },
        { id: 'America/Chicago',            label: 'Chicago',               offset: 'UTC-6'  },
        { id: 'America/Mexico_City',        label: 'Mexico City',           offset: 'UTC-6'  },
        { id: 'America/New_York',           label: 'New York',              offset: 'UTC-5'  },
        { id: 'America/Toronto',            label: 'Toronto',               offset: 'UTC-5'  },
        { id: 'America/Bogota',             label: 'Bogota',                offset: 'UTC-5'  },
        { id: 'America/Lima',               label: 'Lima',                  offset: 'UTC-5'  },
        { id: 'America/Caracas',            label: 'Caracas',               offset: 'UTC-4'  },
        { id: 'America/Halifax',            label: 'Halifax',               offset: 'UTC-4'  },
        { id: 'America/Santiago',           label: 'Santiago',              offset: 'UTC-4'  },
        { id: 'America/Sao_Paulo',          label: 'So Paulo',             offset: 'UTC-3'  },
        { id: 'America/Argentina/Buenos_Aires', label: 'Buenos Aires',      offset: 'UTC-3'  },
        { id: 'America/Montevideo',         label: 'Montevideo',            offset: 'UTC-3'  },
        { id: 'Atlantic/South_Georgia',     label: 'South Georgia',         offset: 'UTC-2'  },
        { id: 'Atlantic/Azores',            label: 'Azores',                offset: 'UTC-1'  },
        { id: 'Atlantic/Cape_Verde',        label: 'Cape Verde',            offset: 'UTC-1'  },
        { id: 'Europe/London',              label: 'London',                offset: 'UTC+0'  },
        { id: 'Europe/Lisbon',              label: 'Lisbon',                offset: 'UTC+0'  },
        { id: 'Africa/Casablanca',          label: 'Casablanca',            offset: 'UTC+0'  },
        { id: 'Europe/Paris',               label: 'Paris',                 offset: 'UTC+1'  },
        { id: 'Europe/Berlin',              label: 'Berlin',                offset: 'UTC+1'  },
        { id: 'Europe/Amsterdam',           label: 'Amsterdam',             offset: 'UTC+1'  },
        { id: 'Europe/Madrid',              label: 'Madrid',                offset: 'UTC+1'  },
        { id: 'Europe/Rome',                label: 'Rome',                  offset: 'UTC+1'  },
        { id: 'Europe/Zurich',              label: 'Zurich',                offset: 'UTC+1'  },
        { id: 'Africa/Lagos',               label: 'Lagos',                 offset: 'UTC+1'  },
        { id: 'Europe/Athens',              label: 'Athens',                offset: 'UTC+2'  },
        { id: 'Europe/Helsinki',            label: 'Helsinki',              offset: 'UTC+2'  },
        { id: 'Europe/Bucharest',           label: 'Bucharest',             offset: 'UTC+2'  },
        { id: 'Africa/Cairo',               label: 'Cairo',                 offset: 'UTC+2'  },
        { id: 'Africa/Johannesburg',        label: 'Johannesburg',          offset: 'UTC+2'  },
        { id: 'Europe/Moscow',              label: 'Moscow',                offset: 'UTC+3'  },
        { id: 'Europe/Istanbul',            label: 'Istanbul',              offset: 'UTC+3'  },
        { id: 'Asia/Riyadh',                label: 'Riyadh',                offset: 'UTC+3'  },
        { id: 'Asia/Baghdad',               label: 'Baghdad',               offset: 'UTC+3'  },
        { id: 'Africa/Nairobi',             label: 'Nairobi',               offset: 'UTC+3'  },
        { id: 'Asia/Tehran',                label: 'Tehran',                offset: 'UTC+3:30'},
        { id: 'Asia/Dubai',                 label: 'Dubai',                 offset: 'UTC+4'  },
        { id: 'Asia/Baku',                  label: 'Baku',                  offset: 'UTC+4'  },
        { id: 'Asia/Tbilisi',               label: 'Tbilisi',               offset: 'UTC+4'  },
        { id: 'Asia/Kabul',                 label: 'Kabul',                 offset: 'UTC+4:30'},
        { id: 'Asia/Karachi',               label: 'Karachi',               offset: 'UTC+5'  },
        { id: 'Asia/Tashkent',              label: 'Tashkent',              offset: 'UTC+5'  },
        { id: 'Asia/Kolkata',               label: 'Mumbai / Kolkata',      offset: 'UTC+5:30'},
        { id: 'Asia/Kathmandu',             label: 'Kathmandu',             offset: 'UTC+5:45'},
        { id: 'Asia/Dhaka',                 label: 'Dhaka',                 offset: 'UTC+6'  },
        { id: 'Asia/Almaty',                label: 'Almaty',                offset: 'UTC+6'  },
        { id: 'Asia/Rangoon',               label: 'Rangoon',               offset: 'UTC+6:30'},
        { id: 'Asia/Bangkok',               label: 'Bangkok',               offset: 'UTC+7'  },
        { id: 'Asia/Jakarta',               label: 'Jakarta',               offset: 'UTC+7'  },
        { id: 'Asia/Ho_Chi_Minh',           label: 'Ho Chi Minh City',      offset: 'UTC+7'  },
        { id: 'Asia/Shanghai',              label: 'Shanghai / Beijing',    offset: 'UTC+8'  },
        { id: 'Asia/Hong_Kong',             label: 'Hong Kong',             offset: 'UTC+8'  },
        { id: 'Asia/Singapore',             label: 'Singapore',             offset: 'UTC+8'  },
        { id: 'Asia/Kuala_Lumpur',          label: 'Kuala Lumpur',          offset: 'UTC+8'  },
        { id: 'Asia/Taipei',                label: 'Taipei',                offset: 'UTC+8'  },
        { id: 'Australia/Perth',            label: 'Perth',                 offset: 'UTC+8'  },
        { id: 'Asia/Tokyo',                 label: 'Tokyo',                 offset: 'UTC+9'  },
        { id: 'Asia/Seoul',                 label: 'Seoul',                 offset: 'UTC+9'  },
        { id: 'Australia/Adelaide',         label: 'Adelaide',              offset: 'UTC+9:30'},
        { id: 'Australia/Darwin',           label: 'Darwin',                offset: 'UTC+9:30'},
        { id: 'Australia/Sydney',           label: 'Sydney',                offset: 'UTC+10' },
        { id: 'Australia/Brisbane',         label: 'Brisbane',              offset: 'UTC+10' },
        { id: 'Pacific/Guam',               label: 'Guam',                  offset: 'UTC+10' },
        { id: 'Asia/Vladivostok',           label: 'Vladivostok',           offset: 'UTC+10' },
        { id: 'Pacific/Noumea',             label: 'New Caledonia',         offset: 'UTC+11' },
        { id: 'Pacific/Auckland',           label: 'Auckland',              offset: 'UTC+12' },
        { id: 'Pacific/Fiji',               label: 'Fiji',                  offset: 'UTC+12' }
    ];

    function initTzDropdown() {
        var btn  = document.getElementById('replayTimezoneToggle');
        var menu = document.getElementById('replayTimezoneMenu');
        var lbl  = document.getElementById('replayTimezoneLabel');
        if (!btn || !menu) return;

        // Get current timezone from settings
        var currentTz = (function(){
            try { var s = JSON.parse(localStorage.getItem('chartSession') || '{}'); return s.timezone || 'UTC'; } catch(e){ return 'UTC'; }
        })();

        // Build menu items
        menu.innerHTML = TIMEZONES.map(function(tz){
            return '<div class="timezone-option' + (tz.id === currentTz ? ' selected' : '') + '" data-tz="' + tz.id + '">' +
                '<span class="timezone-option-label">' + tz.label + '</span>' +
                '<span class="timezone-option-offset">' + tz.offset + '</span>' +
                '</div>';
        }).join('');

        // Update label to current
        var cur = TIMEZONES.find(function(t){ return t.id === currentTz; });
        if (cur && lbl) lbl.textContent = cur.id === 'UTC' ? 'UTC' : cur.offset;

        // Toggle menu on button click
        btn.addEventListener('click', function(e){
            e.stopPropagation();
            var open = menu.classList.contains('show');
            menu.classList.toggle('show', !open);
            // Position just above the button
            if (!open) {
                var rect = btn.getBoundingClientRect();
                menu.style.left = rect.left + 'px';
                menu.style.top = (rect.top - menu.offsetHeight - 4) + 'px';
                // Re-position after layout
                setTimeout(function(){
                    menu.style.top = (rect.top - menu.offsetHeight - 4) + 'px';
                }, 0);
            }
        });

        // Select timezone
        menu.addEventListener('click', function(e){
            var opt = e.target.closest('.timezone-option');
            if (!opt) return;
            var tz = opt.dataset.tz;
            menu.querySelectorAll('.timezone-option').forEach(function(el){ el.classList.remove('selected'); });
            opt.classList.add('selected');
            menu.classList.remove('show');

            // Update label
            var found = TIMEZONES.find(function(t){ return t.id === tz; });
            if (lbl) lbl.textContent = found ? (found.id === 'UTC' ? 'UTC' : found.offset) : tz;

            // Apply timezone via settings mechanism
            var s = (function(){ try { return JSON.parse(localStorage.getItem('chartSession') || '{}'); } catch(e){ return {}; } })();
            s.timezone = tz;
            try { localStorage.setItem('chartSession', JSON.stringify(s)); } catch(e){}
            if (window.timezoneManager && window.timezoneManager.setTimezone) window.timezoneManager.setTimezone(tz);
            var c = window.chart || (window.chartInstances && window.chartInstances[0]);
            if (c) {
                c.chartSettings = c.chartSettings || {};
                c.chartSettings.timezone = tz;
                if (c.applyChartSettings) c.applyChartSettings();
                else if (c.render) c.render();
            }
        });

        // Close on outside click
        document.addEventListener('click', function(){ menu.classList.remove('show'); });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTzDropdown);
    } else {
        initTzDropdown();
    }
})();

}catch(e){ console.error('[SP] FATAL ERROR:', e.message, e.stack); }
    </script>
    
    </body>
</html>
