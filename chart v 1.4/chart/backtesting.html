<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standard Backtesting Mode</title>
    <script>
        (function() {
            function redirectToLogin() {
                var next = window.location.pathname + window.location.search;
                var loginUrl = '/login/?next=' + encodeURIComponent(next);
                try {
                    if (window.top && window.top !== window.self) {
                        window.top.location.href = loginUrl;
                        return;
                    }
                } catch (e) {}
                window.location.href = loginUrl;
            }

            fetch('/api/auth/me', { credentials: 'include', cache: 'no-store' })
                .then(function(res) {
                    if (!res.ok) {
                        redirectToLogin();
                    }
                })
                .catch(function() {
                    redirectToLogin();
                });
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #070711;
            color: #e2e8f0;
            min-height: 100vh;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at top, rgba(59,130,246,0.07), transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .top-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 52px;
            background: rgba(7,7,17,0.92);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
        }
        .top-bar-logo { height: 30px; margin-right: 14px; }
        .top-bar-title { font-size: 14px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px; }
        .top-bar-title svg { width: 16px; height: 16px; stroke: #3b82f6; }
        .top-bar-actions { margin-left: auto; display: flex; gap: 8px; }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 64px 20px 20px;
            height: 100vh;
            overflow: hidden;
        }

        .main-content {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            overflow: hidden;
            height: calc(100vh - 84px);
            display: flex;
            flex-direction: column;
        }

        .modal-header-bar { padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .modal-header-bar h1 { font-size: 15px; font-weight: 600; color: #fff; letter-spacing: -0.01em; }
        .close-btn { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.4); width: 28px; height: 28px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .close-btn:hover { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.2); color: #ef4444; }
        .full-panel { flex: 1; padding: 18px 20px 24px; overflow-y: auto; overflow-x: hidden; }
        .full-panel::-webkit-scrollbar { width: 3px; }
        .full-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        .form-grid { display: flex; flex-direction: column; }
        .form-card { padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .form-card:last-of-type { border-bottom: none; }
        .card-icon { display: none; }
        .form-card h3 { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.28); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 14px; display: flex; align-items: center; }
        .form-group { margin-bottom: 12px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.4); margin-bottom: 5px; }
        .form-group label .required { color: #f87171; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="datetime-local"], .form-group input[type="date"], .form-group textarea, .form-group select { width: 100%; padding: 8px 11px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: #e2e8f0; font-size: 13px; font-family: inherit; transition: border-color 0.15s, background 0.15s; -webkit-appearance: none; appearance: none; }
        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255,255,255,0.18); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: rgba(59,130,246,0.4); background: rgba(255,255,255,0.06); }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .helper-text { font-size: 11px; color: rgba(255,255,255,0.22); margin-top: 4px; line-height: 1.4; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .preset-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }

        .preset-btn { padding: 5px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 20px; color: rgba(255,255,255,0.45); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: inherit; }
        .preset-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.14); color: #fff; }
        .preset-btn.active { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.35); color: #93c5fd; }
        .form-actions { display: flex; justify-content: flex-end; gap: 8px; padding-top: 16px; margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.05); }
        .form-actions-container { display: flex; justify-content: space-between; align-items: center; padding: 14px 0 0; margin-top: 14px; border-top: 1px solid rgba(255,255,255,0.05); }
        .forward-mode-toggle { display: flex; align-items: center; gap: 10px; }
        .toggle-text-wrapper { display: flex; align-items: center; gap: 6px; }
        .toggle-text { color: rgba(255,255,255,0.55); font-size: 12px; font-weight: 500; user-select: none; }
        .action-buttons-group { display: flex; gap: 8px; }
        .btn { padding: 8px 18px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; border: 1px solid rgba(255,255,255,0.08); outline: none; font-family: inherit; display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); }
        .btn:hover { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.14); color: #fff; }
        .btn svg { width: 14px; height: 14px; stroke: currentColor; }
        .btn-cancel { background: transparent; color: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.07); }
        .btn-cancel:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .btn-primary { background: rgba(59,130,246,0.85); color: #fff; border: 1px solid rgba(59,130,246,0.4); }
        .btn-primary:hover { background: #3b82f6; border-color: rgba(59,130,246,0.6); }
        .link { color: rgba(59,130,246,0.8); text-decoration: none; font-size: 12px; }
        .link:hover { color: #60a5fa; text-decoration: underline; }
        .symbol-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.18); border-radius: 16px; font-size: 12px; color: #c4b5fd; }
        .symbol-tag button { background: none; border: none; color: #a78bfa; cursor: pointer; padding: 0; font-size: 14px; line-height: 1; }
        .toggle-switch { position: relative; display: inline-block; width: 38px; height: 22px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.08); transition: all 0.2s; border-radius: 22px; border: 1px solid rgba(255,255,255,0.1); }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background: #94a3b8; transition: all 0.2s; border-radius: 50%; }
        input:checked + .toggle-slider { background: rgba(59,130,246,0.6); border-color: rgba(59,130,246,0.4); }
        input:checked + .toggle-slider:before { transform: translateX(16px); background: #fff; }
        .market-checkbox { width: 14px; height: 14px; cursor: pointer; accent-color: #3b82f6; }
        .warning-box { background: rgba(251,191,36,0.06); border: 1px solid rgba(251,191,36,0.2); border-radius: 8px; padding: 10px 12px; color: #fbbf24; font-size: 12px; }
        .info-tooltip { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; background: rgba(255,255,255,0.08); border-radius: 50%; font-size: 10px; color: rgba(255,255,255,0.35); cursor: help; vertical-align: middle; margin-left: 3px; }
        .info-icon-container { position: relative; display: inline-flex; align-items: center; cursor: help; }
        .info-icon { color: rgba(255,255,255,0.22); transition: all 0.15s; }
        .info-icon-container:hover .info-icon { color: #60a5fa; }
        .info-icon-container .info-tooltip { display: block; width: 280px; height: auto; background: rgba(10,10,20,0.98); border: 1px solid rgba(255,255,255,0.1); color: #e2e8f0; padding: 10px 14px; border-radius: 8px; font-size: 12px; line-height: 1.5; white-space: normal; box-shadow: 0 8px 24px rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.2s; pointer-events: none; z-index: 1000; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%) scale(0.95); }
        .info-icon-container:hover .info-tooltip { opacity: 1; visibility: visible; transform: translateX(-50%) scale(1); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #0a0a14; border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 24px; max-width: 480px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .modal-header h2 { font-size: 15px; font-weight: 600; color: #fff; }
        .modal-close { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); font-size: 18px; cursor: pointer; color: rgba(255,255,255,0.4); width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.15s; }
        .modal-close:hover { background: rgba(239,68,68,0.1); color: #ef4444; }
        #createPresetModal label { color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 500; display: block; margin-bottom: 6px; }
        #createPresetModal .required { color: #f87171; }
        .empty-state { text-align: center; padding: 32px 16px; color: rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <img src="modules/LOGO-04.png" alt="Logo" class="top-bar-logo">
        <div class="top-bar-title">Standard Backtesting Mode</div>
        <div class="top-bar-actions">
            <button type="button" class="btn btn-cancel" onclick="handleCancel()">Back to Sessions</button>
        </div>
    </div>

    <div class="container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="modal-header-bar">
                <h1>Create Standard Backtest</h1>
                <button class="close-btn" onclick="handleCancel()" type="button">&times;</button>
            </div>

            <!-- Content Wrapper -->
            <div class="full-panel">
                <form id="backtestingForm">
                  <div class="form-grid">
                    <!-- General Card -->
                    <div class="form-card form-card-full">
                        <h3>General</h3>
                        <div class="form-group">
                            <label>Session name <span class="required">*</span></label>
                            <input type="text" id="sessionName" name="sessionName" required placeholder="Enter session name">
                        </div>

                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="description" name="description" placeholder="Optional description of your backtesting session"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Playbook</label>
                            <select id="playbook" name="playbook">
                                <option value="">Select playbook...</option>
                                <option value="scalping">Scalping Strategy</option>
                                <option value="swing">Swing Trading</option>
                                <option value="breakout">Breakout Strategy</option>
                                <option value="momentum">Momentum Trading</option>
                                <option value="reversal">Reversal Strategy</option>
                            </select>
                            <a href="#" class="link" style="margin-top: 8px; display: inline-block;">Create new playbook</a>
                        </div>

                        <div class="form-group">
                            <label>Symbols / Data Files <span class="required">*</span></label>
                            <div class="helper-text" style="margin-bottom: 8px;">Select one or more files to backtest. You can switch between them on the chart.</div>
                    
                    <!-- Selected Files Tags -->
                    <div id="selectedFilesContainer" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; min-height: 28px; padding: 6px 8px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);">
                        <span style="color: rgba(255,255,255,0.22); font-size: 12px;" id="noFilesText">No files selected</span>
                    </div>
                    
                    <!-- File Selection Dropdown -->
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div style="flex: 1; position: relative;">
                            <button type="button" id="fileSelectBtn" class="btn" style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; padding: 10px 14px;">
                                <span>Click to select files...</span>
                                <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div id="fileDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #0a0a14; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; margin-top: 4px; max-height: 180px; overflow-y: auto; z-index: 100; box-shadow: 0 8px 24px rgba(0,0,0,0.6);">
                                <div id="fileList" style="padding: 8px;">
                                    <div style="color: #64748b; padding: 12px; text-align: center;">Loading files...</div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn" onclick="loadAvailableFiles()" style="padding: 10px 12px; min-width: auto;" title="Refresh file list">
                            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Hidden input to store selected files -->
                    <input type="hidden" id="selectedFiles" name="selectedFiles" value="[]">
                    
                    <div style="margin-top: 8px; padding: 6px 10px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 6px; font-size: 11px; color: rgba(255,255,255,0.25);">
                        Datasets are managed by the admin. Contact your administrator to add or update datasets.
                    </div>
                        </div>
                    </div>

                    <!-- Testing Period Card -->
                    <div class="form-card">
                        <h3>Testing Period</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Start date <span class="required">*</span></label>
                                <input type="datetime-local" id="startDate" name="startDate" required>
                            </div>
                            <div class="form-group">
                                <label>End date <span class="required">*</span></label>
                                <input type="datetime-local" id="endDate" name="endDate" required>
                            </div>
                        </div>
                        <div class="helper-text">Select a data file to see available date range</div>
                    </div>

                    <!-- Trading Settings Card -->
                    <div class="form-card">
                        <h3>Trading Settings</h3>
                    
                    <!-- Market Types -->
                    <div class="form-group">
                        <label>Market Types <span class="required">*</span></label>
                        <div style="display: flex; gap: 20px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="market-checkbox" name="marketType" value="forex" checked>
                                <span>Forex</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="market-checkbox" name="marketType" value="futures">
                                <span>Futures</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="market-checkbox" name="marketType" value="crypto">
                                <span>Crypto</span>
                            </label>
                        </div>
                        <div class="helper-text" style="margin-top: 8px;">Select one or more market types you're backtesting</div>
                    </div>

                    <div class="form-row">
                        <!-- Default Risk Type -->
                        <div class="form-group">
                            <label>Risk Type</label>
                            <select id="defaultRiskType" name="defaultRiskType">
                                <option value="percent" selected>Percentage (%)</option>
                                <option value="dollar">Dollar ($)</option>
                                <option value="lot">Lot</option>
                            </select>
                            <div class="helper-text">How to specify risk per trade</div>
                        </div>

                        <!-- Default Risk Value -->
                        <div class="form-group">
                            <label id="defaultRiskLabel">Default Risk Per Trade (%)</label>
                            <input type="number" id="defaultRisk" name="defaultRisk" placeholder="1" min="0.1" step="0.1" value="1">
                            <div class="helper-text" id="defaultRiskHelper">Percentage of account balance to risk</div>
                        </div>

                        <!-- Start Balance -->
                        <div class="form-group">
                            <label>Start balance (Leverage is 1:1) <span class="required">*</span></label>
                            <input type="number" id="startBalance" name="startBalance" placeholder="$ 0" min="0" step="1000" required value="10000">
                            <div class="preset-buttons">
                                <button type="button" class="preset-btn" data-value="5000">5K</button>
                                <button type="button" class="preset-btn" data-value="10000">10K</button>
                                <button type="button" class="preset-btn" data-value="20000">20K</button>
                                <button type="button" class="preset-btn" data-value="40000">40K</button>
                                <button type="button" class="preset-btn" data-value="50000">50K</button>
                                <button type="button" class="preset-btn" data-value="100000">100K</button>
                            </div>
                            <div class="helper-text">Your starting account balance for this backtesting session</div>
                        </div>
                    </div>

                    <!-- Protection Settings Card -->
                    <div class="form-card form-card-full">
                        <h3>Protection Settings</h3>
                        <div class="form-group">
                            <label>Load Protection Preset <span class="info-tooltip" title="Use protection presets created in the Place Order panel">?</span></label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="protectionPresetSelect" name="protectionPreset" style="flex: 1;">
                                    <option value="">-- None (Configure in chart) --</option>
                                </select>
                                <button type="button" class="btn" onclick="openCreatePresetModal()" style="padding: 8px 12px; min-width: auto; white-space: nowrap;" title="Create new protection preset">
                                    <svg style="width: 16px; height: 16px; margin-right: 4px; display: inline-block; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M5 12h14"></path>
                                    </svg>
                                    Create New
                                </button>
                            </div>
                            <div class="helper-text">Select a protection preset to auto-apply breakeven, trailing stop, and take profit settings</div>
                            <div id="presetDetails" style="margin-top: 12px; padding: 12px; background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 6px; display: none;">
                                <div style="font-size: 12px; color: #a78bfa; font-weight: 600; margin-bottom: 8px;">üìã Preset Details:</div>
                                <div id="presetDetailsContent" style="font-size: 11px; color: #9ca3af; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </div>

                  </div><!-- end form-grid -->

                    <!-- Actions -->
                    <div class="form-actions-container">
                    <!-- Enable Back Navigation Toggle -->
                    <div class="forward-mode-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="allowBackNavigation" name="allowBackNavigation" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="toggle-text-wrapper">
                            <span class="toggle-text">Enable back/forward navigation</span>
                            <div class="info-icon-container">
                                <svg class="info-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                <div class="info-tooltip">
                                    When enabled, you can go backward in time during replay. A visible badge will appear on the chart for transparency. Disable this for forward-only testing (simulating real trading).
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons-group">
                        <button type="button" class="btn btn-cancel" onclick="handleCancel()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create session</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Handle cancel button - close iframe if in modal, otherwise navigate
        function handleCancel() {
            const isInIframe = window.self !== window.top;
            if (isInIframe) {
                // Close the iframe modal by calling parent function
                window.parent.closeBacktestingIframe();
            } else {
                window.location.href = 'index.html';
            }
        }

        // Hide top bar if in iframe (modal mode)
        if (window.self !== window.top) {
            const topBar = document.querySelector('.top-bar');
            if (topBar) {
                topBar.style.display = 'none';
            }
            // Hide the close button in modal-header-bar (we use the overlay close button)
            const modalCloseBtn = document.querySelector('.modal-header-bar .close-btn');
            if (modalCloseBtn) {
                modalCloseBtn.style.display = 'none';
            }
            // Adjust container padding since top bar is hidden
            const container = document.querySelector('.container');
            if (container) {
                container.style.paddingTop = '0';
            }
        }

        // Open Create Preset Modal
        function openCreatePresetModal() {
            const modal = document.getElementById('createPresetModal');
            modal.style.display = 'flex';
            
            // Reset modal state
            let modalBeMode = 'rr';
            let modalTrailMode = 'trail-rr';
            
            // Toggle handlers
            document.getElementById('presetBreakevenToggle').onchange = (e) => {
                document.getElementById('presetBreakevenSettings').style.display = e.target.checked ? 'block' : 'none';
            };
            
            document.getElementById('presetTrailingToggle').onchange = (e) => {
                document.getElementById('presetTrailingSettings').style.display = e.target.checked ? 'block' : 'none';
            };
            
            document.getElementById('presetMultipleTPToggle').onchange = (e) => {
                document.getElementById('presetMultipleTPSettings').style.display = e.target.checked ? 'block' : 'none';
            };
            
            // Breakeven mode buttons
            document.querySelectorAll('.preset-mode-btn').forEach(btn => {
                btn.onclick = () => {
                    const mode = btn.getAttribute('data-mode');
                    modalBeMode = mode;
                    
                    document.querySelectorAll('.preset-mode-btn').forEach(b => {
                        if (b.getAttribute('data-mode') === mode) {
                            b.style.background = '#7c3aed';
                            b.style.color = '#fff';
                            b.style.border = 'none';
                        } else {
                            b.style.background = 'transparent';
                            b.style.color = '#787b86';
                            b.style.border = '1px solid #2a2e39';
                        }
                    });
                    
                    // Hide all inputs first
                    document.getElementById('presetBreakevenRRInput').style.display = 'none';
                    document.getElementById('presetBreakevenAmountInput').style.display = 'none';
                    document.getElementById('presetBreakevenPercentInput').style.display = 'none';
                    
                    // Show the selected input
                    if (mode === 'rr') {
                        document.getElementById('presetBreakevenRRInput').style.display = 'flex';
                    } else if (mode === 'amount') {
                        document.getElementById('presetBreakevenAmountInput').style.display = 'flex';
                    } else if (mode === 'percent') {
                        document.getElementById('presetBreakevenPercentInput').style.display = 'flex';
                    }
                };
            });
            
            // Trailing mode buttons
            document.querySelectorAll('.preset-trail-btn').forEach(btn => {
                btn.onclick = () => {
                    const mode = btn.getAttribute('data-mode');
                    modalTrailMode = mode;
                    
                    document.querySelectorAll('.preset-trail-btn').forEach(b => {
                        if (b.getAttribute('data-mode') === mode) {
                            b.style.background = '#7c3aed';
                            b.style.color = '#fff';
                            b.style.border = 'none';
                        } else {
                            b.style.background = 'transparent';
                            b.style.color = '#787b86';
                            b.style.border = '1px solid #2a2e39';
                        }
                    });
                    
                    // Hide all inputs first
                    document.getElementById('presetTrailingRRInput').style.display = 'none';
                    document.getElementById('presetTrailingPipsInput').style.display = 'none';
                    document.getElementById('presetTrailingDollarInput').style.display = 'none';
                    document.getElementById('presetTrailingPercentInput').style.display = 'none';
                    
                    // Show the selected input
                    if (mode === 'trail-rr') {
                        document.getElementById('presetTrailingRRInput').style.display = 'flex';
                    } else if (mode === 'trail-pips') {
                        document.getElementById('presetTrailingPipsInput').style.display = 'flex';
                    } else if (mode === 'trail-dollar') {
                        document.getElementById('presetTrailingDollarInput').style.display = 'flex';
                    } else if (mode === 'trail-percent') {
                        document.getElementById('presetTrailingPercentInput').style.display = 'flex';
                    }
                };
            });
            
            // Store modes in window for access in saveNewPreset
            window.currentModalBeMode = modalBeMode;
            window.currentModalTrailMode = modalTrailMode;
            
            // Update modes when buttons are clicked
            document.querySelectorAll('.preset-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    window.currentModalBeMode = btn.getAttribute('data-mode');
                });
            });
            
            document.querySelectorAll('.preset-trail-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    window.currentModalTrailMode = btn.getAttribute('data-mode');
                });
            });
        }
        
        // Close Create Preset Modal
        function closeCreatePresetModal() {
            document.getElementById('createPresetModal').style.display = 'none';
            // Reset form
            document.getElementById('presetName').value = '';
            document.getElementById('presetBreakevenToggle').checked = false;
            document.getElementById('presetTrailingToggle').checked = false;
            document.getElementById('presetMultipleTPToggle').checked = false;
            document.getElementById('presetBreakevenSettings').style.display = 'none';
            document.getElementById('presetTrailingSettings').style.display = 'none';
            document.getElementById('presetMultipleTPSettings').style.display = 'none';
        }
        
        // Save New Preset
        function saveNewPreset() {
            const name = document.getElementById('presetName').value.trim();
            if (!name) {
                alert('‚ö†Ô∏è Please enter a preset name');
                return;
            }
            
            const preset = {
                name: name,
                breakeven: {
                    enabled: document.getElementById('presetBreakevenToggle').checked,
                    mode: window.currentModalBeMode || 'rr',
                    rrValue: parseFloat(document.getElementById('presetBreakevenRR').value || 1),
                    amountValue: parseFloat(document.getElementById('presetBreakevenAmount').value || 50),
                    percentValue: parseFloat(document.getElementById('presetBreakevenPercent').value || 1),
                    pipOffset: 0
                },
                trailing: {
                    enabled: document.getElementById('presetTrailingToggle').checked,
                    activateMode: window.currentModalTrailMode || 'trail-rr',
                    rrValue: parseFloat(document.getElementById('presetTrailingRR').value || 1.5),
                    pipsValue: parseFloat(document.getElementById('presetTrailingPips').value || 10),
                    dollarValue: parseFloat(document.getElementById('presetTrailingDollar').value || 50),
                    percentValue: parseFloat(document.getElementById('presetTrailingPercent').value || 1),
                    stepSize: parseFloat(document.getElementById('presetTrailingStep').value || 4)
                },
                multipleTP: {
                    enabled: document.getElementById('presetMultipleTPToggle').checked,
                    numberOfTargets: parseInt(document.getElementById('presetNumTPTargets').value || 3),
                    targets: []
                }
            };
            
            let saved = JSON.parse(localStorage.getItem('protectionSettings') || '[]');
            
            // Check if name already exists
            const existingIndex = saved.findIndex(s => s.name === preset.name);
            if (existingIndex >= 0) {
                if (!confirm(`Preset "${preset.name}" already exists. Overwrite?`)) return;
                saved[existingIndex] = preset;
            } else {
                saved.push(preset);
            }
            
            localStorage.setItem('protectionSettings', JSON.stringify(saved));
            console.log('‚úÖ Protection preset saved:', preset);
            
            // Reload presets dropdown
            loadProtectionPresets();
            
            // Select the newly created preset
            document.getElementById('protectionPresetSelect').value = preset.name;
            showPresetDetails(preset.name);
            
            // Show success message
            alert(`‚úÖ Protection preset "${preset.name}" saved successfully!`);
            
            // Close modal
            closeCreatePresetModal();
        }

        // Load Protection Presets
        function loadProtectionPresets() {
            const select = document.getElementById('protectionPresetSelect');
            if (!select) return;

            const presets = JSON.parse(localStorage.getItem('protectionSettings') || '[]');
            
            // Clear existing options except first one
            select.innerHTML = '<option value="">-- None (Configure in chart) --</option>';
            
            // Add presets
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.name;
                option.textContent = preset.name;
                select.appendChild(option);
            });

            console.log(`‚úÖ Loaded ${presets.length} protection presets`);
        }

        // Show preset details
        function showPresetDetails(presetName) {
            const detailsDiv = document.getElementById('presetDetails');
            const contentDiv = document.getElementById('presetDetailsContent');
            
            if (!presetName) {
                detailsDiv.style.display = 'none';
                return;
            }

            const presets = JSON.parse(localStorage.getItem('protectionSettings') || '[]');
            const preset = presets.find(p => p.name === presetName);
            
            if (!preset) {
                detailsDiv.style.display = 'none';
                return;
            }

            let details = [];
            
            // Breakeven details
            if (preset.breakeven && preset.breakeven.enabled) {
                const beMode = preset.breakeven.mode === 'rr' ? 
                    `at ${preset.breakeven.rrValue}:1 R:R` : 
                    `at $${preset.breakeven.amountValue}`;
                details.push(`üõ°Ô∏è <strong>Breakeven:</strong> ${beMode}`);
            }
            
            // Trailing SL details
            if (preset.trailing && preset.trailing.enabled) {
                const trailMode = preset.trailing.activateMode === 'trail-rr' ? 
                    `${preset.trailing.rrValue}:1 R:R` : 
                    `${preset.trailing.pipsValue} pips`;
                details.push(`üìä <strong>Trailing SL:</strong> Activate at ${trailMode}, step ${preset.trailing.stepSize} pips`);
            }
            
            // Multiple TP details
            if (preset.multipleTP && preset.multipleTP.enabled) {
                details.push(`üéØ <strong>Multiple TP:</strong> ${preset.multipleTP.numberOfTargets} targets`);
            }
            
            if (details.length === 0) {
                details.push('No protection features enabled');
            }
            
            contentDiv.innerHTML = details.join('<br>');
            detailsDiv.style.display = 'block';
        }

        // Preset select change handler
        document.getElementById('protectionPresetSelect')?.addEventListener('change', function(e) {
            showPresetDetails(e.target.value);
        });

        // Load presets on page load
        loadProtectionPresets();
    </script>

    <!-- Templates Modal -->
    <div id="templatesModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Load Template</h2>
                <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
            </div>
            <div id="templatesList" class="template-list">
                <!-- Templates will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Recent Sessions Modal -->
    <div id="sessionsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Recent Sessions</h2>
                <button class="modal-close" onclick="closeModal('sessionsModal')">&times;</button>
            </div>
            <div id="sessionsList" class="session-list">
                <!-- Sessions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Save Template Modal -->
    <div id="saveTemplateModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save as Template</h2>
                <button class="modal-close" onclick="closeModal('saveTemplateModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Template Name <span class="required">*</span></label>
                <input type="text" id="templateName" placeholder="e.g., Scalping Setup">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="templateDescription" placeholder="Describe this template..." style="min-height: 80px;"></textarea>
            </div>
            <div class="form-actions" style="border-top: none; padding-top: 0;">
                <button type="button" class="btn btn-cancel" onclick="closeModal('saveTemplateModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Create Protection Preset Modal -->
    <div id="createPresetModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Create Protection Preset</h2>
                <button class="modal-close" onclick="closeCreatePresetModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Preset Name <span class="required">*</span></label>
                <input type="text" id="presetName" placeholder="e.g., My Scalping Strategy" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 10px; font-size: 13px; color: #fff;">
            </div>
            
            <!-- Auto Breakeven -->
            <div style="background: rgba(255,255,255,0.02); border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <span style="font-size: 13px; font-weight: 600; color: #fff;">üõ°Ô∏è Auto Breakeven</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="presetBreakevenToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div id="presetBreakevenSettings" style="display: none;">
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button type="button" class="preset-mode-btn" data-mode="rr" style="flex: 1; padding: 8px; font-size: 12px; background: #7c3aed; border: none; color: #fff; border-radius: 4px; cursor: pointer;">R:R</button>
                        <button type="button" class="preset-mode-btn" data-mode="amount" style="flex: 1; padding: 8px; font-size: 12px; background: transparent; border: 1px solid #2a2e39; color: #787b86; border-radius: 4px; cursor: pointer;">Dollar $</button>
                        <button type="button" class="preset-mode-btn" data-mode="percent" style="flex: 1; padding: 8px; font-size: 12px; background: transparent; border: 1px solid #2a2e39; color: #787b86; border-radius: 4px; cursor: pointer;">Percent %</button>
                    </div>
                    <div id="presetBreakevenRRInput" style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="presetBreakevenRR" value="1" min="0.1" step="0.1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">RR</span>
                    </div>
                    <div id="presetBreakevenAmountInput" style="display: none; align-items: center; gap: 8px;">
                        <input type="number" id="presetBreakevenAmount" value="50" min="1" step="1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">$</span>
                    </div>
                    <div id="presetBreakevenPercentInput" style="display: none; align-items: center; gap: 8px;">
                        <input type="number" id="presetBreakevenPercent" value="1" min="0.1" step="0.1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">%</span>
                    </div>
                </div>
            </div>
            
            <!-- Trailing Stop Loss -->
            <div style="background: rgba(255,255,255,0.02); border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <span style="font-size: 13px; font-weight: 600; color: #fff;">üìä Trailing Stop Loss</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="presetTrailingToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div id="presetTrailingSettings" style="display: none;">
                    <label style="display: block; font-size: 11px; color: #9ca3af; margin-bottom: 6px;">Activate At</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button type="button" class="preset-trail-btn" data-mode="trail-rr" style="flex: 1; padding: 8px; font-size: 12px; background: #7c3aed; border: none; color: #fff; border-radius: 4px; cursor: pointer;">R:R</button>
                        <button type="button" class="preset-trail-btn" data-mode="trail-pips" style="flex: 1; padding: 8px; font-size: 12px; background: transparent; border: 1px solid #2a2e39; color: #787b86; border-radius: 4px; cursor: pointer;">Pips</button>
                        <button type="button" class="preset-trail-btn" data-mode="trail-dollar" style="flex: 1; padding: 8px; font-size: 12px; background: transparent; border: 1px solid #2a2e39; color: #787b86; border-radius: 4px; cursor: pointer;">Dollar $</button>
                        <button type="button" class="preset-trail-btn" data-mode="trail-percent" style="flex: 1; padding: 8px; font-size: 12px; background: transparent; border: 1px solid #2a2e39; color: #787b86; border-radius: 4px; cursor: pointer;">Percent %</button>
                    </div>
                    <div id="presetTrailingRRInput" style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <input type="number" id="presetTrailingRR" value="1.5" min="0.1" step="0.1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">RR</span>
                    </div>
                    <div id="presetTrailingPipsInput" style="display: none; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <input type="number" id="presetTrailingPips" value="10" min="1" step="1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">Pips</span>
                    </div>
                    <div id="presetTrailingDollarInput" style="display: none; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <input type="number" id="presetTrailingDollar" value="50" min="1" step="1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">$</span>
                    </div>
                    <div id="presetTrailingPercentInput" style="display: none; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <input type="number" id="presetTrailingPercent" value="1" min="0.1" step="0.1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">%</span>
                    </div>
                    <label style="display: block; font-size: 11px; color: #9ca3af; margin-bottom: 6px;">Step Size</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="presetTrailingStep" value="4" min="1" step="1" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                        <span style="font-size: 11px; color: #9ca3af;">Pips</span>
                    </div>
                </div>
            </div>
            
            <!-- Multiple Take Profits -->
            <div style="background: rgba(255,255,255,0.02); border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <span style="font-size: 13px; font-weight: 600; color: #fff;">üéØ Multiple Take Profits</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="presetMultipleTPToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div id="presetMultipleTPSettings" style="display: none;">
                    <label style="display: block; font-size: 11px; color: #9ca3af; margin-bottom: 6px;">Number of Targets</label>
                    <input type="number" id="presetNumTPTargets" value="3" min="2" max="10" step="1" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; font-size: 12px; color: #fff;">
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="form-actions" style="border-top: none; padding-top: 0;">
                <button type="button" class="btn btn-cancel" onclick="closeCreatePresetModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewPreset()">üíæ Save Preset</button>
            </div>
        </div>
    </div>

    <script>
        // VERSION: 2.0 - Fixed Submit Handler
        console.log('üî• Script loaded - Version 2.0 (backtesting.html)');
        
        // Helper function to parse various date formats including European format
        function parseFlexibleDate(dateStr) {
            // Try European format: DD.MM.YYYY HH:MM:SS.mmm
            if (dateStr.includes('.') && dateStr.includes(' ')) {
                const [datePart, timePart] = dateStr.split(' ');
                const dateParts = datePart.split('.');
                
                // Check if it's DD.MM.YYYY format
                if (dateParts.length === 3 && dateParts[0].length <= 2) {
                    const [day, month, year] = dateParts;
                    const timeComponents = timePart.split(':');
                    const hour = parseInt(timeComponents[0]) || 0;
                    const minute = parseInt(timeComponents[1]) || 0;
                    const secondStr = timeComponents[2] || '0';
                    const second = parseFloat(secondStr) || 0;
                    
                    const timestamp = new Date(
                        parseInt(year), 
                        parseInt(month) - 1, 
                        parseInt(day), 
                        hour, 
                        minute, 
                        Math.floor(second)
                    ).getTime();
                    
                    if (!isNaN(timestamp)) {
                        return timestamp;
                    }
                }
            }
            
            // Try standard Date parsing
            const timestamp = new Date(dateStr).getTime();
            if (!isNaN(timestamp)) {
                return timestamp;
            }
            
            return null;
        }
        
        // Selected files array
        let selectedFilesArray = [];
        let availableFilesCache = [];
        
        // Initialize file dropdown when DOM is ready
        function initFileDropdown() {
            const fileSelectBtn = document.getElementById('fileSelectBtn');
            const fileDropdown = document.getElementById('fileDropdown');
            
            if (!fileSelectBtn || !fileDropdown) {
                console.log('File dropdown elements not found, retrying...');
                setTimeout(initFileDropdown, 100);
                return;
            }
            
            // Toggle file dropdown
            fileSelectBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                fileDropdown.style.display = fileDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!fileDropdown.contains(e.target) && !fileSelectBtn.contains(e.target)) {
                    fileDropdown.style.display = 'none';
                }
            });
            
            // Load files on init
            loadAvailableFiles();
            
            console.log('‚úÖ File dropdown initialized');
        }
        
        // Run when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFileDropdown);
        } else {
            initFileDropdown();
        }
        
        // Toggle file selection
        function toggleFileSelection(fileId, fileName) {
            const index = selectedFilesArray.findIndex(f => f.id === fileId);
            if (index === -1) {
                selectedFilesArray.push({ id: fileId, name: fileName });
            } else {
                selectedFilesArray.splice(index, 1);
            }
            updateSelectedFilesUI();
            updateFileListUI();
        }
        
        // Remove file from selection
        function removeSelectedFile(fileId) {
            selectedFilesArray = selectedFilesArray.filter(f => f.id !== fileId);
            updateSelectedFilesUI();
            updateFileListUI();
        }
        
        // Update the selected files display
        function updateSelectedFilesUI() {
            const container = document.getElementById('selectedFilesContainer');
            const noFilesText = document.getElementById('noFilesText');
            const hiddenInput = document.getElementById('selectedFiles');
            
            // Update hidden input
            hiddenInput.value = JSON.stringify(selectedFilesArray);
            
            if (selectedFilesArray.length === 0) {
                container.innerHTML = '<span style="color: rgba(255,255,255,0.22); font-size: 12px;" id="noFilesText">No files selected</span>';
                return;
            }
            
            container.innerHTML = selectedFilesArray.map(file => {
                const display = cleanPairName(file.name);
                return `
                <span style="display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2)); border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 10px; border-radius: 16px; font-size: 12px; color: #fff; font-weight: 600;">
                    ${display}
                    <button type="button" onclick="removeSelectedFile('${file.id}')" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;">&times;</button>
                </span>
            `}).join('');
            
            // Load date range from first selected file
            if (selectedFilesArray.length > 0) {
                loadDateRangeFromFile(selectedFilesArray[0].id);
            }
        }
        
        // Update file list checkboxes
        // Extract clean pair name from CSV filename
        function cleanPairName(rawName) {
            if (!rawName) return 'Unknown';
            // Remove path, extension, timestamps, prefixes
            let name = rawName.replace(/^.*[\/\\]/, '').replace(/\.csv$/i, '');
            // Remove common prefixes like dates: 20260217_182920_
            name = name.replace(/^\d{8}_\d{6}_/, '');
            // Extract 6-letter pair from patterns like "eurusd_data", "eurusd-m1-bid-2022...", "GBPUSD"
            const currencies = ['USD','EUR','GBP','JPY','AUD','NZD','CAD','CHF','HKD','SGD','SEK','NOK','DKK','ZAR','TRY','MXN','BTC','ETH','XAU','XAG'];
            const pairMatch = name.match(/([a-zA-Z]{6})/);
            if (pairMatch) {
                const pair = pairMatch[1].toUpperCase();
                const base = pair.substring(0, 3);
                const quote = pair.substring(3, 6);
                if (currencies.includes(base) || currencies.includes(quote)) {
                    return base + '/' + quote;
                }
            }
            // Try 3-letter match for indices/commodities (e.g. "NAS", "SPX")
            const indexMatch = name.match(/([a-zA-Z]{3,5})/);
            if (indexMatch) {
                return indexMatch[1].toUpperCase();
            }
            // Fallback: clean up the name
            return name.replace(/[-_]/g, ' ').trim() || rawName;
        }

        function formatRowCount(count) {
            if (!count) return '';
            if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
            if (count >= 1000) return (count / 1000).toFixed(0) + 'K';
            return count.toString();
        }

        function updateFileListUI() {
            const fileList = document.getElementById('fileList');
            if (availableFilesCache.length === 0) return;

            // Detect duplicate pair names to add differentiators
            const pairCounts = {};
            availableFilesCache.forEach(file => {
                const raw = file.original_name || file.name || file.filename || '';
                const pair = cleanPairName(raw);
                pairCounts[pair] = (pairCounts[pair] || 0) + 1;
            });
            
            fileList.innerHTML = availableFilesCache.map(file => {
                const isSelected = selectedFilesArray.some(f => f.id === file.id);
                const rawName = file.original_name || file.name || file.filename || file.symbol || `File ${file.id}`;
                const pairName = cleanPairName(rawName);
                const rows = file.row_count ? formatRowCount(file.row_count) : '';
                // Add row count suffix if duplicate pair names exist
                const hasDupes = pairCounts[pairName] > 1;
                const displayName = hasDupes && rows ? pairName + ' (' + rows + ')' : pairName;
                return `
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-radius: 6px; transition: background 0.15s; ${isSelected ? 'background: rgba(59, 130, 246, 0.15);' : ''}" 
                           onmouseover="this.style.background='rgba(59, 130, 246, 0.1)'" 
                           onmouseout="this.style.background='${isSelected ? 'rgba(59, 130, 246, 0.15)' : 'transparent'}'">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleFileSelection('${file.id}', '${displayName.replace(/'/g, "\\'")}')" style="accent-color: #3b82f6; width: 16px; height: 16px;">
                        <div style="flex:1;display:flex;justify-content:space-between;align-items:center;">
                            <span style="color: #e5e7eb; font-size: 14px; font-weight: 600;">${pairName}</span>
                            <span style="color: #64748b; font-size: 11px;">${rows ? rows + ' candles' : ''}</span>
                        </div>
                    </label>
                `;
            }).join('');
        }
        
        // Load available files on page load
        async function loadAvailableFiles() {
            const fileList = document.getElementById('fileList');
            
            try {
                console.log('üîÑ Fetching files from /api/files...');
                
                // Show loading state
                fileList.innerHTML = '<div style="color: #64748b; padding: 12px; text-align: center;">Loading files...</div>';
                
                const response = await fetch('/api/files');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìÅ API Response:', data);
                
                // Handle multiple response formats
                let files = [];
                if (Array.isArray(data)) {
                    files = data;
                } else if (data.files && Array.isArray(data.files)) {
                    files = data.files;
                } else if (typeof data === 'object') {
                    files = Object.values(data).find(val => Array.isArray(val)) || [];
                }
                
                // Add id to each file if missing
                files = files.map((file, idx) => ({
                    ...file,
                    id: file.id || file.filename || file.name || `file_${idx}`
                }));
                
                console.log('üìÅ Number of files:', files.length);
                
                if (!files || files.length === 0) {
                    fileList.innerHTML = '<div style="color: #64748b; padding: 12px; text-align: center;">No datasets available ‚Äî contact your administrator.</div>';
                    return;
                }
                
                // Sort files by name
                files.sort((a, b) => {
                    const nameA = (a.original_name || a.name || a.filename || '').toLowerCase();
                    const nameB = (b.original_name || b.name || b.filename || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                
                availableFilesCache = files;
                updateFileListUI();
                
                console.log(`‚úÖ Successfully loaded ${files.length} files`);
            } catch (error) {
                console.error('‚ùå Error loading files:', error);
                fileList.innerHTML = '<div style="color: #ef4444; padding: 12px; text-align: center;">Error loading files - Click refresh</div>';
            }
        }

        // Load date range from selected file
        async function loadDateRangeFromFile(fileId) {
            if (!fileId) {
                console.log('‚ö†Ô∏è No fileId provided');
                return;
            }
            
            try {
                console.log(`üìÖ Loading date range from file ${fileId}...`);

                // Preferred path: use metadata (binary-derived range) to avoid relying on
                // potentially stale CSV row_count values when locating the last row.
                try {
                    const metaResponse = await fetch(`/api/file/${fileId}/meta`);
                    if (metaResponse.ok) {
                        const meta = await metaResponse.json();
                        const metaStartTs = Number(meta.start_ts);
                        const metaEndTs = Number(meta.end_ts);

                        if (Number.isFinite(metaStartTs) && Number.isFinite(metaEndTs) && metaEndTs >= metaStartTs) {
                            const firstDate = new Date(metaStartTs);
                            const lastDate = new Date(metaEndTs);

                            const startDateInput = document.getElementById('startDate');
                            const endDateInput = document.getElementById('endDate');

                            startDateInput.min = firstDate.toISOString().slice(0, 16);
                            startDateInput.max = lastDate.toISOString().slice(0, 16);
                            endDateInput.min = firstDate.toISOString().slice(0, 16);
                            endDateInput.max = lastDate.toISOString().slice(0, 16);

                            // Set default values to full available span.
                            startDateInput.value = firstDate.toISOString().slice(0, 16);
                            endDateInput.value = lastDate.toISOString().slice(0, 16);

                            const helperText = document.querySelector('.form-row .helper-text');
                            const helperValue = `Available data: ${firstDate.toLocaleDateString()} to ${lastDate.toLocaleDateString()}`;
                            if (!helperText) {
                                const newHelper = document.createElement('div');
                                newHelper.className = 'helper-text';
                                newHelper.style.gridColumn = '1 / -1';
                                newHelper.textContent = helperValue;
                                document.querySelector('.form-row').appendChild(newHelper);
                            } else {
                                helperText.textContent = helperValue;
                            }

                            console.log(`‚úÖ Date range (meta): ${firstDate.toLocaleString()} to ${lastDate.toLocaleString()}`);
                            return;
                        }
                    }
                } catch (metaError) {
                    console.warn('‚ö†Ô∏è Meta range lookup failed, falling back to CSV row scan:', metaError);
                }
                
                // Fetch file data (first and last few rows to get date range)
                console.log(`üîÑ Fetching from /api/file/${fileId}?offset=0&limit=1`);
                const response = await fetch(`/api/file/${fileId}?offset=0&limit=1`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseData = await response.json();
                console.log('üìä API Response:', responseData);
                
                // API returns {data: "csv string"}, need to parse it
                if (!responseData.data) {
                    console.warn('‚ö†Ô∏è No data in response');
                    alert('No data found in this file');
                    return;
                }
                
                // Parse CSV string into rows
                const lines = responseData.data.trim().split('\n');
                console.log(`üìä Got ${lines.length} lines`);
                
                if (lines.length < 2) {
                    console.warn('‚ö†Ô∏è Not enough data');
                    alert('File contains no data rows');
                    return;
                }
                
                // First line is header
                const header = lines[0].split(',');
                console.log('üìä CSV Headers:', header);
                
                // Second line is first data row
                const firstRowValues = lines[1].split(',');
                console.log('üìä First row values:', firstRowValues);
                
                // Create object from header and values
                const firstRow = {};
                header.forEach((key, index) => {
                    firstRow[key] = firstRowValues[index];
                });
                console.log('üìä First row object:', firstRow);
                
                let firstTimestamp = null;
                
                // Strategy 1: Try standard timestamp fields
                if (firstRow.t) {
                    firstTimestamp = firstRow.t;
                } else if (firstRow.time) {
                    firstTimestamp = firstRow.time;
                } else if (firstRow.timestamp) {
                    firstTimestamp = firstRow.timestamp;
                }
                // Strategy 2: Try to find date + time fields and combine them
                else if (firstRow['<DTYYYYMMDD>'] && firstRow['<TIME>']) {
                    // Format: <DTYYYYMMDD>=20240101, <TIME>=090000
                    const dateStr = String(firstRow['<DTYYYYMMDD>']);
                    const timeStr = String(firstRow['<TIME>']).padStart(6, '0');
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    const hour = timeStr.substring(0, 2);
                    const minute = timeStr.substring(2, 4);
                    const second = timeStr.substring(4, 6);
                    firstTimestamp = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`).getTime();
                }
                // Strategy 3: Search for any field with date/time in the name
                else {
                    const keys = Object.keys(firstRow);
                    for (let key of keys) {
                        if (key.toLowerCase().includes('date') || key.toLowerCase().includes('time')) {
                            const value = firstRow[key];
                            const timestamp = parseFlexibleDate(value);
                            if (timestamp) {
                                firstTimestamp = timestamp;
                                console.log(`‚úÖ Found date in field "${key}": ${value}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!firstTimestamp) {
                    console.error('‚ùå Cannot find date/time field in data:', firstRow);
                    alert('Cannot detect date format. Please contact support.');
                    return;
                }
                
                // Convert to number if it's a string epoch timestamp
                if (typeof firstTimestamp === 'string' && /^\d+$/.test(firstTimestamp)) {
                    firstTimestamp = parseInt(firstTimestamp, 10);
                }
                
                const firstDate = new Date(firstTimestamp);
                console.log('üìÖ First date detected:', firstDate.toLocaleString());
                
                // Use reported total row count to get the last row (no hardcoded fallback).
                const totalRows = Number(responseData.total);
                if (!Number.isFinite(totalRows) || totalRows < 1) {
                    console.warn('‚ö†Ô∏è Missing/invalid total row count; using first row timestamp for both bounds');
                }
                const lastOffset = Math.max(0, (Number.isFinite(totalRows) && totalRows > 0 ? totalRows : 1) - 1);
                console.log(`üìä File has ${totalRows} rows, fetching row at offset ${lastOffset}`);
                
                // Fetch last row using actual row count
                const response2 = await fetch(`/api/file/${fileId}?offset=${lastOffset}&limit=1`);
                const lastResponseData = await response2.json();
                
                let lastDate = firstDate;
                if (lastResponseData.data) {
                    const lastLines = lastResponseData.data.trim().split('\n');
                    if (lastLines.length >= 2) {
                        // Get last data row (skip header)
                        const lastRowValues = lastLines[lastLines.length - 1].split(',');
                        const lastRow = {};
                        header.forEach((key, index) => {
                            lastRow[key] = lastRowValues[index];
                        });
                        console.log('üìä Last row object:', lastRow);
                        
                        let lastTimestamp = null;
                        
                        // Use same detection logic as first date
                        if (lastRow.t) {
                            lastTimestamp = lastRow.t;
                        } else if (lastRow.time) {
                            lastTimestamp = lastRow.time;
                        } else if (lastRow.timestamp) {
                            lastTimestamp = lastRow.timestamp;
                        } else if (lastRow['<DTYYYYMMDD>'] && lastRow['<TIME>']) {
                            const dateStr = String(lastRow['<DTYYYYMMDD>']);
                            const timeStr = String(lastRow['<TIME>']).padStart(6, '0');
                            const year = dateStr.substring(0, 4);
                            const month = dateStr.substring(4, 6);
                            const day = dateStr.substring(6, 8);
                            const hour = timeStr.substring(0, 2);
                            const minute = timeStr.substring(2, 4);
                            const second = timeStr.substring(4, 6);
                            lastTimestamp = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`).getTime();
                        } else {
                            const keys = Object.keys(lastRow);
                            for (let key of keys) {
                                if (key.toLowerCase().includes('date') || key.toLowerCase().includes('time')) {
                                    const value = lastRow[key];
                                    const timestamp = parseFlexibleDate(value);
                                    if (timestamp) {
                                        lastTimestamp = timestamp;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (lastTimestamp) {
                            // Convert to number if it's a string epoch timestamp
                            if (typeof lastTimestamp === 'string' && /^\d+$/.test(lastTimestamp)) {
                                lastTimestamp = parseInt(lastTimestamp, 10);
                            }
                            lastDate = new Date(lastTimestamp);
                            console.log('üìÖ Last date detected:', lastDate.toLocaleString());
                        }
                    }
                }
                
                // Set min/max and default values
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                startDateInput.min = firstDate.toISOString().slice(0, 16);
                startDateInput.max = lastDate.toISOString().slice(0, 16);
                endDateInput.min = firstDate.toISOString().slice(0, 16);
                endDateInput.max = lastDate.toISOString().slice(0, 16);
                
                // Set default values (first date to last date)
                startDateInput.value = firstDate.toISOString().slice(0, 16);
                endDateInput.value = lastDate.toISOString().slice(0, 16);
                
                console.log(`‚úÖ Date range: ${firstDate.toLocaleString()} to ${lastDate.toLocaleString()}`);
                
                // Update helper text
                const helperText = document.querySelector('.form-row .helper-text');
                if (!helperText) {
                    const newHelper = document.createElement('div');
                    newHelper.className = 'helper-text';
                    newHelper.style.gridColumn = '1 / -1';
                    newHelper.textContent = `Available data: ${firstDate.toLocaleDateString()} to ${lastDate.toLocaleDateString()}`;
                    document.querySelector('.form-row').appendChild(newHelper);
                } else {
                    helperText.textContent = `Available data: ${firstDate.toLocaleDateString()} to ${lastDate.toLocaleDateString()}`;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading date range:', error);
            }
        }


        // Poll binary conversion status until all timeframes are ready
        async function pollBinaryConversion(fileId, statusEl) {
            const allTFs = ['1m', '5m', '15m', '30m', '1h', '4h', '1d', '1w'];
            let attempts = 0;
            const maxAttempts = 120; // 2 minutes max

            const poll = async () => {
                if (attempts++ > maxAttempts) {
                    statusEl.innerHTML = `<span style="color:#f59e0b">‚ö† Conversion taking long ‚Äî will complete in background</span>`;
                    return;
                }
                try {
                    const res = await fetch(`/api/file/${fileId}/meta`);
                    if (!res.ok) return;
                    const meta = await res.json();
                    const tfs = meta.timeframes || {};
                    
                    const ready = allTFs.filter(tf => tfs[tf] && tfs[tf].status === 'ready').length;
                    const total = allTFs.length;
                    const pct = Math.round((ready / total) * 100);
                    
                    if (ready === total) {
                        const rowCount = tfs['1m'] ? tfs['1m'].row_count : '?';
                        statusEl.innerHTML = `<span style="color:#10b981">‚úì Ready ‚Äî ${typeof rowCount === 'number' ? rowCount.toLocaleString() : rowCount} candles, all ${total} timeframes converted to binary</span>`;
                        setTimeout(() => { statusEl.innerHTML = ''; }, 8000);
                        return;
                    }
                    
                    // Show progress bar
                    const processing = allTFs.filter(tf => tfs[tf] && tfs[tf].status === 'processing');
                    const currentTF = processing.length > 0 ? processing[0] : '...';
                    statusEl.innerHTML = `
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="flex:1;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;min-width:120px;">
                                <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#3b82f6,#8b5cf6);border-radius:3px;transition:width 0.3s;"></div>
                            </div>
                            <span style="color:#a78bfa;font-size:12px;white-space:nowrap;">${ready}/${total} TFs ‚Äî converting ${currentTF}</span>
                        </div>`;
                    
                    setTimeout(poll, 1000);
                } catch (e) {
                    setTimeout(poll, 2000);
                }
            };
            
            setTimeout(poll, 1500); // First poll after 1.5s
        }

        // Check server status
        async function checkServerStatus() {
            const statusEl = document.getElementById('serverStatus');
            try {
                const response = await fetch('/api/files');
                if (response.ok) {
                    statusEl.textContent = '‚úì Connected';
                    statusEl.style.color = '#10b981';
                    return true;
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                statusEl.textContent = '‚úó Not connected (Start server first!)';
                statusEl.style.color = '#ef4444';
                console.error('‚ùå Server not reachable:', error);
                return false;
            }
        }

        // Load files when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Page loaded, initializing...');
            
            // Try to load files immediately
            try {
                await loadAvailableFiles();
                console.log('‚úÖ Initial file load successful');
            } catch (error) {
                console.error('‚ùå Initial file load failed:', error);
                
                // Check server status
                const serverOk = await checkServerStatus();
                if (!serverOk) {
                    alert('‚ö†Ô∏è Server not running!\n\nPlease start the server first:\npython3 api_server.py');
                } else {
                    // Retry loading files
                    console.log('üîÑ Retrying file load...');
                    setTimeout(async () => {
                        await loadAvailableFiles();
                    }, 1000);
                }
            }
        });

        // Balance preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('startBalance').value = this.dataset.value;
            });
        });

        // Default Risk Type Update
        const defaultRiskTypeSelect = document.getElementById('defaultRiskType');
        const defaultRiskLabel = document.getElementById('defaultRiskLabel');
        const defaultRiskInput = document.getElementById('defaultRisk');
        const defaultRiskHelper = document.getElementById('defaultRiskHelper');

        defaultRiskTypeSelect.addEventListener('change', function() {
            const type = this.value;
            
            switch(type) {
                case 'percent':
                    defaultRiskLabel.textContent = 'Default Risk Per Trade (%)';
                    defaultRiskInput.value = '1';
                    defaultRiskInput.placeholder = '1';
                    defaultRiskInput.step = '0.1';
                    defaultRiskInput.min = '0.1';
                    defaultRiskHelper.textContent = 'Percentage of account balance to risk';
                    break;
                case 'dollar':
                    defaultRiskLabel.textContent = 'Default Risk Per Trade ($)';
                    defaultRiskInput.value = '100';
                    defaultRiskInput.placeholder = '100';
                    defaultRiskInput.step = '10';
                    defaultRiskInput.min = '1';
                    defaultRiskHelper.textContent = 'Fixed dollar amount to risk per trade';
                    break;
                case 'lot':
                    defaultRiskLabel.textContent = 'Default Risk Per Trade (Lot)';
                    defaultRiskInput.value = '0.01';
                    defaultRiskInput.placeholder = '0.01';
                    defaultRiskInput.step = '0.01';
                    defaultRiskInput.min = '0.01';
                    defaultRiskHelper.textContent = 'Fixed lot size per trade';
                    break;
            }
        });


        // Form submission - Wait for window to load
        window.addEventListener('load', function() {
            console.log('üìÑ Window loaded, attaching form handler...');
            
            const backtestingForm = document.getElementById('backtestingForm');
            console.log('üîç Form element found:', backtestingForm);
            
            if (!backtestingForm) {
                console.error('‚ùå CRITICAL: Form element not found!');
                alert('ERROR: Form not found! Please refresh the page.');
                return;
            }
            
            backtestingForm.addEventListener('submit', async function(e) {
                console.log('‚úÖ Form submit event fired!');
                e.preventDefault();
                
                // Get selected files from multi-select
                if (selectedFilesArray.length === 0) {
                    alert('Please select at least one data file');
                    return;
                }
                
                // Use first file as primary, store all files
                const primaryFile = selectedFilesArray[0];
                const selectedFileId = primaryFile.id;
                const selectedFileName = primaryFile.name;

                // Validate at least one market type is selected
                const selectedMarkets = document.querySelectorAll('.market-checkbox:checked');
                if (selectedMarkets.length === 0) {
                    alert('Please select at least one market type');
                    return;
                }

                // Get selected protection preset
                const selectedPresetName = document.getElementById('protectionPresetSelect')?.value;
                let protectionPreset = null;
                if (selectedPresetName) {
                    const presets = JSON.parse(localStorage.getItem('protectionSettings') || '[]');
                    protectionPreset = presets.find(p => p.name === selectedPresetName);
                }

                const formData = {
                    type: 'standard', // Distinguish from prop firm mode
                    sessionName: document.getElementById('sessionName').value,
                    description: document.getElementById('description').value,
                    playbook: document.getElementById('playbook').value,
                    fileId: selectedFileId,
                    fileName: selectedFileName,
                    // Store all selected files for symbol switching
                    files: selectedFilesArray,
                    activeFileIndex: 0,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    startBalance: document.getElementById('startBalance').value,
                    
                    // Trading Settings
                    marketType: Array.from(document.querySelectorAll('.market-checkbox:checked')).map(cb => cb.value),
                    defaultRiskType: document.getElementById('defaultRiskType').value,
                    defaultRisk: parseFloat(document.getElementById('defaultRisk').value) || 1,
                    allowBackNavigation: document.getElementById('allowBackNavigation').checked,
                    
                    // Protection Preset
                    protectionPreset: protectionPreset
                };

                let sessionId = null;
                try {
                    const res = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            name: String(formData.sessionName || '').trim() || 'Backtest Session',
                            session_type: 'personal',
                            config: formData
                        })
                    });
                    if (!res.ok) {
                        const body = await res.json().catch(() => null);
                        throw new Error((body && body.detail) ? String(body.detail) : 'Failed to create session');
                    }
                    const payload = await res.json();
                    sessionId = payload && payload.session && payload.session.id ? payload.session.id : null;
                } catch (err) {
                    alert('Failed to create session: ' + String(err && err.message ? err.message : err));
                    return;
                }

                // Store session data locally for compatibility with existing UI
                try {
                    localStorage.setItem('backtestingSession', JSON.stringify(formData));
                    if (sessionId) {
                        localStorage.setItem('active_trading_session_id', String(sessionId));
                    }
                } catch (e) {}

                // Save to session history
                formData.created = new Date().toISOString();
                const sessions = JSON.parse(localStorage.getItem('backtestingSessions') || '[]');
                sessions.push(formData);
                // Keep only last 20 sessions
                if (sessions.length > 20) {
                    sessions.shift();
                }
                localStorage.setItem('backtestingSessions', JSON.stringify(sessions));

                // Small delay to ensure localStorage is written
                setTimeout(() => {
                    // Redirect to chart with backtesting mode
                    console.log('üöÄ Redirecting to backtesting mode...');
                    const targetUrl = `index.html?mode=backtest&sessionId=${encodeURIComponent(String(sessionId))}&fileId=${selectedFileId}`;
                    
                    // Check if we're in an iframe
                    const isInIframe = window.self !== window.top;
                    if (isInIframe) {
                        // If in iframe (opened from sessions.html), redirect parent window
                        console.log('üì± Running in iframe, redirecting parent window');
                        window.top.location.href = targetUrl;
                    } else {
                        // If standalone page, redirect normally
                        window.location.href = targetUrl;
                    }
                }, 100);
            });
        });

        // Dates will be auto-populated when user selects a file

        // ========== Template & Session Management ==========

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Get current form data
        function getCurrentFormData() {
            return {
                type: 'standard',
                marketType: Array.from(document.querySelectorAll('.market-checkbox:checked')).map(cb => cb.value),
                defaultRiskType: document.getElementById('defaultRiskType').value,
                defaultRisk: parseFloat(document.getElementById('defaultRisk').value) || 1,
                allowBackNavigation: document.getElementById('allowBackNavigation').checked
            };
        }

        // Load form data
        function loadFormData(data) {
            if (!data) return;
            
            // Load all fields
            // Load market types (handle both array and single string for backward compatibility)
            const marketTypes = Array.isArray(data.marketType) ? data.marketType : [data.marketType || 'forex'];
            document.querySelectorAll('.market-checkbox').forEach(cb => {
                cb.checked = marketTypes.includes(cb.value);
            });
            document.getElementById('defaultRiskType').value = data.defaultRiskType || 'percent';
            document.getElementById('defaultRisk').value = data.defaultRisk || 1;
            document.getElementById('allowBackNavigation').checked = data.allowBackNavigation !== false;
            
            // Trigger the risk type change to update labels
            const riskEvent = new Event('change');
            document.getElementById('defaultRiskType').dispatchEvent(riskEvent);
        }

        // Save Template
        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            const template = {
                name: name,
                description: document.getElementById('templateDescription').value.trim(),
                data: getCurrentFormData(),
                created: new Date().toISOString()
            };

            const templates = JSON.parse(localStorage.getItem('backtestingTemplates') || '[]');
            templates.push(template);
            localStorage.setItem('backtestingTemplates', JSON.stringify(templates));

            alert('‚úÖ Template saved successfully!');
            closeModal('saveTemplateModal');
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
        }

        // Load Templates
        function loadTemplates() {
            const templates = JSON.parse(localStorage.getItem('backtestingTemplates') || '[]');
            const templatesList = document.getElementById('templatesList');

            if (templates.length === 0) {
                templatesList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"/>
                        </svg>
                        <p>No templates saved yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Configure your settings and click "Save as Template"</p>
                    </div>
                `;
                return;
            }

            templatesList.innerHTML = templates.map((template, index) => `
                <div class="template-item" onclick="useTemplate(${index})">
                    <div class="template-info">
                        <div class="template-name">${template.name}</div>
                        <div class="template-desc">${template.description || 'No description'} ‚Ä¢ ${new Date(template.created).toLocaleDateString()}</div>
                    </div>
                    <div class="template-actions">
                        <button class="btn-icon delete" onclick="event.stopPropagation(); deleteTemplate(${index})" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Use Template
        function useTemplate(index) {
            const templates = JSON.parse(localStorage.getItem('backtestingTemplates') || '[]');
            if (templates[index]) {
                loadFormData(templates[index].data);
                closeModal('templatesModal');
                alert('‚úÖ Template loaded successfully!');
            }
        }

        // Delete Template
        function deleteTemplate(index) {
            if (!confirm('Are you sure you want to delete this template?')) return;

            const templates = JSON.parse(localStorage.getItem('backtestingTemplates') || '[]');
            templates.splice(index, 1);
            localStorage.setItem('backtestingTemplates', JSON.stringify(templates));
            loadTemplates();
        }

        // Load Recent Sessions
        function loadRecentSessions() {
            const sessions = JSON.parse(localStorage.getItem('backtestingSessions') || '[]');
            const sessionsList = document.getElementById('sessionsList');

            if (sessions.length === 0) {
                sessionsList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <p>No recent sessions</p>
                        <p style="font-size: 12px; margin-top: 8px;">Your backtesting sessions will appear here</p>
                    </div>
                `;
                return;
            }

            // Show last 10 sessions
            const recentSessions = sessions.slice(-10).reverse();
            sessionsList.innerHTML = recentSessions.map((session, index) => `
                <div class="session-item" onclick="useSession(${sessions.length - 1 - index})">
                    <div class="session-info">
                        <div class="session-name">${session.sessionName}</div>
                        <div class="session-desc">${session.fileName || 'Unknown file'} ‚Ä¢ ${session.marketType || 'Forex'} ‚Ä¢ ${new Date(session.created || Date.now()).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }

        // Use Recent Session
        function useSession(index) {
            const sessions = JSON.parse(localStorage.getItem('backtestingSessions') || '[]');
            if (sessions[index]) {
                loadFormData(sessions[index]);
                // Also load session-specific data
                document.getElementById('sessionName').value = sessions[index].sessionName + ' (Copy)';
                document.getElementById('description').value = sessions[index].description || '';
                closeModal('sessionsModal');
                alert('‚úÖ Session loaded successfully!');
            }
        }

        // Button Event Listeners
        document.getElementById('saveTemplateBtn').addEventListener('click', () => {
            document.getElementById('saveTemplateModal').classList.add('active');
        });

        document.getElementById('loadTemplateBtn').addEventListener('click', () => {
            loadTemplates();
            document.getElementById('templatesModal').classList.add('active');
        });

        document.getElementById('recentSessionsBtn').addEventListener('click', () => {
            loadRecentSessions();
            document.getElementById('sessionsModal').classList.add('active');
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Note: Session history saving is already handled in the main submit handler above
    </script>
</body>
</html>
